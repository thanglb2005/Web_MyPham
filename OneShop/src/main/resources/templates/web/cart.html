<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<meta http-equiv="content-type" content="text/html;charset=utf-8" />
<head>
    <meta charset="UTF-809" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="author" content="mironcoder" />
    <meta name="email" content="mironcoder@gmail.com" />
    <meta name="profile" content="https://themeforest.net/user/mironcoder" />
    <meta name="template" content="greeny" />
    <meta name="title" content="greeny - Ecommerce Food Store HTML Template" />
    <meta name="keywords" content="organic, food, shop, ecommerce, store, html, bootstrap, template, agriculture, vegetables, products, farm, grocery, natural, online" />
    <title>Giỏ hàng - OneShop</title>
    <link rel="stylesheet" href="fonts/flaticon/flaticon.css" />
    <link rel="stylesheet" href="fonts/icofont/icofont.min.css" />
    <link rel="stylesheet" href="fonts/fontawesome/fontawesome.min.css" />
    <link rel="stylesheet" href="vendor/venobox/venobox.min.css" />
    <link rel="stylesheet" href="vendor/slickslider/slick.min.css" />
    <link rel="stylesheet" href="vendor/niceselect/nice-select.min.css" />
    <link rel="stylesheet" href="vendor/bootstrap/bootstrap.min.css" />
    <link rel="stylesheet" th:href="@{/css/main.css}" />
    <link rel="stylesheet" th:href="@{/css/checkout.css}" />
    <style>
        /* Hide number input spinners */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body>
    <!--************************************
				Header Start
		*************************************-->
    <header th:replace="~{/web/fragments/header :: header(isCartPage=${true})}"></header>
    <!--************************************
				Header End
		*************************************-->

    
    <section class="inner-section checkout-part">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    
                    <!-- Error message for no selected items -->
                    <div class="alert alert-warning" th:if="${param.error != null and param.error[0] == 'no-selected-items'}" 
                         style="background-color: #fff3cd; border-color: #ffeaa7; color: #856404; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                        <strong>Chú ý:</strong> Vui lòng chọn ít nhất một sản phẩm để thanh toán!
                    </div>
                    
                    <!-- Error message from flash attributes -->
                    <div class="alert alert-danger" th:if="${error != null}" 
                         style="background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                        <strong>Lỗi:</strong> <span th:text="${error}"></span>
                    </div>
                    
                    <!-- Success message from flash attributes -->
                    <div class="alert alert-success" th:if="${success != null}" 
                         style="background-color: #d4edda; border-color: #c3e6cb; color: #155724; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                        <strong>Thành công:</strong> <span th:text="${success}"></span>
                    </div>
                </div>
                <div class="col-lg-12">
                    <div class="cart-header-row" style="background: #fff; padding: 12px 16px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #e5e5e5; box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center;">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)" style="margin-right: 12px; transform: scale(1.1); accent-color: #33a3cc;">
                            <span style="font-size: 14px; color: #333; font-weight: 500;">Sản Phẩm</span>
                        </div>
                        <div style="display: flex; gap: 20px;">
                            <div style="width: 140px; text-align: center; font-size: 14px; color: #757575;">Đơn Giá</div>
                            <div style="width: 140px; text-align: center; font-size: 14px; color: #757575;">Số Lượng</div>
                            <div style="width: 140px; text-align: center; font-size: 14px; color: #757575;">Số Tiền</div>
                            <div style="width: 140px; text-align: center; font-size: 14px; color: #757575;">Thao Tác</div>
                        </div>
                    </div>
                    
                    <div class="account-card">
                        <div th:unless="${cartItemsByShop != null and !#lists.isEmpty(cartItemsByShop)}" class="text-center">
                            <h3 style="color: #119744" class="mt-5">Hiện tại bạn chưa có sản phẩm nào trong giỏ hàng!</h3>
                            <h4 style="color: #119744">Hãy mua sắm đi nào!</h4>
                            <a th:href="@{/products}" style="text-decoration: underline;">Click tại đây!</a>
                        </div>
                        <!-- One-style cart grouped by shop -->
                        <div class="One-cart-container" th:if="${cartItemsByShop != null and !#lists.isEmpty(cartItemsByShop)}">
                            <!-- Header row like Shopee: checkbox + column titles -->
                            
                            
                            <!-- Shop groups -->
                            <div th:each="shopGroup : ${cartItemsByShop}" class="shop-group" style="background: #fff; margin-bottom: 12px; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                                <!-- Shop header -->
                                <div class="shop-header" style="padding: 16px; background: #fff; border-bottom: 1px solid #f5f5f5;">
                                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                        <div style="display: flex; align-items: center;">
                                            <input type="checkbox" class="shop-checkbox" 
                                                   th:data-shop-id="${shopGroup.shop?.shopId}" 
                                                   th:checked="${shopGroup.shopSelected}"
                                                   onchange="toggleSelectShop(this)" 
                                                   style="margin-right: 12px; transform: scale(1.1); accent-color: #33a3cc;">
                                            <div class="shop-info" style="display: flex; align-items: center;">
                                                <span style="font-weight: 500; color: #333; font-size: 14px;">[[${shopGroup.shopName}]]</span>
                                                <a th:href="@{/chat(shopId=${shopGroup.shop?.shopId}, room=${'shop-' + shopGroup.shop?.shopId + '-customer-' + session.user.userId}, user=${session.user.name})}"
                                                   title="Chat với shop"
                                                   aria-label="Chat với shop"
                                                   style="margin-left: 8px; background: #33a3cc; width: 22px; height: 22px; border-radius: 4px; display: inline-flex; align-items: center; justify-content: center; text-decoration: none;">
                                                    <i class="fas fa-comment-dots" style="color: #fff; font-size: 12px;"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Shop products -->
                                <div class="shop-products">
                                    <div th:each="item,itemState : ${shopGroup.cartItems}" class="product-item" style="padding: 16px; border-bottom: 1px solid #f5f5f5; display: flex; align-items: center; justify-content: space-between;">
                                        <!-- Column: Product (checkbox + image + info) -->
                                        <div style="display: flex; align-items: center; min-width: 0;">
                                            <input type="checkbox" class="item-checkbox" 
                                                   th:data-product-id="${item.id}" 
                                                   th:data-shop-id="${shopGroup.shop?.shopId}"
                                                   th:checked="${item.selected}"
                                                   onchange="toggleSelectItem(this)"
                                                   style="margin-right: 12px; transform: scale(1.1); accent-color: #33a3cc;">
                                            <img th:src="@{'/loadImage?imageName='+${item.imageUrl}}" alt="product" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px; border: 1px solid #f0f0f0; margin-right: 12px;" onerror="this.src='/images/no-image.png'" />
                                            <div style="min-width: 0;">
                                                <div style="font-size: 14px; color: #333; line-height: 1.4; margin-bottom: 4px; word-wrap: break-word;">
                                                    <a th:href="@{/productDetail(id=${item.id})}" target="_blank" 
                                                       style="color: #333; text-decoration: none; cursor: pointer;"
                                                       onmouseover="this.style.color='#33a3cc'" 
                                                       onmouseout="this.style.color='#333'">
                                                        [[${item.name}]]
                                                    </a>
                                                </div>
                                                <div style="font-size: 12px; color: #757575;">Phân Loại Hàng: [[${item.categoryName}]]</div>
                                            </div>
                                        </div>
                                        
                                        <!-- Right side columns container -->
                                        <div style="display: flex; gap: 20px;">
                                            <!-- Column: Unit Price -->
                                            <div style="width: 150px; text-align: right;">
                                                <div th:if="${item.discount != null and item.discount > 0}" 
                                                     style="color: #757575; font-size: 12px; text-decoration: line-through;" 
                                                     th:text="${#numbers.formatDecimal(item.unitPrice, 0, 'DEFAULT', 0, 'DEFAULT')} + 'đ'"></div>
                                                <div style="color: #33a3cc; font-size: 16px; font-weight: 500;" 
                                                     th:text="${#numbers.formatDecimal(item.discount != null and item.discount > 0 ? item.unitPrice * (1 - item.discount/100.0) : item.unitPrice, 0, 'DEFAULT', 0, 'DEFAULT')} + 'đ'"></div>
                                            </div>
                                            
                                            <!-- Column: Quantity -->
                                            <div style="width: 140px; text-align: left; display: flex; flex-direction: column; gap: 6px;">
                                                <form th:action="@{/cart/update}" method="post" class="quantity-form" style="display: inline-flex; align-items: center; margin-left: 50px;">
                                                    <input type="hidden" name="productId" th:value="${item.id}">
                                                    <div class="quantity-controls" style="display: inline-flex; align-items: center; border: 1px solid #e5e5e5; border-radius: 4px;">
                                                        <button type="button" class="quantity-btn minus" onclick="changeQuantity(this, -1)" 
                                                                style="width: 28px; height: 32px; border: none; background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #757575; border-radius: 4px 0 0 4px;">-</button>
                                                        <input type="number" name="quantity" th:value="${item.quantity}" min="1" th:max="${item.product.quantity}" class="quantity-input" 
                                                               style="width: 45px; height: 32px; text-align: center; border: none; border-left: 1px solid #e5e5e5; border-right: 1px solid #e5e5e5; font-size: 14px; font-weight: 500; -moz-appearance: textfield; -webkit-appearance: none; appearance: none;"
                                                               onchange="validateQuantity(this)" title="Tối đa: [[${item.product.quantity}]] sản phẩm">
                                                        <button type="button" class="quantity-btn plus" onclick="changeQuantity(this, 1)" 
                                                                style="width: 28px; height: 32px; border: none; background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #757575; border-radius: 0 4px 4px 0;">+</button>
                                                    </div>
                                                </form>
                                                </div>
                                            
                                            <!-- Column: Total -->
                                            <div style="width: 140px; text-align: right; color: #33a3cc; font-size: 16px; font-weight: 500;" th:text="${#numbers.formatDecimal(item.totalPrice, 0, 'DEFAULT', 0, 'DEFAULT')} + 'đ'"></div>
                                            
                                            <!-- Column: Actions -->
                                            <div style="width: 140px; text-align: left; display: flex; flex-direction: column; gap: 6px;">
                                                <form th:action="@{/cart/remove/{productId}(productId=${item.id})}" method="get" style="display: inline;">
                                                    <button type="submit" style="background: none; border: none; color: #33a3cc; cursor: pointer; font-size: 12px; padding: 0; display: flex; align-items: center; gap: 4px; margin-left: 80px;">
                                                        <i class="fas fa-trash-alt"></i>
                                                        <span>Xóa</span>
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Shop Voucher section -->
                                <div class="shop-voucher" style="padding: 12px 16px; background: #eff9fc; border-top: 1px solid #f5f5f5; display: flex; align-items: center; justify-content: space-between;">
                                    
                                    <!-- No shop voucher selected -->
                                    <th:block th:if="${shopVoucher == null}">
                                    <div style="display: flex; align-items: center;">
                                        <i class="fas fa-ticket-alt" style="color: #33a3cc; margin-right: 8px; font-size: 14px;"></i>
                                        <span style="font-size: 13px; color: #333;">Xem tất cả Voucher của Shop</span>
                        </div>
                                        <div style="color: #33a3cc; font-size: 13px; cursor: pointer;" th:onclick="'openShopVoucherModal(' + ${shopGroup.shop?.shopId} + ')'">
                                        <span>Xem thêm voucher</span>
                                        <i class="fas fa-chevron-right" style="margin-left: 4px; font-size: 10px;"></i>
                    </div>
                                    </th:block>
                                    
                                    <!-- Shop voucher selected -->
                                    <th:block th:if="${shopVoucher != null}">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <i class="fas fa-ticket-alt" style="color: #33a3cc; margin-right: 8px; font-size: 14px;"></i>
                                            <div style="background: #e3f2fd; padding: 4px 8px; border-radius: 4px; font-size: 12px; color: #1976d2; font-weight: 500; border: 1px solid #bbdefb;">
                                                <i class="fas fa-check-circle" style="margin-right: 4px;"></i>
                                                <span th:text="${shopVoucher.promotionCode}"></span>
                </div>
                                            <span style="font-size: 13px; color: #1976d2; font-weight: 500;" th:text="'Giảm ' + ${#numbers.formatDecimal(shopVoucherDiscount ?: 0, 0, 'DEFAULT', 0, 'DEFAULT')} + 'đ'"></span>
            </div>
                                        <button onclick="removeShopVoucher()" style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 12px; padding: 2px 4px;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </th:block>
                                    
        </div>
                    </div>
                </div>
    
    <!-- Sticky Checkout Bar (part of the cart block, not global footer) -->
    <div th:if="${cartItemsByShop != null and !#lists.isEmpty(cartItemsByShop)}"
         style="position: sticky; bottom: 0; z-index: 10;">
        <div class="account-card" style="margin-bottom: 0; border-radius: 0; border: none; box-shadow: none; background: #fff; border-top: 1px solid #e5e5e5;">
            <!-- Top section - Vouchers -->
            <div style="background: #fafafa; padding: 12px 16px; border-bottom: 1px solid #e5e5e5;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <!-- One Voucher -->
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <div th:if="${appliedPromotion == null}" style="display: flex; align-items: center; cursor: pointer;" onclick="openVoucherModal()">
                            <i class="fas fa-gift" style="color: #33a3cc; margin-right: 6px; font-size: 14px;"></i>
                            <span style="font-size: 14px; color: #333;">One Voucher</span>
                            <span style="font-size: 14px; color: #0088ff; margin-left: 16px;">Chọn hoặc nhập mã</span>
                        </div>
                        <div th:if="${appliedPromotion != null}" style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-gift" style="color: #28a745; margin-right: 6px; font-size: 14px;"></i>
                            <span style="font-size: 14px; color: #333;">Voucher:</span>
                            <span style="background: #e8f5e8; padding: 2px 6px; border-radius: 3px; font-size: 12px; color: #28a745; font-weight: 500;" th:text="${appliedPromotion.promotionCode}"></span>
                            <span style="color: #28a745; font-size: 12px; font-weight: 500;">-[[${#numbers.formatDecimal(discountAmount, 0, 'DEFAULT', 0, 'DEFAULT')}]]đ</span>
                            <button onclick="removeAppliedVoucher()" style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 11px; padding: 1px 3px;" title="Bỏ voucher">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- One Xu -->
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="display: flex; align-items: center;">
                            <i class="fas fa-coins" style="color: #33a3cc; margin-right: 6px; font-size: 14px;"></i>
                            <span style="font-size: 14px; color: #333;">One Xu</span>
                        </div>
                        
                        <!-- Xu Balance Display -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 12px; color: #666;">Số dư:</span>
                            <span id="xuBalanceDisplay" style="font-size: 12px; color: #33a3cc; font-weight: 500;" th:text="${user?.oneXuBalance != null ? #numbers.formatDecimal(user.oneXuBalance, 0, 'DEFAULT', 0, 'DEFAULT') + ' xu' : '0 xu'}"></span>
                        </div>
                        
                        <!-- Xu Input -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="number" id="xuInput" placeholder="Nhập xu" min="0" th:max="${user?.oneXuBalance ?: 0}" 
                                   style="width: 80px; padding: 4px 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" 
                                   oninput="validateXuInput()">
                            <span style="font-size: 12px; color: #666;">xu</span>
                            <button onclick="applyXuDiscount()" style="background: #33a3cc; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#2a8bb8'" onmouseout="this.style.background='#33a3cc'">
                                Áp dụng
                            </button>
                        </div>
                        
                        <!-- Xu Discount Display -->
                        <div style="display: flex; align-items: center;">
                            <span id="xuDiscountDisplay" style="font-size: 12px; color: #28a745; font-weight: 500;">-0đ</span>
                        </div>
                    </div>
                    </div>
                </div>
            
            <!-- Bottom section - Checkout -->
            <div style="padding: 16px;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <!-- Left side - Select options -->
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <label style="display: flex; align-items: center; font-size: 14px; color: #333; cursor: pointer;">
                            <input type="checkbox" id="selectAllBottom" onchange="toggleSelectAll(this)" style="margin-right: 8px; transform: scale(1.1); accent-color: #33a3cc;">
                            <span>Chọn Tất Cả (<span id="total-items-footer">[[${totalItems}]]</span>)</span>
                        </label>
                        <button style="background: none; border: none; color: #333; font-size: 14px; cursor: pointer; padding: 0; text-decoration: underline;">Xóa</button>
                        <button style="background: none; border: none; color: #333; font-size: 14px; cursor: pointer; padding: 0; text-decoration: underline;">Bỏ sản phẩm không hoạt động</button>
                        <button style="background: none; border: none; color: #ee4d2d; font-size: 14px; cursor: pointer; padding: 0; text-decoration: underline;">Lưu vào mục Đã thích</button>
                    </div>
                    
                    <!-- Right side - Price and checkout -->
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <div class="cart-footer-summary" style="text-align: right;">
                            <!-- No vouchers applied -->
                            <div th:if="${totalDiscount == null or totalDiscount == 0}" style="font-size: 16px; color: #333; margin-bottom: 2px;">
                                <span>Tổng cộng (<span id="selected-count-footer" th:text="${selectedItems ?: 0}"></span> Sản phẩm): </span>
                                <span style="color: #33a3cc; font-size: 20px; font-weight: 500;">₫<span id="selected-total-footer" th:text="${#numbers.formatDecimal(selectedPrice ?: 0, 0, 'DEFAULT', 0, 'DEFAULT')}"></span></span>
                            </div>
                            
                            <!-- Vouchers applied -->
                            <div th:if="${totalDiscount != null and totalDiscount > 0}" style="font-size: 14px; color: #333;">
                                <div style="margin-bottom: 4px;">
                                    <span>Tạm tính (<span th:text="${selectedItems ?: 0}"></span> Sản phẩm): </span>
                                    <span style="color: #666; font-size: 16px;" th:text="'₫' + ${#numbers.formatDecimal(selectedPrice ?: 0, 0, 'DEFAULT', 0, 'DEFAULT')}"></span>
                                </div>
                                
                                <!-- OneShop voucher discount -->
                                <div th:if="${oneVoucherDiscount != null and oneVoucherDiscount > 0}" style="margin-bottom: 4px;">
                                    <span>OneShop voucher: </span>
                                    <span style="color: #1976d2; font-size: 16px;" th:text="'-₫' + ${#numbers.formatDecimal(oneVoucherDiscount ?: 0, 0, 'DEFAULT', 0, 'DEFAULT')}"></span>
                                </div>
                                
                                <!-- Shop voucher discount -->
                                <div th:if="${shopVoucherDiscount != null and shopVoucherDiscount > 0}" style="margin-bottom: 4px;">
                                    <span>Shop voucher: </span>
                                    <span style="color: #1976d2; font-size: 16px;" th:text="'-₫' + ${#numbers.formatDecimal(shopVoucherDiscount ?: 0, 0, 'DEFAULT', 0, 'DEFAULT')}"></span>
                                </div>
                                
                                <div style="border-top: 1px solid #e5e5e5; padding-top: 4px;">
                                    <span>Tổng thanh toán: </span>
                                    <span style="color: #33a3cc; font-size: 20px; font-weight: 500;">₫<span th:text="${#numbers.formatDecimal(finalPrice ?: 0, 0, 'DEFAULT', 0, 'DEFAULT')}"></span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                        <button id="checkout-btn-footer" onclick="proceedToCheckout()" 
                                style="background: #33a3cc; color: white; border: none; padding: 12px 40px; border-radius: 2px; font-size: 14px; font-weight: 500; cursor: pointer; min-width: 140px;">
                            Mua Hàng
                        </button>
                </div>
                        </div>
                    </div>
                </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
        
    </section>

    <!-- Removed global fixed footer and extra spacer: now sticky bar is part of cart block -->

    
    <script>
        function changeQuantity(button, change) {
            const form = button.closest('.quantity-form');
            const input = form.querySelector('.quantity-input');
            const maxQuantity = parseInt(input.getAttribute('max'));
            let newQuantity = parseInt(input.value) + change;
            
            if (newQuantity < 1) {
                newQuantity = 1;
            }
            
            if (newQuantity > maxQuantity) {
                alert('Số lượng không được vượt quá tồn kho (' + maxQuantity + ')');
                newQuantity = maxQuantity;
            }
            
            input.value = newQuantity;
            form.submit();
        }
        
        function validateQuantity(input) {
            const maxQuantity = parseInt(input.getAttribute('max'));
            const quantity = parseInt(input.value);
            
            if (quantity > maxQuantity) {
                alert('Số lượng không được vượt quá tồn kho (' + maxQuantity + ')');
                input.value = maxQuantity;
            }
            
            if (quantity < 1) {
                input.value = 1;
            }
            
            input.closest('form').submit();
        }

        function showConfigModalDialog(id, name) {
            $('#productName').text(name);
            $('#yesOption').attr('href', '/cart/remove/'+id);
            $('#configmationId').modal('show');
        }
        
    </script>
    
    <!-- Modal -->
    <div class="modal" id="configmationId">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <button class="modal-close" data-bs-dismiss="modal">
                    <i class="icofont-close"></i>
                </button>
                <div class="modal-form">
                    <h5 class="modal-title">Xác nhận</h5>
                    <div class="modal-body">
                        <p>
                            Bạn có muốn xoá sản phẩm " <span style="color: #119744" id="productName"></span> "
                            ra khỏi giỏ hàng không ?
                        </p>
                    </div>
                    <div class="modal-footer">
                        <a id="yesOption" type="button" class="btn btn-success">Có</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Voucher Modal -->
    <div class="modal fade" id="voucherModal" tabindex="-1" style="z-index: 1055;">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content" style="border: none; border-radius: 8px; overflow: hidden;">
                <div class="modal-header" style="background: #33a3cc; color: white; border: none; padding: 16px 20px;">
                    <h5 class="modal-title" style="margin: 0; font-weight: 500; font-size: 18px;">
                        Chọn OneShop Voucher
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                
                <div class="modal-body" style="padding: 0; background: white; max-height: 70vh; overflow-y: auto;">
                    <!-- Voucher Input -->
                    <div style="padding: 16px; border-bottom: 1px solid #f1f1f1; position: sticky; top: 0; background: white; z-index: 10;">
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="voucher-input" placeholder="Mã Voucher" 
                                   style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                                   onkeypress="if(event.key==='Enter') applyManualVoucher()">
                            <button onclick="applyManualVoucher()" 
                                    style="background: #33a3cc; color: white; border: none; padding: 10px 16px; border-radius: 4px; font-size: 14px; cursor: pointer;">
                                ÁP DỤNG
                            </button>
                        </div>
                    </div>
                    
                    <!-- Mã Miễn Phí Vận Chuyển -->
                    <div style="padding: 16px; border-bottom: 1px solid #f1f1f1;">
                        <h6 style="margin: 0 0 12px 0; font-size: 14px; color: #333;">Mã Miễn Phí Vận Chuyển</h6>
                        
                        <!-- Loading state -->
                        <div id="voucher-loading" style="text-align: center; padding: 20px; display: none;">
                            <i class="fas fa-spinner fa-spin" style="color: #999;"></i>
                            <span style="margin-left: 8px; color: #999; font-size: 14px;">Đang tải...</span>
                        </div>
                        
                        <!-- Voucher list -->
                        <div id="voucher-list">
                            <!-- Vouchers will be loaded here -->
                        </div>
                        
                        <!-- No vouchers -->
                        <div id="no-vouchers" style="text-align: center; padding: 20px; color: #999; font-size: 14px; display: none;">
                            Không có voucher khả dụng
                        </div>
                        
                        <!-- Warning message -->
                        <div style="background: #fff3e0; border: 1px solid #ffcc02; border-radius: 4px; padding: 8px 12px; margin-top: 12px; display: flex; align-items: center;">
                            <i class="fas fa-exclamation-triangle" style="color: #ff6600; margin-right: 8px; font-size: 14px;"></i>
                            <span style="color: #ff6600; font-size: 13px;">Vui lòng chọn sản phẩm trong giỏ hàng để áp dụng Voucher này</span>
                        </div>
                    </div>
                    
                </div>
                
                <div class="modal-footer" style="border-top: 1px solid #f1f1f1; padding: 16px 20px; background: white; display: flex; gap: 10px;">
                    <button type="button" class="btn" data-bs-dismiss="modal" 
                            style="flex: 1; background: white; border: 1px solid #ddd; color: #333; padding: 10px; border-radius: 4px; font-size: 14px;">
                        TRỞ LẠI
                    </button>
                    <button type="button" class="btn" onclick="applySelectedVoucher()" 
                            style="flex: 1; background: #33a3cc; border: none; color: white; padding: 10px; border-radius: 4px; font-size: 14px;">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Shop Voucher Modal -->
    <div class="modal fade" id="shopVoucherModal" tabindex="-1" style="z-index: 1060;">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content" style="border: none; border-radius: 8px; overflow: hidden;">
                <div class="modal-header" style="background: #33a3cc; color: white; border: none; padding: 16px 20px;">
                    <h5 class="modal-title" style="margin: 0; font-weight: 500; font-size: 18px;">
                        <i class="fas fa-store" style="margin-right: 8px;"></i>
                        <span id="shop-voucher-title">Voucher của Shop</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body" style="padding: 0; background: white; max-height: 70vh; overflow-y: auto;">
                    <!-- Loading state -->
                    <div id="shop-voucher-loading" style="text-align: center; padding: 40px; display: none;">
                        <i class="fas fa-spinner fa-spin" style="color: #999; font-size: 24px;"></i>
                        <div style="margin-top: 12px; color: #999; font-size: 14px;">Đang tải voucher...</div>
                    </div>

                    <!-- Voucher list -->
                    <div id="shop-voucher-list" style="padding: 16px;">
                        <!-- Shop vouchers will be loaded here -->
                    </div>

                    <!-- No vouchers -->
                    <div id="shop-no-vouchers" style="text-align: center; padding: 40px; color: #999; display: none;">
                        <i class="fas fa-ticket-alt" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px;"></i>
                        <div style="font-size: 16px; margin-bottom: 8px;">Shop này chưa có voucher</div>
                        <div style="font-size: 14px;">Hãy quay lại sau để xem voucher mới!</div>
                    </div>
                </div>

                <div class="modal-footer" style="border-top: 1px solid #f1f1f1; padding: 16px 20px; background: white;">
                    <button type="button" class="btn" data-bs-dismiss="modal"
                            style="width: 100%; background: #33a3cc; border: none; color: white; padding: 12px; border-radius: 4px; font-size: 14px;">
                        ĐÓNG
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!--************************************
				Footer Start
		*************************************-->
    <footer th:replace="~{/web/fragments/footer :: footer}"></footer>
    <!--************************************
				Footer End
		*************************************-->
    
    <script src="vendor/bootstrap/jquery-1.12.4.min.js"></script>
    <script src="vendor/bootstrap/popper.min.js"></script>
    <script src="vendor/bootstrap/bootstrap.min.js"></script>
    <script src="vendor/countdown/countdown.min.js"></script>
    <script src="vendor/niceselect/nice-select.min.js"></script>
    <script src="vendor/slickslider/slick.min.js"></script>
    <script src="vendor/venobox/venobox.min.js"></script>
    <script src="js/nice-select.js"></script>
    <script src="js/countdown.js"></script>
    <script src="js/accordion.js"></script>
    <script src="js/venobox.js"></script>
    <script src="js/slick.js"></script>
    <script src="js/main.js"></script>
    
    <!-- Cart Selection JavaScript -->
    <script>
        // Toggle individual item selection
        function toggleSelectItem(checkbox) {
            const productId = checkbox.getAttribute('data-product-id');
            const shopId = checkbox.getAttribute('data-shop-id');
            const selected = checkbox.checked;
            
            // Send AJAX request to update selection status
            fetch('/cart/update-selected', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `productId=${productId}&selected=${selected}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateTotals(data.selectedTotal, data.selectedCount);
                    updateSelectAllCheckbox();
                    updateShopCheckbox(shopId);
                } else {
                    alert(data.message || 'Có lỗi xảy ra');
                    // Revert checkbox state
                    checkbox.checked = !selected;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi cập nhật giỏ hàng');
                // Revert checkbox state
                checkbox.checked = !selected;
            });
        }
        
        // Toggle select all items
        function toggleSelectAll(selectAllCheckbox) {
            const selected = selectAllCheckbox.checked;
            
            // Send AJAX request to update all items
            fetch('/cart/select-all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `selected=${selected}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update all individual checkboxes
                    const itemCheckboxes = document.querySelectorAll('.item-checkbox');
                    itemCheckboxes.forEach(checkbox => {
                        checkbox.checked = selected;
                    });
                    
                    updateTotals(data.selectedTotal, data.selectedCount);
                    updateAllShopCheckboxes();
                } else {
                    alert(data.message || 'Có lỗi xảy ra');
                    // Revert select all checkbox
                    selectAllCheckbox.checked = !selected;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi cập nhật giỏ hàng');
                // Revert select all checkbox
                selectAllCheckbox.checked = !selected;
            });
        }
        
        // Toggle select shop items
        function toggleSelectShop(shopCheckbox) {
            const shopId = shopCheckbox.getAttribute('data-shop-id');
            const selected = shopCheckbox.checked;
            
            // Send AJAX request to update shop selection
            fetch('/cart/select-shop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `shopId=${shopId}&selected=${selected}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update all items in this shop
                    const shopItems = document.querySelectorAll(`input[data-shop-id="${shopId}"].item-checkbox`);
                    shopItems.forEach(checkbox => {
                        checkbox.checked = selected;
                    });
                    
                    updateTotals(data.selectedTotal, data.selectedCount);
                    updateSelectAllCheckbox();
                    updateShopStats(shopId);
                } else {
                    alert(data.message || 'Có lỗi xảy ra');
                    // Revert shop checkbox state
                    shopCheckbox.checked = !selected;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi cập nhật giỏ hàng');
                // Revert shop checkbox state
                shopCheckbox.checked = !selected;
            });
        }
        
        // Update totals display
        function updateTotals(selectedTotal, selectedCount) {
            const selectedTotalElement = document.getElementById('selected-total');
            const selectedCountElement = document.getElementById('selected-count');
            const checkoutCountElement = document.getElementById('checkout-count');
            
            // Footer elements - use querySelector to find visible elements
            const footerContainer = document.querySelector('.cart-footer-summary');
            
            // Check if footer has voucher structure (3 divs instead of 1)
            const hasVoucher = footerContainer && footerContainer.querySelector('div > div');
            
            if (hasVoucher) {
                // Footer has voucher structure, need to rebuild with updated values
                // Extract discount amounts from current display
                const discountElements = footerContainer.querySelectorAll('span');
                let oneVoucherDiscount = 0;
                let shopVoucherDiscount = 0;
                
                discountElements.forEach(el => {
                    const text = el.textContent;
                    if (text.includes('OneShop voucher') || text.includes('Giảm giá voucher')) {
                        const nextElement = el.nextElementSibling;
                        if (nextElement && nextElement.textContent.includes('-₫')) {
                            const discountText = nextElement.textContent.replace(/[^\d]/g, '');
                            oneVoucherDiscount = parseInt(discountText) || 0;
                        }
                    } else if (text.includes('Shop voucher')) {
                        const nextElement = el.nextElementSibling;
                        if (nextElement && nextElement.textContent.includes('-₫')) {
                            const discountText = nextElement.textContent.replace(/[^\d]/g, '');
                            shopVoucherDiscount = parseInt(discountText) || 0;
                        }
                    }
                });
                
                const totalDiscount = oneVoucherDiscount + shopVoucherDiscount;
                const finalTotal = selectedTotal - totalDiscount;
                
                // Rebuild footer with updated values
                let footerHTML = '<div style="font-size: 14px; color: #333;"><div style="margin-bottom: 4px;">';
                footerHTML += `<span>Tạm tính (${selectedCount} Sản phẩm): </span>`;
                footerHTML += `<span style="color: #666; font-size: 16px;">₫${formatNumber(selectedTotal)}</span></div>`;
                
                if (oneVoucherDiscount > 0) {
                    footerHTML += '<div style="margin-bottom: 4px;">';
                    footerHTML += '<span>OneShop voucher: </span>';
                    footerHTML += `<span style="color: #1976d2; font-size: 16px;">-₫${formatNumber(oneVoucherDiscount)}</span></div>`;
                }
                
                if (shopVoucherDiscount > 0) {
                    footerHTML += '<div style="margin-bottom: 4px;">';
                    footerHTML += '<span>Shop voucher: </span>';
                    footerHTML += `<span style="color: #1976d2; font-size: 16px;">-₫${formatNumber(shopVoucherDiscount)}</span></div>`;
                }
                
                footerHTML += '<div style="border-top: 1px solid #e5e5e5; padding-top: 4px;">';
                footerHTML += '<span>Tổng thanh toán: </span>';
                footerHTML += `<span style="color: #33a3cc; font-size: 20px; font-weight: 500;">₫${formatNumber(finalTotal)}</span></div></div>`;
                
                footerContainer.innerHTML = footerHTML;
            } else {
                // No voucher, use simple update
                let selectedTotalFooter = null;
                let selectedCountFooter = null;
                
                if (footerContainer) {
                    selectedTotalFooter = footerContainer.querySelector('#selected-total-footer');
                    selectedCountFooter = footerContainer.querySelector('#selected-count-footer');
                }
                
            if (selectedTotalFooter) {
                selectedTotalFooter.textContent = formatNumber(selectedTotal);
            }
            if (selectedCountFooter) {
                selectedCountFooter.textContent = selectedCount;
                }
            }
            
            const selectAllBottom = document.getElementById('selectAllBottom');
            
            if (selectedTotalElement) {
                selectedTotalElement.textContent = formatNumber(selectedTotal) + ' VNĐ';
            }
            if (selectedCountElement) {
                selectedCountElement.textContent = selectedCount;
            }
            if (checkoutCountElement) {
                checkoutCountElement.textContent = selectedCount;
            }
            
            // Sync bottom select all checkbox
            if (selectAllBottom) {
                const selectAllTop = document.getElementById('selectAll');
                if (selectAllTop) {
                    selectAllBottom.checked = selectAllTop.checked;
                    selectAllBottom.indeterminate = selectAllTop.indeterminate;
                }
            }
            
            // Disable checkout button if no items selected
            const checkoutBtn = document.getElementById('checkout-btn-footer');
            if (checkoutBtn) {
                if (selectedCount === 0) {
                    checkoutBtn.style.opacity = '0.5';
                    checkoutBtn.style.pointerEvents = 'none';
                    checkoutBtn.setAttribute('title', 'Vui lòng chọn ít nhất một sản phẩm để thanh toán');
                } else {
                    checkoutBtn.style.opacity = '1';
                    checkoutBtn.style.pointerEvents = 'auto';
                    checkoutBtn.removeAttribute('title');
                }
            }
        }
        
        // Update select all checkbox based on individual selections
        function updateSelectAllCheckbox() {
            const itemCheckboxes = document.querySelectorAll('.item-checkbox');
            const selectAllCheckbox = document.getElementById('selectAll');
            
            if (itemCheckboxes.length === 0) return;
            
            const checkedCount = document.querySelectorAll('.item-checkbox:checked').length;
            
            if (checkedCount === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCount === itemCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }
        
        // Update shop checkbox based on its items
        function updateShopCheckbox(shopId) {
            const shopCheckbox = document.querySelector(`input[data-shop-id="${shopId}"].shop-checkbox`);
            if (!shopCheckbox) return;
            
            const shopItems = document.querySelectorAll(`input[data-shop-id="${shopId}"].item-checkbox`);
            const checkedShopItems = document.querySelectorAll(`input[data-shop-id="${shopId}"].item-checkbox:checked`);
            
            if (checkedShopItems.length === 0) {
                shopCheckbox.checked = false;
                shopCheckbox.indeterminate = false;
            } else if (checkedShopItems.length === shopItems.length) {
                shopCheckbox.checked = true;
                shopCheckbox.indeterminate = false;
            } else {
                shopCheckbox.checked = false;
                shopCheckbox.indeterminate = true;
            }
            
            updateShopStats(shopId);
        }
        
        // Update all shop checkboxes
        function updateAllShopCheckboxes() {
            const shopCheckboxes = document.querySelectorAll('.shop-checkbox');
            shopCheckboxes.forEach(shopCheckbox => {
                const shopId = shopCheckbox.getAttribute('data-shop-id');
                updateShopCheckbox(shopId);
            });
        }
        
        // Update shop statistics display
        function updateShopStats(shopId) {
            const shopItems = document.querySelectorAll(`input[data-shop-id="${shopId}"].item-checkbox`);
            const checkedShopItems = document.querySelectorAll(`input[data-shop-id="${shopId}"].item-checkbox:checked`);
            
            // Find and update shop stats element
            const shopStatsElement = document.querySelector(`.shop-group input[data-shop-id="${shopId}"].shop-checkbox`)
                ?.closest('.shop-header')
                ?.querySelector('.shop-stats span');
            
            if (shopStatsElement) {
                shopStatsElement.textContent = `${checkedShopItems.length}/${shopItems.length} sản phẩm`;
            }
        }
        
        // Format number with thousand separators
        function formatNumber(num) {
            return new Intl.NumberFormat('vi-VN').format(num);
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateSelectAllCheckbox();
            updateAllShopCheckboxes();
            
            // Restore checkbox states after reload (for shop voucher)
            const savedSelectedItems = sessionStorage.getItem('selectedItems');
            if (savedSelectedItems) {
                const selectedItemIds = JSON.parse(savedSelectedItems);
                console.log('Restoring selected items:', selectedItemIds);
                
                let syncCount = 0;
                const totalItems = selectedItemIds.length;
                
                // Force sync ALL items in sessionStorage with backend (regardless of UI state)
                selectedItemIds.forEach((itemId, index) => {
                    const checkbox = document.querySelector(`.item-checkbox[data-product-id="${itemId}"]`);
                    if (checkbox) {
                        // Always sync with backend to ensure state consistency
                        fetch('/cart/update-selected', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: `productId=${itemId}&selected=true`
                        })
                        .then(response => response.json())
                        .then(data => {
                            syncCount++;
                            if (data.success) {
                                checkbox.checked = true;
                                // Only update totals on the last sync to avoid multiple updates
                                if (syncCount === totalItems) {
                                    updateTotals(data.selectedTotal, data.selectedCount);
                                    updateSelectAllCheckbox();
                                    updateAllShopCheckboxes();
                                    console.log('All items synced successfully');
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error restoring item selection:', error);
                            syncCount++;
                        });
                    }
                });
                
                sessionStorage.removeItem('selectedItems'); // Clean up
            } else {
                // No sessionStorage, but still need to sync current UI state with backend
                const currentCheckedItems = document.querySelectorAll('.item-checkbox:checked');
                console.log('Syncing current checked items with backend:', currentCheckedItems.length);
                
                if (currentCheckedItems.length > 0) {
                    let syncCount = 0;
                    const totalItems = currentCheckedItems.length;
                    
                    currentCheckedItems.forEach(checkbox => {
                        const itemId = checkbox.getAttribute('data-product-id');
                        if (itemId) {
                            fetch('/cart/update-selected', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                },
                                body: `productId=${itemId}&selected=true`
                            })
                            .then(response => response.json())
                            .then(data => {
                                syncCount++;
                                if (data.success && syncCount === totalItems) {
                                    updateTotals(data.selectedTotal, data.selectedCount);
                                    updateSelectAllCheckbox();
                                    updateAllShopCheckboxes();
                                    console.log('Current UI state synced with backend');
                                }
                            })
                            .catch(error => {
                                console.error('Error syncing current state:', error);
                                syncCount++;
                            });
                        }
                    });
                }
            }
            
            // Initial state of checkout button
            const selectedCountElement = document.getElementById('selected-count');
            const selectedCount = selectedCountElement ? parseInt(selectedCountElement.textContent) || 0 : 0;
            updateTotals(0, selectedCount); // Use 0 for total as we'll get it from server
        });
        
        // ===== ONE XU FUNCTIONALITY =====
        
        // Validate xu input
        function validateXuInput() {
            const xuInput = document.getElementById('xuInput');
            const maxXu = parseInt(xuInput.getAttribute('max')) || 0;
            const currentValue = parseInt(xuInput.value) || 0;
            
            if (currentValue > maxXu) {
                xuInput.value = maxXu;
                alert(`Bạn chỉ có ${maxXu} xu trong tài khoản!`);
            }
            
            if (currentValue < 0) {
                xuInput.value = 0;
            }
        }
        
        // Apply xu discount
        function applyXuDiscount() {
            const xuInput = document.getElementById('xuInput');
            const xuAmount = parseInt(xuInput.value) || 0;
            
            if (xuAmount === 0) {
                // Remove xu discount
                removeXuDiscount();
                return;
            }
            
            // Send to backend to apply xu discount
            fetch('/cart/apply-xu', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `xuAmount=${xuAmount}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update xu discount display
                    document.getElementById('xuDiscountDisplay').textContent = `-${formatNumber(data.xuDiscount)}đ`;
                    
                    // Update footer totals
                    updateFooterTotals();
                } else {
                    alert(data.message || 'Có lỗi xảy ra khi áp dụng xu');
                    xuInput.value = 0;
                    document.getElementById('xuDiscountDisplay').textContent = '-0đ';
                }
            })
            .catch(error => {
                console.error('Error applying xu:', error);
                alert('Có lỗi xảy ra khi áp dụng xu');
                xuInput.value = 0;
                document.getElementById('xuDiscountDisplay').textContent = '-0đ';
            });
        }
        
        // Remove xu discount
        function removeXuDiscount() {
            fetch('/cart/remove-xu', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('xuInput').value = 0;
                    document.getElementById('xuDiscountDisplay').textContent = '-0đ';
                    updateFooterTotals();
                }
            })
            .catch(error => {
                console.error('Error removing xu:', error);
            });
        }
        
        
        // Proceed to checkout function
        function proceedToCheckout() {
            // Check directly from checkboxes instead of DOM elements
            const checkedItems = document.querySelectorAll('.item-checkbox:checked');
            const selectedCount = checkedItems.length;
            
            if (selectedCount === 0) {
                alert('Vui lòng chọn ít nhất một sản phẩm để thanh toán!');
                return;
            }
            window.location.href = '/checkout';
        }
        
        // Sync select all checkboxes
        function syncSelectAllCheckboxes() {
            const selectAllTop = document.getElementById('selectAll');
            const selectAllBottom = document.getElementById('selectAllBottom');
            
            if (selectAllTop && selectAllBottom) {
                selectAllBottom.checked = selectAllTop.checked;
                selectAllBottom.indeterminate = selectAllTop.indeterminate;
            }
        }
        
        // Override original updateSelectAllCheckbox to sync both
        const originalUpdateSelectAllCheckbox = updateSelectAllCheckbox;
        updateSelectAllCheckbox = function() {
            originalUpdateSelectAllCheckbox();
            syncSelectAllCheckboxes();
        };
        
        // ===== VOUCHER FUNCTIONALITY =====
        
        // Open voucher modal
        function openVoucherModal() {
            $('#voucherModal').modal('show');
            loadAvailableVouchers();
        }
        
        // Simple initialization for voucher modal
        document.addEventListener('DOMContentLoaded', function() {
            // No more tabs, just simple initialization
        });

        // ===== SHOP VOUCHER FUNCTIONALITY =====
        function openShopVoucherModal(shopId) {
            if (!shopId) {
                alert('Không thể xác định shop ID');
                return;
            }
            
            // Show modal
            if (typeof $ !== 'undefined') {
                $('#shopVoucherModal').modal('show');
            } else {
                const modalElement = document.getElementById('shopVoucherModal');
                if (modalElement) {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                } else {
                    alert('Không thể mở modal voucher shop');
                    return;
                }
            }
            
            loadShopVouchers(shopId);
        }

        function loadShopVouchers(shopId) {
            // Show loading state
            document.getElementById('shop-voucher-loading').style.display = 'block';
            document.getElementById('shop-voucher-list').style.display = 'none';
            document.getElementById('shop-no-vouchers').style.display = 'none';

            fetch(`/cart/shop-promotions/${shopId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('shop-voucher-loading').style.display = 'none';

                    if (data.success && data.promotions && data.promotions.length > 0) {
                        // Update modal title with shop name if available
                        const titleElement = document.getElementById('shop-voucher-title');
                        if (titleElement && data.shopName) {
                            titleElement.textContent = `Voucher của ${data.shopName}`;
                        }
                        
                        displayShopVouchers(data.promotions);
                        document.getElementById('shop-voucher-list').style.display = 'block';
                    } else {
                        document.getElementById('shop-no-vouchers').style.display = 'block';
                    }
                })
                .catch(error => {
                    document.getElementById('shop-voucher-loading').style.display = 'none';
                    document.getElementById('shop-no-vouchers').style.display = 'block';
                });
        }

        function displayShopVouchers(promotions) {
            const voucherList = document.getElementById('shop-voucher-list');
            if (!voucherList) {
                return;
            }

            voucherList.innerHTML = '';

            promotions.forEach((promotion) => {
                try {
                    const voucherCard = createShopVoucherCard(promotion);
                    voucherList.appendChild(voucherCard);
                } catch (error) {
                    // Skip invalid voucher cards
                }
            });
        }

        function createShopVoucherCard(promotion) {
            const card = document.createElement('div');
            card.style.cssText = 'border: 1px solid #f1f1f1; border-radius: 8px; margin-bottom: 12px; padding: 16px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';

            try {
                const discountText = getDiscountText(promotion);
                const expiryDate = new Date(promotion.endDate).toLocaleDateString('vi-VN');
                const isActive = promotion.isActive;
                const isExpired = new Date(promotion.endDate) < new Date();

                let bgColor = isActive && !isExpired ? '#4db3f1' : '#999';
                let voucherDisplay = '';

                if (promotion.promotionType === 'FREE_SHIPPING') {
                    voucherDisplay = '<div style="font-size: 18px; font-weight: bold; margin: 2px 0;">FREE</div><div style="font-size: 18px; font-weight: bold;">SHIP</div>';
                } else {
                    voucherDisplay = '<div style="font-size: 18px; font-weight: bold; margin: 2px 0;">GIẢM</div><div style="font-size: 18px; font-weight: bold;">GIÁ</div>';
                }

                const maxDiscount = promotion.maximumDiscountAmount || promotion.discountValue || 0;
                const minOrder = promotion.minimumOrderAmount || 0;
                const usedPercent = Math.round(((promotion.usedCount || 0) / (promotion.usageLimit || 1)) * 100);

                const statusText = !isActive ? 'HẾT HIỆU LỰC' : isExpired ? 'HẾT HẠN' : 'KHẢ DỤNG';
                const statusColor = !isActive || isExpired ? '#ff4757' : '#2ed573';
                const canApply = isActive && !isExpired;

                card.innerHTML =
                    '<div style="display: flex; align-items: center; gap: 16px;">' +
                        '<div style="background: ' + bgColor + '; color: white; padding: 12px; border-radius: 8px; min-width: 100px; text-align: center;">' +
                            '<div style="font-size: 12px; opacity: 0.9;">SHOP</div>' +
                            voucherDisplay +
                            '<div style="font-size: 11px; opacity: 0.9;">Tối đa ' + formatNumber(maxDiscount) + 'đ</div>' +
                        '</div>' +
                        '<div style="flex: 1;">' +
                            '<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">' +
                                '<h6 style="margin: 0; font-size: 16px; color: #333; font-weight: 600;">' + (promotion.promotionName || 'Voucher Shop') + '</h6>' +
                                '<span style="background: ' + statusColor + '; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;">' + statusText + '</span>' +
                            '</div>' +
                            '<div style="font-size: 14px; color: #666; margin-bottom: 4px;">' + discountText + '</div>' +
                            '<div style="font-size: 13px; color: #333; margin-bottom: 6px;">Mã: <strong>' + (promotion.promotionCode || 'N/A') + '</strong></div>' +
                            '<div style="font-size: 13px; color: #333; margin-bottom: 6px;">Đơn Tối Thiểu: ₫' + formatNumber(minOrder) + '</div>' +
                            '<div style="font-size: 12px; color: #999; margin-bottom: 8px;">' +
                                'Đã sử dụng ' + usedPercent + '% • HSD: ' + expiryDate +
                            '</div>' +
                            (promotion.description ? '<div style="font-size: 12px; color: #666; margin-bottom: 8px; font-style: italic;">' + promotion.description + '</div>' : '') +
                            '<div style="text-align: right;">' +
                                (canApply ? 
                                    '<button onclick="applyShopVoucher(\'' + (promotion.promotionCode || '') + '\')" style="background: #33a3cc; color: white; border: none; padding: 6px 16px; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: 500;">ÁP MÃ</button>' :
                                    '<button disabled style="background: #ccc; color: #999; border: none; padding: 6px 16px; border-radius: 4px; font-size: 12px; cursor: not-allowed; font-weight: 500;">KHÔNG KHẢ DỤNG</button>'
                                ) +
                            '</div>' +
                        '</div>' +
                    '</div>';

                return card;

            } catch (error) {
                card.innerHTML = '<div style="padding: 10px; color: red;">Lỗi hiển thị voucher: ' + (promotion.promotionName || 'Unknown') + '</div>';
                return card;
            }
        }

        // Apply shop voucher from shop modal
        function applyShopVoucher(promotionCode) {
            if (!promotionCode) {
                alert('Mã voucher không hợp lệ');
                return;
            }

            // Close shop modal first
            if (typeof $ !== 'undefined') {
                $('#shopVoucherModal').modal('hide');
            } else {
                const modalElement = document.getElementById('shopVoucherModal');
                if (modalElement) {
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) {
                        modal.hide();
                    }
                    // Remove focus from any focused elements in modal to fix accessibility warning
                    const focusedElement = modalElement.querySelector(':focus');
                    if (focusedElement) {
                        focusedElement.blur();
                    }
                }
            }

            // Apply shop voucher via dedicated API
            fetch('/cart/apply-shop-voucher', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'promotionCode=' + encodeURIComponent(promotionCode)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update shop voucher section specifically
                    updateCartWithShopVoucher(data);
                    
                    // Also update footer with dual voucher system
                    updateFooterTotals(data);
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error applying shop voucher:', error);
                alert('Có lỗi xảy ra khi áp dụng voucher');
            });
        }
        
        // Load available vouchers
        function loadAvailableVouchers() {
            document.getElementById('voucher-loading').style.display = 'block';
            document.getElementById('voucher-list').style.display = 'none';
            document.getElementById('no-vouchers').style.display = 'none';
            
            fetch('/cart/promotions')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('voucher-loading').style.display = 'none';

                    if (data.success && data.promotions && data.promotions.length > 0) {
                        displayVouchers(data.promotions);
                        document.getElementById('voucher-list').style.display = 'block';
                    } else {
                        document.getElementById('no-vouchers').style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error loading vouchers:', error);
                    document.getElementById('voucher-loading').style.display = 'none';
                    document.getElementById('no-vouchers').style.display = 'block';
                });
        }
        
        // Display vouchers in list
        function displayVouchers(promotions) {
            const voucherList = document.getElementById('voucher-list');
            if (!voucherList) {
                console.error('voucher-list element not found!');
                return;
            }

            voucherList.innerHTML = '';

            promotions.forEach((promotion, index) => {
                try {
                    const voucherCard = createVoucherCard(promotion);
                    voucherList.appendChild(voucherCard);
                } catch (error) {
                    console.error(`Error creating card ${index}:`, error);
                }
            });
        }
        
        // Create voucher card element (Simple Shopee style)
        function createVoucherCard(promotion) {
            
            const card = document.createElement('div');
            card.style.cssText = 'border: 1px solid #f1f1f1; border-radius: 4px; margin-bottom: 8px; padding: 12px; cursor: pointer; transition: all 0.2s ease;';
            
            try {
                const discountText = getDiscountText(promotion);
                const expiryDate = new Date(promotion.endDate).toLocaleDateString('vi-VN');
                
                // Simple background color based on promotion type
                let bgColor = '#4db3f1';
                let labelText = 'OneShop';
                let voucherDisplay = '';
                
                if (promotion.promotionType === 'FREE_SHIPPING') {
                    voucherDisplay = '<div style="font-size: 16px; font-weight: bold; margin: 2px 0;">FREE</div><div style="font-size: 16px; font-weight: bold;">SHIP</div>';
                } else {
                    voucherDisplay = '<div style="font-size: 16px; font-weight: bold; margin: 2px 0;">GIẢM</div><div style="font-size: 16px; font-weight: bold;">GIÁ</div>';
                }
                
                const maxDiscount = promotion.maximumDiscountAmount || promotion.discountValue || 0;
                const minOrder = promotion.minimumOrderAmount || 0;
                const usedPercent = Math.round(((promotion.usedCount || 0) / (promotion.usageLimit || 1)) * 100);
                
                card.innerHTML = 
                    '<div style="display: flex; align-items: center; gap: 12px;">' +
                        '<input type="radio" name="selectedVoucher" value="' + (promotion.promotionCode || '') + '" style="accent-color: #33a3cc;">' +
                        '<div style="background: ' + bgColor + '; color: white; padding: 8px; border-radius: 4px; min-width: 80px; text-align: center;">' +
                            '<div style="font-size: 11px; opacity: 0.9;">' + labelText + '</div>' +
                            voucherDisplay +
                            '<div style="font-size: 10px; opacity: 0.9;">Giảm tối đa ' + formatNumber(maxDiscount) + 'đ</div>' +
                        '</div>' +
                        '<div style="flex: 1;">' +
                            '<div style="font-size: 14px; color: #333; margin-bottom: 4px;">' + discountText + '</div>' +
                            '<div style="font-size: 13px; color: #333; margin-bottom: 4px;">Đơn Tối Thiểu ₫' + formatNumber(minOrder) + '</div>' +
                            '<div style="font-size: 12px; color: #999;">' +
                                'Đã dùng ' + usedPercent + '%. HSD: ' + expiryDate +
                                '<a href="#" style="color: #05a; text-decoration: none; margin-left: 8px;">Điều Kiện</a>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
                
                // Add click event to select radio
                card.addEventListener('click', function() {
                    const radio = card.querySelector('input[type="radio"]');
                    radio.checked = true;
                    
                    // Update visual selection
                    document.querySelectorAll('#voucher-list > div').forEach(c => {
                        c.style.borderColor = '#f1f1f1';
                        c.style.backgroundColor = 'white';
                    });
                    
                    this.style.borderColor = '#33a3cc';
                    this.style.backgroundColor = '#f0f9fc';
                });
                
                return card;
                
            } catch (error) {
                console.error('Error in createVoucherCard:', error);
                // Return simple fallback card
                card.innerHTML = '<div style="padding: 10px; color: red;">Lỗi hiển thị voucher: ' + (promotion.promotionName || 'Unknown') + '</div>';
                return card;
            }
        }
        
        // Get discount text based on promotion type
        function getDiscountText(promotion) {
            try {
                switch (promotion.promotionType) {
                    case 'PERCENTAGE':
                        return 'Giảm tối đa ' + formatNumber(promotion.maximumDiscountAmount || 0) + 'đ';
                    case 'FIXED_AMOUNT':
                        return 'Giảm ' + formatNumber(promotion.discountValue || 0) + 'đ';
                    case 'FREE_SHIPPING':
                        return 'Giảm tối đa ' + formatNumber(promotion.maximumDiscountAmount || 50000) + 'đ';
                    case 'BUY_X_GET_Y':
                        return 'Mua X tặng Y';
                    default:
                        return 'Khuyến mãi đặc biệt';
                }
            } catch (error) {
                console.error('Error in getDiscountText:', error);
                return 'Khuyến mãi';
            }
        }
        
        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }
        
        // Apply voucher
        function applyVoucher(promotionCode, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            // Show loading
            const button = event ? event.target : null;
            const originalText = button ? button.textContent : '';
            if (button) {
                button.textContent = 'Đang áp dụng...';
                button.disabled = true;
            }
            
            fetch('/cart/apply-promotion', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `promotionCode=${encodeURIComponent(promotionCode)}`
            })
            .then(response => response.json())
            .then(data => {
                if (button) {
                    button.textContent = originalText;
                    button.disabled = false;
                }
                
                if (data.success) {
                    $('#voucherModal').modal('hide');
                    // Update cart totals display without full reload
                    updateCartWithVoucher(data);
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                if (button) {
                    button.textContent = originalText;
                    button.disabled = false;
                }
                console.error('Error applying voucher:', error);
                alert('Có lỗi xảy ra khi áp dụng voucher');
            });
        }
        
        // Apply manual voucher
        function applyManualVoucher() {
            const codeInput = document.getElementById('voucher-input');
            const code = codeInput.value.trim();
            
            if (!code) {
                alert('Vui lòng nhập mã voucher');
                return;
            }
            
            applyVoucher(code);
        }
        
        // Apply selected voucher from radio buttons
        function applySelectedVoucher() {
            const selectedRadio = document.querySelector('input[name="selectedVoucher"]:checked');
            if (selectedRadio) {
                const code = selectedRadio.value;
                applyVoucher(code);
            } else {
                alert('Vui lòng chọn một voucher');
            }
        }
        
        // Update cart with shop voucher information
        function updateCartWithShopVoucher(voucherData) {
            // Update shop voucher display in the shop section
            const shopVoucherElements = document.querySelectorAll('[onclick*="openShopVoucherModal"]');
            
            shopVoucherElements.forEach(element => {
                if (element.textContent.includes('Xem thêm voucher')) {
                    // Update to show applied voucher
                    element.innerHTML = `
                        <span style="background: #e3f2fd; padding: 2px 6px; border-radius: 3px; font-size: 12px; color: #1976d2; font-weight: 500;">${voucherData.promotion.promotionCode}</span>
                        <span style="color: #1976d2; font-size: 12px; font-weight: 500; margin-left: 4px;">-${formatNumber(voucherData.discountAmount)}đ</span>
                        <button onclick="removeShopVoucher()" style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 11px; padding: 1px 3px; margin-left: 6px;" title="Bỏ shop voucher">
                            ✕
                        </button>
                    `;
                    element.onclick = null; // Remove click handler
                }
            });
            
            // Save checkbox states 
            const selectedItems = [];
            document.querySelectorAll('.item-checkbox:checked').forEach(checkbox => {
                selectedItems.push(checkbox.value);
            });
            sessionStorage.setItem('selectedItems', JSON.stringify(selectedItems));
        }
        
        // Update cart with voucher information
        function updateCartWithVoucher(voucherData) {
            // Update all "Chọn hoặc nhập mã" text to show applied voucher
            const voucherSelectors = document.querySelectorAll('[onclick="openVoucherModal()"]');
            
            voucherSelectors.forEach(element => {
                if (element.textContent.includes('Chọn hoặc nhập mã')) {
                    // Replace with voucher info
                    element.innerHTML = `
                        <span style="background: #e8f5e8; padding: 2px 6px; border-radius: 3px; font-size: 12px; color: #28a745; font-weight: 500;">${voucherData.promotion.promotionCode}</span>
                        <span style="color: #28a745; font-size: 12px; font-weight: 500; margin-left: 4px;">-${formatNumber(voucherData.discountAmount)}đ</span>
                        <button onclick="removeAppliedVoucher()" style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 11px; padding: 1px 3px; margin-left: 6px;" title="Bỏ voucher">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    element.style.cursor = 'default';
                    element.onclick = null; // Remove click handler
                }
            });
            
            // Update totals in footer
            updateFooterTotals(voucherData);
        }
        
        // Update footer totals with voucher - supports dual voucher system
        function updateFooterTotals(voucherData = null) {
            const footerContainer = document.querySelector('.cart-footer-summary');
            if (footerContainer) {
                // Add small delay to ensure session is updated
                setTimeout(() => {
                    // Fetch current session voucher data to display both vouchers
                    fetch('/cart/voucher-status')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(sessionData => {
                        console.log('Session data from API:', sessionData);
                        const selectedItems = document.querySelectorAll('.item-checkbox:checked').length;
                        
                        // Use backend data for original amount calculation
                        let original = 0;
                        if (sessionData.selectedPrice) {
                            original = sessionData.selectedPrice;
                        } else if (voucherData && voucherData.originalAmount) {
                            original = voucherData.originalAmount;
                        } else {
                            // Fallback: calculate from DOM
                        document.querySelectorAll('.item-checkbox:checked').forEach(checkbox => {
                            const productRow = checkbox.closest('.product-item');
                            if (productRow) {
                                const rightColumns = productRow.querySelector('div[style*="display: flex; gap: 20px"]');
                                if (rightColumns) {
                                    // Find the div that contains total price (has color: #33a3cc and font-size: 16px)
                                    const allDivs = rightColumns.querySelectorAll('div');
                                    allDivs.forEach(div => {
                                        const style = div.getAttribute('style');
                                        if (style && style.includes('color: #33a3cc') && style.includes('font-size: 16px')) {
                                            const priceText = div.textContent.replace(/[^\d]/g, '');
                                            const price = parseInt(priceText) || 0;
                                            if (price > 0) {
                                                original += price;
                                            }
                                        }
                                    });
                                }
                            }
                        });
                        }
                        
                        let footerHTML = `<div style="font-size: 14px; color: #333;">`;
                        footerHTML += `<div style="margin-bottom: 4px;">`;
                        footerHTML += `<span>Tạm tính (${selectedItems} Sản phẩm): </span>`;
                        footerHTML += `<span style="color: #666; font-size: 16px;">₫${formatNumber(original)}</span></div>`;
                        
                        let totalDiscount = 0;
                        
                        // OneShop voucher
                        if (sessionData.oneVoucherDiscount && sessionData.oneVoucherDiscount > 0) {
                            footerHTML += `<div style="margin-bottom: 4px;">`;
                            footerHTML += `<span>OneShop voucher: </span>`;
                            footerHTML += `<span style="color: #1976d2; font-size: 16px;">-₫${formatNumber(sessionData.oneVoucherDiscount)}</span></div>`;
                            totalDiscount += sessionData.oneVoucherDiscount;
                        }
                        
                        // Shop voucher  
                        if (sessionData.shopVoucherDiscount && sessionData.shopVoucherDiscount > 0) {
                            footerHTML += `<div style="margin-bottom: 4px;">`;
                            footerHTML += `<span>Shop voucher: </span>`;
                            footerHTML += `<span style="color: #1976d2; font-size: 16px;">-₫${formatNumber(sessionData.shopVoucherDiscount)}</span></div>`;
                            totalDiscount += sessionData.shopVoucherDiscount;
                        }
                        
                        // One Xu discount
                        if (sessionData.xuDiscount && sessionData.xuDiscount > 0) {
                            footerHTML += `<div style="margin-bottom: 4px;">`;
                            footerHTML += `<span>One Xu: </span>`;
                            footerHTML += `<span style="color: #ff9800; font-size: 16px;">-₫${formatNumber(sessionData.xuDiscount)}</span></div>`;
                            totalDiscount += sessionData.xuDiscount;
                        }
                        
                        const finalTotal = original - totalDiscount;
                        
                        footerHTML += `<div style="border-top: 1px solid #e5e5e5; padding-top: 4px;">`;
                        footerHTML += `<span>Tổng thanh toán: </span>`;
                        footerHTML += `<span style="color: #33a3cc; font-size: 20px; font-weight: 500;">₫${formatNumber(finalTotal)}</span></div>`;
                        footerHTML += `</div>`;
                        
                        footerContainer.innerHTML = footerHTML;
                    })
                    .catch(error => {
                        console.error('Error fetching voucher status:', error);
                        // Fallback to single voucher display
                        const selectedItems = document.querySelectorAll('.item-checkbox:checked').length;
                        const newTotal = voucherData.finalAmount;
                        const discount = voucherData.discountAmount;
                        const original = voucherData.originalAmount;
                        
                        footerContainer.innerHTML = `
                            <div style="font-size: 14px; color: #333;">
                                <div style="margin-bottom: 4px;">
                                    <span>Tạm tính (${selectedItems} Sản phẩm): </span>
                                    <span style="color: #666; font-size: 16px;">₫${formatNumber(original)}</span>
                                </div>
                                <div style="margin-bottom: 4px;">
                                    <span>Giảm giá voucher: </span>
                                    <span style="color: #1976d2; font-size: 16px;">-₫${formatNumber(discount)}</span>
                                </div>
                                <div style="border-top: 1px solid #e5e5e5; padding-top: 4px;">
                                    <span>Tổng thanh toán: </span>
                                    <span style="color: #33a3cc; font-size: 20px; font-weight: 500;">₫${formatNumber(newTotal)}</span>
                                </div>
                            </div>
                        `;
                    });
                }, 100); // 100ms delay
            }
        }
        
        
        // Remove applied voucher
        function removeAppliedVoucher() {
            if (confirm('Bạn có chắc muốn bỏ voucher này không?')) {
                fetch('/cart/remove-promotion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error removing voucher:', error);
                    alert('Có lỗi xảy ra khi bỏ voucher');
                });
            }
        }
        
        // Remove OneShop voucher
        function removeOneVoucher() {
            if (confirm('Bạn có chắc muốn bỏ OneShop voucher này không?')) {
                fetch('/cart/remove-promotion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'type=one'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error removing OneShop voucher:', error);
                    alert('Có lỗi xảy ra khi bỏ voucher');
                });
            }
        }
        
        // Remove Shop voucher
        function removeShopVoucher() {
            if (confirm('Bạn có chắc muốn bỏ shop voucher này không?')) {
                fetch('/cart/remove-promotion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'type=shop'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error removing shop voucher:', error);
                    alert('Có lỗi xảy ra khi bỏ voucher');
                });
            }
        }
    </script>
</body>
</html>