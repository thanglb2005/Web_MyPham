<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kho voucher - OneShop</title>
    <link rel="stylesheet" href="/fonts/flaticon/flaticon.css" />
    <link rel="stylesheet" href="/fonts/icofont/icofont.min.css" />
    <link rel="stylesheet" href="/fonts/fontawesome/fontawesome.min.css" />
    <link rel="stylesheet" href="/vendor/bootstrap/bootstrap.min.css" />
    <link rel="stylesheet" th:href="@{/css/main.css}" />
    <link rel="stylesheet" th:href="@{/css/user-vouchers.css}" />
  </head>
  <body>
    <header th:replace="~{/web/fragments/header :: header}"></header>

    <main class="voucher-page">
      <section class="voucher-hero container">
        <div class="hero-text">
          <h1>Kho voucher của bạn</h1>
          <p th:text="${totalVoucherCount > 0} ? 'Chọn voucher phù hợp để tiết kiệm thêm khi thanh toán.' : 'Bạn chưa có voucher nào khả dụng. Ghé thăm các shop để săn ưu đãi nhé!'">
            Mô tả ngắn
          </p>
        </div>
        <div class="hero-stats">
          <div class="stat-card">
            <div class="stat-label">Voucher khả dụng</div>
            <div class="stat-value" th:text="${totalVoucherCount}">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Shop đang ưu đãi</div>
            <div class="stat-value" th:text="${shopVoucherCount}">0</div>
          </div>
          <div class="stat-card highlight" th:classappend="${expiringSoonCount > 0} ? ' pulse'">
            <div class="stat-label">Sắp hết hạn</div>
            <div class="stat-value" th:text="${expiringSoonCount}">0</div>
          </div>
        </div>
      </section>

      <section class="voucher-toolbar container" th:if="${totalVoucherCount > 0}">
        <div class="filter-buttons">
          <button class="filter-btn active" data-filter="all">Tất cả</button>
          <button class="filter-btn" data-filter="expiring">
            Sắp hết hạn
            <span class="badge" th:text="${expiringSoonCount}">0</span>
          </button>
          <button class="filter-btn" data-filter="usable">Chưa sử dụng hết</button>
        </div>
        <div class="actions">
          <div class="search-box">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input
              id="voucher-search"
              type="search"
              placeholder="Tìm theo shop hoặc mã voucher"
              autocomplete="off"
            />
          </div>
        </div>
      </section>

      <section class="voucher-content container">
        <div class="empty-state" th:if="${voucherGroups == null || voucherGroups.isEmpty()}">
          <i class="fa-solid fa-ticket-simple empty-icon"></i>
          <h2>Hiện chưa có voucher nào</h2>
          <p>Giỏ hàng của bạn sẽ tiết kiệm hơn khi sưu tầm voucher từ các shop yêu thích.</p>
          <a class="btn btn-primary" href="/" role="button">Khám phá sản phẩm</a>
        </div>

        <div
          class="shop-voucher-grid"
          th:if="${voucherGroups != null and !voucherGroups.isEmpty()}"
        >
          <article
            class="shop-voucher-card"
            th:each="group : ${voucherGroups}"
            th:attr="data-expiring=${group.expiringSoonCount > 0}, data-shop=${group.shopName}"
          >
            <div class="shop-card-header">
              <div class="shop-logo">
                <img
                  th:if="${group.shopLogo != null}"
                  th:src="@{'/loadImage?imageName=' + ${group.shopLogo}}"
                  alt="Shop logo"
                  onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                />
                <div class="shop-avatar-fallback" th:text="${#strings.substring(group.shopName,0,1)}"></div>
              </div>
              <div class="shop-meta">
                <div class="shop-name" th:text="${group.shopName}">Tên shop</div>
                <div class="shop-location" th:text="${group.location}">Địa điểm</div>
                <div class="shop-tags">
                  <span class="tag">Voucher: <span th:text="${group.vouchers.size()}">0</span></span>
                  <span class="tag success" th:if="${group.allowCod}">COD</span>
                  <span class="tag warning" th:if="${group.expiringSoonCount > 0}">
                    <i class="fa-solid fa-hourglass-half"></i>
                    <span th:text="${group.expiringSoonCount} + ' sắp hết hạn'">0 sắp hết hạn</span>
                  </span>
                </div>
              </div>
              <a class="shop-link" th:href="@{${group.shopUrl}}" target="_blank">
                Xem shop
              </a>
            </div>

            <div class="voucher-list">
              <div
                class="voucher-item"
                th:each="voucher : ${group.vouchers}"
                th:attr="data-expiring=${voucher.expiringSoon}, data-remaining=${voucher.remainingUses}"
              >
                <div class="voucher-value">
                  <span class="value-text" th:text="${voucher.discountLabel}">-20%</span>
                  <span class="voucher-type" th:text="${voucher.type.name()}">PERCENTAGE</span>
                </div>
                <div class="voucher-info">
                  <div class="voucher-title" th:text="${voucher.promotionName}">
                    Tiêu đề voucher
                  </div>
                  <div class="voucher-meta">
                    <span class="voucher-code">
                      Mã:
                      <strong th:text="${voucher.promotionCode}">VOUCHER2025</strong>
                    </span>
                    <button
                      class="copy-btn"
                      type="button"
                      th:attr="data-code=${voucher.promotionCode}"
                    >
                      Sao chép
                    </button>
                  </div>
                  <ul class="voucher-conditions">
                    <li th:text="${voucher.minimumOrderLabel}">Đơn tối thiểu</li>
                    <li th:text="${voucher.maximumDiscountLabel}">Giảm tối đa</li>
                    <li>
                      Hạn dùng:
                      <span th:text="${voucher.expiryLabel}">31/12/2025 23:59</span>
                      <span
                        class="badge danger"
                        th:if="${voucher.expiringSoon}"
                        th:text="${voucher.daysRemaining == 0 ? 'Hết hạn hôm nay' : 'Còn ' + voucher.daysRemaining + ' ngày'}"
                      >
                        Còn 2 ngày
                      </span>
                    </li>
                    <li th:if="${voucher.remainingUses != null}">
                      Lượt sử dụng còn lại:
                      <span th:text="${voucher.remainingUses}">3</span>
                    </li>
                  </ul>
                </div>
                <div class="voucher-actions">
                  <a
                    th:href="@{${group.shopUrl}}"
                    class="btn btn-outline-primary"
                    target="_blank"
                    >Áp dụng</a
                  >
                </div>
              </div>
            </div>
          </article>
        </div>
      </section>
    </main>

    <footer th:replace="~{/web/fragments/footer :: footer}"></footer>
    <script src="/vendor/bootstrap/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/user-vouchers.js}"></script>
  </body>
</html>
