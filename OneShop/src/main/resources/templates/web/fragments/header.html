<!DOCTYPE html>

<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <title></title>

    <link rel="stylesheet" href="/vendor/bootstrap/bootstrap.min.css" />

    <link rel="stylesheet" href="/fonts/fontawesome/fontawesome.min.css" />

    <script src="/vendor/bootstrap/jquery-1.12.4.min.js"></script>

    <script src="/vendor/bootstrap/bootstrap.min.js"></script>

    <script src="/assets/js/plugin/sweetalert/sweetalert.min.js"></script>

    <style>


      /* Improve visibility of cart count badge */

      .header-part .header-widget {

        position: relative;

      }

      /* Ensure dropdown works properly */

      .navbar-item.dropdown .dropdown-position-list {

        display: none;

      }

      .navbar-item.dropdown:hover .dropdown-position-list {

        display: block;

      }

      .header-part .header-widget .cart-count {

        position: absolute;

        top: -6px;

        right: -8px;

        background: #0db1fd; /* theme primary blue */

        color: #ffffff !important; /* white text for contrast */

        border: 2px solid #fff;

        border-radius: 999px;

        min-width: 20px;

        height: 18px;

        padding: 0 5px;

        line-height: 16px;

        font-size: 8px;

        font-weight: 700;

        text-align: center;

        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);

        transform-origin: center;

      }

      @keyframes cart-bump {

        0% {

          transform: scale(1);

        }

        30% {

          transform: scale(1.15);

        }

        100% {

          transform: scale(1);

        }

      }

      .header-part .header-widget .cart-count.badge-bump {

        animation: cart-bump 0.25s ease-out;

      }

      @media (min-width: 992px) {

        .header-part .header-widget .cart-count {

          top: -8px;

          right: -10px;

          min-width: 20px;

          height: 20px;

          line-height: 18px;

          font-size: 11px;

        }

      }

      /* ====== Chatbot AI message formatting (ChatGPT style) ====== */
      .oneshop-chatbot-popup .message-bubble.message-bubble-ai {
        white-space: pre-line;       /* Giữ \n và xuống dòng như nội dung gốc */
        line-height: 1.65;           /* Giãn dòng nhẹ cho dễ đọc */
        font-size: 14px;
        color: #1f2937;
        background: #ffffff;
        padding: 12px 16px;
        border-radius: 14px;
        border: 1px solid #e5e7eb;
        margin: 8px 0;
      }

      /* Căn lề cho danh sách (bullet hoặc numbered list) */
      .oneshop-chatbot-popup .message-bubble.message-bubble-ai ul,
      .oneshop-chatbot-popup .message-bubble.message-bubble-ai ol {
        margin: 8px 0 8px 22px;
        padding-left: 0;
      }

      /* Kiểu bullet (•) hoặc numbered (1.) căn đều */
      .oneshop-chatbot-popup .message-bubble.message-bubble-ai li {
        margin-bottom: 6px;
      }

      /* In đậm, in nghiêng giữ màu gốc */
      .oneshop-chatbot-popup .message-bubble.message-bubble-ai strong {
        color: #1e3a8a;
        font-weight: 600;
      }
      .oneshop-chatbot-popup .message-bubble.message-bubble-ai em {
        font-style: italic;
      }

      /* Giữa các đoạn cách nhẹ (như ChatGPT) */
      .oneshop-chatbot-popup .message-bubble.message-bubble-ai p {
        margin: 8px 0;
      }

    </style>

  </head>

  <body>

    <th:block th:fragment="header">

      <div class="backdrop"></div>

      <a class="backtop fas fa-arrow-up" href="#"></a>

      <th:block th:if="${isCartPage} == null or ${isCartPage} == false">

        <header class="header-part">

          <div class="container">

            <div class="header-content">

              <a th:href="@{/}" class="header-logo">

                <img src="/images/logo/logo.png" alt="logo" />

              </a>

              <form

                th:action="@{/searchProduct}"

                method="get"

                class="header-form"

              >

                <input

                  type="text"

                  name="productName"

                  th:value="${keyword}"

                  placeholder="Tìm kiếm..."

                  autocomplete="off"

                />

                <button><i class="fas fa-search"></i></button>

              </form>

              <div class="header-widget-group">

                <a

                  th:href="@{/profile}"

                  class="header-widget"

                  title="Trang cá nhân"

                >

                  <i class="fas fa-user"></i>

                </a>

                <a

                  th:href="@{/products}"

                  class="header-widget"

                  title="Sản phẩm"

                >

                  <i class="fas fa-store"></i>

                </a>

                <th:block th:if="${session.user != null}">

                  <a

                    th:href="@{/favorites}"

                    class="header-widget"

                    title="Yêu thích"

                  >

                    <i class="fas fa-heart"></i>

                  </a>

                </th:block>

                <th:block th:if="${session.user != null}">

                  <a th:href="@{/cart}" class="header-widget" title="Giỏ hàng">

                    <i class="fas fa-shopping-cart"></i>

                    <span

                      class="cart-count"

                      th:text="${session.cartMap != null ? session.cartMap.size() : (totalCartItems != null ? totalCartItems : 0)}"

                      >0</span

                    >

                  </a>

                  <a

                    th:href="@{/user/my-orders}"

                    class="header-widget"

                    title="Đơn hàng của tôi"

                  >

                    <i class="fas fa-shopping-bag"></i>

                  </a>

                </th:block>



                <!-- Icon Shipper -->

                <th:block

                  th:if="${session.user != null and !#lists.isEmpty(session.user.roles.?[name=='ROLE_SHIPPER'])}"

                >

                  <a

                    th:href="@{/shipper/home}"

                    class="header-widget"

                    title="Dashboard Shipper"

                    style="color: #10b981"

                  >

                    <i class="fas fa-shipping-fast"></i>

                  </a>

                </th:block>

                <th:block th:if="${session.user == null}">

                  <a

                    th:href="@{/login}"

                    class="header-widget"

                    title="Đăng nhập Shipper"

                    style="color: #10b981"

                  >

                    <i class="fas fa-shipping-fast"></i>

                  </a>

                </th:block>



                <th:block th:if="${session.user != null}">

                  <a

                    th:href="@{/logout}"

                    class="header-widget"

                    title="Đăng xuất"

                  >

                    <i class="fas fa-sign-out-alt"></i>

                  </a>

                </th:block>

                <th:block

                  th:if="${session.user == null or (#lists.isEmpty(session.user.roles.?[name=='ROLE_VENDOR']) and #lists.isEmpty(session.user.roles.?[name=='ROLE_ADMIN']))}"

                >

                  <!-- Nút Store chỉ hiện khi đã chọn shop -->

                  <th:block

                    th:if="${param.shopId != null and param.shopId.size() > 0}"

                    th:with="shopIdValue=${param.shopId[0]}"

                  >

                    <a

                      th:href="@{/chat(shopId=${shopIdValue})}"

                      class="header-widget"

                      title="Chat với Shop"

                      style="display: inline-block; margin-right: 5px"

                    >

                      <i class="fas fa-store"></i>

                    </a>

                  </th:block>

                  <!-- Nút CSKH riêng biệt -->

                  <a

                    th:href="@{/chat}"

                    class="header-widget"

                    title="Chat với CSKH - Hỗ trợ khách hàng"

                    style="

                      color: #6c757d;

                      display: inline-block;

                      margin-left: 5px;

                    "

                  >

                    <i class="fas fa-headset"></i>

                  </a>

                </th:block>

                <th:block

                  th:if="${session.user != null and (!#lists.isEmpty(session.user.roles.?[name=='ROLE_VENDOR']) or !#lists.isEmpty(session.user.roles.?[name=='ROLE_ADMIN']))}"

                >

                  <a

                    th:href="@{/vendor/dashboard}"

                    class="header-widget"

                    title="Quản lý shop"

                  >

                    <i class="fas fa-store"></i>

                  </a>

                  <a

                    th:href="@{/cskh/chat}"

                    class="header-widget"

                    title="Vendor Chat"

                  >

                    <i class="fas fa-headset"></i>

                  </a>

                </th:block>

              </div>

            </div>

          </div>

        </header>

        <nav class="navbar-part">

          <div class="container">

            <div class="row">

              <div class="col-lg-12">

                <div class="navbar-content">

                  <!-- Shop Selector -->

                  <div class="shop-selector-navbar mb-3">

                    <select

                      id="navbarShopSelector"

                      class="form-select"

                      onchange="filterHomeByShop()"

                    >

                      <option value="">Tất cả cửa hàng</option>

                      <option

                        th:each="shop : ${shopList}"

                        th:value="${shop.shopId}"

                        th:text="${shop.shopName}"

                        th:attr="data-slug=${shop.shopSlug}"

                        th:selected="${selectedShopId != null and selectedShopId == shop.shopId}"

                      ></option>

                    </select>

                  </div>



                  <ul class="navbar-list">

                    <li class="navbar-item">

                      <a class="navbar-link" th:href="@{/}">Trang chủ</a>

                    </li>

                    <li class="navbar-item">

                      <a class="navbar-link" th:href="@{/products}">Sản phẩm</a>

                    </li>

                    <li class="navbar-item dropdown">

                      <a

                        class="navbar-link dropdown-arrow"

                        href="javascript:void(0);"

                        >Thể loại</a

                      >

                      <ul class="dropdown-position-list">

                        <li th:each="item : ${categories}">

                          <a

                            th:href="@{/productByCategory(id=${item.categoryId})}"

                            >[[${item.categoryName}]]</a

                          >

                        </li>

                      </ul>

                    </li>

                    <li class="navbar-item">

                      <a class="navbar-link" th:href="@{/blogs}">Blog</a>

                    </li>

                    <li class="navbar-item">

                      <a class="navbar-link" th:href="@{/contact}">Liên hệ</a>

                    </li>

                  </ul>

                </div>

              </div>

            </div>

          </div>

        </nav>

      </th:block>

      <!-- Cart page header: Logo | Giỏ Hàng + search + widgets (no navbar) -->

      <th:block th:if="${isCartPage} == true">

        <header class="header-part">

          <div class="container">

            <div class="header-content">

              <div style="display: flex; align-items: center; gap: 10px">

                <a th:href="@{/}" class="header-logo" style="margin-right: 0">

                  <img src="/images/logo/logo.png" alt="logo" />

                </a>

                <div

                  style="width: 1px; height: 24px; background: #33a3cc"

                ></div>

                <span

                  style="

                    color: #33a3cc;

                    font-size: 24px;

                    font-weight: 600;

                    line-height: 1;

                    white-space: nowrap;

                  "

                  >Giỏ Hàng</span

                >

              </div>

              <form

                th:action="@{/searchProduct}"

                method="get"

                class="header-form"

                style="flex: 0 1 70%; max-width: 70%"

              >

                <input

                  type="text"

                  name="productName"

                  th:value="${keyword}"

                  placeholder="Tìm kiếm..."

                  autocomplete="off"

                />

                <button><i class="fas fa-search"></i></button>

              </form>

              <div class="header-widget-group">

                <a

                  th:href="@{/profile}"

                  class="header-widget"

                  title="Trang cá nhân"

                  ><i class="fas fa-user"></i

                ></a>

                <a th:href="@{/products}" class="header-widget" title="Sản phẩm"

                  ><i class="fas fa-store"></i

                ></a>



                <!-- Icon Shipper -->

                <th:block

                  th:if="${session.user != null and !#lists.isEmpty(session.user.roles.?[name=='ROLE_SHIPPER'])}"

                >

                  <a

                    th:href="@{/shipper/home}"

                    class="header-widget"

                    title="Dashboard Shipper"

                    style="color: #10b981"

                  >

                    <i class="fas fa-shipping-fast"></i>

                  </a>

                </th:block>

                <th:block th:if="${session.user == null}">

                  <a

                    th:href="@{/login}"

                    class="header-widget"

                    title="Đăng nhập Shipper"

                    style="color: #10b981"

                  >

                    <i class="fas fa-shipping-fast"></i>

                  </a>

                </th:block>



                <th:block th:if="${session.user != null}">

                  <a

                    th:href="@{/logout}"

                    class="header-widget"

                    title="Đăng xuất"

                    ><i class="fas fa-sign-out-alt"></i

                  ></a>

                </th:block>

                <th:block

                  th:if="${session.user == null or (#lists.isEmpty(session.user.roles.?[name=='ROLE_VENDOR']) and #lists.isEmpty(session.user.roles.?[name=='ROLE_ADMIN']))}"

                >

                  <th:block

                    th:with="shopIdValue=${param.shopId != null and param.shopId.size() > 0 ? param.shopId[0] : null}"

                  >

                    <a

                      th:href="${shopIdValue != null} ? @{/chat(shopId=${shopIdValue})} : @{/chat}"

                      class="header-widget"

                      title="Chat tư vấn"

                      ><i class="fas fa-comments"></i

                    ></a>

                  </th:block>

                </th:block>

                <th:block

                  th:if="${session.user != null and !#lists.isEmpty(session.user.roles.?[name=='ROLE_VENDOR'])}"

                >

                  <a

                    th:href="@{/vendor/dashboard}"

                    class="header-widget"

                    title="Quản lý shop"

                    ><i class="fas fa-store"></i

                  ></a>

                  <a

                    th:href="@{/admin/vendor-chat}"

                    class="header-widget"

                    title="Chat cửa hàng"

                    ><i class="fas fa-headset"></i

                  ></a>

                </th:block>

                <th:block th:if="${session.user != null and #lists.isEmpty(session.user.roles.?[name=='ROLE_VENDOR']) and !#lists.isEmpty(session.user.roles.?[name=='ROLE_CSKH'])}">

                  <a th:href="@{/cskh/chat}" class="header-widget" title="CSKH ↔ Khách hàng">

                    <i class="fas fa-comments"></i>

                  </a>

                  <a th:href="@{/cskh/vendor-chat}" class="header-widget" title="CSKH ↔ Vendor">

                    <i class="fas fa-user-tie"></i>

                  </a>

                </th:block>

              </div>

            </div>

          </div>

        </header>

      </th:block>

      <style>

        /* Keep local override in case other styles load later */

        .header-part .header-widget .cart-count {

          background: #0e98dd !important;

          color: #ffffff !important;

          font-size: 12px !important; /* smaller numeral only */

          font-weight: 600 !important;

        }



        /* Shop selector in navbar styling */

        .shop-selector-navbar {

          background: #f8f9fa;

          padding: 10px 15px;

          border-radius: 8px;

          margin-bottom: 10px;

          border: 1px solid #e9ecef;

        }



        .shop-selector-navbar .form-label {

          font-size: 14px;

          font-weight: 600;

          margin-bottom: 8px;

          color: #495057;

        }



        .shop-selector-navbar .form-select {

          border: 1px solid #ced4da;

          border-radius: 6px;

          padding: 8px 12px;

          font-size: 14px;

          background-color: #fff;

        }



        .shop-selector-navbar .form-select:focus {

          border-color: #0e98dd;

          box-shadow: 0 0 0 0.2rem rgba(14, 152, 221, 0.25);

        }



        @media (max-width: 768px) {

          .shop-selector-navbar {

            padding: 8px 12px;

            margin-bottom: 8px;

          }



          .shop-selector-navbar .form-label {

            font-size: 13px;

          }



          .shop-selector-navbar .form-select {

            font-size: 13px;

            padding: 6px 10px;

          }

        }

      </style>

      <script th:inline="javascript">

        /*<![CDATA[*/

        document.addEventListener("DOMContentLoaded", function () {

          // Ensure cart-count reflects current session value

          try {

            if (window.fetch) {

              fetch("/cart/count", { credentials: "same-origin" })

                .then(function (res) {

                  return res.ok ? res.text() : "0";

                })

                .then(function (txt) {

                  var val = parseInt(txt, 10);

                  if (!isNaN(val)) {

                    var el = document.querySelector(".cart-count");

                    if (el) {

                      var old = el.textContent;

                      el.textContent = String(val);

                      if (old !== String(val)) {

                        el.classList.remove("badge-bump");

                        // force reflow for animation restart

                        void el.offsetWidth;

                        el.classList.add("badge-bump");

                        setTimeout(function () {

                          el.classList.remove("badge-bump");

                        }, 300);

                      }

                    }

                  }

                })

                .catch(function () {});

            }

          } catch (e) {}



          var successMsg = /*[[${success}]]*/ null;

          var errorMsg = /*[[${error}]]*/ null;

          function showFallbackToast(text, type) {

            var el = document.createElement("div");

            el.textContent = text;

            el.style.position = "fixed";

            el.style.top = "16px";

            el.style.right = "16px";

            el.style.zIndex = "9999";

            el.style.padding = "10px 14px";

            el.style.borderRadius = "6px";

            el.style.color = "#fff";

            el.style.background = type === "error" ? "#dc3545" : "#198754";

            el.style.boxShadow = "0 4px 12px rgba(0,0,0,.15)";

            document.body.appendChild(el);

            setTimeout(function () {

              el.remove();

            }, 2000);

          }

          function showAlert(text, type) {

            if (window.swal) {

              swal({

                title: type === "error" ? "Lỗi" : "Thành công",

                text: text,

                icon: type === "error" ? "error" : "success",

                timer: 1800,

                buttons: false,

              });

            } else {

              showFallbackToast(text, type);

            }

          }

          if (typeof successMsg === "string" && successMsg.length > 0) {

            showAlert(successMsg, "success");

          }

          if (typeof errorMsg === "string" && errorMsg.length > 0) {

            showAlert(errorMsg, "error");

          }



          // Global shop selector handler so it works on all pages

          window.filterHomeByShop = function () {

            try {

              var sel = document.getElementById("navbarShopSelector");

              if (!sel) return;

              var shopId = sel.value;

              var selectedOption = sel.options[sel.selectedIndex];

              var selectedSlug = selectedOption ? selectedOption.getAttribute("data-slug") : null;

              var currentUrl = new URL(window.location.href);

              var path = currentUrl.pathname || "";



              // Keep common params when switching

              var keep = ["size", "sort", "minPrice", "maxPrice", "categoryId"]; // same set as products page

              var preserved = new URLSearchParams();

              keep.forEach(function (k) {

                var v = currentUrl.searchParams.get(k);

                if (v !== null && v !== "") preserved.set(k, v);

              });

              preserved.delete("page");



              if (path.indexOf("/shop/") === 0) {

                if (shopId && selectedSlug) {

                  var next = new URL(window.location.origin + "/shop/" + selectedSlug);

                  next.search = preserved.toString();

                  window.location.href = next.toString();

                } else {

                  var nextAll = new URL(window.location.origin + "/products");

                  nextAll.search = preserved.toString();

                  window.location.href = nextAll.toString();

                }

              } else {

                var next = new URL(currentUrl);

                if (shopId) {

                  next.searchParams.set("shopId", shopId);

                } else {

                  next.searchParams.delete("shopId");

                }

                next.searchParams.delete("page");

                window.location.href = next.toString();

              }

            } catch (e) {}

          };

        });

        /*]]>*/

      </script>



      <!-- Simple Floating Chat Button -->

      <div

        id="floatingChatButton"

        th:if="${session.user != null and #lists.isEmpty(session.user.roles.?[name=='ROLE_VENDOR']) and #lists.isEmpty(session.user.roles.?[name=='ROLE_ADMIN']) and #lists.isEmpty(session.user.roles.?[name=='ROLE_CSKH'])}"

      >

        <div class="chat-button" onclick="toggleChatPopup()">

          <i class="fas fa-comments"></i>

          <span class="chat-text">Chat</span>

          <div id="unreadCount" class="unread-count" style="display: none">

            0

          </div>

        </div>



        <!-- Chat Popup -->

        <div id="chatPopup" class="chat-popup" style="display: none">

          <div class="popup-header">

            <h5><i class="fas fa-comments"></i> Chat</h5>

            <button class="close-btn" onclick="toggleChatPopup()">

              <i class="fas fa-times"></i>

            </button>

          </div>



          <div class="popup-content">

            <!-- Left Panel: Conversations List -->

            <div class="conversations-panel">

              <div class="conversations-list" id="conversationsList">

                <!-- Conversations will be loaded here -->

              </div>



              <div id="emptyState" class="empty-state" style="display: none">

                <i class="fas fa-comments"></i>

                <p>Chưa có cuộc trò chuyện nào</p>

                <small>Bắt đầu chat với shop để mua sắm</small>

              </div>

            </div>



            <!-- Right Panel: Chat Window -->

            <div class="chat-panel" id="chatPanel" style="display: none">

              <div class="chat-header">

                <div class="chat-partner-info">

                  <div class="partner-avatar" id="partnerAvatar">

                    <span id="partnerInitial">S</span>

                  </div>

                  <div class="partner-details">

                    <h6 id="partnerName">Shop Name</h6>

                    <small id="partnerStatus">Đang hoạt động</small>

                  </div>

                </div>

              </div>



              <div class="chat-messages" id="chatMessages">

                <!-- Messages will be loaded here -->

              </div>



              <div class="chat-input-area">

                <div class="input-group">

                  <input type="file" id="imageInput" accept="image/*" style="display: none;">

                  <button class="btn btn-outline-secondary" id="imageButton" title="Gửi ảnh">

                    <i class="fas fa-image"></i>

                  </button>

                  <input type="text" id="messageInput" placeholder="Nhập nội dung tin nhắn..." class="form-control">

                  <button class="btn btn-primary" id="sendButton">

                    <i class="fas fa-paper-plane"></i>

                  </button>

                </div>

                <div id="imagePreview" class="image-preview" style="display: none;">

                  <img id="previewImg" src="" alt="Preview">

                  <button class="btn btn-sm btn-danger" id="removePreview">

                    <i class="fas fa-times"></i>

                  </button>

                </div>

              </div>

            </div>

          </div>

        </div>

      </div>



      <style>

        /* Simple Floating Chat Button Styles */



        .chat-button {

          background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);

          color: white;

          padding: 15px 20px;

          border-radius: 50px;

          cursor: pointer;

          box-shadow: 0 4px 20px rgba(255, 107, 53, 0.3);

          transition: all 0.3s ease;

          display: flex;

          align-items: center;

          gap: 8px;

          position: relative;

          min-width: 80px;

          justify-content: center;

          border: 2px solid rgba(255, 255, 255, 0.2);

        }



        .chat-button:hover {

          transform: translateY(-2px);

          box-shadow: 0 6px 25px rgba(255, 107, 53, 0.4);

        }



        .chat-button i {

          font-size: 18px;

        }



        .chat-text {

          font-weight: 600;

          font-size: 14px;

        }



        .unread-count {

          position: absolute;

          top: -5px;

          right: -5px;

          background: #e74c3c;

          color: white;

          border-radius: 50%;

          width: 20px;

          height: 20px;

          font-size: 11px;

          font-weight: bold;

          display: flex;

          align-items: center;

          justify-content: center;

          animation: pulse 2s infinite;

          border: 2px solid white;

          box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);

          min-width: 20px;

          padding: 0 4px;

        }



        @keyframes pulse {

          0% {

            transform: scale(1);

          }

          50% {

            transform: scale(1.1);

          }

          100% {

            transform: scale(1);

          }

        }



        /* Chat Popup Styles - Static Design */

        .chat-popup {

          position: fixed;

          bottom: 180px; /* Moved higher above chat button (100px + 60px + 20px margin) */

          right: 20px;

          width: 800px;

          height: 600px;

          background: white;

          border-radius: 20px;

          box-shadow: 0 20px 60px rgba(30, 58, 138, 0.15), 0 8px 25px rgba(0, 0, 0, 0.1);

          border: 1px solid rgba(59, 130, 246, 0.1);

          display: flex;

          flex-direction: column;

          overflow: hidden;

          z-index: 1000;

          /* Remove all animations */

          animation: none !important;

          transition: none !important;

        }



        /* Disabled animations */



        .popup-header {

          background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);

          color: white;

          padding: 20px 25px;

          display: flex;

          justify-content: space-between;

          align-items: center;

          flex-shrink: 0;

          border-radius: 20px 20px 0 0;

        }



        .popup-header h5 {

          margin: 0;

          font-weight: 700;

          font-size: 18px;

          letter-spacing: 0.5px;

          color: white;

          text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);

        }



        .popup-header h5 i {

          margin-right: 10px;

          font-size: 20px;

        }



        .close-btn {

          background: rgba(255, 255, 255, 0.15);

          backdrop-filter: blur(10px);

          border: none;

          color: white;

          font-size: 18px;

          cursor: pointer;

          padding: 8px;

          border-radius: 50%;

          transition: all 0.3s ease;

          width: 35px;

          height: 35px;

          display: flex;

          align-items: center;

          justify-content: center;

        }



        .close-btn:hover {

          background: rgba(255, 255, 255, 0.25);

          transform: scale(1.1);

        }



        .popup-content {

          flex: 1;

          display: flex;

          overflow: hidden;

          background: #f8fafc;

        }



        /* Left Panel: Conversations - Modern Design */

        .conversations-panel {

          width: 320px;

          border-right: 1px solid #e2e8f0;

          display: flex;

          flex-direction: column;

          background: #ffffff;

        }



        .conversations-list {

          flex: 1;

          overflow-y: auto;

          padding: 15px 0;

        }



        /* Remove all animations from chat elements */

        .conversation-item {

          display: flex;

          align-items: center;

          padding: 15px 20px;

          cursor: pointer;

          border-bottom: 1px solid #f1f5f9;

          position: relative;

          /* Remove animations */

          transition: none !important;

          animation: none !important;

          border-radius: 8px;

          margin: 2px 8px;

        }



        .conversation-item:hover {

          background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);

          transform: translateX(3px);

        }



        .conversation-item.active {

          background: linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%);

          border-left: 4px solid #3b82f6;

          box-shadow: 0 2px 10px rgba(59, 130, 246, 0.1);

        }



        .conversation-avatar {

          width: 50px;

          height: 50px;

          border-radius: 50%;

          overflow: hidden;

          margin-right: 15px;

          flex-shrink: 0;

          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

          display: flex;

          align-items: center;

          justify-content: center;

          font-weight: 700;

          color: white;

          font-size: 18px;

          box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);

        }



        .conversation-avatar img {

          width: 100%;

          height: 100%;

          object-fit: cover;

        }



        .conversation-info {

          flex: 1;

          min-width: 0;

        }



        .conversation-name {

          font-weight: 700;

          font-size: 15px;

          color: #1e293b;

          margin-bottom: 4px;

          white-space: nowrap;

          overflow: hidden;

          text-overflow: ellipsis;

        }



        .conversation-preview {

          font-size: 13px;

          color: #64748b;

          white-space: nowrap;

          overflow: hidden;

          text-overflow: ellipsis;

          margin-bottom: 3px;

          line-height: 1.4;

        }



        .conversation-time {

          font-size: 11px;

          color: #94a3b8;

          font-weight: 500;

        }



        .conversation-status {

          margin-left: 12px;

          flex-shrink: 0;

        }



        .unread-count-small {

          background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);

          color: white;

          border-radius: 50%;

          width: 20px;

          height: 20px;

          font-size: 11px;

          font-weight: 700;

          display: flex;

          align-items: center;

          justify-content: center;

          box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);

        }



        /* Right Panel: Chat - Professional Design */

        .chat-panel {

          flex: 1;

          display: flex;

          flex-direction: column;

          background: #ffffff;

        }



        .chat-header {

          padding: 20px 25px;

          border-bottom: 1px solid #e2e8f0;

          background: #ffffff;

          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);

        }



        .chat-partner-info {

          display: flex;

          align-items: center;

        }



        .partner-avatar {

          width: 45px;

          height: 45px;

          border-radius: 50%;

          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

          display: flex;

          align-items: center;

          justify-content: center;

          margin-right: 15px;

          font-weight: 700;

          color: white;

          font-size: 18px;

          box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);

        }



        .partner-details h6 {

          margin: 0;

          font-weight: 700;

          color: #1e293b;

          font-size: 16px;

        }



        .partner-details small {

          color: #10b981;

          font-weight: 600;

          font-size: 12px;

        }



        .chat-messages {

          flex: 1;

          overflow-y: auto;

          padding: 25px;

          background: #f8fafc;

          scroll-behavior: smooth;

        }



        /* Scope .message for chat popup only, not chatbot AI */
        #floatingChatButton ~ #floatingChatPopup .message,
        .chat-container .message {
          margin-bottom: 20px;
          display: flex;
          align-items: flex-end;
          /* Remove animations */
          animation: none !important;
          transition: none !important;
        }



        /* Disabled animations */



        /* Scope .message.sent/.received for chat popup only */
        #floatingChatButton ~ #floatingChatPopup .message.sent,
        .chat-container .message.sent {
          justify-content: flex-end;
        }

        #floatingChatButton ~ #floatingChatPopup .message.received,
        .chat-container .message.received {
          justify-content: flex-start;
        }



        /* Scope .message-bubble for chat popup only */
        #floatingChatButton ~ #floatingChatPopup .message-bubble,
        .chat-container .message-bubble {
          max-width: 70%;
          padding: 15px 20px;
          border-radius: 20px;
          font-size: 14px;
          line-height: 1.5;
          position: relative;
          word-wrap: break-word;
          backdrop-filter: blur(10px);
        }

        #floatingChatButton ~ #floatingChatPopup .message.sent .message-bubble,
        .chat-container .message.sent .message-bubble {
          background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
          color: white;
          border-bottom-right-radius: 8px;
          box-shadow: 0 4px 15px rgba(30, 58, 138, 0.3);
        }

        #floatingChatButton ~ #floatingChatPopup .message.received .message-bubble,
        .chat-container .message.received .message-bubble {
          background: #ffffff;
          color: #1e293b;
          border-bottom-left-radius: 8px;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
          border: 1px solid #e2e8f0;
        }



        .message-text {

          margin-bottom: 5px;

        }



        .message-image {

          margin-bottom: 8px;

        }



        .chat-image {

          max-width: 250px;

          max-height: 200px;

          border-radius: 12px;

          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);

          /* Remove animations */

          transition: none !important;

          animation: none !important;

        }



        .chat-image:hover {

          opacity: 0.9;

        }



        .message-time {

          font-size: 11px;

          opacity: 0.7;

          font-weight: 500;

        }



        .chat-input-area {

          padding: 20px 25px;

          border-top: 1px solid #e2e8f0;

          background: #ffffff;

        }



        .input-group {

          display: flex;

          gap: 12px;

          align-items: flex-end;

          padding: 20px 25px;

          background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);

          border-top: 1px solid rgba(59, 130, 246, 0.1);

        }



        .input-group .form-control {

          flex: 1;

          border-radius: 25px;

          border: 2px solid #e2e8f0;

          padding: 12px 20px;

          font-size: 14px;

          transition: all 0.3s ease;

          background: #f8fafc;

        }



        .input-group .form-control:focus {

          border-color: #3b82f6;

          box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);

          background: #ffffff;

        }



        .input-group .btn {

          border-radius: 50%;

          width: 45px;

          height: 45px;

          display: flex;

          align-items: center;

          justify-content: center;

          border: none;

          /* Remove animations */

          transition: none !important;

          animation: none !important;

        }



        .input-group .btn:hover {

          opacity: 0.9;

        }



        .input-group .btn-outline-secondary {

          background: #f1f5f9;

          color: #64748b;

        }



        .input-group .btn-outline-secondary:hover {

          background: #e2e8f0;

          color: #475569;

        }



        .input-group .btn-primary {

          background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);

          color: white;

          box-shadow: 0 4px 15px rgba(30, 58, 138, 0.3);

        }



        .input-group .btn-primary:hover {

          box-shadow: 0 6px 20px rgba(30, 58, 138, 0.4);

        }



        .image-preview {

          margin-top: 15px;

          position: relative;

          display: inline-block;

          /* Remove animations */

          animation: none !important;

          transition: none !important;

        }



        /* Disabled animations */



        .image-preview img {

          max-width: 200px;

          max-height: 150px;

          border-radius: 12px;

          border: 2px solid #e2e8f0;

          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);

        }



        .image-preview .btn {

          position: absolute;

          top: -8px;

          right: -8px;

          width: 24px;

          height: 24px;

          border-radius: 50%;

          padding: 0;

          font-size: 12px;

          background: #ef4444;

          color: white;

          border: 2px solid white;

          box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);

        }



        .empty-state {

          text-align: center;

          padding: 60px 30px;

          color: #64748b;

          flex: 1;

          display: flex;

          flex-direction: column;

          align-items: center;

          justify-content: center;

        }



        .empty-state i {

          font-size: 64px;

          margin-bottom: 20px;

          opacity: 0.5;

          color: #cbd5e1;

        }



        .empty-state p {

          margin: 0 0 8px 0;

          font-weight: 700;

          font-size: 18px;

          color: #475569;

        }



        .empty-state small {

          font-size: 14px;

          color: #94a3b8;

        }



        /* Responsive Design - Floating */

        @media (max-width: 1200px) {

          .chat-popup {

            width: 700px;

            height: 550px;

            right: 15px;

          }

        }



        @media (max-width: 992px) {

          .chat-popup {

            width: 600px;

            height: 500px;

            right: 10px;

          }

          

          .conversations-panel {

            width: 250px;

          }

        }



        @media (max-width: 768px) {

          .chat-popup {

            width: calc(100vw - 20px);

            height: calc(100vh - 20px);

            bottom: 200px; /* Moved higher above chat button on mobile */

            right: 10px;

            left: 10px;

            border-radius: 10px;

          }

          

          .conversations-panel {

            width: 100%;

            height: 100%;

          }

          

          .chat-panel {

            display: none;

          }

          

          .chat-panel.active {

            display: flex;

            position: absolute;

            top: 0;

            left: 0;

            width: 100%;

            height: 100%;

            z-index: 10000;

            background: white;

          }

        }



        /* Chat Button - Static Design */

        #floatingChatButton {

          position: fixed;

          bottom: 80px; /* Below chatbot button */

          right: 20px;

          width: 60px;

          height: 60px;

          background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);

          border-radius: 50%;

          border: none;

          color: white;

          font-size: 24px;

          cursor: pointer;

          box-shadow: 0 12px 35px rgba(30, 58, 138, 0.4), 0 4px 15px rgba(0, 0, 0, 0.1);

          z-index: 999; /* Below chatbot z-index */

          display: flex;

          align-items: center;

          justify-content: center;

          /* Remove all animations */

          animation: none !important;

          transition: none !important;

        }

        

        /* Ensure chat popup doesn't overlap content */

        .chat-popup {

          position: fixed;

          bottom: 100px;

          right: 20px;

          width: 800px;

          height: 600px;

          background: white;

          border-radius: 15px;

          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);

          border: 1px solid #e9ecef;

          display: flex;

          flex-direction: column;

          overflow: hidden;

          z-index: 1000;

        }

        

        /* Prevent content overlap on mobile */

        @media (max-width: 768px) {

          body {

            padding-bottom: 120px; /* More padding for mobile */

          }

          

          #floatingChatButton {

            bottom: 120px; /* More space on mobile */

            right: 20px;

          }

        }



        /* Disabled animations */


        #floatingChatButton:hover {

          opacity: 0.9;

        }



      </style>



      <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>

      <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

      

      <!-- Fix slick.min.js error -->

      <script>

        // Prevent slick.min.js errors

        window.addEventListener('error', function(e) {

          if (e.filename && e.filename.includes('slick.min.js')) {

            console.warn('Slick carousel error prevented:', e.message);

            e.preventDefault();

            return true;

          }

        });

        

        // Fix slick initialization errors

        if (typeof $ !== 'undefined' && $.fn.slick) {

          $(document).ready(function() {

            try {

              $('.slick-slider').each(function() {

                if (!$(this).hasClass('slick-initialized')) {

                  $(this).slick({

                    dots: true,

                    infinite: true,

                    speed: 300,

                    slidesToShow: 1,

                    adaptiveHeight: true

                  });

                }

              });

            } catch (e) {

              console.warn('Slick initialization error prevented:', e.message);

            }

          });

        }

      </script>

      

      <script>

        // Simple Chat Button JavaScript

        let chatPopupOpen = false;

        let stompClient = null;

        let currentRoomId = null;

        let currentShopId = null;

        let displayedMessageIds = new Set(); // Track displayed messages to avoid duplicates

        let currentConversation = null; // Store current conversation data

        let selectedImageFile = null; // Store selected image file

        

        // Store read conversations to prevent showing notifications again

        let readConversations = new Set();

        

        // Load read conversations from localStorage

        function loadReadConversations() {

          const saved = localStorage.getItem('readConversations');

          if (saved) {

            readConversations = new Set(JSON.parse(saved));

          }

        }

        

        // Load read conversations when page loads

        loadReadConversations();

        

        // Save read conversations to localStorage

        function saveReadConversations() {

          localStorage.setItem('readConversations', JSON.stringify([...readConversations]));

        }

        

        // Mark conversation as read

        function markConversationAsRead(roomId) {

          readConversations.add(roomId);

          saveReadConversations();

        }

        

        // Check if conversation is read

        function isConversationRead(roomId) {

          return readConversations.has(roomId);

        }



        function toggleChatPopup() {

          const popup = document.getElementById("chatPopup");

          chatPopupOpen = !chatPopupOpen;



          if (chatPopupOpen) {

            popup.style.display = "flex";

            loadReadConversations(); // Load read conversations

            loadConversations();

            

            // Restore conversation if there's a pending one

            if (window.pendingConversation) {

              setTimeout(() => {

                console.log('Restoring pending conversation...');

                restoreConversation(window.pendingConversation);

                window.pendingConversation = null; // Clear after restore

              }, 1000); // Wait for conversations to load

            }

          } else {

            popup.style.display = "none";

            // Clear current conversation when closing popup

            currentConversation = null;

            currentRoomId = null;

            currentShopId = null;

            displayedMessageIds.clear();

            // Save state

            saveChatState();

          }

        }



        function loadConversations() {

          console.log("Loading conversations...");



          fetch("/api/chat/conversations")

            .then((response) => {

              console.log("API Response status:", response.status);

              return response.json();

            })

            .then((data) => {

              console.log("Conversations data:", data);

              displayConversations(data);

            })

            .catch((error) => {

              console.error("Error loading conversations:", error);

              showEmptyState();

            });

        }



        function displayConversations(conversations) {

          const list = document.getElementById("conversationsList");

          const emptyState = document.getElementById("emptyState");



          if (conversations.length === 0) {

            showEmptyState();

            return;

          }



          list.style.display = "block";

          emptyState.style.display = "none";



          list.innerHTML = conversations

            .map(

              (conv) => `

            <div class="conversation-item" data-room-id="${conv.roomId}" onclick="openChat('${

              conv.shopId

            }', '${conv.shopName}', '${conv.roomId}', '${conv.room}', '${

                 conv.user

               }', this)">

              <div class="conversation-avatar">

                ${

                  conv.shopLogo

                    ? `<img src="/loadImage?imageName=${conv.shopLogo}" alt="${conv.shopName}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">`

                    : ""

                }

                <div style="display: ${conv.shopLogo ? "none" : "flex"};">

                  ${conv.shopName ? conv.shopName.charAt(0).toUpperCase() : "S"}

                </div>

              </div>

              <div class="conversation-info">

                <div class="conversation-name">${conv.shopName || "Shop"}</div>

                <div class="conversation-preview">${

                  conv.lastMessage && conv.lastMessage.includes('/loadImage?imageName=') 

                    ? '[Hình ảnh]' 

                    : conv.lastMessage || "Chưa có tin nhắn"

                }</div>

                <div class="conversation-time">${formatTime(

                  conv.lastMessageTime

                )}</div>

              </div>

              <div class="conversation-status">

                ${

                  conv.unreadCount > 0 && !isConversationRead(conv.roomId)

                    ? `<div class="unread-count-small">${conv.unreadCount}</div>`

                    : ""

                }

              </div>

            </div>

          `

            )

            .join("");



          updateUnreadBadge(conversations);

        }



        function showEmptyState() {

          const list = document.getElementById("conversationsList");

          const emptyState = document.getElementById("emptyState");



          list.style.display = "none";

          emptyState.style.display = "flex";

        }



        function openChat(shopId, shopName, roomId, room, user, element) {

          console.log("Opening chat:", {

            shopId,

            shopName,

            roomId,

            room,

            user,

          });



          // Show chat panel

          showChatPanel(shopId, shopName, roomId, room, user, element);

        }



        function showChatPanel(shopId, shopName, roomId, room, user, element) {

          console.log('showChatPanel called with:', {shopId, shopName, roomId, room, user});

          

          // Hide empty state

          const emptyState = document.getElementById('emptyState');

          emptyState.style.display = 'none';



          // Show chat panel

          const chatPanel = document.getElementById('chatPanel');

          chatPanel.style.display = 'flex';

          console.log('Chat panel displayed:', chatPanel.style.display);



          // Update chat header

          document.getElementById('partnerName').textContent = shopName;

          document.getElementById('partnerInitial').textContent = shopName ? shopName.charAt(0).toUpperCase() : 'S';



          // Mark conversation as active

          document.querySelectorAll('.conversation-item').forEach(item => {

            item.classList.remove('active');

          });

          element.classList.add('active');



          // Clear unread count for this conversation

          clearUnreadCount(element);



          // Set current room and shop

          currentRoomId = roomId;

          currentShopId = shopId;



          // Store current conversation data

          currentConversation = {

            shopId: shopId,

            shopName: shopName,

            roomId: roomId,

            room: room,

            user: user

          };



          // Save to localStorage

          saveChatState();



          // Clear displayed message IDs for new room

          displayedMessageIds.clear();



          // Connect WebSocket if not connected

          if (!stompClient) {

            connectWebSocket();

          } else {

            // If already connected, subscribe to new room

            subscribeToRoom();

          }



          // Load chat history

          console.log('Loading chat history for room:', roomId);

          loadChatHistory(roomId);

        }



        function connectWebSocket() {

          const socket = new SockJS('/ws');

          stompClient = Stomp.over(socket);

          

          stompClient.connect({}, function(frame) {

            console.log('Connected: ' + frame);

            

            // Subscribe to current room if exists

            subscribeToRoom();

          }, function(error) {

            console.log('WebSocket connection error: ' + error);

          });

        }



        function subscribeToRoom() {

          if (currentRoomId && stompClient) {

            stompClient.subscribe('/topic/room/' + currentRoomId, function(message) {

              const messageData = JSON.parse(message.body);

              displayNewMessage(messageData);

            });

            console.log('Subscribed to room: ' + currentRoomId);

          }

        }



        function sendMessage() {

          const messageInput = document.getElementById('messageInput');

          const message = messageInput.value.trim();

          

          if (!message && !selectedImageFile) {

            return;

          }



          if (selectedImageFile) {

            // Send image

            sendImageMessage(message);

          } else {

            // Send text message

            const messageData = {

              roomId: currentRoomId,

              messageContent: message,

              messageType: 'TEXT',

              senderName: window.CHAT_INIT?.userName || 'Khách hàng',

              userType: 'customer'

            };



            stompClient.send('/app/chat.send', {}, JSON.stringify(messageData));

            messageInput.value = '';

          }

        }



        async function sendImageMessage(textMessage = '') {

          if (!selectedImageFile || !currentRoomId) {

            return;

          }



          try {

            const formData = new FormData();

            formData.append('file', selectedImageFile);



            const response = await fetch('/api/chat/uploadImage', {

              method: 'POST',

              body: formData

            });



            if (!response.ok) {

              console.error('Upload failed:', response.status, response.statusText);

              alert('Tải ảnh thất bại: ' + response.statusText);

              return;

            }



            const data = await response.json();

            console.log('Image uploaded successfully:', data);



            if (!data.success || !data.url) {

              console.error('Invalid response:', data);

              alert('Tải ảnh thất bại: Phản hồi không hợp lệ');

              return;

            }



            // Send IMAGE message with URL (same as main chat)

            const messageData = {

              roomId: currentRoomId,

              messageContent: data.url, // URL to the image

              messageType: 'IMAGE',

              userType: 'customer',

              senderName: window.CHAT_INIT?.userName || 'Khách hàng'

            };



            stompClient.send('/app/chat.send', {}, JSON.stringify(messageData));

            

            // Clear inputs

            document.getElementById('messageInput').value = '';

            clearImagePreview();

          } catch (error) {

            console.error('Error uploading image:', error);

            alert('Lỗi khi upload ảnh: ' + error.message);

          }

        }



        function handleImageSelect(event) {

          const file = event.target.files[0];

          if (file) {

            selectedImageFile = file;

            showImagePreview(file);

          }

        }



        function showImagePreview(file) {

          const reader = new FileReader();

          reader.onload = function(e) {

            const preview = document.getElementById('imagePreview');

            const previewImg = document.getElementById('previewImg');

            previewImg.src = e.target.result;

            preview.style.display = 'block';

          };

          reader.readAsDataURL(file);

        }



        function clearImagePreview() {

          selectedImageFile = null;

          document.getElementById('imageInput').value = '';

          document.getElementById('imagePreview').style.display = 'none';

        }



        function displayNewMessage(messageData) {

          const chatMessages = document.getElementById('chatMessages');

          const isSent = messageData.senderType === 'customer';

          const messageClass = isSent ? 'sent' : 'received';

          const time = formatTime(messageData.sentAt);

          const content = messageData.messageContent || messageData.content || 'Tin nhắn trống';

          

          // Create unique ID for this message

          const messageId = `${messageData.sentAt}_${messageData.sender}_${content.substring(0, 10)}`;

          

          // Check if message already exists

          if (displayedMessageIds.has(messageId)) {

            console.log('Duplicate message detected, skipping:', messageId);

            return;

          }

          

          // Add to displayed messages

          displayedMessageIds.add(messageId);

          

          const messageElement = document.createElement('div');

          messageElement.className = `message ${messageClass}`;

          messageElement.setAttribute('data-message-id', messageId);

          

          // Check if message has image - debug

          console.log('Message data for display:', messageData);

          const isImage = messageData.messageType === 'IMAGE';

          let messageContent = '';

          

          if (isImage && messageData.messageContent) {

            // Same logic as main chat - messageContent contains the image URL

            messageContent = `

              <div class="message-image">

                <a href="${messageData.messageContent}" target="_blank">

                  <img src="${messageData.messageContent}" alt="Chat image" class="chat-image" 

                       onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"

                       onload="this.nextElementSibling.style.display='none';">

                  <div style="display:none; padding:20px; background:#f8f9fa; border-radius:8px; color:#6c757d; text-align:center;">

                    <i class="fas fa-image"></i><br>

                    Không thể tải ảnh

                  </div>

                </a>

              </div>

              <div class="message-time">${time}</div>

            `;

          } else {

            messageContent = `

              <div class="message-text">${content}</div>

              <div class="message-time">${time}</div>

            `;

          }

          

          messageElement.innerHTML = `

            <div class="message-bubble">

              ${messageContent}

            </div>

          `;

          

          chatMessages.appendChild(messageElement);

          chatMessages.scrollTop = chatMessages.scrollHeight;

        }



        function clearUnreadCount(element) {

          const unreadBadge = element.querySelector('.unread-count-small');

          if (unreadBadge) {

            unreadBadge.style.display = 'none';

          }

          

          // Mark conversation as read

          const roomId = element.getAttribute('data-room-id');

          if (roomId) {

            markConversationAsRead(roomId);

          }

          

          // Update total unread count

          updateTotalUnreadCount();

        }



        function updateTotalUnreadCount() {

          // Count only conversations that are not marked as read

          const conversationElements = document.querySelectorAll('.conversation-item');

          let totalUnread = 0;

          

          conversationElements.forEach(element => {

            const roomId = element.getAttribute('data-room-id');

            const unreadBadge = element.querySelector('.unread-count-small');

            

            if (unreadBadge && !isConversationRead(roomId)) {

              const count = parseInt(unreadBadge.textContent) || 0;

              totalUnread += count;

            }

          });

          

          const badge = document.getElementById('unreadCount');

          

          if (totalUnread > 0) {

            badge.textContent = totalUnread;

            badge.style.display = 'block';

          } else {

            badge.style.display = 'none';

          }

        }



        function loadChatHistory(roomId) {

          console.log('=== LOAD CHAT HISTORY DEBUG ===');

          console.log('Loading chat history for room:', roomId);

          

          fetch(`/api/chat/history?roomId=${roomId}&limit=50`)

            .then(response => {

              console.log('Chat history API response status:', response.status);

              return response.json();

            })

            .then(messages => {

              console.log('Chat history loaded:', messages);

              

              // Check if response is an array

              if (Array.isArray(messages)) {

                console.log('Number of messages:', messages.length);

                console.log('First message structure:', messages[0]);

                displayChatMessages(messages);

              } else {

                console.error('API returned non-array response:', messages);

                displayChatMessages([]); // Show empty state

              }

              console.log('=== END LOAD CHAT HISTORY DEBUG ===');

            })

            .catch(error => {

              console.error('Error loading chat history:', error);

              console.log('=== END LOAD CHAT HISTORY DEBUG (ERROR) ===');

            });

        }



        function displayChatMessages(messages) {

          console.log('=== DISPLAY CHAT MESSAGES DEBUG ===');

          const chatMessages = document.getElementById('chatMessages');

          console.log('Chat messages element:', chatMessages);

          console.log('Messages to display:', messages);

          

          if (messages.length === 0) {

            console.log('No messages to display, showing empty state');

            chatMessages.innerHTML = '<div class="text-center text-muted">Chưa có tin nhắn nào</div>';

            console.log('=== END DISPLAY CHAT MESSAGES DEBUG (EMPTY) ===');

            return;

          }



          // Clear displayed message IDs for this room

          displayedMessageIds.clear();



          chatMessages.innerHTML = messages.map(msg => {

            const isSent = msg.senderType === 'customer';

            const messageClass = isSent ? 'sent' : 'received';

            const time = formatTime(msg.sentAt);

            const content = msg.messageContent || msg.content || 'Tin nhắn trống';

            

            // Create unique ID for this message

            const messageId = `${msg.sentAt}_${msg.sender}_${content.substring(0, 10)}`;

            displayedMessageIds.add(messageId);

            

            // Check if message has image

            const isImage = msg.messageType === 'IMAGE';

            let messageContent = '';

            

            if (isImage && msg.messageContent) {

              // Same logic as main chat - messageContent contains the image URL

              messageContent = `

                <div class="message-image">

                  <a href="${msg.messageContent}" target="_blank">

                    <img src="${msg.messageContent}" alt="Chat image" class="chat-image" 

                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"

                         onload="this.nextElementSibling.style.display='none';">

                    <div style="display:none; padding:20px; background:#f8f9fa; border-radius:8px; color:#6c757d; text-align:center;">

                      <i class="fas fa-image"></i><br>

                      Không thể tải ảnh

                    </div>

                  </a>

                </div>

                <div class="message-time">${time}</div>

              `;

            } else {

              messageContent = `

                <div class="message-text">${content}</div>

                <div class="message-time">${time}</div>

              `;

            }

            

            return `

              <div class="message ${messageClass}" data-message-id="${messageId}">

                <div class="message-bubble">

                  ${messageContent}

                </div>

              </div>

            `;

          }).join('');



          // Scroll to bottom

          chatMessages.scrollTop = chatMessages.scrollHeight;

          console.log('Messages displayed successfully, scroll position:', chatMessages.scrollTop);

          console.log('=== END DISPLAY CHAT MESSAGES DEBUG ===');

        }



        function updateUnreadBadge(conversations) {

          const totalUnread = conversations.reduce(

            (sum, conv) => sum + (conv.unreadCount > 0 && !isConversationRead(conv.roomId) ? conv.unreadCount : 0),

            0

          );

          const badge = document.getElementById("unreadCount");



          if (totalUnread > 0) {

            badge.textContent = totalUnread;

            badge.style.display = "block";

          } else {

            badge.style.display = "none";

          }

        }



        function saveChatState() {

          if (currentConversation) {

            localStorage.setItem('chatState', JSON.stringify({

              conversation: currentConversation,

              popupOpen: chatPopupOpen,

              timestamp: Date.now()

            }));

            console.log('Chat state saved:', currentConversation);

          }

        }



        function restoreChatState() {

          try {

            console.log('=== RESTORE CHAT STATE DEBUG ===');

            const savedState = localStorage.getItem('chatState');

            console.log('Saved state from localStorage:', savedState);

            

            if (savedState) {

              const state = JSON.parse(savedState);

              const timeDiff = Date.now() - state.timestamp;

              console.log('Time difference:', timeDiff, 'ms');

              

              // Only restore if saved within last 24 hours

              if (timeDiff < 24 * 60 * 60 * 1000) {

                console.log('Restoring chat state:', state);

                

                // DON'T auto-open popup - let user click to open

                // if (state.popupOpen) {

                //   console.log('Opening popup...');

                //   toggleChatPopup();

                // }

                

                // Store conversation data for when user opens chat

                if (state.conversation) {

                  console.log('Storing conversation data for manual open...');

                  // Store in a separate variable for manual restoration

                  window.pendingConversation = state.conversation;

                }

              } else {

                console.log('State too old, clearing...');

                localStorage.removeItem('chatState');

              }

            } else {

              console.log('No saved state found');

            }

            console.log('=== END RESTORE DEBUG ===');

          } catch (error) {

            console.error('Error restoring chat state:', error);

            localStorage.removeItem('chatState');

          }

        }



        function restoreConversation(conversation) {

          console.log('Restoring conversation:', conversation);

          

          // Find the conversation element

          const conversationElements = document.querySelectorAll('.conversation-item');

          console.log('Found conversation elements:', conversationElements.length);

          

          let targetElement = null;

          

          for (let element of conversationElements) {

            const shopNameElement = element.querySelector('.conversation-name');

            if (shopNameElement) {

              const shopName = shopNameElement.textContent;

              console.log('Checking conversation:', shopName, 'vs', conversation.shopName);

              if (shopName === conversation.shopName) {

                targetElement = element;

                console.log('Found matching conversation element');

                break;

              }

            }

          }

          

          if (targetElement) {

            console.log('Restoring chat panel for:', conversation.shopName);

            // Restore the conversation

            showChatPanel(

              conversation.shopId,

              conversation.shopName,

              conversation.roomId,

              conversation.room,

              conversation.user,

              targetElement

            );

          } else {

            console.log('Conversation element not found, waiting for conversations to load...');

            console.log('Available conversations:', Array.from(conversationElements).map(el => el.querySelector('.conversation-name')?.textContent));

            // Retry after a short delay

            setTimeout(() => restoreConversation(conversation), 1000);

          }

        }



        function formatTime(timestamp) {

          if (!timestamp) return "";



          const date = new Date(timestamp);

          const now = new Date();

          const diff = now - date;



          if (diff < 60000) return "Vừa xong";

          if (diff < 3600000) return Math.floor(diff / 60000) + " phút";

          if (diff < 86400000) return Math.floor(diff / 3600000) + " giờ";

          if (diff < 604800000) return Math.floor(diff / 86400000) + " ngày";



          return date.toLocaleDateString("vi-VN");

        }


        // Flag to ensure floating chat listeners are bound only once
        let floatingChatBound = false;


        // Initialize when page loads

        document.addEventListener("DOMContentLoaded", function () {


          console.log("Floating chat button initialized");

          

          // Add event listeners for send button and Enter key

          const sendButton = document.getElementById('sendButton');

          const messageInput = document.getElementById('messageInput');

          const imageButton = document.getElementById('imageButton');

          const imageInput = document.getElementById('imageInput');

          const removePreview = document.getElementById('removePreview');

          

          if (sendButton) {

            sendButton.addEventListener('click', sendMessage);

          }

          

          if (messageInput) {

            messageInput.addEventListener('keypress', function(e) {

              if (e.key === 'Enter') {

                sendMessage();

              }

            });

          }

          

          if (imageButton) {

            imageButton.addEventListener('click', function() {

              imageInput.click();

            });

          }

          

          if (imageInput) {

            imageInput.addEventListener('change', handleImageSelect);

          }

          

          if (removePreview) {

            removePreview.addEventListener('click', clearImagePreview);

          }

          

          floatingChatBound = true;
          

          // DON'T auto-restore chat state - let user click to open

          // setTimeout(() => {

          //   console.log('Attempting to restore chat state...');

          //   restoreChatState();

          // }, 2000); // Increase delay to ensure conversations are loaded

          

          // Add debug commands to window for manual testing

          window.debugChat = {

            checkState: () => {

              console.log('=== MANUAL DEBUG COMMANDS ===');

              console.log('Current conversation:', currentConversation);

              console.log('Current room ID:', currentRoomId);

              console.log('Current shop ID:', currentShopId);

              console.log('Chat popup open:', chatPopupOpen);

              console.log('Stomp client:', stompClient);

              console.log('Displayed message IDs:', Array.from(displayedMessageIds));

              console.log('Saved state:', localStorage.getItem('chatState'));

              console.log('Chat panel element:', document.getElementById('chatPanel'));

              console.log('Chat messages element:', document.getElementById('chatMessages'));

              console.log('Conversation elements:', document.querySelectorAll('.conversation-item'));

              console.log('=== END MANUAL DEBUG ===');

            },

            testRestore: () => {

              console.log('Testing restore manually...');

              // restoreChatState(); // Commented out - no auto restore

            },

            testLoadHistory: (roomId) => {

              console.log('Testing load history for room:', roomId);

              loadChatHistory(roomId);

            },

            testShowPanel: (shopId, shopName, roomId, room, user) => {

              console.log('Testing show panel manually...');

              const element = document.querySelector('.conversation-item');

              if (element) {

                showChatPanel(shopId, shopName, roomId, room, user, element);

              } else {

                console.log('No conversation element found');

              }

            }

          };

        });

      </script>

    <!-- Floating OneShop AI Chatbot Button -->
    <div id="oneshopChatbotButton" class="oneshop-chatbot-button" onclick="toggleOneshopChatbot()">
      <div class="chatbot-avatar">

          <div class="robot-face">

            <div class="robot-eyes">

              <div class="eye left"></div>

              <div class="eye right"></div>

            </div>

            <div class="robot-mouth"></div>

          </div>

        </div>

        <div class="chatbot-sparkles">

          <span class="sparkle">✨</span>

          <span class="sparkle">✨</span>

        </div>

      </div>

      <span class="chatbot-badge" id="chatbotBadge" style="display: none;">1</span>
    </div>
    <!-- End Floating OneShop AI Chatbot Button -->



    <!-- Floating AI Chatbot Popup -->

    <div id="floatingChatbotPopup" class="oneshop-chatbot-popup" style="display: none;">

      <div class="chatbot-header">

        <div class="chatbot-title">

          <div class="title-icon">

            <div class="oneshop-logo-icon">OS</div>

          </div>

          <div class="title-text">

            <h3>Trợ lý AI - OneShop</h3>

          </div>

        </div>

         <div class="chatbot-controls">

          <button class="control-btn refresh-btn" onclick="refreshChatbot()">

            <i class="fas fa-sync-alt"></i>

          </button>


          <button class="control-btn close-btn" onclick="closeOneshopChatbot()">

            <i class="fas fa-times"></i>

          </button>

         </div>

      </div>

      

      <div class="chatbot-body">

        <!-- Welcome Message -->
        <div class="welcome-message-simple">
          <p>Chào bạn! 👋 Mình là trợ lý AI của OneShop. Mình có thể giúp bạn tìm kiếm sản phẩm mỹ phẩm phù hợp.</p>
        </div>



        <!-- Suggested Topics -->

        <div class="suggested-topics">

          <button class="topic-btn" onclick="sendSuggestedMessage('Tư vấn kem dưỡng da')">

            Kem dưỡng da

          </button>

          <button class="topic-btn" onclick="sendSuggestedMessage('Son môi cao cấp')">

            Son môi cao cấp

          </button>

          <button class="topic-btn" onclick="sendSuggestedMessage('Chính sách bảo hành')">

            Chính sách bảo hành

          </button>

          <button class="topic-btn" onclick="sendSuggestedMessage('Chính sách đổi trả')">

            Chính sách đổi trả

          </button>

        </div>


        <!-- Chat Messages - Scrollable -->
        <div class="chat-messages" id="aiChatbotMessages">

          <!-- Messages will be added here dynamically -->

        </div>


        <!-- Input Area - Fixed -->

        <div class="chatbot-input-area">

          <div class="input-label">Bạn cần hỗ trợ gì?</div>

          <!-- Image Preview -->

          <div id="aiChatbotImagePreview" class="image-preview" style="display: none; margin-bottom: 10px;">
            <img id="aiChatbotPreviewImg" src="" alt="Preview" style="max-width: 100%; max-height: 200px; border-radius: 8px;">

            <button class="remove-image-btn" onclick="removeImagePreview()">

              <i class="fas fa-times"></i>

            </button>

          </div>

          <div class="input-group">

            <button type="button" class="upload-btn" id="aiChatbotUploadBtn" title="Gửi hình ảnh">
              <i class="fas fa-image"></i>
              <input type="file" id="aiChatbotImageInput" accept="image/*" style="display: none;">
            </button>
            <input type="text" id="aiChatbotMessageInput" placeholder="Nhập Tin Nhắn..." class="chatbot-input">
            <button type="button" class="send-btn" id="aiChatbotSendBtn">
              <i class="fas fa-paper-plane"></i>

            </button>

          </div>

        </div>



        <!-- Footer with Disclaimer - Sticky -->
        <div class="chatbot-footer">
          <div class="disclaimer">
            <small>Thông tin chỉ mang tính tham khảo, được tư vấn bởi Trí Tuệ Nhân Tạo</small>
          </div>
        </div>

      </div>

    </div>
    </div> <!-- End ai-chatbot-container -->



    <style>

      /* OneShop Chatbot Button - Original Orange Style */

      #oneshopChatbotButton {

        position: fixed !important;

        bottom: 220px !important; /* Higher position */

        right: 30px !important; /* Moved slightly left */

        width: 70px !important;

        height: 70px !important;

        background: linear-gradient(135deg, #ff6b00 0%, #ff8c00 100%) !important;

        border-radius: 50% !important;

        display: flex !important;

        align-items: center !important;

        justify-content: center !important;

        cursor: pointer !important;

        box-shadow: 0 8px 25px rgba(255, 107, 0, 0.4) !important;

        transition: all 0.3s ease !important;

        z-index: 1002 !important; /* Higher than chat button */

        animation: float 3s ease-in-out infinite !important;

        opacity: 1 !important;

        visibility: visible !important;

      }



      @keyframes float {

        0%, 100% { transform: translateY(0px); }

        50% { transform: translateY(-10px); }

      }



      .oneshop-chatbot-button:hover {

        transform: scale(1.1);

        box-shadow: 0 12px 35px rgba(255, 107, 157, 0.6);

      }



      .chatbot-icon {

        position: relative;

        width: 50px;

        height: 50px;

      }



      .chatbot-avatar {

        width: 50px;

        height: 50px;

        background: white;

        border-radius: 50%;

        display: flex;

        align-items: center;

        justify-content: center;

        position: relative;

        overflow: hidden;

      }



      .robot-face {

        width: 35px;

        height: 35px;

        position: relative;

      }



      .robot-eyes {

        position: absolute;

        top: 8px;

        left: 50%;

        transform: translateX(-50%);

        display: flex;

        gap: 8px;

      }



      .eye {

        width: 6px;

        height: 6px;

        background: #333;

        border-radius: 50%;

        animation: blink 4s infinite;

      }



      @keyframes blink {

        0%, 90%, 100% { transform: scaleY(1); }

        95% { transform: scaleY(0.1); }

      }



      .robot-mouth {

        position: absolute;

        bottom: 8px;

        left: 50%;

        transform: translateX(-50%);

        width: 12px;

        height: 6px;

        background: #333;

        border-radius: 0 0 12px 12px;

      }



      .chatbot-sparkles {

        position: absolute;

        top: -5px;

        right: -5px;

        display: flex;

        gap: 2px;

      }



      .sparkle {

        font-size: 12px;

        animation: sparkle 2s infinite;

      }



      .sparkle:nth-child(2) {

        animation-delay: 1s;

      }



      @keyframes sparkle {

        0%, 100% { opacity: 0.3; transform: scale(0.8); }

        50% { opacity: 1; transform: scale(1.2); }

      }



      .chatbot-badge {

        position: absolute;

        top: -8px;

        right: -8px;

        background: #ff4757;

        color: white;

        border-radius: 50%;

        width: 24px;

        height: 24px;

        display: flex;

        align-items: center;

        justify-content: center;

        font-size: 12px;

        font-weight: bold;

        animation: pulse 2s infinite;

      }



      @keyframes pulse {

        0% { transform: scale(1); }

        50% { transform: scale(1.1); }

        100% { transform: scale(1); }

      }



      /* OneShop Chatbot Popup - Bitu Style */

      .oneshop-chatbot-popup {

        position: fixed;

        bottom: 100px;

        right: 20px;

        width: 500px;
        height: 700px;

        background: #fef7f7;

        border-radius: 20px;

        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        
        /* Scale down to 80% */
        transform: scale(0.8);
        transform-origin: bottom right;

        z-index: 10020;

        display: flex;

        flex-direction: column;

        overflow: hidden;

        animation: slideUp 0.4s ease-out;

        border: 1px solid rgba(255, 107, 157, 0.2);

        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;

      }



      @keyframes slideUp {

        from {

          transform: translateY(100%) scale(0.8);

          opacity: 0;

        }

        to {

          transform: translateY(0) scale(1);

          opacity: 1;

        }

      }



      .chatbot-header {

        background: #fff;
        color: #333;

        padding: 15px 20px;

        display: flex;

        justify-content: space-between;

        align-items: center;

        border-bottom: 1px solid #e5e5e5;
      }



      .chatbot-title {

        display: flex;

        align-items: center;

        gap: 10px;

      }



      .title-icon {

        display: flex;

        align-items: center;

        gap: 5px;

      }


      .oneshop-logo-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #ff6b9d 0%, #ff8fab 100%);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 16px;
      }

      .title-text h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: #333;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      .chatbot-controls {
        display: flex;
        gap: 8px;
      }

      .control-btn {
        width: 36px;
        height: 36px;
        background: transparent;
        border: 1px solid #e5e5e5;
        border-radius: 50%;
        color: #666;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        font-size: 14px;
      }

      .control-btn:hover {
        background: #f8f9fa;
        border-color: #ccc;
        transform: scale(1.05);
      }

      .chatbot-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        padding: 0;
        background: #fff;
      }
      
      .welcome-message-simple {
        padding: 15px 20px;
        background: #f8f9fa;
        border-bottom: 1px solid #e5e5e5;
      }
      
      .welcome-message-simple p {
        margin: 0;
        font-size: 14px;
        color: #333;
        line-height: 1.5;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
      
      /* Suggested Topics */
      .suggested-topics {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        padding: 10px 20px;
        border-bottom: 1px solid #e5e5e5;
        flex-shrink: 0;
      }

      .topic-btn {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 13px;
        color: #333;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        line-height: 1.4;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      .topic-btn:hover {
        background: #e0e0e0;
        border-color: #ccc;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      /* Chatbot Introduction */
      .chatbot-intro {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        padding: 15px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(255, 107, 157, 0.1);
      }

      .intro-avatar {
        position: relative;
      }

      .oneshop-robot {
        width: 60px;
        height: 60px;
        position: relative;
      }

      .robot-body {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #ff6b9d 0%, #ff8fab 100%);
        border-radius: 50%;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .robot-face-large {

      }

      /* Suggested Topics */
      .suggested-topics {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        padding: 10px 20px;
        border-bottom: 1px solid #e5e5e5;
        flex-shrink: 0;
      }

      .topic-btn {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 13px;
        color: #333;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        line-height: 1.4;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      .topic-btn:hover {
        background: #e0e0e0;
        border-color: #ccc;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }



      /* Chatbot Introduction */

      .chatbot-intro {

        display: flex;

        align-items: center;

        gap: 15px;

        margin-bottom: 20px;

        padding: 15px;

        background: white;

        border-radius: 15px;

        box-shadow: 0 4px 15px rgba(255, 107, 157, 0.1);

      }



      .intro-avatar {

        position: relative;

      }



      .oneshop-robot {

        width: 60px;

        height: 60px;

        position: relative;

      }



      .robot-body {

        width: 60px;

        height: 60px;

        background: linear-gradient(135deg, #ff6b9d 0%, #ff8fab 100%);

        border-radius: 50%;

        position: relative;

        display: flex;

        align-items: center;

        justify-content: center;

      }



      .robot-face-large {

        width: 40px;

        height: 40px;

        background: white;

        border-radius: 50%;

        position: relative;

        display: flex;

        align-items: center;

        justify-content: center;

      }



      .robot-face-large .robot-eyes {

        top: 10px;

        gap: 8px;

      }



      .robot-face-large .eye {

        width: 6px;

        height: 6px;

      }



      .robot-face-large .robot-mouth {

        bottom: 10px;

        width: 12px;

        height: 6px;

      }



      .robot-chest {

        position: absolute;

        bottom: 8px;

        left: 50%;

        transform: translateX(-50%);

        width: 20px;

        height: 15px;

        background: white;

        border-radius: 8px;

        display: flex;

        align-items: center;

        justify-content: center;

      }



      .oneshop-logo {

        font-size: 8px;

        font-weight: bold;

        color: #ff6b9d;

      }



      .robot-arm {

        position: absolute;

        right: -8px;

        top: 15px;

        width: 12px;

        height: 20px;

        background: #ff6b9d;

        border-radius: 6px;

        animation: wave 2s infinite;

      }



      @keyframes wave {

        0%, 100% { transform: rotate(0deg); }

        50% { transform: rotate(20deg); }

      }



      .thinking-bubble {

        position: absolute;

        top: -15px;

        right: -10px;

        display: flex;

        gap: 2px;

      }



      .thinking-bubble span {

        width: 4px;

        height: 4px;

        background: #ff6b9d;

        border-radius: 50%;

        animation: thinking 1.5s infinite;

      }



      .thinking-bubble span:nth-child(2) {

        animation-delay: 0.3s;

      }



      .thinking-bubble span:nth-child(3) {

        animation-delay: 0.6s;

      }



      @keyframes thinking {

        0%, 100% { opacity: 0.3; transform: scale(0.8); }

        50% { opacity: 1; transform: scale(1.2); }

      }



      .intro-content h2 {

        margin: 0 0 5px 0;

        font-size: 18px;

        color: #333;

        display: flex;

        align-items: center;

        gap: 8px;

      }



      .ai-badge {

        background: linear-gradient(135deg, #ff6b9d 0%, #ff8fab 100%);

        color: white;

        padding: 2px 8px;

        border-radius: 10px;

        font-size: 10px;

        font-weight: bold;

      }



      .intro-tagline {

        margin: 0;

        font-size: 12px;

        color: #666;

        line-height: 1.4;

      }



      /* Welcome Section */

      .welcome-section {

        display: flex;

        gap: 12px;

        margin-bottom: 20px;

        padding: 15px;

        background: white;

        border-radius: 15px;

        box-shadow: 0 4px 15px rgba(255, 107, 157, 0.1);

      }



      .welcome-avatar {

        flex-shrink: 0;

      }



      .welcome-message p {

        margin: 0 0 10px 0;

        font-size: 14px;

        color: #333;

        line-height: 1.5;

      }



      .escalation-note {

        font-size: 12px;

        color: #666;

        font-style: italic;

      }

      /* Chat Messages - Scrollable - Scoped to AI Chatbot */
      #ai-chatbot-container .chat-messages {

        flex: 1;

        overflow-y: auto;

        padding: 20px;
        background: #fff;
        /* Reserve space for input + footer */
        padding-bottom: 140px;
      }

      #ai-chatbot-container .chat-message {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        align-items: flex-start;
      }

      #ai-chatbot-container .chat-message.user {
        /* User messages align to right - avatar on right side */
        justify-content: flex-end;
        flex-direction: row;
        align-items: flex-end;
      }
      
      /* AI messages stay left-aligned by default */
      #ai-chatbot-container .chat-message:not(.user) {
        justify-content: flex-start;
      }

      #ai-chatbot-container .message-avatar {

        width: 36px;

        height: 36px;

        border-radius: 50%;

        display: flex;

        align-items: center;

        justify-content: center;

        flex-shrink: 0;

      }


      #ai-chatbot-container .message-avatar.ai {

        background: linear-gradient(135deg, #ff6b9d 0%, #ff8fab 100%);

        color: white;

        font-size: 14px;
        font-weight: 600;

      }


      #ai-chatbot-container .message-avatar.user {

        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

        color: white;

        font-size: 14px;
        font-weight: 600;

      }

      #ai-chatbot-container .message-bubble {

        max-width: 75%;
        padding: 14px 18px;
        border-radius: 18px;
        font-size: 14px;
        line-height: 1.5;
        word-wrap: break-word;

        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      #ai-chatbot-container .message-bubble-ai {
        background: #f8f9fa;
        color: #333;
        border: 1px solid rgba(255, 107, 157, 0.15);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      }

      #ai-chatbot-container .message-bubble-user {
        background: linear-gradient(135deg, #ff6b9d 0%, #ff8fab 100%);
        color: white;
        /* User messages align to right with avatar on right side */
      }

      /* Legacy support - keep old classes for now */
      #ai-chatbot-container .message-bubble.ai {
        background: white;
        color: #333;
        border: 1px solid rgba(255, 107, 157, 0.2);
        box-shadow: 0 2px 8px rgba(255, 107, 157, 0.1);
      }

      #ai-chatbot-container .message-bubble.user {

        background: linear-gradient(135deg, #ff6b9d 0%, #ff8fab 100%);

        color: white;

      }


      /* Input Area - Fixed */
      .chatbot-input-area {
        background: #fff;
        border-top: 1px solid #e5e5e5;
        padding: 12px 20px;
        flex-shrink: 0;
        position: relative;
        z-index: 3;
        pointer-events: auto;
      }



      .input-label {

        font-size: 10px;
        color: #999;
        margin-bottom: 4px;
        font-weight: normal;
      }

      /* Scoped to chatbot AI popup to avoid conflicts with regular chat */
      #ai-chatbot-container .input-group {
        display: flex;
        align-items: center;
        gap: 8px;
        position: relative;
        z-index: 3;
        pointer-events: auto;
        width: 100%; /* Full width của chatbot-input-area */
      }

      /* Scoped to chatbot AI to avoid conflicts */
      #ai-chatbot-container .chatbot-input {
        flex: 1;
        min-width: 0; /* Allow input to shrink */
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #e5e5e5;
        min-height: 40px;
        border-radius: 20px;
        font-size: 14px;
        outline: none;
        transition: all 0.3s ease;
        background: #f8f9fa;
        position: relative;
        z-index: 3;
        pointer-events: auto;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      #ai-chatbot-container .chatbot-input:focus {
        border-color: #ff6b9d;
        box-shadow: 0 0 0 2px rgba(255, 107, 157, 0.1);
        background: #fff;
      }

      /* Scoped to chatbot AI to avoid conflicts */
      #ai-chatbot-container .upload-btn {
        width: 45px;
        height: 45px;
        background: #f8f9fa;
        border: 1px solid #e5e5e5;
        border-radius: 50%;
        color: #666;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        font-size: 18px;
        flex-shrink: 0;
        position: relative;
        z-index: 4;
        pointer-events: auto;
      }

      #ai-chatbot-container .upload-btn:hover {
        background: #e8e8e8;
        border-color: #ccc;
      }

      #ai-chatbot-container .image-preview {

        position: absolute;

        top: 5px;

        right: 5px;

        width: 24px;

        height: 24px;

        background: #ff4757;

        color: white;

        border: none;

        border-radius: 50%;

        cursor: pointer;

        display: flex;

        align-items: center;

        justify-content: center;

        font-size: 12px;

      }


      #ai-chatbot-container .remove-image-btn:hover {

        background: #ff6b7d;

      }



      #ai-chatbot-container .send-btn {
        width: 45px;
        height: 45px;
        background: #ff6b9d;

        border: none;

        border-radius: 50%;

        color: white;

        cursor: pointer;

        display: flex;

        align-items: center;

        justify-content: center;

        transition: all 0.3s ease;

        font-size: 18px;
        flex-shrink: 0;
        position: relative;
        z-index: 4;
        pointer-events: auto;
      }

      #ai-chatbot-container .send-btn:hover {
        background: #ff8fab;
        transform: scale(1.05);
      }

      #ai-chatbot-container .send-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      /* Footer with Disclaimer - Sticky */
      .chatbot-footer {
        background: #fff;
        border-top: 1px solid #e5e5e5;
        flex-shrink: 0;
        position: relative;
        z-index: 1;
      }

      /* Hide floating buttons when chatbot is open */
      body.oneshop-chatbot-popup-open #floatingChatButton,
      body.oneshop-chatbot-popup-open #oneshopChatbotButton {
        display: none !important;
      }

      /* ====== CHATBOT AI — FIX LỆCH CĂN ====== */
      /* Override tất cả rule CSS của chat thường để không ảnh hưởng chatbot AI */
      .oneshop-chatbot-popup #ai-chatbot-container .chat-message.user {
        justify-content: flex-end !important;
        flex-direction: row !important;
      }
      
      .oneshop-chatbot-popup #ai-chatbot-container .chat-message:not(.user) {
        justify-content: flex-start !important;
      }
      
      /* Đảm bảo input group nằm ngang và full width */
      .oneshop-chatbot-popup .chatbot-input-area {
        padding: 12px 16px !important;
      }
      
      .oneshop-chatbot-popup .chatbot-input-area .input-group {
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
        width: 100% !important;
      }

      /* ========== 1) CĂN VỊ TRÍ TIN NHẮN (AVATAR + BUBBLE) ========== */
      /* Danh sách tin nhắn cuộn dọc, không đổi thiết kế */
      .oneshop-chatbot-popup .chat-messages {
        display: flex;
        flex-direction: column;
        gap: 10px;
        overflow-y: auto;
      }

      /* Mỗi message = 1 hàng: avatar + bubble */
      .oneshop-chatbot-popup .chat-message {
        display: flex;
        align-items: flex-end;
        gap: 8px;
      }

      /* AI (bot) bên trái: avatar trái, bubble/phần nội dung bên phải */
      .oneshop-chatbot-popup .chat-message.ai {
        justify-content: flex-start;
        flex-direction: row;
      }
      .oneshop-chatbot-popup .chat-message.ai .message-avatar.ai {
        width: 30px; height: 30px; line-height: 30px; text-align: center;
        flex: 0 0 30px; border-radius: 50%;
        margin-right: 8px;
      }
      .oneshop-chatbot-popup .chat-message.ai .message-bubble.message-bubble-ai {
        max-width: 78%;
        word-break: break-word;
      }

      /* Trường hợp AI trả về khối sản phẩm không nằm trong bubble */
      .oneshop-chatbot-popup .chat-message.ai > .chatbot-products {
        max-width: 100%;
        overflow: hidden;
      }

      /* User bên phải: avatar ngoài cùng bên phải, bubble ở trái avatar */
      .oneshop-chatbot-popup .chat-message.user {
        justify-content: flex-end;
        flex-direction: row-reverse;
        align-self: flex-end;
        margin-left: auto;
      }
      .oneshop-chatbot-popup .chat-message.user .message-avatar.user {
        width: 30px; height: 30px; line-height: 30px; text-align: center;
        flex: 0 0 30px; border-radius: 50%;
        margin-left: 8px;
      }
      .oneshop-chatbot-popup .chat-message.user .message-bubble.message-bubble-user {
        max-width: 78%;
        word-break: break-word;
      }

      /* ========== 2) CĂN LẠI THANH NHẬP (UPLOAD + INPUT + SEND) ========== */
      .oneshop-chatbot-popup .chatbot-input-area {
        /* Giữ nguyên layout hiện tại, chỉ đảm bảo mọi thứ thẳng hàng */
        padding: 10px 14px;
        border-top: 1px solid #e5e7eb;
        box-sizing: border-box;
      }
      .oneshop-chatbot-popup .chatbot-input-area .input-group {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
      }

      /* Nút upload và gửi giữ kích thước gọn, không bị kéo giãn */
      .oneshop-chatbot-popup .chatbot-input-area .upload-btn,
      .oneshop-chatbot-popup .chatbot-input-area .send-btn {
        flex-shrink: 0;
        width: 38px; height: 38px;
        display: flex; align-items: center; justify-content: center;
        border: none; background: transparent; cursor: pointer;
      }

      /* Ô nhập giãn hết phần còn lại, không tràn */
      .oneshop-chatbot-popup .chatbot-input-area .chatbot-input {
        flex: 1;
        min-width: 0;
        height: 38px;
        box-sizing: border-box;
      }

      /* Nhãn "Bạn cần hỗ trợ gì?" chiếm 100% chiều ngang (tránh đẩy input lệch) */
      .oneshop-chatbot-popup .chatbot-input-area .input-label {
        display: block;
        width: 100%;
        margin-bottom: 6px;
      }

      /* Ảnh preview không làm bể hàng input */
      .oneshop-chatbot-popup .chatbot-input-area .image-preview {
        margin-bottom: 8px;
        max-width: 100%;
      }

      .disclaimer {
        margin: 6px 15px;
        padding: 6px 12px;
        background: #f8f9fb;
        border-radius: 6px;
        text-align: center;
      }



      .disclaimer small {

        color: #64748b;
        font-size: 10px;
        font-style: italic;
        line-height: 1.3;
        display: block;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;

      }



      /* Typing Indicator */

      .typing-indicator {

        display: flex;

        gap: 4px;

        align-items: center;

        padding: 10px 15px;

        background: white;

        border-radius: 15px;

        box-shadow: 0 2px 8px rgba(255, 107, 157, 0.1);

        margin-bottom: 10px;

        border: 1px solid rgba(255, 107, 157, 0.2);

      }



      .typing-indicator span {

        width: 8px;

        height: 8px;

        border-radius: 50%;

        background: #ff6b9d;

        animation: typing 1.4s infinite ease-in-out;

      }



      .typing-indicator span:nth-child(1) {

        animation-delay: -0.32s;

      }



      .typing-indicator span:nth-child(2) {

        animation-delay: -0.16s;

      }



      @keyframes typing {

        0%, 80%, 100% {

          transform: scale(0.8);

          opacity: 0.5;

        }

        40% {

          transform: scale(1);

          opacity: 1;

        }

      }



      /* Product Display Styles */

      .chatbot-products {

        max-width: 100%;

        margin-top: 10px;

      }



      .products-title {

        font-size: 13px;

        font-weight: 600;

        color: #ff6b9d;

        margin-bottom: 12px;

      }



      .products-grid {

        display: grid;

        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
      
      /* Responsive: Giữ nguyên 2x2 trên tất cả màn hình */
      @media (max-width: 600px) {
        .products-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 8px;
        }
      }



      .product-card {

        background: white;

        border-radius: 12px;

        overflow: hidden;

        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);

        transition: transform 0.3s ease, box-shadow 0.3s ease;

      }



      .product-card:hover {

        transform: translateY(-3px);

        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);

      }



      .product-image {

        position: relative;

        width: 100%;

        padding-top: 100%; /* Tăng tỷ lệ ảnh để ảnh gần vuông hơn */

        overflow: hidden;

      }



      .product-image img {

        position: absolute;

        top: 0;

        left: 0;

        width: 100%;

        height: 100%;

        object-fit: cover;

      }



      .product-discount {

        position: absolute;

        top: 6px;

        right: 6px;

        background: linear-gradient(135deg, #ff6b9d 0%, #ff8fab 100%);

        color: white;

        padding: 4px 8px;

        border-radius: 12px;

        font-size: 10px;

        font-weight: bold;

      }



      .product-info {

        padding: 12px;

      }



      .product-name {

        font-size: 14px;

        font-weight: 600;

        color: #333;

        margin: 0 0 6px 0;

        overflow: hidden;

        text-overflow: ellipsis;

        white-space: nowrap;

        line-height: 1.3;
      }



      .product-brand, .product-category {

        font-size: 11px;

        color: #666;

        margin: 2px 0;

      }



      .product-price {

        display: flex;

        align-items: center;

        gap: 8px;

        margin: 8px 0;

        flex-wrap: wrap;

      }



      .old-price {

        font-size: 11px;

        color: #999;

        text-decoration: line-through;

      }



      .current-price {

        font-size: 15px;
        font-weight: bold;

        color: #ff6b9d;

      }



      .product-button {

        display: block;

        width: 100%;

        padding: 8px;

        background: linear-gradient(135deg, #ff6b9d 0%, #ff8fab 100%);

        color: white;

        text-align: center;

        border-radius: 6px;

        font-size: 12px;

        text-decoration: none;

        transition: opacity 0.3s ease;

      }



      .product-button:hover {

        opacity: 0.9;

      }



      /* Error message */

      .error-message {

        background: #fef2f2;

        color: #dc2626;

        padding: 10px 15px;

        border-radius: 15px;

        border: 1px solid #fecaca;

        margin-bottom: 10px;

        font-size: 14px;

      }



      /* Drag and drop effect */

      .oneshop-chatbot-popup.drag-over {

        border: 3px dashed #ff6b9d;

        background: linear-gradient(135deg, #fff5f8 0%, #ffeef3 100%);

      }



      .oneshop-chatbot-popup.drag-over::before {

        content: 'Thả hình ảnh vào đây';

        position: absolute;

        top: 50%;

        left: 50%;

        transform: translate(-50%, -50%);

        background: rgba(255, 107, 157, 0.9);

        color: white;

        padding: 20px 40px;

        border-radius: 15px;

        font-size: 16px;

        font-weight: 600;

        z-index: 1000;

        pointer-events: none;

      }



      /* Responsive */

      @media (max-width: 768px) {

        .oneshop-chatbot-popup {

          width: 400px;
          height: 600px;
          right: 10px;

          bottom: 80px;
          
          /* Keep scale on mobile */
          transform: scale(0.8);
          transform-origin: bottom right;

        }

        

        .oneshop-chatbot-button {

          width: 60px;

          height: 60px;

          bottom: 15px;

          right: 15px;

        }



        .chatbot-icon {

          width: 40px;

          height: 40px;

        }



        .chatbot-avatar {

          width: 40px;

          height: 40px;

        }



        .robot-face {

          width: 30px;

          height: 30px;

        }



        .suggested-topics {

          grid-template-columns: 1fr;

        }

      }

    </style>



    <script>

      // OneShop Chatbot Functions - Bitu Style
      
      // Initialize chatbot state
      if (!window.chatbotState) {
        window.chatbotState = {
          isTyping: false,
          open: false,
          imageBase64: null,
          conversationHistory: []
        };
      }
      
      // Get user ID from localStorage or use 'guest' as default
      function getChatbotUserId() {
        try {
          // Get user info from JWT auth system
          const userInfoStr = localStorage.getItem('oneshop_user_info');
          if (userInfoStr) {
            const userInfo = JSON.parse(userInfoStr);
            // Return user ID from userInfo object (userInfo.user_id)
            if (userInfo && userInfo.user_id) {
              return `user_${userInfo.user_id}`;
            }
            // Fallback to email if user_id not available
            if (userInfo && userInfo.email) {
              return `user_${userInfo.email}`;
            }
          }
          return 'guest';
        } catch (e) {
          console.error('Error getting chatbot user ID:', e);
          return 'guest';
        }
      }
      
      // Get storage key for current user
      function getChatbotStorageKey() {
        return `oneshopChatbotHistory_${getChatbotUserId()}`;
      }
      
      // Load conversation history from localStorage (per user)
      function loadChatbotHistory() {
        try {
          const storageKey = getChatbotStorageKey();
          const savedHistory = localStorage.getItem(storageKey);
          if (savedHistory) {
            window.chatbotState.conversationHistory = JSON.parse(savedHistory);
            return true;
          }
        } catch (e) {
          console.error('Error loading chatbot history:', e);
        }
        return false;
      }
      
      // Save conversation history to localStorage (per user)
      function saveChatbotHistory() {
        try {
          const storageKey = getChatbotStorageKey();
          localStorage.setItem(storageKey, JSON.stringify(window.chatbotState.conversationHistory));
        } catch (e) {
          console.error('Error saving chatbot history:', e);
        }
      }
      
      // Render saved conversation history
      function renderChatbotHistory() {
        const messagesContainer = document.getElementById('aiChatbotMessages');
        const history = window.chatbotState.conversationHistory;
        
        if (!history || history.length === 0) {
          return;
        }
        
        // Clear welcome message and suggested topics
        hideIntroAndWelcome();
        
        // Render each message from history
        history.forEach(item => {
          if (item.role === 'user') {
            // Check if user message has image
            if (item.image) {
              addChatbotMessage(item.content, 'user', item.image);
            } else {
              addChatbotMessage(item.content, 'user');
            }
          } else if (item.role === 'model') {
            // Check if it's a products message
            if (item.type === 'products' && item.products) {
              // Restore products display (skip history to avoid duplicates)
              displayProducts(item.products, true);
            } else {
              // Regular text message
              addChatbotMessage(item.content, 'ai');
            }
          }
        });
      }
      
      // Load history when chatbot opens
      window.loadChatbotHistory = loadChatbotHistory;
      window.saveChatbotHistory = saveChatbotHistory;
      window.renderChatbotHistory = renderChatbotHistory;

      // Define all functions first
      function toggleOneshopChatbot() {

        const popup = document.getElementById('floatingChatbotPopup');

        const button = document.getElementById('oneshopChatbotButton');

        const isHidden = getComputedStyle(popup).display === 'none';
        const open = isHidden;

        popup.style.display = open ? 'flex' : 'none';
        button.style.transform = open ? 'scale(0.9)' : 'scale(1)';
        window.chatbotState.open = open;

        document.body.classList.toggle('oneshop-chatbot-popup-open', open);
        document.body.classList.toggle('chatbot-open', open);

        if (open) {
          hideChatbotBadge();
          
          // Load conversation history from localStorage for current user
          loadChatbotHistory();
          
          // Check if there's history to render
          if (window.chatbotState.conversationHistory && window.chatbotState.conversationHistory.length > 0) {
            // Clear current messages first
            const messagesContainer = document.getElementById('aiChatbotMessages');
            if (messagesContainer) {
              messagesContainer.innerHTML = '';
            }
            // Render saved history
            renderChatbotHistory();
          }
          
          setTimeout(() => {
            const inp = document.getElementById('aiChatbotMessageInput');
            if (inp) inp.focus();
          }, 400);

        }

      }

      // Expose toggleOneshopChatbot immediately
      window.toggleOneshopChatbot = toggleOneshopChatbot;

      function closeOneshopChatbot() {

        const popup = document.getElementById('floatingChatbotPopup');

        const button = document.getElementById('oneshopChatbotButton');

        

        popup.style.display = 'none';

        button.style.transform = 'scale(1)';
        
        // Update chatbot state
        window.chatbotState.open = false;
        
        // Remove body classes
        document.body.classList.remove('oneshop-chatbot-popup-open');
        document.body.classList.remove('chatbot-open');

      }

      // Expose closeOneshopChatbot immediately  
      window.closeOneshopChatbot = closeOneshopChatbot;

      function refreshChatbot() {

        // Clear messages and reset

        const messagesContainer = document.getElementById('aiChatbotMessages');

        messagesContainer.innerHTML = '';
        
        // Clear conversation history
        window.chatbotState.conversationHistory = [];
        
        // Clear localStorage history for current user
        const storageKey = getChatbotStorageKey();
        localStorage.removeItem(storageKey);

        

        // Show intro and welcome sections again

        const introSection = document.querySelector('.chatbot-intro');

        const welcomeSection = document.querySelector('.welcome-section');

        const suggestedTopics = document.querySelector('.suggested-topics');

        

        if (introSection) {

          introSection.style.display = 'flex';

        }

        if (welcomeSection) {

          welcomeSection.style.display = 'flex';

        }

        if (suggestedTopics) {

          suggestedTopics.style.display = 'grid';

        }

        

        // Show welcome message again

        showWelcomeMessage();

      }

      // Expose refreshChatbot immediately
      window.refreshChatbot = refreshChatbot;

      function hideIntroAndWelcome() {

        const introSection = document.querySelector('.chatbot-intro');

        const welcomeSection = document.querySelector('.welcome-section');

        const suggestedTopics = document.querySelector('.suggested-topics');

        

        if (introSection) {

          introSection.style.display = 'none';

        }

        if (welcomeSection) {

          welcomeSection.style.display = 'none';

        }

        if (suggestedTopics) {

          suggestedTopics.style.display = 'none';

        }

      }

      
      function sendChatbotMessage() {
        const input = document.getElementById('aiChatbotMessageInput');
        const sendBtn = document.getElementById('aiChatbotSendBtn');
        const message = input.value.trim();

        if (!message || window.chatbotState.isTyping) {

          return;

        }

        

        // Hide intro and welcome sections on first message

        hideIntroAndWelcome();

        

        // Disable input and button

        input.disabled = true;

        sendBtn.disabled = true;

        window.chatbotState.isTyping = true;

        

        // Add user message

        addChatbotMessage(message, 'user');

        

        // Thêm vào lịch sử
        window.chatbotState.conversationHistory.push({ role: 'user', content: message });
        
        // Save history to localStorage
        saveChatbotHistory();
        
        // Clear input

        input.value = '';

        

        // Show typing indicator

        showChatbotTypingIndicator();

        

        // Call REST API instead of WebSocket

        fetch('/api/ai/chat', {

          method: 'POST',

          headers: {

            'Content-Type': 'application/json'

          },

          body: JSON.stringify({

            message: message,

            context: 'OneShop mỹ phẩm',

            history: window.chatbotState.conversationHistory
          })

        })

        .then(response => {

          if (!response.ok) {

            throw new Error('Network response was not ok');

          }

          return response.json();

        })

        .then(data => {

          hideChatbotTypingIndicator();

          

          if (data.status === 'success') {

            addChatbotMessage(data.message, 'ai');
            
            // Thêm phản hồi AI vào lịch sử
            window.chatbotState.conversationHistory.push({ role: 'model', content: data.message });
            
            // Save history to localStorage
            saveChatbotHistory();

            // Check if message contains product-related keywords and search for products

            const productKeywords = ['sản phẩm', 'kem', 'son', 'mỹ phẩm', 'nước hoa', 'serum', 'tư vấn', 'giới thiệu', 'bạn có', 'có gì'];

            const hasProductKeyword = productKeywords.some(keyword => message.toLowerCase().includes(keyword));

            

            if (hasProductKeyword) {

              // Search for related products

              fetch('/api/ai/search-products', {

                method: 'POST',

                headers: {

                  'Content-Type': 'application/json'

                },

                body: JSON.stringify({

                  query: message

                })

              })

              .then(response => response.json())

              .then(productData => {

                if (productData.status === 'success' && productData.products && productData.products.length > 0) {

                  // Display products

                  displayProducts(productData.products);

                }

              })

              .catch(err => {

                console.error('Error searching products:', err);

              });

            }

          } else {

            addChatbotMessage('Xin lỗi, có lỗi xảy ra: ' + (data.message || 'Vui lòng thử lại'), 'ai');

          }

        })

        .catch(error => {

          console.error('Error calling AI:', error);

          hideChatbotTypingIndicator();

          addChatbotMessage('Xin lỗi, không thể kết nối với AI. Vui lòng thử lại sau.', 'ai');

        })

        .finally(() => {

          // Re-enable input and button

          input.disabled = false;

          sendBtn.disabled = false;

          window.chatbotState.isTyping = false;
          input.focus();

        });

      }



      function sendSuggestedMessage(message) {

        const input = document.getElementById('aiChatbotMessageInput');
        if (!input) return;
        
        input.value = message;

        // Hide suggested topics
        hideIntroAndWelcome();

        // Trigger send
        sendChatbotMessage();

      }

      function addChatbotMessage(content, type, imageBase64) {
        const messagesContainer = document.getElementById('aiChatbotMessages');

        

        const messageDiv = document.createElement('div');

        messageDiv.className = `chat-message ${type}`;

        

        const avatarDiv = document.createElement('div');

        avatarDiv.className = `message-avatar ${type}`;

        avatarDiv.textContent = type === 'user' ? '👤' : '🤖';
        
        const bubbleDiv = document.createElement('div');

        bubbleDiv.className = 'message-bubble';

        // If there's an image, display it
        if (imageBase64) {
          const imageWrapper = document.createElement('div');
          imageWrapper.className = 'chatbot-image-wrapper';
          
          const image = document.createElement('img');
          
          // Check if base64 already has data: prefix, if not add it
          let imageSrc = imageBase64;
          if (!imageBase64.startsWith('data:image')) {
            imageSrc = `data:image/jpeg;base64,${imageBase64}`;
          }
          
          image.src = imageSrc;
          image.className = 'chatbot-uploaded-image';
          image.style.maxWidth = '200px';
          image.style.maxHeight = '200px';
          image.style.borderRadius = '8px';
          image.style.marginBottom = '8px';
          
          imageWrapper.appendChild(image);
          bubbleDiv.appendChild(imageWrapper);
        }

        // Format content for better readability (convert numbered lists to HTML)
        const formattedContent = formatMessageContent(content);
        if (content && content.trim()) {
          const textDiv = document.createElement('div');
          textDiv.innerHTML = formattedContent;
          bubbleDiv.appendChild(textDiv);
        }
        
        // Add class to differentiate bubble styling
        bubbleDiv.classList.add(`message-bubble-${type}`);

        messageDiv.appendChild(avatarDiv);

        messageDiv.appendChild(bubbleDiv);

        messagesContainer.appendChild(messageDiv);

        

        // Scroll to bottom

        messagesContainer.scrollTop = messagesContainer.scrollHeight;

      }
      
      // Helper function to format message content (ChatGPT style - convert to proper HTML)
      function formatMessageContent(text) {
        // Escape HTML to prevent XSS
        let safeText = text
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
        
        // Convert **text** to bold
        safeText = safeText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        // Split into lines
        const lines = safeText.replace(/\r\n/g, '\n').split('\n');
        let html = '';
        let inOl = false, inUl = false;

        const openOl = () => { if (!inOl) { html += '<ol>'; inOl = true; } };
        const closeOl = () => { if (inOl) { html += '</ol>'; inOl = false; } };
        const openUl = () => { if (!inUl) { html += '<ul>'; inUl = true; } };
        const closeUl = () => { if (inUl) { html += '</ul>'; inUl = false; } };

        for (const raw of lines) {
          const line = raw.trim();

          if (/^\d+\.\s+/.test(line)) {
            // numbered list: 1. 2. 3.
            closeUl(); openOl();
            html += '<li>' + line.replace(/^\d+\.\s+/, '') + '</li>';
          } else if (/^[\*\-]\s+/.test(line)) {
            // bullet list: *  hoặc -
            closeOl(); openUl();
            html += '<li>' + line.replace(/^[\*\-]\s+/, '') + '</li>';
          } else if (line === '') {
            // dòng trống -> ngắt đoạn
            closeOl(); closeUl();
            html += '<br>';
          } else {
            // đoạn văn bình thường
            closeOl(); closeUl();
            html += '<p>' + line + '</p>';
          }
        }
        closeOl(); closeUl();
        
        return html;
      }



      function displayProducts(products, skipHistory) {

        const messagesContainer = document.getElementById('aiChatbotMessages');

        

        // Create product container

        const productContainer = document.createElement('div');

        productContainer.className = 'chatbot-products';

        productContainer.innerHTML = '<div class="products-title">📦 Sản phẩm liên quan:</div><div class="products-grid"></div>';

        

        const productsGrid = productContainer.querySelector('.products-grid');

        

        // Display each product as a card

        products.forEach(product => {

          const productCard = document.createElement('div');

          productCard.className = 'product-card';

          


          const finalPrice = product.discount > 0 

            ? product.price * (100 - product.discount) / 100 

            : product.price;

          

          // Get product image - mỗi product_id tương ứng với product_image từ database
          let imageUrl = '/assets/img/examples/product1.jpg'; // Default fallback
          
          if (product.image) {
            // Nếu là URL Cloudinary (http/https)
            if (product.image.startsWith('http://') || product.image.startsWith('https://')) {
              imageUrl = product.image;
            } 
            // Nếu là local file, sử dụng endpoint /loadImage
            else if (product.image.includes('upload') || product.image.includes('images')) {
              // Đây là file upload local
              imageUrl = `/loadImage?imageName=${encodeURIComponent(product.image)}`;
            }
            // Nếu chỉ có tên file (như kemEAU.png)
            else {
              imageUrl = `/loadImage?imageName=${encodeURIComponent(product.image)}`;
            }
          } else if (product.imageUrl) {
            imageUrl = product.imageUrl.startsWith('http') 
              ? product.imageUrl 
              : `/loadImage?imageName=${encodeURIComponent(product.imageUrl)}`;
          }
          
          console.log(`Product ID: ${product.id}, Name: ${product.name}`);
          console.log(`Original image path: ${product.image || product.imageUrl}`);
          console.log(`Final image URL: ${imageUrl}`);
          
          productCard.innerHTML = `

            <div class="product-image">

              <img src="${imageUrl}" alt="${product.name}" 
                   onerror="console.error('Image failed for product ${product.id}: ${imageUrl}'); this.src='/assets/img/examples/product1.jpg'">
              ${product.discount > 0 ? `<span class="product-discount">-${product.discount}%</span>` : ''}

            </div>

            <div class="product-info">

              <h4 class="product-name">${product.name}</h4>

              ${product.brand ? `<p class="product-brand">Thương hiệu: ${product.brand}</p>` : ''}

              ${product.category ? `<p class="product-category">Loại: ${product.category}</p>` : ''}

              <div class="product-price">

                ${product.discount > 0 ? `<span class="old-price">${product.price.toLocaleString('vi-VN')}₫</span>` : ''}

                <span class="current-price">${finalPrice.toLocaleString('vi-VN')}₫</span>

              </div>

              <a href="/productDetail?id=${product.id}" class="product-button">Xem chi tiết</a>

            </div>

          `;

          

          productsGrid.appendChild(productCard);

        });

        

        // Add product container to messages

        const messageDiv = document.createElement('div');

        messageDiv.className = 'chat-message ai';

        

        const avatarDiv = document.createElement('div');

        avatarDiv.className = 'message-avatar ai';

        avatarDiv.textContent = '🤖';

        

        messageDiv.appendChild(avatarDiv);

        messageDiv.appendChild(productContainer);

        messagesContainer.appendChild(messageDiv);
        
        // Save products to conversation history (skip if rendering from history)
        if (!skipHistory) {
          window.chatbotState.conversationHistory.push({
            role: 'model',
            type: 'products',
            products: products,
            content: '📦 Sản phẩm liên quan'
          });
          
          // Save to localStorage
          saveChatbotHistory();
        }

        // Scroll to bottom

        messagesContainer.scrollTop = messagesContainer.scrollHeight;

      }



      function showChatbotTypingIndicator() {

        const messagesContainer = document.getElementById('aiChatbotMessages');

        

        // Remove existing typing indicator

        const existingTyping = document.getElementById('chatbotTypingIndicator');

        if (existingTyping) {

          existingTyping.remove();

        }

        

        const typingDiv = document.createElement('div');

        typingDiv.id = 'chatbotTypingIndicator';

        typingDiv.className = 'typing-indicator';

        typingDiv.innerHTML = `

          <span></span>

          <span></span>

          <span></span>

        `;

        

        messagesContainer.appendChild(typingDiv);

        messagesContainer.scrollTop = messagesContainer.scrollHeight;

      }



      function hideChatbotTypingIndicator() {

        const typingIndicator = document.getElementById('chatbotTypingIndicator');

        if (typingIndicator) {

          typingIndicator.remove();

        }

      }



      function showChatbotBadge() {

        const badge = document.getElementById('chatbotBadge');

        badge.style.display = 'flex';

      }



      function hideChatbotBadge() {

        const badge = document.getElementById('chatbotBadge');

        badge.style.display = 'none';

      }



      function showWelcomeMessage() {

        // This function can be used to show welcome message again if needed

        console.log('Welcome message shown');

      }



      // Image upload handling

      function handleImageUpload(event) {

        const file = event.target.files[0];

        if (!file) return;



        // Validate file type

        if (!file.type.startsWith('image/')) {

          alert('Vui lòng chọn file hình ảnh');

          return;

        }



        // Validate file size (max 5MB)

        if (file.size > 5 * 1024 * 1024) {

          alert('Kích thước file không được vượt quá 5MB');

          return;

        }



        const reader = new FileReader();

        reader.onload = function(e) {

          window.chatbotState.imageBase64 = e.target.result;

          

          // Show preview

          const preview = document.getElementById('aiChatbotImagePreview');
          const previewImg = document.getElementById('aiChatbotPreviewImg');
          previewImg.src = window.chatbotState.imageBase64;
          preview.style.display = 'block';

        };

        reader.readAsDataURL(file);

      }


      function removeImagePreview() {
        window.chatbotState.imageBase64 = null;
        const preview = document.getElementById('aiChatbotImagePreview');
        preview.style.display = 'none';
        document.getElementById('aiChatbotImageInput').value = '';
      }

      function sendChatbotMessageWithImage() {
        const input = document.getElementById('aiChatbotMessageInput');
        const sendBtn = document.getElementById('aiChatbotSendBtn');
        const message = input.value.trim() || 'Phân tích hình ảnh này cho tôi';

        

        if (window.chatbotState.isTyping) return;
        

        // Disable input and button

        input.disabled = true;

        sendBtn.disabled = true;

        window.chatbotState.isTyping = true;
        

        // Hide intro and welcome

        hideIntroAndWelcome();
        
        // Add user message FIRST (before AI response)
        addChatbotMessage(message, 'user', window.chatbotState.imageBase64);
        
        // Save user message with image to conversation history
        window.chatbotState.conversationHistory.push({
          role: 'user',
          content: message,
          image: window.chatbotState.imageBase64
        });
        
        // Save to localStorage
        saveChatbotHistory();

        

        // Show typing indicator

        showChatbotTypingIndicator();

        

        // Validate image data before sending

        if (!window.chatbotState.imageBase64) {

          console.error('No image data to send');

          hideChatbotTypingIndicator();

          addChatbotMessage('Vui lòng chọn hình ảnh để gửi.', 'ai');

          input.disabled = false;

          sendBtn.disabled = false;

          window.chatbotState.isTyping = false;
          return;

        }



        // Prepare request body

        const requestBody = {

          message: message,

          imageData: window.chatbotState.imageBase64
        };

        console.log('Sending image to AI, image size:', window.chatbotState.imageBase64.length);


        // Call API with image

        fetch('/api/ai/upload-image', {

          method: 'POST',

          headers: {

            'Content-Type': 'application/json'

          },

          body: JSON.stringify(requestBody)

        })

        .then(response => {

          console.log('Response status:', response.status);

          if (!response.ok) {

            return response.json().then(err => {

              console.error('API error:', err);

              throw new Error(err.message || 'Network response was not ok');

            }).catch(() => {

              throw new Error('Network response was not ok');

            });

          }

          return response.json();

        })

        .then(data => {

          console.log('Response data:', data);

          hideChatbotTypingIndicator();

          

          if (data.status === 'success') {

            addChatbotMessage(data.message, 'ai');
            
            // Save AI response to conversation history
            window.chatbotState.conversationHistory.push({
              role: 'model',
              content: data.message
            });
            
            // Save to localStorage
            saveChatbotHistory();

          } else {

            addChatbotMessage('Xin lỗi, có lỗi xảy ra: ' + (data.message || 'Vui lòng thử lại'), 'ai');

          }

        })

        .catch(error => {

          console.error('Error calling AI with image:', error);

          hideChatbotTypingIndicator();

          addChatbotMessage('Xin lỗi, không thể xử lý hình ảnh: ' + error.message, 'ai');

        })

        .finally(() => {

          // Clear input and image after sending

          input.value = '';

          removeImagePreview();

          

          input.disabled = false;

          sendBtn.disabled = false;

          window.chatbotState.isTyping = false;
          input.focus();

        });

      }

      // Expose remaining functions globally BEFORE DOMContentLoaded
      // (toggleOneshopChatbot, closeOneshopChatbot, refreshChatbot already exposed immediately above)
      window.hideIntroAndWelcome = hideIntroAndWelcome;
      window.showWelcomeMessage = showWelcomeMessage;
      window.sendChatbotMessage = sendChatbotMessage;
      window.sendChatbotMessageWithImage = sendChatbotMessageWithImage;
      window.sendSuggestedMessage = sendSuggestedMessage;
      window.handleImageUpload = handleImageUpload;
      window.removeImagePreview = removeImagePreview;
      window.hideChatbotBadge = hideChatbotBadge;
      window.showChatbotBadge = showChatbotBadge;
      window.showChatbotTypingIndicator = showChatbotTypingIndicator;
      window.hideChatbotTypingIndicator = hideChatbotTypingIndicator;
      window.addChatbotMessage = addChatbotMessage;
      window.displayProducts = displayProducts;

      // Flag to ensure we only bind once
      // Enter key support - Single initialization with window flag
      document.addEventListener('DOMContentLoaded', function() {

        // Initialize chatbot popup size
        // initializeChatbotPopup(); // Function not defined yet

        // Reset possible pre-bound listeners by cloning elements
        const __idsToReset = ['aiChatbotMessageInput','aiChatbotSendBtn','aiChatbotUploadBtn','aiChatbotImageInput'];
        __idsToReset.forEach(id => {
          const el = document.getElementById(id);
          if (!el || !el.parentNode) return;
          const fresh = el.cloneNode(true);
          el.parentNode.replaceChild(fresh, el);
        });

        // Bind event listeners only once
        const chatbotInput = document.getElementById('aiChatbotMessageInput');
        const chatbotBody = document.getElementById('floatingChatbotPopup');
        const aiChatbotSendBtn = document.getElementById('aiChatbotSendBtn');
        const uploadBtn = document.getElementById('aiChatbotUploadBtn');
        const aiImageInput = document.getElementById('aiChatbotImageInput');
        const chatbotToggleBtn = document.getElementById('oneshopChatbotButton');
        const refreshBtn = document.querySelector('#floatingChatbotPopup .refresh-btn');
        const closeBtn = document.querySelector('#floatingChatbotPopup .close-btn');

        // Functions are already exposed globally above (before DOMContentLoaded)
          
          if (chatbotInput) {
            chatbotInput.addEventListener('keydown', function(e) {
              if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                
                // Check if there's an image ready to send
                if (window.chatbotState.imageBase64) {
                  sendChatbotMessageWithImage();
                } else {
                  sendChatbotMessage();
                }
              }
            });
          }

          // Click on send button (no onclick in HTML)
          if (aiChatbotSendBtn) {
            aiChatbotSendBtn.addEventListener('click', function() {
              if (window.chatbotState.imageBase64) {
                sendChatbotMessageWithImage();
              } else {
                sendChatbotMessage();
              }
            });
          }

          // Click on upload button (no onclick in HTML)
          if (uploadBtn) {
            uploadBtn.addEventListener('click', function() {
              document.getElementById('aiChatbotImageInput').click();
            });
          }

          // Bind file input change once (avoid inline handler duplication)
          if (aiImageInput) {
            aiImageInput.addEventListener('change', handleImageUpload);
          }
          
          // Drag and drop functionality
          if (chatbotBody) {
            chatbotBody.addEventListener('dragover', function(e) {
              e.preventDefault();
              e.stopPropagation();
              chatbotBody.classList.add('drag-over');
            });

            chatbotBody.addEventListener('dragleave', function(e) {
              e.preventDefault();
              e.stopPropagation();
              chatbotBody.classList.remove('drag-over');
            });

            chatbotBody.addEventListener('drop', function(e) {
              e.preventDefault();
              e.stopPropagation();
              chatbotBody.classList.remove('drag-over');
              
              const files = e.dataTransfer.files;
              if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                  const reader = new FileReader();
                  reader.onload = function(event) {
                    window.chatbotState.imageBase64 = event.target.result;
                    
                    // Show preview
                    const preview = document.getElementById('aiChatbotImagePreview');
                    const previewImg = document.getElementById('aiChatbotPreviewImg');
                    if (preview && previewImg) {
                      previewImg.src = window.chatbotState.imageBase64;
                      preview.style.display = 'block';
                    }
                  };
                  reader.readAsDataURL(file);
                } else {
                  alert('Vui lòng kéo thả file hình ảnh');
                }
              }
            });
          }
      });

      // Paste from clipboard - Global event listener (bind once)
      if (!window.chatbotPasteBound) {
        window.chatbotPasteBound = true;
        document.addEventListener('paste', function(e) {
          // Only handle paste when chatbot is open
          if (!window.chatbotState.open) return;
            
            const items = e.clipboardData.items;
            let hasImage = false;
            
            // Check if clipboard contains image
            // Process each clipboard item
            for (let i = 0; i < items.length; i++) {
              if (items[i].type.indexOf('image') !== -1) {
                hasImage = true;
                const blob = items[i].getAsFile();
                
                if (!blob) continue;
                
                // Validate file size (max 5MB)
                if (blob.size > 5 * 1024 * 1024) {
                  alert('Kích thước hình ảnh quá lớn (tối đa 5MB)');
                  return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                  window.chatbotState.imageBase64 = event.target.result;
                  
                  // Show preview
                  const preview = document.getElementById('aiChatbotImagePreview');
                  const previewImg = document.getElementById('aiChatbotPreviewImg');
                  if (preview && previewImg) {
                    previewImg.src = window.chatbotState.imageBase64;
                    preview.style.display = 'block';
                  }
                  
                  // Hide intro when image is pasted
                  hideIntroAndWelcome();
                  
                  console.log('Image pasted from clipboard, size:', window.chatbotState.imageBase64.length);
                };
                reader.readAsDataURL(blob);
                e.preventDefault();
                break; // Only process first image
              }
            }
            
            // If image was pasted, prevent default text paste
            if (hasImage) {
              e.preventDefault();
            }
          });

        }



      // Hide badge when chat is opened

      document.addEventListener('click', function(e) {

        if (e.target.closest('#floatingChatbotPopup')) {

          hideChatbotBadge();

        }

      });



      // Auto-hide suggested topics after first message

      let suggestedTopicsHidden = false;

      function hideSuggestedTopics() {

        if (!suggestedTopicsHidden) {

          const suggestedTopics = document.querySelector('.suggested-topics');

          if (suggestedTopics) {

            suggestedTopics.style.display = 'none';

            suggestedTopicsHidden = true;

          }

        }

      }

    </script>

  </body>

</html>




