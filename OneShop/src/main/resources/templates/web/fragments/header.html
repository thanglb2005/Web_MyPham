<!DOCTYPE html>
<html lang="" xmlns:th="http://www.thymeleaf.org">
  <head>
    <title></title>
    <link rel="stylesheet" href="/vendor/bootstrap/bootstrap.min.css" />
    <link rel="stylesheet" href="/fonts/fontawesome/fontawesome.min.css" />
    <script src="/vendor/bootstrap/jquery-1.12.4.min.js"></script>
    <script src="/vendor/bootstrap/bootstrap.min.js"></script>
    <script src="/assets/js/plugin/sweetalert/sweetalert.min.js"></script>
    <style>
      /* Improve visibility of cart count badge */
      .header-part .header-widget { position: relative; }
      .header-part .header-widget .cart-count {
        position: absolute;
        top: -6px;
        right: -8px;
        background: #0db1fd; /* theme primary blue */
        color: #ffffff !important; /* white text for contrast */
        border: 2px solid #fff;
        border-radius: 999px;
        min-width: 20px;
        height: 18px;
        padding: 0 5px;
        line-height: 16px;
        font-size: 8px;
        font-weight: 700;
        text-align: center;
        box-shadow: 0 2px 6px rgba(0,0,0,.2);
        transform-origin: center;
      }
      @keyframes cart-bump { 0% { transform: scale(1); } 30% { transform: scale(1.15); } 100% { transform: scale(1); } }
      .header-part .header-widget .cart-count.badge-bump { animation: cart-bump .25s ease-out; }
      @media (min-width: 992px) {
        .header-part .header-widget .cart-count {
          top: -8px;
          right: -10px;
          min-width: 20px;
          height: 20px;
          line-height: 18px;
          font-size: 11px;
        }
      }
    </style>
  </head>
  <body>
    <th:block th:fragment="header">
      <div class="backdrop"></div>
      <a class="backtop fas fa-arrow-up" href="#"></a>
      <header class="header-part">
        <div class="container">
          <div class="header-content">
            <a th:href="@{/}" class="header-logo">
              <img src="/images/logo/logo.png" alt="logo" />
            </a>
            <form
              th:action="@{/searchProduct}"
              method="get"
              class="header-form"
            >
              <input
                type="text"
                name="productName"
                th:value="${keyword}"
                placeholder="Tìm kiếm..."
                autocomplete="off"
              />
              <button><i class="fas fa-search"></i></button>
            </form>
            <div class="header-widget-group">
              <a
                th:href="@{/profile}"
                class="header-widget"
                title="Trang cá nhân"
              >
                <i class="fas fa-user"></i>
              </a>
              <a th:href="@{/products}" class="header-widget" title="Sản phẩm">
                <i class="fas fa-store"></i>
              </a>
              <th:block th:if="${session.user != null}">
                <a th:href="@{/cart}" class="header-widget" title="Giỏ hàng">
                  <i class="fas fa-shopping-cart"></i>
                  <span class="cart-count" th:text="${session.cartMap != null ? session.cartMap.size() : (totalCartItems != null ? totalCartItems : 0)}">0</span>
                </a>
              </th:block>
              <th:block th:if="${session.user != null}">
                <a th:href="@{/logout}" class="header-widget" title="Đăng xuất">
                  <i class="fas fa-sign-out-alt"></i>
                </a>
              </th:block>
              <th:block
                th:if="${session.user == null or (#lists.isEmpty(session.user.roles.?[name=='ROLE_VENDOR']) and #lists.isEmpty(session.user.roles.?[name=='ROLE_ADMIN']))}"
              >
                <a th:href="@{/chat}" class="header-widget" title="Chat tư vấn">
                  <i class="fas fa-comments"></i>
                </a>
              </th:block>
              <th:block
                th:if="${session.user != null and (!#lists.isEmpty(session.user.roles.?[name=='ROLE_VENDOR']) or !#lists.isEmpty(session.user.roles.?[name=='ROLE_ADMIN']))}"
              >
                <a
                  th:href="@{/admin/vendor-chat}"
                  class="header-widget"
                  title="Vendor Chat"
                >
                  <i class="fas fa-headset"></i>
                </a>
              </th:block>
            </div>
          </div>
        </div>
      </header>
      <nav class="navbar-part">
        <div class="container">
          <div class="row">
            <div class="col-lg-12">
              <div class="navbar-content">
                <ul class="navbar-list">
                  <li class="navbar-item">
                    <a class="navbar-link" th:href="@{/}">Trang chủ</a>
                  </li>
                  <li class="navbar-item">
                    <a class="navbar-link" th:href="@{/products}">Sản phẩm</a>
                  </li>
                  <li class="navbar-item dropdown">
                    <a
                      class="navbar-link dropdown-arrow"
                      href="javascript:void(0);"
                      >Thể loại</a
                    >
                    <ul class="dropdown-position-list">
                      <li th:each="item : ${categories}">
                        <a
                          th:href="@{/productByCategory(id=${item.categoryId})}"
                          >[[${item.categoryName}]]</a
                        >
                      </li>
                    </ul>
                  </li>
                  <li class="navbar-item">
                    <a class="navbar-link" th:href="@{/contact}">Liên hệ</a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </nav>
      <style>
        /* Keep local override in case other styles load later */
        .header-part .header-widget .cart-count {
          background: #0e98dd !important;
          color: #ffffff !important;
          font-size: 12px !important; /* smaller numeral only */
          font-weight: 600 !important;
        }
      </style>
      <script src="/assets/js/plugin/sweetalert/sweetalert.min.js"></script>
      <script th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', function () {
          // Ensure cart-count reflects current session value
          try {
            if (window.fetch) {
              fetch('/cart/count', { credentials: 'same-origin' })
                .then(function(res){ return res.ok ? res.text() : '0'; })
                .then(function(txt){
                  var val = parseInt(txt, 10);
                  if (!isNaN(val)) {
                    var el = document.querySelector('.cart-count');
                    if (el) {
                      var old = el.textContent;
                      el.textContent = String(val);
                      if (old !== String(val)) {
                        el.classList.remove('badge-bump');
                        // force reflow for animation restart
                        void el.offsetWidth;
                        el.classList.add('badge-bump');
                        setTimeout(function(){ el.classList.remove('badge-bump'); }, 300);
                      }
                    }
                  }
                })
                .catch(function(){});
            }
          } catch (e) {}

          var successMsg = /*[[${success}]]*/ null;
          var errorMsg = /*[[${error}]]*/ null;
          function showFallbackToast(text, type) {
            var el = document.createElement('div');
            el.textContent = text;
            el.style.position = 'fixed';
            el.style.top = '16px';
            el.style.right = '16px';
            el.style.zIndex = '9999';
            el.style.padding = '10px 14px';
            el.style.borderRadius = '6px';
            el.style.color = '#fff';
            el.style.background = type === 'error' ? '#dc3545' : '#198754';
            el.style.boxShadow = '0 4px 12px rgba(0,0,0,.15)';
            document.body.appendChild(el);
            setTimeout(function(){ el.remove(); }, 2000);
          }
          function showAlert(text, type) {
            if (window.swal) {
              swal({ title: type === 'error' ? 'Lỗi' : 'Thành công', text: text, icon: type === 'error' ? 'error' : 'success', timer: 1800, buttons: false });
            } else {
              showFallbackToast(text, type);
            }
          }
          if (typeof successMsg === 'string' && successMsg.length > 0) { showAlert(successMsg, 'success'); }
          if (typeof errorMsg === 'string' && errorMsg.length > 0) { showAlert(errorMsg, 'error'); }
        });
        /*]]>*/
      </script>
    </th:block>
  </body>
</html>
