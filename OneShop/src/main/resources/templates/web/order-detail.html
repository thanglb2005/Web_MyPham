<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chi tiết đơn hàng</title>
  <link rel="stylesheet" th:href="@{/vendor/bootstrap/bootstrap.min.css}" />
  <link rel="stylesheet" th:href="@{/css/main.css}" />
  <style>
    body { background:#f7f7f7; }
    .page { max-width: 1024px; margin: 24px auto; }
    .card { background:#fff; border-radius:12px; padding:20px; box-shadow:0 2px 12px rgba(0,0,0,.06); margin-bottom:16px; }
    .title { font-weight:700; font-size:18px; margin-bottom:12px; }
    .badge { padding:4px 10px; border-radius:999px; font-size:12px; font-weight:600; }
    .badge.pending { background: rgba(255,193,7,.12); color:#b58100; }
    .badge.confirmed { background: rgba(168,85,247,.12); color:#6b21a8; }
    .badge.shipping { background: rgba(59,130,246,.12); color:#1d4ed8; }
    .badge.delivered { background: rgba(16,185,129,.12); color:#047857; }
    .badge.cancelled { background: rgba(239,68,68,.12); color:#b91c1c; }
    .info { display:flex; gap:16px; flex-wrap:wrap; }
    .info .item { min-width: 240px; }
    .table th { background:#f8fafc; }
    .total { text-align:right; }
  </style>
  <script>
    function formatVnd(n){try{return Number(n).toLocaleString('vi-VN')+" ₫"}catch(e){return n}}
  </script>
  <script defer>
    document.addEventListener('DOMContentLoaded',()=>{
      document.querySelectorAll('[data-money]')
        .forEach(el=>{ el.textContent = formatVnd(el.getAttribute('data-money')); });
    });
  </script>
  </head>
<body>
  <div class="page">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
        <div class="title">Chi tiết đơn hàng #<span th:text="${order.orderId}"></span></div>
        <span class="badge"
              th:classappend="${#strings.toLowerCase(order.status.name())}">
          <span th:text="${order.status}"></span>
        </span>
      </div>
      <div class="info" style="margin-top:8px;">
        <div class="item"><strong>Ngày đặt:</strong>
          <span th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm')}" />
        </div>
        <div class="item"><strong>Phương thức thanh toán:</strong>
          <span th:text="${order.paymentMethod}"></span>
          <span th:if="${order.paymentPaid}" class="badge delivered" style="margin-left:6px;">Đã thanh toán</span>
          <span th:unless="${order.paymentPaid}" class="badge pending" style="margin-left:6px;">Chưa thanh toán</span>
        </div>
        <div class="item"><strong>Người nhận:</strong> <span th:text="${order.customerName}"></span></div>
        <div class="item"><strong>SĐT:</strong> <span th:text="${order.customerPhone}"></span></div>
        <div class="item" style="flex:1 1 100%"><strong>Địa chỉ giao:</strong> <span th:text="${order.shippingAddress}"></span></div>
      </div>
    </div>

    <div class="card">
      <div class="title">Sản phẩm</div>
      <div class="table-responsive">
        <table class="table table-bordered align-middle">
          <thead>
            <tr>
              <th style="width:64px;">Ảnh</th>
              <th>Tên sản phẩm</th>
              <th style="width:140px;" class="text-end">Đơn giá</th>
              <th style="width:100px;" class="text-center">Số lượng</th>
              <th style="width:160px;" class="text-end">Thành tiền</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="it : ${orderDetails}">
              <td>
                <img th:if="${it[5] != null and #strings.length(it[5]) > 0}"
                     th:src="@{'/loadImage?imageName=' + ${it[5]}}"
                     alt="image"
                     style="width:48px;height:48px;object-fit:cover;border-radius:6px;"
                     onerror="this.src='/images/no-image.png'" />
                <img th:unless="${it[5] != null and #strings.length(it[5]) > 0}"
                     src="/images/no-image.png"
                     alt="no-image"
                     style="width:48px;height:48px;object-fit:cover;border-radius:6px;" />
              </td>
              <td th:text="${it[1]}"></td>
              <td class="text-end"><span data-money th:attr="data-money=${it[3]}"></span></td>
              <td class="text-center" th:text="${it[2]}"></td>
              <td class="text-end"><span data-money th:attr="data-money=${it[4]}"></span></td>
            </tr>
            <tr th:if="${#lists.isEmpty(orderDetails)}">
              <td colspan="5" class="text-center text-muted">Không có sản phẩm trong đơn</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="title">Tổng kết</div>
      <div class="row g-0">
        <div class="col-12">
          <div class="total">
            <div>Tiền hàng: <strong><span data-money th:attr="data-money=${order.totalAmount}"></span></strong></div>
            <div>Giảm giá: <strong>- <span data-money th:attr="data-money=${order.discountAmount}"></span></strong></div>
            <div>Phí vận chuyển: <strong><span data-money th:attr="data-money=${order.shippingFee}"></span></strong></div>
            <div style="font-size:18px; margin-top:6px;">Tổng cộng: <strong><span data-money th:attr="data-money=${order.finalAmount}"></span></strong></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card" th:if="${order.note}">
      <div class="title">Ghi chú</div>
      <div th:text="${order.note}"></div>
    </div>

    <div>
      <a th:href="@{/user/my-orders}" class="btn btn-outline-secondary">← Quay lại lịch sử</a>
    </div>
  </div>
</body>
</html>