<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thống kê sản phẩm - OneShop Admin</title>
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/assets/css/atlantis.min.css" />
    <link rel="stylesheet" href="/assets/css/atlantis.css" />
    <link rel="stylesheet" href="/assets/css/demo.css" />
    <link rel="stylesheet" href="/assets/css/fonts.min.css" />
    <link rel="stylesheet" href="/fonts/fontawesome/fontawesome.min.css" />
    <link rel="stylesheet" href="/css/admin-fonts.css" />
    <style>
      :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        --info-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        --hover-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
      }

      body {
        background: #f8fafc;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
      }

      .admin-header {
        background: var(--primary-gradient);
        color: white;
        padding: 30px;
        border-radius: 20px;
        margin-bottom: 30px;
        box-shadow: var(--card-shadow);
      }

      .admin-header h2 {
        font-weight: 700;
        margin-bottom: 10px;
      }

      .admin-header p {
        opacity: 0.9;
        margin: 0;
      }

      .stats-card {
        background: white;
        border-radius: 20px;
        padding: 25px;
        box-shadow: var(--card-shadow);
        border: 1px solid rgba(0, 0, 0, 0.05);
        height: 180px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
      }

      .stats-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary-gradient);
      }

      .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--hover-shadow);
      }

      .stats-card .icon {
        font-size: 2.5rem;
        margin-bottom: 15px;
        opacity: 0.8;
      }

      .stats-card .number {
        font-size: 2.2rem;
        font-weight: 800;
        color: #2c3e50;
        margin-bottom: 5px;
      }

      .stats-card .label {
        color: #7f8c8d;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
        text-align: center;
      }

      .filter-card {
        background: white;
        border-radius: 20px;
        padding: 25px;
        box-shadow: var(--card-shadow);
        margin-bottom: 30px;
      }

      .filter-card h5 {
        color: #2c3e50;
        font-weight: 700;
        margin-bottom: 20px;
      }

      .form-control,
      .form-select {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 12px 16px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
      }

      .form-control:focus,
      .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
      }

      .btn-primary {
        background: var(--primary-gradient);
        border: none;
        border-radius: 12px;
        padding: 12px 24px;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
      }

      .btn-outline-secondary {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 12px 24px;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .btn-outline-secondary:hover {
        background: #f8f9fa;
        border-color: #dee2e6;
      }

      .table-card {
        background: white;
        border-radius: 20px;
        padding: 25px;
        box-shadow: var(--card-shadow);
        margin-bottom: 30px;
      }

      .table-card h5 {
        color: #2c3e50;
        font-weight: 700;
        margin-bottom: 20px;
      }

      .table {
        margin-bottom: 0;
      }

      .table thead th {
        background: rgba(102, 126, 234, 0.1);
        color: #2c3e50;
        border: none;
        font-weight: 700;
        padding: 15px;
        font-size: 0.9rem;
      }

      .table tbody td {
        border: none;
        padding: 15px;
        vertical-align: middle;
      }

      .table tbody tr:hover {
        background: rgba(102, 126, 234, 0.05);
      }

      .status-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-active {
        background: var(--success-gradient);
        color: white;
      }

      .status-pending {
        background: var(--warning-gradient);
        color: white;
      }

      .status-rejected {
        background: var(--danger-gradient);
        color: white;
      }

      .status-suspended {
        background: var(--info-gradient);
        color: #2c3e50;
      }

      .shop-overview {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        color: #1e293b;
        border-radius: 20px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: var(--card-shadow);
        border: 1px solid rgba(0, 0, 0, 0.1);
      }

      .shop-overview h5 {
        color: #1e293b;
        font-weight: bold;
        margin-bottom: 20px;
      }

      .shop-stats-table th {
        background: rgba(102, 126, 234, 0.1);
        color: #1e293b;
        border: none;
        font-weight: 700;
      }

      .shop-stats-table td {
        border: none;
        color: #1e293b;
        font-weight: 600;
      }

      .shop-stats-table tbody tr:hover {
        background: rgba(102, 126, 234, 0.05);
      }

      .pagination .page-link {
        border-radius: 12px;
        margin: 0 2px;
        border: none;
        color: #667eea;
        font-weight: 600;
        padding: 10px 16px;
      }

      .pagination .page-item.active .page-link {
        background: var(--primary-gradient);
        color: white;
      }

      .pagination .page-link:hover {
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
      }

      .alert {
        border-radius: 15px;
        border: none;
        padding: 20px;
        margin-bottom: 20px;
      }

      .alert-success {
        background: var(--success-gradient);
        color: white;
      }

      .alert-warning {
        background: var(--warning-gradient);
        color: white;
      }

      .alert-danger {
        background: var(--danger-gradient);
        color: white;
      }

      .alert-info {
        background: var(--info-gradient);
        color: #2c3e50;
      }

      @media (max-width: 768px) {
        .stats-card {
          height: 160px;
          padding: 20px;
          margin-bottom: 15px;
        }

        .stats-card .number {
          font-size: 1.8rem;
        }

        .stats-card .label {
          font-size: 0.7rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <th:block th:replace="~{admin/fragments/header :: header}"></th:block>
      <th:block th:replace="~{admin/fragments/navbar :: navbar}"></th:block>

      <div class="main-panel">
        <div class="content">
          <!-- Header Section -->
          <div class="admin-header">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h2><i class="fas fa-chart-line"></i> Thống kê sản phẩm</h2>
                <p>
                  Tổng quan tồn kho, sản phẩm yêu thích, hạn dùng và khuyến mãi
                </p>
              </div>
              <div>
                <a href="/admin/products" class="btn btn-light btn-lg">
                  <i class="fas fa-arrow-left"></i> Quay lại quản lý sản phẩm
                </a>
              </div>
            </div>
          </div>

          <!-- KPI Cards Row 1 -->
          <div class="row mb-4">
            <div class="col-xl-3 col-lg-6 col-md-6">
              <div
                class="stats-card text-center"
                data-show="bestseller"
                title="Hiển thị sản phẩm bán chạy"
              >
                <div class="icon text-success">
                  <i class="fas fa-trophy"></i>
                </div>
                <div
                  class="number"
                  th:text="${#numbers.formatInteger(bestSellers,0)}"
                >
                  0
                </div>
                <div class="label">Bán chạy</div>
              </div>
            </div>
            <div class="col-xl-3 col-lg-6 col-md-6">
              <div
                class="stats-card text-center"
                data-show="newest"
                title="Hiển thị sản phẩm mới nhập"
              >
                <div class="icon text-info">
                  <i class="fas fa-box"></i>
                </div>
                <div
                  class="number"
                  th:text="${#numbers.formatInteger(newProducts,0)}"
                >
                  0
                </div>
                <div class="label">Mới nhập</div>
              </div>
            </div>
            <div class="col-xl-3 col-lg-6 col-md-6">
              <div
                class="stats-card text-center"
                data-show="slowmoving"
                title="Sản phẩm bán chậm"
              >
                <div class="icon text-warning">
                  <i class="fas fa-exclamation-circle"></i>
                </div>
                <div
                  class="number"
                  th:text="${#numbers.formatInteger(slowMoving,0)}"
                >
                  0
                </div>
                <div class="label">Bán chậm 30D</div>
              </div>
            </div>
            <div class="col-xl-3 col-lg-6 col-md-6">
              <div
                class="stats-card text-center"
                data-show="trending_up"
                title="Xu hướng tăng trưởng"
              >
                <div class="icon text-success">
                  <i class="fas fa-chart-bar"></i>
                </div>
                <div
                  class="number"
                  th:text="${#numbers.formatInteger(trendingUp,0)}"
                >
                  0
                </div>
                <div class="label">Tăng trưởng</div>
              </div>
            </div>
          </div>

          <!-- KPI Cards Row 2 -->
          <div class="row mb-4">
            <div class="col-xl-3 col-lg-6 col-md-6">
              <div
                class="stats-card text-center"
                data-show="lowstock"
                title="Hiển thị bảng sắp hết hàng"
              >
                <div class="icon text-danger">
                  <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div
                  class="number"
                  th:text="${#numbers.formatInteger(lowStockCount,0)}"
                >
                  0
                </div>
                <div class="label">Số lượng còn lại ≤ 10</div>
              </div>
            </div>
            <div class="col-xl-3 col-lg-6 col-md-6">
              <div
                class="stats-card text-center"
                data-show="expiring"
                title="Hiển thị bảng sắp hết hạn"
              >
                <div class="icon text-warning">
                  <i class="fas fa-hourglass-end"></i>
                </div>
                <div
                  class="number"
                  th:text="${#numbers.formatInteger(expiringSoonCount,0)}"
                >
                  0
                </div>
                <div class="label">Hạn dùng ≤ 30 ngày</div>
              </div>
            </div>
            <div class="col-xl-3 col-lg-6 col-md-6">
              <div
                class="stats-card text-center"
                data-show="favorites"
                title="Hiển thị bảng được ưa chuộng"
              >
                <div class="icon text-danger">
                  <i class="fas fa-heart"></i>
                </div>
                <div
                  class="number"
                  th:text="${#numbers.formatInteger(favoritesCount,0)}"
                >
                  0
                </div>
                <div class="label">Được khách hàng ưa chuộng</div>
              </div>
            </div>
            <div class="col-xl-3 col-lg-6 col-md-6">
              <div
                class="stats-card text-center"
                data-show="discounted"
                title="Hiển thị bảng đang khuyến mãi"
              >
                <div class="icon text-primary">
                  <i class="fas fa-percent"></i>
                </div>
                <div
                  class="number"
                  th:text="${#numbers.formatInteger(discountedCount,0)}"
                >
                  0
                </div>
                <div class="label">Đang khuyến mãi</div>
              </div>
            </div>
          </div>

          <!-- Shop Overview Section -->
          <div class="shop-overview">
            <h5><i class="fas fa-store"></i> Tổng quan theo shop</h5>
            <div class="table-responsive">
              <table class="table shop-stats-table">
                <thead>
                  <tr>
                    <th><i class="fas fa-store"></i> Shop</th>
                    <th><i class="fas fa-info-circle"></i> Trạng thái</th>
                    <th><i class="fas fa-cube"></i> Sản phẩm</th>
                    <th><i class="fas fa-warehouse"></i> Tồn kho</th>
                    <th><i class="fas fa-chart-line"></i> Giá trị tồn</th>
                  </tr>
                </thead>
                <tbody>
                  <tr th:each="stat : ${shopStats}">
                    <td>
                      <div class="fw-bold text-dark" th:text="${stat.shopName}">
                        Shop name
                      </div>
                      <div
                        class="text-muted small"
                        th:text="${stat.vendorName}"
                      >
                        Vendor
                      </div>
                    </td>
                    <td>
                      <span
                        class="status-badge status-active"
                        th:if="${stat.status.name() == 'ACTIVE'}"
                        >Hoạt động</span
                      >
                      <span
                        class="status-badge status-pending"
                        th:if="${stat.status.name() == 'PENDING'}"
                        >Chờ duyệt</span
                      >
                      <span
                        class="status-badge status-rejected"
                        th:if="${stat.status.name() == 'REJECTED'}"
                        >Từ chối</span
                      >
                      <span
                        class="status-badge status-suspended"
                        th:if="${stat.status.name() == 'SUSPENDED'}"
                        >Tạm ngưng</span
                      >
                    </td>
                    <td
                      class="text-end fw-bold text-dark"
                      th:text="${stat.productCount}"
                    >
                      0
                    </td>
                    <td
                      class="text-end fw-bold text-dark"
                      th:text="${stat.totalQuantity}"
                    >
                      0
                    </td>
                    <td
                      class="text-end fw-bold text-dark"
                      th:text="${#numbers.formatDecimal(stat.totalInventoryValue, 0, 'DEFAULT', 0, 'DEFAULT')} + ' ₫'"
                    >
                      0 ₫
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Filter Section -->
          <div class="filter-card">
            <h5><i class="fas fa-filter"></i> Bộ lọc thống kê</h5>
            <form method="get" th:action="@{/admin/statistics}">
              <div class="row g-3 align-items-end">
                <div class="col-lg-3 col-md-6">
                  <label class="form-label text-muted fw-bold">
                    <i class="fas fa-layer-group text-primary"></i> Danh mục
                  </label>
                  <select class="form-select" name="categoryId">
                    <option
                      th:selected="${selectedCategoryId == null}"
                      th:value="${null}"
                    >
                      Tất cả danh mục
                    </option>
                    <option
                      th:each="c : ${categories}"
                      th:value="${c.categoryId}"
                      th:selected="${selectedCategoryId != null and c.categoryId == selectedCategoryId}"
                      th:text="${c.categoryName}"
                    >
                      Danh mục
                    </option>
                  </select>
                </div>
                <div class="col-lg-3 col-md-6">
                  <label class="form-label text-muted fw-bold">
                    <i class="fas fa-store text-primary"></i> Shop
                  </label>
                  <select class="form-select" name="shopId">
                    <option
                      th:selected="${selectedShopId == null}"
                      th:value="${null}"
                    >
                      Tất cả shop
                    </option>
                    <option
                      th:each="shop : ${shops}"
                      th:value="${shop[0]}"
                      th:selected="${selectedShopId != null and shop[0] == selectedShopId}"
                      th:text="${shop[1]}"
                    >
                      Shop name
                    </option>
                  </select>
                </div>
                <div class="col-lg-4 col-md-6">
                  <label class="form-label text-muted fw-bold">
                    <i class="fas fa-search text-primary"></i> Tìm kiếm
                  </label>
                  <input
                    class="form-control"
                    type="text"
                    name="search"
                    th:value="${searchTerm}"
                    placeholder="Nhập tên sản phẩm, danh mục hoặc thương hiệu..."
                  />
                </div>
                <div class="col-lg-2 col-md-6">
                  <label class="form-label text-muted fw-bold">
                    <i class="fas fa-list text-primary"></i> Hiển thị
                  </label>
                  <select class="form-select" name="size">
                    <option th:selected="${pageSize == 10}" value="10">
                      10 mục
                    </option>
                    <option th:selected="${pageSize == 20}" value="20">
                      20 mục
                    </option>
                    <option th:selected="${pageSize == 50}" value="50">
                      50 mục
                    </option>
                  </select>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-12">
                  <button class="btn btn-primary me-2" type="submit">
                    <i class="fas fa-filter"></i> Lọc dữ liệu
                  </button>
                  <a
                    th:href="@{/admin/statistics}"
                    class="btn btn-outline-secondary"
                  >
                    <i class="fas fa-refresh"></i> Làm mới
                  </a>
                </div>
              </div>
            </form>
          </div>

          <!-- Inventory Details Table -->
          <div class="table-card">
            <h5><i class="fas fa-cubes"></i> Chi tiết tồn kho</h5>
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead>
                  <tr>
                    <th style="width: 20%">Danh mục</th>
                    <th style="width: 30%">Tên sản phẩm</th>
                    <th style="width: 20%">Thương hiệu</th>
                    <th style="width: 15%" class="text-end">Số lượng</th>
                    <th style="width: 15%" class="text-end">Đơn giá</th>
                    <th style="width: 15%" class="text-end">Giá trị</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    th:if="${inventoryDetails == null or #lists.isEmpty(inventoryDetails)}"
                  >
                    <td colspan="6" class="text-center text-muted py-4">
                      <i class="fas fa-inbox fa-2x mb-2"></i><br />
                      Không có dữ liệu tồn kho
                    </td>
                  </tr>
                  <tr th:each="r, stat : ${inventoryDetails}">
                    <td th:text="${r[0]}"></td>
                    <td><strong th:text="${r[1]}"></strong></td>
                    <td th:text="${r[2]}"></td>
                    <td
                      class="text-end fw-bold"
                      th:text="${#numbers.formatInteger(r[3],0)}"
                    ></td>
                    <td
                      class="text-end fw-bold"
                      th:text="${#numbers.formatInteger(r[4],0)}"
                    ></td>
                    <td
                      class="text-end fw-bold text-success"
                      th:text="${#numbers.formatInteger(r[5],0)}"
                    ></td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            <nav aria-label="Pagination" class="mt-4" th:if="${totalPages > 0}">
              <ul class="pagination justify-content-center">
                <li
                  class="page-item"
                  th:classappend="${currentPage == 0} ? ' disabled'"
                >
                  <a
                    class="page-link"
                    th:href="@{/admin/statistics(page=0, size=${pageSize}, search=${searchTerm}, categoryId=${selectedCategoryId}, shopId=${selectedShopId})}"
                  >
                    <i class="fas fa-angle-double-left"></i>
                  </a>
                </li>
                <li
                  class="page-item"
                  th:classappend="${currentPage == 0} ? ' disabled'"
                >
                  <a
                    class="page-link"
                    th:href="@{/admin/statistics(page=${currentPage-1}, size=${pageSize}, search=${searchTerm}, categoryId=${selectedCategoryId}, shopId=${selectedShopId})}"
                  >
                    <i class="fas fa-angle-left"></i>
                  </a>
                </li>
                <li
                  class="page-item"
                  th:each="p : ${#numbers.sequence(0, totalPages-1)}"
                  th:classappend="${p==currentPage} ? ' active'"
                >
                  <a
                    class="page-link"
                    th:text="${p+1}"
                    th:href="@{/admin/statistics(page=${p}, size=${pageSize}, search=${searchTerm}, categoryId=${selectedCategoryId}, shopId=${selectedShopId})}"
                  ></a>
                </li>
                <li
                  class="page-item"
                  th:classappend="${currentPage >= totalPages-1} ? ' disabled'"
                >
                  <a
                    class="page-link"
                    th:href="@{/admin/statistics(page=${currentPage+1}, size=${pageSize}, search=${searchTerm}, categoryId=${selectedCategoryId}, shopId=${selectedShopId})}"
                  >
                    <i class="fas fa-angle-right"></i>
                  </a>
                </li>
                <li
                  class="page-item"
                  th:classappend="${currentPage >= totalPages-1} ? ' disabled'"
                >
                  <a
                    class="page-link"
                    th:href="@{/admin/statistics(page=${totalPages-1}, size=${pageSize}, search=${searchTerm}, categoryId=${selectedCategoryId}, shopId=${selectedShopId})}"
                  >
                    <i class="fas fa-angle-double-right"></i>
                  </a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </div>

      <th:block th:replace="~{admin/fragments/footer :: footer}"></th:block>
    </div>

    <script src="/assets/js/core/jquery.3.2.1.min.js"></script>
    <script src="/assets/js/core/popper.min.js"></script>
    <script src="/assets/js/core/bootstrap.min.js"></script>

    <script th:inline="javascript">
      $(document).ready(function () {
        // KPI card click handling
        $(".stats-card[data-show]").on("click", function () {
          const $card = $(this);
          const which = $card.data("show");

          console.log("KPI card clicked:", which);

          // Validate type parameter
          const validTypes = [
            "lowstock",
            "expiring",
            "discounted",
            "favorites",
            "bestseller",
            "newest",
            "slowmoving",
            "trending_up",
          ];

          if (!validTypes.includes(which)) {
            console.error("Invalid statistics type:", which);
            alert("Loại thống kê không hợp lệ: " + which);
            return;
          }

          // Navigate to detailed view
          const url =
            "/admin/statistics/view?type=" + encodeURIComponent(which);
          console.log("Target URL:", url);
          window.location.href = url;
        });

        // Auto-dismiss alerts
        setTimeout(function () {
          $(".alert").fadeOut("slow");
        }, 5000);
      });
    </script>
  </body>
</html>
