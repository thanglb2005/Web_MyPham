<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thống kê sản phẩm - OneShop Admin</title>
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/assets/css/atlantis.min.css" />
    <link rel="stylesheet" href="/assets/css/atlantis.css" />
    <link rel="stylesheet" href="/assets/css/demo.css" />
    <link rel="stylesheet" href="/assets/css/fonts.min.css" />
    <link rel="stylesheet" href="/fonts/fontawesome/fontawesome.min.css" />
    <link rel="stylesheet" href="/css/admin-fonts.css" />
    <style>
      :root {
        --section-gap: 30px;
      }
      body {
        background: #f4f6f9;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        font-size: 14px;
        line-height: 1.5;
      }
      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 30px;
        border-radius: 15px;
        color: #fff;
        margin-bottom: var(--section-gap);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      }
      .stats-card {
        background: #fff;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
        height: 180px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 20px;
      }

      .action-button-card {
        background: #fff;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
      }

      .action-button-card .btn {
        border-radius: 10px;
        font-size: 1.1rem;
        font-weight: 600;
        padding: 15px 20px;
        transition: all 0.3s ease;
      }

      /* Responsive improvements */
      @media (max-width: 768px) {
        .stats-card {
          height: 160px;
          padding: 20px;
          margin-bottom: 15px;
        }
        .stats-card .number {
          font-size: 1.8rem;
        }
        .stats-card .label {
          font-size: 0.75rem;
        }
        .action-button-card {
          margin-bottom: 15px;
        }
      }

      @media (max-width: 576px) {
        .stats-card {
          height: 140px;
          padding: 15px;
        }
        .stats-card .number {
          font-size: 1.5rem;
        }
      }
      .stats-card .icon {
        font-size: 2.6rem;
        margin-bottom: 10px;
      }
      .stats-card .number {
        font-size: 2.2rem;
        font-weight: 800;
        color: #2c3e50;
      }
      .stats-card .label {
        color: #7f8c8d;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        font-weight: 600;
      }
      .table-responsive {
        background: #fff;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
        margin-bottom: var(--section-gap);
      }
      .chart-container {
        background: #fff;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
        margin-bottom: var(--section-gap);
        min-height: 520px;
        position: relative;
        overflow: hidden;
      }
      .chart-container canvas {
        width: 100% !important;
        height: 450px !important;
        max-height: 450px;
        display: block;
      }
      .chart-title {
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 15px;
      }
      .nav-tabs {
        border: none;
        /* Use previous section margin for top spacing; keep bottom equal */
        margin-top: 0;
        margin-bottom: var(--section-gap);
      }
      /* Keep spacing above tabs equal to below (one margin source only) */
      .alert-tables-section {
        margin-bottom: var(--section-gap) !important;
      }
      .nav-tabs .nav-link {
        border: none;
        background: #fff;
        margin-right: 12px;
        padding: 14px 28px;
        border-radius: 12px;
        color: #7f8c8d;
        font-weight: 700;
        font-size: 1rem;
        line-height: 1;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
      }
      .nav-tabs .nav-link i {
        margin-right: 8px;
        font-size: 1rem;
      }
      .nav-tabs .nav-link.active {
        color: #fff;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: 1px solid transparent;
      }
      /* Show the Products tab before Overview without changing HTML order */
      .nav-tabs {
        display: flex;
      }
      .nav-tabs .nav-item:nth-child(1) {
        order: 2;
      }
      .nav-tabs .nav-item:nth-child(2) {
        order: 1;
      }
      .qty-low {
        font-size: 1.25rem;
        font-weight: 800;
        white-space: nowrap;
      }
      .favorite-desc,
      .kpi-desc-big {
        font-size: 0.9rem !important;
        font-weight: 700;
        position: relative;
        top: -2px;
        margin-top: 0 !important;
      }
      .statistics-page .admin-footer {
        display: none !important;
      }
      /* Keep left sidebar width consistent with Products page */
      .sidebar {
        width: 250px !important;
      }
      .main-panel {
        margin-left: 250px !important;
      }
      @media (min-width: 991px) {
        .sidebar_minimize .main-panel {
          width: calc(100% - 75px);
          margin-left: 75px !important;
        }
      }
      /* Force uniform vertical spacing across sections */
      .row.mb-4 {
        margin-bottom: var(--section-gap) !important;
      }

      /* Loading states for KPI cards */
      .stats-card.loading {
        opacity: 0.7;
        transition: opacity 0.3s ease;
      }

      .loading-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.2rem;
        color: #007bff;
        z-index: 10;
      }

      .stats-card {
        position: relative;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .stats-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 35px rgba(102, 126, 234, 0.25);
      }

      .stats-card:active {
        transform: translateY(0);
      }
    </style>
  </head>
  <body class="statistics-page">
    <div class="wrapper">
      <th:block th:replace="~{admin/fragments/header :: header}"></th:block>
      <th:block th:replace="~{admin/fragments/navbar :: navbar}"></th:block>
      <div class="main-panel">
        <div class="content">
          <div class="header">
            <h3 class="mb-1">
              <i class="fas fa-chart-line"></i> Thống kê sản phẩm
            </h3>
            <div class="text-light" style="opacity: 0.9">
              Tổng quan tồn kho, sản phẩm yêu thích, hạn dùng và khuyến mãi
            </div>
          </div>

          <!-- KPI Cards - Row 1 -->
          <div class="row mb-3">
            <div class="col-xl-3 col-lg-6 col-md-6">
              <div
                class="stats-card text-center"
                data-show="bestseller"
                title="Hiển thị Sản phẩm bán chạy"
              >
                <div class="icon text-success">
                  <i class="fas fa-trophy"></i>
                </div>
                <div class="number" id="best-sellers">
                  12
                </div>
                <div class="label">BÁN CHẠY</div>
              </div>
            </div>
            <div class="col-xl-3 col-lg-6 col-md-6">
              <div
                class="stats-card text-center"
                data-show="newest"
                title="Hiển thị Sản phẩm mới nhập"
              >
                <div class="icon text-info">
                  <i class="fas fa-box"></i>
                </div>
                <div class="number" id="new-products">
                  6
                </div>
                <div class="label">MỚI NHẬP</div>
              </div>
            </div>
            <div class="col-xl-3 col-lg-6 col-md-6">
              <div
                class="stats-card text-center"
                data-show="slowmoving"
                title="Sản phẩm bán chậm"
              >
                <div class="icon text-warning">
                  <i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="number" id="slow-moving">
                  3
                </div>
                <div class="label">BÁN CHẬM 30D</div>
              </div>
            </div>
            <div class="col-xl-3 col-lg-6 col-md-6">
              <div
                class="stats-card text-center"
                data-show="trending_up"
                title="Xu hướng tăng trưởng"
              >
                <div class="icon text-success">
                  <i class="fas fa-chart-bar"></i>
                </div>
                <div class="number" id="trending-up">
                  8
                </div>
                <div class="label">TĂNG TRƯỞNG</div>
              </div>
            </div>
          </div>

          <!-- KPI Cards - Row 2 -->
          <div class="row mb-4">
            <div class="col-xl-3 col-lg-6 col-md-6">
              <div
                class="stats-card text-center"
                data-show="lowstock"
                title="Hiển thị bảng sắp hết hàng"
              >
                <div class="icon text-danger">
                  <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="number" id="low-stock">
                  8
                </div>
                <div class="label">SỐ LƯỢNG CÒN LẠI ≤ 10</div>
              </div>
            </div>
            <div class="col-xl-3 col-lg-6 col-md-6">
              <div
                class="stats-card text-center"
                data-show="expiring"
                title="Hiển thị bảng sắp hết hạn"
              >
                <div class="icon text-warning">
                  <i class="fas fa-hourglass-end"></i>
                </div>
                <div class="number" id="expiring-products">
                  5
                </div>
                <div class="label">HẠN DÙNG ≤ 30 NGÀY</div>
              </div>
            </div>
            <div class="col-xl-3 col-lg-6 col-md-6">
              <div
                class="stats-card text-center"
                data-show="favorites"
                title="Hiển thị bảng được ưa chuộng"
              >
                <div class="icon text-danger"><i class="fas fa-heart"></i></div>
                <div class="number" id="favorite-products">
                  15
                </div>
                <div class="label">ĐƯỢC KHÁCH HÀNG ƯA CHUỘNG</div>
              </div>
            </div>
            <div class="col-xl-3 col-lg-6 col-md-6">
              <div
                class="stats-card text-center"
                data-show="discounted"
                title="Hiển thị bảng đang khuyến mãi"
              >
                <div class="icon text-primary">
                  <i class="fas fa-percent"></i>
                </div>
                <div class="number" id="discounted-products">
                  7
                </div>
                <div class="label">ĐANG KHUYẾN MÃI</div>
              </div>
            </div>
          </div>



          <!-- Charts Section -->
          <div class="row mb-4">
            <div class="col-lg-6">
              <div class="chart-container">
                <div class="chart-title">
                  <i class="fas fa-cube"></i> Tồn kho theo danh mục
                </div>
                <canvas id="inventoryChart"></canvas>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="chart-container">
                <div class="chart-title">
                  <i class="fas fa-heart"></i> Sản phẩm được yêu thích
                </div>
                <canvas id="favoriteChart"></canvas>
              </div>
            </div>

        </div>
      </div>
      <th:block th:replace="~{admin/fragments/footer :: footer}"></th:block>
    </div>
    <script src="/assets/js/core/jquery.3.2.1.min.js"></script>
    <script src="/assets/js/core/popper.min.js"></script>
    <script src="/assets/js/core/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
      /**
       * ONESHOP ADMIN STATISTICS DASHBOARD
       *
       * FEATURES:
       * 1. KPI CARDS: Click any card to navigate to detailed list view
       *    - Low Stock, Expiring, Discounted, Favorites, Best Sellers
       *    - New Products, Slow Moving, Trending Up/Down
       *
       * 2. NAVIGATION: Two tabs - Overview and Products with hash support
       *
       * 3. API ENDPOINTS: All /admin/statistics/api/* for real-time data
       *
       * 4. DETAILED VIEWS: /admin/statistics/view?type={type} with pagination
       *
       * Usage: Click any KPI card to view detailed data for that type.
       */
      $(function () {
        const charts = {};
        const store = {
          lowstock: { pageSize: 10 },
          expiring: { pageSize: 10 },
          discounted: { pageSize: 10 },
          favorites: { pageSize: 10 },
        };
        const baseOpts = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: "bottom",
              labels: { usePointStyle: true, font: { size: 12 } },
            },
          },
        };
        function makeChart(id) {
          console.log("Creating chart for:", id);
          const ctx = document.getElementById(id);
          
          if (!ctx) {
            console.error("Canvas element not found:", id);
            return null;
          }
          
          if (!window.Chart) {
            console.error("Chart.js library not loaded");
            return null;
          }
          
          try {
            const chart = new Chart(ctx, {
              type: "doughnut",
              data: {
                labels: [],
                datasets: [
                  {
                    data: [],
                    backgroundColor: [
                      "#667eea",
                      "#764ba2",
                      "#a29bfe",
                      "#fd79a8",
                      "#fdcb6e",
                      "#55efc4",
                      "#81ecec",
                      "#74b9ff",
                    ],
                    borderWidth: 2,
                  },
                ],
              },
              options: baseOpts,
            });
            console.log("Chart created successfully:", id);
            return chart;
          } catch (error) {
            console.error("Error creating chart:", id, error);
            return null;
          }
        }
        
        // Initialize everything when DOM is ready
        $(document).ready(function() {
          console.log("DOM ready, checking Chart.js...");
          console.log("Chart.js available:", typeof Chart !== 'undefined');
          console.log("Canvas elements:", {
            inventory: !!document.getElementById("inventoryChart"),
            favorite: !!document.getElementById("favoriteChart")
          });
          
          // Initialize charts first
          initializeCharts();
          
          // Load KPI data once
          loadKPIData();
        });
        
        function initializeCharts() {
          try {
            const invCanvas = document.getElementById("inventoryChart");
            const favCanvas = document.getElementById("favoriteChart");
            
            if (!invCanvas || !favCanvas) {
              console.error("Canvas elements not found");
              return;
            }
            
            // Create inventory chart with immediate test data
            charts.inventoryChart = new Chart(invCanvas, {
              type: 'doughnut',
              data: {
                labels: ["Kem dưỡng da", "Son môi", "Nước hoa", "Sữa rửa mặt"],
                datasets: [{
                  data: [45, 32, 28, 15],
                  backgroundColor: ['#667eea', '#764ba2', '#a29bfe', '#fd79a8', '#fdcb6e', '#55efc4', '#81ecec', '#74b9ff']
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { position: 'bottom' }
                }
              }
            });
            
            // Create favorite chart with immediate test data
            charts.favoriteChart = new Chart(favCanvas, {
              type: 'doughnut', 
              data: {
                labels: ["Son môi", "Kem dưỡng da", "Nước hoa"],
                datasets: [{
                  data: [23, 18, 12],
                  backgroundColor: ['#fd79a8', '#fdcb6e', '#55efc4', '#667eea', '#764ba2', '#a29bfe']
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { position: 'bottom' }
                }
              }
            });
            
            console.log("Charts created with test data immediately");
            
            // Then try to load real data (will replace test data if successful)
            setTimeout(() => {
              loadRealChartData();
            }, 500);
            
          } catch (error) {
            console.error("Chart initialization error:", error);
          }
        }
        
        function loadKPIData() {
          // Load real KPI data from database
          fetch("/admin/statistics/api/kpis")
            .then(r => r.json())
            .then(data => {
              console.log("KPI data loaded from database:", data);
              updateKPICards(data);
            })
            .catch(err => {
              console.error("KPI load error:", err);
              // Keep current static values as fallback
            });
        }
        
        function updateKPICards(data) {
          console.log("Updating KPI cards with real data:", data);
          
          // Map API response to card IDs - use real data from database
          const cards = {
            'best-sellers': data.bestSellers || data.bestSeller || 0,
            'new-products': data.newProducts || 0, 
            'slow-moving': data.slowMoving || 0,
            'trending-up': data.trendingUp || 0,
            'low-stock': data.lowStock || 0,
            'expiring-products': data.expiringSoon || data.expiring || 0,
            'favorite-products': data.favorites || 0,
            'discounted-products': data.discounted || 0
          };
          
          // Update each card with real database values
          Object.entries(cards).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
              element.textContent = value.toLocaleString('vi-VN');
              console.log(`Updated ${id}: ${value}`);
            }
          });
        }
        
        function loadRealChartData() {
          // Load inventory chart data from database
          // API format: [category_name, brand_name, total_quantity, total_value, avg_price]
          fetch("/admin/statistics/api/inventory")
            .then(r => r.json())
            .then(data => {
              console.log("Inventory API response:", data);
              
              if (charts.inventoryChart && data && Array.isArray(data) && data.length > 0) {
                console.log("Processing real inventory data:", data);
                
                // Aggregate by category for chart
                const categoryData = {};
                data.forEach(row => {
                  const categoryName = row[0]; // category_name
                  const quantity = Number(row[2]) || 0; // total_quantity
                  categoryData[categoryName] = (categoryData[categoryName] || 0) + quantity;
                });
                
                const labels = Object.keys(categoryData);
                const values = Object.values(categoryData);
                
                charts.inventoryChart.data.labels = labels;
                charts.inventoryChart.data.datasets[0].data = values;
                charts.inventoryChart.update();
                console.log("Inventory chart updated with real database data:", {labels, values});
              } else {
                console.log("No inventory data from API");
              }
            })
            .catch(err => {
              console.error("Inventory data load error:", err);
            });
            
          // Load favorites chart data from database  
          // API format: [category_name, brand_name, favorite_count, total_products]
          fetch("/admin/statistics/api/favorites")
            .then(r => r.json())
            .then(data => {
              console.log("Favorites API response:", data);
              
              if (charts.favoriteChart && data && Array.isArray(data) && data.length > 0) {
                console.log("Processing real favorites data:", data);
                
                // Aggregate by category for chart
                const categoryData = {};
                data.forEach(row => {
                  const categoryName = row[0]; // category_name
                  const favoriteCount = Number(row[2]) || 0; // favorite_count
                  categoryData[categoryName] = (categoryData[categoryName] || 0) + favoriteCount;
                });
                
                const labels = Object.keys(categoryData);
                const values = Object.values(categoryData);
                
                charts.favoriteChart.data.labels = labels;
                charts.favoriteChart.data.datasets[0].data = values;
                charts.favoriteChart.update();
                console.log("Favorites chart updated with real database data:", {labels, values});
              } else {
                console.log("No favorites data from API");
              }
            })
            .catch(err => {
              console.error("Favorites data load error:", err);
            });
        }

        function buildPagination(pagerId, totalRows, pageSize, onPageChange) {
          const ul = document.getElementById(pagerId);
          if (!ul) return;
          const totalPages = Math.max(1, Math.ceil(totalRows / pageSize));
          let current = 1;
          function render() {
            const span = 2;
            let html = "";
            const li = (dis, text, page, active) =>
              `<li class="page-item ${dis ? "disabled" : ""} ${
                active ? "active" : ""
              }"><a class="page-link" href="#" data-page="${page}">${text}</a></li>`;
            html += li(current === 1, "«", 1, false);
            html += li(current === 1, "‹", Math.max(1, current - 1), false);
            const start = Math.max(1, current - span);
            const end = Math.min(totalPages, current + span);
            for (let i = start; i <= end; i++)
              html += li(false, String(i), i, i === current);
            html += li(
              current === totalPages,
              "›",
              Math.min(totalPages, current + 1),
              false
            );
            html += li(current === totalPages, "»", totalPages, false);
            ul.innerHTML = html;
            ul.querySelectorAll("a[data-page]").forEach((a) => {
              a.addEventListener("click", (e) => {
                e.preventDefault();
                const p = Number(a.getAttribute("data-page")) || 1;
                if (p >= 1 && p <= totalPages) {
                  current = p;
                  onPageChange(p);
                  render();
                }
              });
            });
          }
          render();
          return {
            go: (p) => {
              current = p;
              render();
            },
          };
        }

        function paginateExistingTable(bodySelector, pagerId, pageSize) {
          const rows = Array.from(
            document.querySelectorAll(bodySelector + " > tr")
          );
          if (!rows.length) return;
          function showPage(page) {
            const start = (page - 1) * pageSize;
            const end = start + pageSize;
            rows.forEach((tr, idx) => {
              tr.style.display = idx >= start && idx < end ? "" : "none";
            });
          }
          const pager = buildPagination(
            pagerId,
            rows.length,
            pageSize,
            showPage
          );
          showPage(1);
          return pager;
        }

        function setChartTitle(canvasId, icon, text) {
          const cv = document.getElementById(canvasId);
          if (!cv) return;
          const t = cv.previousElementSibling;
          if (t && t.classList.contains("chart-title")) {
            t.innerHTML = `<i class="fas ${icon}"></i> ${text}`;
          }
        }
        /* OLD CHART FUNCTION - COMMENTED OUT 
        function loadOverviewCharts() {
          // Overview shows: Inventory by Category (left), Favorite Products (right)
          setChartTitle("inventoryChart", "fa-cube", "Tồn kho theo danh mục");
          setChartTitle(
            "favoriteChart",
            "fa-heart",
            "Sản phẩm được yêu thích"
          );
          fetch("/admin/statistics/api/inventory")
            .then((r) => r.json())
            .then((d) => {
              console.log("Inventory data:", d);
              if (charts.inventoryChart) {
                if (d && d.length > 0) {
                  charts.inventoryChart.data.labels = d.map(x => x[0]);
                  charts.inventoryChart.data.datasets[0].data = d.map(x => Number(x[1]) || 0);
                } else {
                  // Fallback test data if API returns empty
                  charts.inventoryChart.data.labels = ["Kem dưỡng da", "Son môi", "Nước hoa", "Sữa rửa mặt"];
                  charts.inventoryChart.data.datasets[0].data = [45, 32, 28, 15];
                }
                charts.inventoryChart.update();
              }
            })
            .catch((err) => {
              console.error("Inventory API error:", err);
              if (charts.inventoryChart) {
                charts.inventoryChart.data.labels = ["Kem dưỡng da", "Son môi", "Nước hoa", "Sữa rửa mặt"];
                charts.inventoryChart.data.datasets[0].data = [45, 32, 28, 15];
                charts.inventoryChart.update();
              }
            });
          fetch("/admin/statistics/api/favorites")
            .then((r) => r.json())
            .then((d) => {
              console.log("Favorites data:", d);
              if (charts.favoriteChart) {
                if (d && d.length > 0) {
                  charts.favoriteChart.data.labels = d.map(x => x[0]);
                  charts.favoriteChart.data.datasets[0].data = d.map(x => Number(x[1]) || 0);
                } else {
                  // Fallback test data if API returns empty
                  charts.favoriteChart.data.labels = ["Son môi", "Kem dưỡng da", "Nước hoa"];
                  charts.favoriteChart.data.datasets[0].data = [23, 18, 12];
                }
                charts.favoriteChart.update();
              }
            })
            .catch((err) => {
              console.error("Favorites API error:", err);
              if (charts.favoriteChart) {
                charts.favoriteChart.data.labels = ["Son môi", "Kem dưỡng da", "Nước hoa"];
                charts.favoriteChart.data.datasets[0].data = [23, 18, 12];
                charts.favoriteChart.update();
              }
            });
        }
        function loadProductCharts() {
          // Products tab now shows: Inventory (left), Favorites (right)
          setChartTitle("manufactureChart", "fa-cube", "Tồn kho theo danh mục");
          setChartTitle("expiryChart", "fa-heart", "Sản phẩm được yêu thích");
          fetch("/admin/statistics/api/inventory")
            .then((r) => r.json())
            .then((d) => {
              if (charts.manufactureChart && d) {
                const agg = {};
                d.forEach((row) => {
                  const cat = row[0];
                  const qty = Number(row[2]) || 0;
                  agg[cat] = (agg[cat] || 0) + qty;
                });
                charts.manufactureChart.data.labels = Object.keys(agg);
                charts.manufactureChart.data.datasets[0].data =
                  Object.values(agg);
                charts.manufactureChart.update();
              }
            })
            .catch(() => {});
          fetch("/admin/statistics/api/favorites")
            .then((r) => r.json())
            .then((d) => {
              if (charts.expiryChart && d) {
                charts.expiryChart.data.labels = d.map(
                  (x) => `${x[0]} - ${x[1]}`
                );
                charts.expiryChart.data.datasets[0].data = d.map(
                  (x) => Number(x[2]) || 0
                );
                charts.expiryChart.update();
              }
            })
            .then(() => {
              paginateExistingTable(
                "#expiringSoonTable tbody",
                "expiringPagination",
                10
              );
            })
            .catch(() => {});
        }
        */ // END OLD CHART FUNCTION COMMENT
        
        /* OLD KPI FUNCTION - COMMENTED OUT TO PREVENT CONFLICTS
        function kpis() {
          fetch("/admin/statistics/api/kpis")
            .then((r) => r.json())
            .then((k) => {
              [
                ["kpiLowStock", "lowStock"],
                ["kpiExpiring", "expiringSoon"], 
                ["kpiFavorites", "favorites"],
                ["kpiDiscounted", "discounted"],
                ["kpiBestSeller", "bestSellers"],
                ["kpiNewProducts", "newProducts"],
                ["kpiSlowMoving", "slowMoving"],
                ["kpiTrendingUp", "trendingUp"],
              ].forEach(([id, key]) => {
                const el = document.getElementById(id);
                if (!el) return;
                el.textContent = (k[key] || 0).toLocaleString("vi-VN");
              });
            })
            .then(() => {
              paginateExistingTable(
                "#discountedTable tbody",
                "discountedPagination",
                10
              );
              console.log("KPIs loaded successfully");
            })
            .catch((error) => {
              console.error("Failed to load KPIs:", error);
              // Show fallback values
              [
                "kpiLowStock",
                "kpiExpiring",
                "kpiFavorites",
                "kpiDiscounted",
                "kpiBestSeller",
                "kpiNewProducts",
                "kpiSlowMoving",
                "kpiTrendingUp",
              ].forEach((id) => {
                const el = document.getElementById(id);
                if (el) el.textContent = "0";
              });
            });
        }
        */ // END OLD KPI FUNCTION COMMENT
        function lowStock() {
          // Commented out - tables removed
          return;
        }
        function expiring() {
          // Stub - tables removed
          return;
        }
        function discounted() {
          // Stub - tables removed  
          return;
        }
        function favorites() {
          // Stub - tables removed
          return;
        }

        // Show corresponding table when clicking KPI cards
        $(
          "#section-lowstock,#section-expiring,#section-discounted,#section-favorites"
        ).hide();
        function showSection(id) {
          $(
            "#section-lowstock,#section-expiring,#section-discounted,#section-favorites"
          ).hide();
          $(id).show();
          document
            .querySelector(id)
            .scrollIntoView({ behavior: "smooth", block: "start" });
        }
        // Enhanced KPI card click handling with visual feedback
        $(".stats-card[data-show]").on("click", function () {
          const $card = $(this);
          const which = $card.data("show");

          console.log("KPI card clicked:", which);

          // Validate type parameter
          const validTypes = [
            "lowstock",
            "expiring",
            "discounted",
            "favorites",
            "bestseller",
            "newest",
            "slowmoving",
            "trending_up",
          ];
          if (!validTypes.includes(which)) {
            console.error("Invalid statistics type:", which);
            alert("Loại thống kê không hợp lệ: " + which);
            return;
          }

          // Add loading state visual feedback - DISABLED
          // $card.addClass("loading").css("pointer-events", "none");
          // $card.find(".number").text("...");
          // $card.append(
          //   '<div class="loading-overlay"><i class="fas fa-spinner fa-spin"></i></div>'
          // );

          // Navigate to detailed view
          console.log("Navigating to statistics view:", which);
          const url =
            "/admin/statistics/view?type=" + encodeURIComponent(which);
          console.log("Target URL:", url);
          window.location.href = url;
        });
        $('a[data-toggle="tab"]').on("shown.bs.tab", function (e) {
          const target = $(e.target).attr("href");
          if (history.replaceState) {
            history.replaceState(null, null, target);
          } else {
            location.hash = target;
          }
          if (target === "#products") {
            loadProductCharts();
            setTimeout(() => {
              Object.values(charts).forEach((c) => c && c.resize());
            }, 100);
          }
        });
        // Handle URL hash navigation
        function initializeTabFromURL() {
          const hash = location.hash;
          const validTabs = ["#overview", "#products"];

          console.log("Current URL hash:", hash);

          if (validTabs.includes(hash)) {
            const targetTab = `a[href="${hash}"]`;
            if ($(targetTab).length > 0) {
              console.log("Activating tab:", hash);
              $(targetTab).tab("show");

              if (hash === "#products") {
                setTimeout(loadProductCharts, 100);
              }
            }
          } else if (hash) {
            console.warn("Invalid tab hash:", hash);
            // Default to overview
            $('a[href="#overview"]').tab("show");
          }
        }

        // Initialize on page load
        initializeTabFromURL();

        // Handle back/forward browser navigation
        $(window).on("hashchange", initializeTabFromURL);

        // Action button functions
        window.showAllProducts = function () {
          $('a[href="#products"]').tab("show");
        };

        window.showFavoriteProducts = function () {
          window.location.href = "/admin/statistics/view?type=favorites";
        };
        
        // Auto refresh disabled to prevent loading issues
        // setInterval(() => {
        //   if (charts.inventoryChart && charts.favoriteChart) {
        //     loadKPIData();
        //   }
        // }, 300000);
        
      }); // End $(function())
    </script>
  </body>
</html>
