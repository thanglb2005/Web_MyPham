<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Th·ªëng k√™ s·∫£n ph·∫©m - OneShop Admin</title>
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/assets/css/atlantis.min.css" />
    <link rel="stylesheet" href="/assets/css/atlantis.css" />
    <link rel="stylesheet" href="/assets/css/demo.css" />
    <link rel="stylesheet" href="/assets/css/fonts.min.css" />
    <link rel="stylesheet" href="/fonts/fontawesome/fontawesome.min.css" />
    <link rel="stylesheet" href="/css/admin-fonts.css" />
    <style>
      :root {
        --section-gap: 30px;
      }
      body {
        background: #f4f6f9;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        font-size: 14px;
        line-height: 1.5;
      }
      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 30px;
        border-radius: 15px;
        color: #fff;
        margin-bottom: var(--section-gap);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      }
      .stats-card {
        background: #fff;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
        height: 180px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 20px;
      }

      .action-button-card {
        background: #fff;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
      }

      .action-button-card .btn {
        border-radius: 10px;
        font-size: 1.1rem;
        font-weight: 600;
        padding: 15px 20px;
        transition: all 0.3s ease;
      }

      /* Responsive improvements */
      @media (max-width: 768px) {
        .stats-card {
          height: 160px;
          padding: 20px;
          margin-bottom: 15px;
        }
        .stats-card .number {
          font-size: 1.8rem;
        }
        .stats-card .label {
          font-size: 0.75rem;
        }
        .action-button-card {
          margin-bottom: 15px;
        }
      }

      @media (max-width: 576px) {
        .stats-card {
          height: 140px;
          padding: 15px;
        }
        .stats-card .number {
          font-size: 1.5rem;
        }
      }
      .stats-card .icon {
        font-size: 2.6rem;
        margin-bottom: 10px;
      }
      .stats-card .number {
        font-size: 2.2rem;
        font-weight: 800;
        color: #2c3e50;
      }
      .stats-card .label {
        color: #7f8c8d;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        font-weight: 600;
      }
      .table-responsive {
        background: #fff;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
        margin-bottom: var(--section-gap);
      }
      .chart-container {
        background: #fff;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
        margin-bottom: var(--section-gap);
        min-height: 520px;
        position: relative;
        overflow: hidden;
      }
      .chart-container canvas {
        width: 100% !important;
        height: 450px !important;
        max-height: 450px;
        display: block;
      }
      .chart-title {
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 15px;
      }
      .nav-tabs {
        border: none;
        /* Use previous section margin for top spacing; keep bottom equal */
        margin-top: 0;
        margin-bottom: var(--section-gap);
      }
      /* Keep spacing above tabs equal to below (one margin source only) */
      .alert-tables-section {
        margin-bottom: var(--section-gap) !important;
      }
      .nav-tabs .nav-link {
        border: none;
        background: #fff;
        margin-right: 12px;
        padding: 14px 28px;
        border-radius: 12px;
        color: #7f8c8d;
        font-weight: 700;
        font-size: 1rem;
        line-height: 1;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
      }
      .nav-tabs .nav-link i {
        margin-right: 8px;
        font-size: 1rem;
      }
      .nav-tabs .nav-link.active {
        color: #fff;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: 1px solid transparent;
      }
      /* Show the Products tab before Overview without changing HTML order */
      .nav-tabs {
        display: flex;
      }
      .nav-tabs .nav-item:nth-child(1) {
        order: 2;
      }
      .nav-tabs .nav-item:nth-child(2) {
        order: 1;
      }
      .qty-low {
        font-size: 1.25rem;
        font-weight: 800;
        white-space: nowrap;
      }
      .favorite-desc,
      .kpi-desc-big {
        font-size: 0.9rem !important;
        font-weight: 700;
        position: relative;
        top: -2px;
        margin-top: 0 !important;
      }
      .statistics-page .admin-footer {
        display: none !important;
      }
      /* Keep left sidebar width consistent with Products page */
      .sidebar {
        width: 250px !important;
      }
      .main-panel {
        margin-left: 250px !important;
      }
      @media (min-width: 991px) {
        .sidebar_minimize .main-panel {
          width: calc(100% - 75px);
          margin-left: 75px !important;
        }
      }
      /* Force uniform vertical spacing across sections */
      .row.mb-4 {
        margin-bottom: var(--section-gap) !important;
      }

      /* Loading states for KPI cards */
      .stats-card.loading {
        opacity: 0.7;
        transition: opacity 0.3s ease;
      }

      .loading-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.2rem;
        color: #007bff;
        z-index: 10;
      }

      .stats-card {
        position: relative;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .stats-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 35px rgba(102, 126, 234, 0.25);
      }

      .stats-card:active {
        transform: translateY(0);
      }
    </style>
  </head>
  <body class="statistics-page">
    <div class="wrapper">
      <th:block th:replace="~{admin/fragments/header :: header}"></th:block>
      <th:block th:replace="~{admin/fragments/navbar :: navbar}"></th:block>
      <div class="main-panel">
        <div class="content">
          <div class="header">
            <h3 class="mb-1">
              <i class="fas fa-chart-line"></i> Th·ªëng k√™ s·∫£n ph·∫©m
            </h3>
            <div class="text-light" style="opacity: 0.9">
              T·ªïng quan t·ªìn kho, s·∫£n ph·∫©m y√™u th√≠ch, h·∫°n d√πng v√† khuy·∫øn m√£i
            </div>
          </div>

          <!-- KPI Cards - Row 1 -->
          <div class="row mb-3">
            <div class="col-xl-3 col-lg-6 col-md-6">
              <div
                class="stats-card text-center"
                data-show="bestseller"
                title="Hi·ªÉn th·ªã S·∫£n ph·∫©m b√°n ch·∫°y"
              >
                <div class="icon text-success">
                  <i class="fas fa-trophy"></i>
                </div>
                <div class="number" id="best-sellers" th:text="${#numbers.formatInteger(bestSellers,0)}">0</div>
                <div class="label">B√ÅN CH·∫†Y</div>
              </div>
            </div>
            <div class="col-xl-3 col-lg-6 col-md-6">
              <div
                class="stats-card text-center"
                data-show="newest"
                title="Hi·ªÉn th·ªã S·∫£n ph·∫©m m·ªõi nh·∫≠p"
              >
                <div class="icon text-info">
                  <i class="fas fa-box"></i>
                </div>
                <div class="number" id="new-products" th:text="${#numbers.formatInteger(newProducts,0)}">0</div>
                <div class="label">M·ªöI NH·∫¨P</div>
              </div>
            </div>
            <div class="col-xl-3 col-lg-6 col-md-6">
              <div
                class="stats-card text-center"
                data-show="slowmoving"
                title="S·∫£n ph·∫©m b√°n ch·∫≠m"
              >
                <div class="icon text-warning">
                  <i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="number" id="slow-moving" th:text="${#numbers.formatInteger(slowMoving,0)}">0</div>
                <div class="label">B√ÅN CH·∫¨M 30D</div>
              </div>
            </div>
            <div class="col-xl-3 col-lg-6 col-md-6">
              <div
                class="stats-card text-center"
                data-show="trending_up"
                title="Xu h∆∞·ªõng tƒÉng tr∆∞·ªüng"
              >
                <div class="icon text-success">
                  <i class="fas fa-chart-bar"></i>
                </div>
                <div class="number" id="trending-up" th:text="${#numbers.formatInteger(trendingUp,0)}">0</div>
                <div class="label">TƒÇNG TR∆Ø·ªûNG</div>
              </div>
            </div>
          </div>

          <!-- KPI Cards - Row 2 -->
          <div class="row mb-4">
            <div class="col-xl-3 col-lg-6 col-md-6">
              <div
                class="stats-card text-center"
                data-show="lowstock"
                title="Hi·ªÉn th·ªã b·∫£ng s·∫Øp h·∫øt h√†ng"
              >
                <div class="icon text-danger">
                  <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="number" id="low-stock" th:text="${#numbers.formatInteger(lowStockCount,0)}">0</div>
                <div class="label">S·ªê L∆Ø·ª¢NG C√íN L·∫†I ‚â§ 10</div>
              </div>
            </div>
            <div class="col-xl-3 col-lg-6 col-md-6">
              <div
                class="stats-card text-center"
                data-show="expiring"
                title="Hi·ªÉn th·ªã b·∫£ng s·∫Øp h·∫øt h·∫°n"
              >
                <div class="icon text-warning">
                  <i class="fas fa-hourglass-end"></i>
                </div>
                <div class="number" id="expiring-products" th:text="${#numbers.formatInteger(expiringSoonCount,0)}">0</div>
                <div class="label">H·∫†N D√ôNG ‚â§ 30 NG√ÄY</div>
              </div>
            </div>
            <div class="col-xl-3 col-lg-6 col-md-6">
              <div
                class="stats-card text-center"
                data-show="favorites"
                title="Hi·ªÉn th·ªã b·∫£ng ƒë∆∞·ª£c ∆∞a chu·ªông"
              >
                <div class="icon text-danger"><i class="fas fa-heart"></i></div>
                <div class="number" id="favorite-products" th:text="${#numbers.formatInteger(favoritesCount,0)}">0</div>
                <div class="label">ƒê∆Ø·ª¢C KH√ÅCH H√ÄNG ∆ØA CHU·ªòNG</div>
              </div>
            </div>
            <div class="col-xl-3 col-lg-6 col-md-6">
              <div
                class="stats-card text-center"
                data-show="discounted"
                title="Hi·ªÉn th·ªã b·∫£ng ƒëang khuy·∫øn m√£i"
              >
                <div class="icon text-primary">
                  <i class="fas fa-percent"></i>
                </div>
                <div class="number" id="discounted-products" th:text="${#numbers.formatInteger(discountedCount,0)}">0</div>
                <div class="label">ƒêANG KHUY·∫æN M√ÉI</div>
              </div>
            </div>
          </div>



          <!-- Inventory Table Section with filters -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="search-bar" style="background:#fff;padding:14px;border-radius:12px;border:1px solid rgba(0,0,0,0.05);box-shadow:0 6px 18px rgba(0,0,0,0.06);">
                <form method="get" th:action="@{/admin/statistics}">
                  <div class="row g-2 align-items-end">
                    <div class="col-lg-4 col-md-6">
                      <label class="form-label text-muted" style="font-size:0.85rem;font-weight:600;margin-bottom:6px">
                        <i class="fas fa-layer-group text-primary"></i> Danh m·ª•c
                      </label>
                      <select class="form-select form-control" name="categoryId" style="height:38px;border:2px solid #e9ecef;border-radius:8px">
                        <option th:selected="${selectedCategoryId == null}" th:value="${null}">T·∫•t c·∫£ danh m·ª•c</option>
                        <option th:each="c : ${categories}"
                                th:value="${c.categoryId}"
                                th:selected="${selectedCategoryId != null and c.categoryId == selectedCategoryId}"
                                th:text="${c.categoryName}">Danh m·ª•c</option>
                      </select>
                    </div>
                    <div class="col-lg-5 col-md-6">
                      <label class="form-label text-muted" style="font-size:0.85rem;font-weight:600;margin-bottom:6px">
                        <i class="fas fa-search text-primary"></i> T√¨m ki·∫øm s·∫£n ph·∫©m/brand
                      </label>
                      <input class="form-control" type="text" name="search" th:value="${searchTerm}"
                             placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m, danh m·ª•c ho·∫∑c th∆∞∆°ng hi·ªáu..."
                             style="height:38px;border:2px solid #e9ecef;border-radius:8px" />
                    </div>
                    <div class="col-lg-2 col-md-4">
                      <label class="form-label text-muted" style="font-size:0.85rem;font-weight:600;margin-bottom:6px">
                        <i class="fas fa-list text-primary"></i> Hi·ªÉn th·ªã
                      </label>
                      <select class="form-select form-control" name="size" style="height:38px;border:2px solid #e9ecef;border-radius:8px">
                        <option th:selected="${pageSize == 10}" value="10">üìÑ 10 m·ª•c</option>
                        <option th:selected="${pageSize == 20}" value="20">üìÑ 20 m·ª•c</option>
                        <option th:selected="${pageSize == 50}" value="50">üìÑ 50 m·ª•c</option>
                      </select>
                    </div>
                    <div class="col-lg-1 col-md-2">
                      <label class="form-label text-muted d-block" style="opacity:0">&nbsp;</label>
                      <button class="btn btn-primary w-100" type="submit" style="height:38px;border-radius:8px;font-weight:600">
                        L·ªçc
                      </button>
                    </div>
                  </div>
                </form>
              </div>

              <div class="table-responsive">
                <div class="chart-title"><i class="fas fa-cubes"></i> T·ªìn kho chi ti·∫øt theo danh m·ª•c</div>
                <table class="table table-hover align-middle">
                  <thead>
                    <tr>
                      <th style="width: 22%">DANH M·ª§C</th>
                      <th style="width: 35%">T√äN S·∫¢N PH·∫®M</th>
                      <th style="width: 18%">TH∆Ø∆†NG HI·ªÜU</th>
                      <th class="text-end" style="width: 8%">S·ªê L∆Ø·ª¢NG</th>
                      <th class="text-end" style="width: 8%">ƒê∆†N GI√Å</th>
                      <th class="text-end" style="width: 9%">GI√Å TR·ªä</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr th:if="${inventoryDetails == null or #lists.isEmpty(inventoryDetails)}">
                      <td colspan="6" class="text-center text-muted">Kh√¥ng c√≥ d·ªØ li·ªáu t·ªìn kho</td>
                    </tr>
                    <tr th:each="r, stat : ${inventoryDetails}">
                      <!-- r: [category_name, product_name, brand_name, quantity, price, total_value] -->
                      <td th:text="${r[0]}"></td>
                      <td><strong th:text="${r[1]}"></strong></td>
                      <td th:text="${r[2]}"></td>
                      <td class="text-end" th:text="${#numbers.formatInteger(r[3],0)}"></td>
                      <td class="text-end" th:text="${#numbers.formatInteger(r[4],0)}"></td>
                      <td class="text-end" th:text="${#numbers.formatInteger(r[5],0)}"></td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Pagination -->
              <nav aria-label="Pagination" class="p-2" th:if="${totalPages > 0}">
                <ul class="pagination justify-content-end">
                  <li class="page-item" th:classappend="${currentPage == 0} ? ' disabled'">
                    <a class="page-link"
                       th:href="@{/admin/statistics(page=0, size=${pageSize}, search=${searchTerm}, categoryId=${selectedCategoryId})}">&laquo;</a>
                  </li>
                  <li class="page-item" th:classappend="${currentPage == 0} ? ' disabled'">
                    <a class="page-link"
                       th:href="@{/admin/statistics(page=${currentPage-1}, size=${pageSize}, search=${searchTerm}, categoryId=${selectedCategoryId})}">&lsaquo;</a>
                  </li>
                  <li class="page-item" th:each="p : ${#numbers.sequence(0, totalPages-1)}" th:classappend="${p==currentPage} ? ' active'">
                    <a class="page-link"
                       th:text="${p+1}"
                       th:href="@{/admin/statistics(page=${p}, size=${pageSize}, search=${searchTerm}, categoryId=${selectedCategoryId})}"></a>
                  </li>
                  <li class="page-item" th:classappend="${currentPage >= totalPages-1} ? ' disabled'">
                    <a class="page-link"
                       th:href="@{/admin/statistics(page=${currentPage+1}, size=${pageSize}, search=${searchTerm}, categoryId=${selectedCategoryId})}">&rsaquo;</a>
                  </li>
                  <li class="page-item" th:classappend="${currentPage >= totalPages-1} ? ' disabled'">
                    <a class="page-link"
                       th:href="@{/admin/statistics(page=${totalPages-1}, size=${pageSize}, search=${searchTerm}, categoryId=${selectedCategoryId})}">&raquo;</a>
                  </li>
                </ul>
              </nav>
            </div>
          </div>
      </div>
      <th:block th:replace="~{admin/fragments/footer :: footer}"></th:block>
    </div>
    <script src="/assets/js/core/jquery.3.2.1.min.js"></script>
    <script src="/assets/js/core/popper.min.js"></script>
    <script src="/assets/js/core/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script th:inline="javascript">
  /**
   * ONESHOP ADMIN STATISTICS DASHBOARD (Server-side render)
   * - KPI cards v√† charts ƒë∆∞·ª£c render d·ªØ li·ªáu ngay t·ª´ server (Thymeleaf)
   * - Click KPI card ƒë·ªÉ m·ªü danh s√°ch chi ti·∫øt: /admin/statistics/view?type={type}
   */
      $(function () {
        const charts = {};
        const store = {
          lowstock: { pageSize: 10 },
          expiring: { pageSize: 10 },
          discounted: { pageSize: 10 },
          favorites: { pageSize: 10 },
        };
        const baseOpts = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: "bottom",
              labels: { usePointStyle: true, font: { size: 12 } },
            },
          },
        };
        function makeChart(id) {
          console.log("Creating chart for:", id);
          const ctx = document.getElementById(id);
          
          if (!ctx) {
            console.error("Canvas element not found:", id);
            return null;
          }
          
          if (!window.Chart) {
            console.error("Chart.js library not loaded");
            return null;
          }
          
          try {
            const chart = new Chart(ctx, {
              type: "doughnut",
              data: {
                labels: [],
                datasets: [
                  {
                    data: [],
                    backgroundColor: [
                      "#667eea",
                      "#764ba2",
                      "#a29bfe",
                      "#fd79a8",
                      "#fdcb6e",
                      "#55efc4",
                      "#81ecec",
                      "#74b9ff",
                    ],
                    borderWidth: 2,
                  },
                ],
              },
              options: baseOpts,
            });
            console.log("Chart created successfully:", id);
            return chart;
          } catch (error) {
            console.error("Error creating chart:", id, error);
            return null;
          }
        }
        
        // Initialize everything when DOM is ready (server-side data)
        $(document).ready(function() {
          // Charts removed; server-side table only
        });
        
        // Charts removed
        
        // Removed client-side fetch; charts use server-provided data

        function buildPagination(pagerId, totalRows, pageSize, onPageChange) {
          const ul = document.getElementById(pagerId);
          if (!ul) return;
          const totalPages = Math.max(1, Math.ceil(totalRows / pageSize));
          let current = 1;
          function render() {
            const span = 2;
            let html = "";
            const li = (dis, text, page, active) =>
              `<li class="page-item ${dis ? "disabled" : ""} ${
                active ? "active" : ""
              }"><a class="page-link" href="#" data-page="${page}">${text}</a></li>`;
            html += li(current === 1, "¬´", 1, false);
            html += li(current === 1, "‚Äπ", Math.max(1, current - 1), false);
            const start = Math.max(1, current - span);
            const end = Math.min(totalPages, current + span);
            for (let i = start; i <= end; i++)
              html += li(false, String(i), i, i === current);
            html += li(
              current === totalPages,
              "‚Ä∫",
              Math.min(totalPages, current + 1),
              false
            );
            html += li(current === totalPages, "¬ª", totalPages, false);
            ul.innerHTML = html;
            ul.querySelectorAll("a[data-page]").forEach((a) => {
              a.addEventListener("click", (e) => {
                e.preventDefault();
                const p = Number(a.getAttribute("data-page")) || 1;
                if (p >= 1 && p <= totalPages) {
                  current = p;
                  onPageChange(p);
                  render();
                }
              });
            });
          }
          render();
          return {
            go: (p) => {
              current = p;
              render();
            },
          };
        }

        function paginateExistingTable(bodySelector, pagerId, pageSize) {
          const rows = Array.from(
            document.querySelectorAll(bodySelector + " > tr")
          );
          if (!rows.length) return;
          function showPage(page) {
            const start = (page - 1) * pageSize;
            const end = start + pageSize;
            rows.forEach((tr, idx) => {
              tr.style.display = idx >= start && idx < end ? "" : "none";
            });
          }
          const pager = buildPagination(
            pagerId,
            rows.length,
            pageSize,
            showPage
          );
          showPage(1);
          return pager;
        }

        function setChartTitle(canvasId, icon, text) {
          const cv = document.getElementById(canvasId);
          if (!cv) return;
          const t = cv.previousElementSibling;
          if (t && t.classList.contains("chart-title")) {
            t.innerHTML = `<i class="fas ${icon}"></i> ${text}`;
          }
        }
        /* Old client-side fetch logic removed: dashboard now uses server data */
        
        /* Old KPI fetch removed */
        function lowStock() {
          // Commented out - tables removed
          return;
        }
        function expiring() {
          // Stub - tables removed
          return;
        }
        function discounted() {
          // Stub - tables removed  
          return;
        }
        function favorites() {
          // Stub - tables removed
          return;
        }

        // Show corresponding table when clicking KPI cards
        $(
          "#section-lowstock,#section-expiring,#section-discounted,#section-favorites"
        ).hide();
        function showSection(id) {
          $(
            "#section-lowstock,#section-expiring,#section-discounted,#section-favorites"
          ).hide();
          $(id).show();
          document
            .querySelector(id)
            .scrollIntoView({ behavior: "smooth", block: "start" });
        }
        // Enhanced KPI card click handling with visual feedback
        $(".stats-card[data-show]").on("click", function () {
          const $card = $(this);
          const which = $card.data("show");

          console.log("KPI card clicked:", which);

          // Validate type parameter
          const validTypes = [
            "lowstock",
            "expiring",
            "discounted",
            "favorites",
            "bestseller",
            "newest",
            "slowmoving",
            "trending_up",
          ];
          if (!validTypes.includes(which)) {
            console.error("Invalid statistics type:", which);
            alert("Lo·∫°i th·ªëng k√™ kh√¥ng h·ª£p l·ªá: " + which);
            return;
          }

          // Add loading state visual feedback - DISABLED
          // $card.addClass("loading").css("pointer-events", "none");
          // $card.find(".number").text("...");
          // $card.append(
          //   '<div class="loading-overlay"><i class="fas fa-spinner fa-spin"></i></div>'
          // );

          // Navigate to detailed view
          console.log("Navigating to statistics view:", which);
          const url =
            "/admin/statistics/view?type=" + encodeURIComponent(which);
          console.log("Target URL:", url);
          window.location.href = url;
        });
        $('a[data-toggle="tab"]').on("shown.bs.tab", function (e) {
          const target = $(e.target).attr("href");
          if (history.replaceState) {
            history.replaceState(null, null, target);
          } else {
            location.hash = target;
          }
          if (target === "#products") {
            loadProductCharts();
            setTimeout(() => {
              Object.values(charts).forEach((c) => c && c.resize());
            }, 100);
          }
        });
        // Handle URL hash navigation
        function initializeTabFromURL() {
          const hash = location.hash;
          const validTabs = ["#overview", "#products"];

          console.log("Current URL hash:", hash);

          if (validTabs.includes(hash)) {
            const targetTab = `a[href="${hash}"]`;
            if ($(targetTab).length > 0) {
              console.log("Activating tab:", hash);
              $(targetTab).tab("show");

              if (hash === "#products") {
                setTimeout(loadProductCharts, 100);
              }
            }
          } else if (hash) {
            console.warn("Invalid tab hash:", hash);
            // Default to overview
            $('a[href="#overview"]').tab("show");
          }
        }

        // Initialize on page load
        initializeTabFromURL();

        // Handle back/forward browser navigation
        $(window).on("hashchange", initializeTabFromURL);

        // Action button functions
        window.showAllProducts = function () {
          $('a[href="#products"]').tab("show");
        };

        window.showFavoriteProducts = function () {
          window.location.href = "/admin/statistics/view?type=favorites";
        };
        
  // Auto refresh disabled
        
      }); // End $(function())
    </script>
  </body>
</html>
