<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thống Kê Doanh Thu - OneShop Admin</title>
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/assets/css/atlantis.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <style>
        /* Enhanced UI Styles */
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }
        .metric-card.primary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .metric-card.success-card {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        .metric-card.info-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .metric-card.warning-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .chart-container {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            position: relative;
            overflow: hidden;
        }
        
        /* Grid overlay cho tất cả biểu đồ */
        .chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(0,0,0,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.03) 1px, transparent 1px),
                linear-gradient(rgba(0,0,0,0.08) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.08) 1px, transparent 1px);
            background-size: 20px 20px, 20px 20px, 100px 100px, 100px 100px;
            pointer-events: none;
            border-radius: 15px;
            z-index: 1;
        }
        
        /* Tăng độ mờ cho doughnut chart */
        .doughnut-grid .chart-container::before {
            background-image: 
                linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px);
        }
        
        .chart-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            opacity: 0.1;
            color: #667eea;
        }
        
        /* Đảm bảo canvas luôn ở trên grid */
        #revenueChart {
            position: relative;
            z-index: 2;
        }
        
        .btn-filter {
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .btn-filter:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 35px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .page-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }
        
        .header-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 2;
        }
        
        .header-content {
            flex: 1;
        }
        
        .header-stats {
            margin-left: 30px;
        }
        
        .page-title {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 0 0 12px 0;
            display: flex;
            align-items: center;
            gap: 12px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .page-title i {
            font-size: 2rem;
            color: rgba(255,255,255,0.9);
        }
        
        .page-description {
            font-size: 1.1rem;
            opacity: 0.95;
            margin: 0;
            line-height: 1.5;
            font-weight: 400;
        }
        
        .total-revenue-card {
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 15px;
            padding: 20px 25px;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 280px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .total-revenue-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }
        
        .revenue-icon {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
        }
        
        .revenue-info {
            flex: 1;
        }
        
        .revenue-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 4px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .revenue-value {
            font-size: 1.8rem;
            font-weight: 700;
            line-height: 1.2;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .breadcrumb-nav {
            background: white;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .breadcrumb {
            margin: 0;
            padding: 0;
            background: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .breadcrumb-item a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: color 0.3s ease;
            padding: 6px 10px;
            border-radius: 8px;
        }
        
        .breadcrumb-item a:hover {
            color: #5a67d8;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .breadcrumb-item span {
            color: #666;
            font-weight: 500;
            padding: 6px 10px;
        }
        
        .breadcrumb-item.active span {
            color: #333;
            font-weight: 600;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
        }
        
        .breadcrumb-separator {
            color: #ccc;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .metric-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .stats-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .page-description {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .stats-overview .stat-item {
            text-align: right;
        }
        
        .stat-label {
            display: block;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .stat-value {
            display: block;
            font-size: 1.4rem;
            font-weight: bold;
        }
        
        .growth-indicator {
            display: inline-flex;
            align-items: center;
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.85rem;
        }
        
        .customer-item, .product-item {
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .customer-item:last-child, .product-item:last-child {
            border-bottom: none;
        }
        
        .chart-placeholder {
            position: relative;
            z-index: 2;
        }
        
        .bg-gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }
        
        .form-control, .form-select {
            border-radius: 8px !important;
            border: 1px solid #ddd;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25) !important;
            border-color: #667eea;
        }
        
        .breadcrumb {
            background: none;
            padding: 0;
        }
        
        .breadcrumb-item a {
            text-decoration: none;
        }
        
        /* Animation cho elements */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .metric-card, .card {
            animation: fadeInUp 0.6s ease-out;
        }
        
        .metric-card:nth-child(2) { animation-delay: 0.1s; }
        .metric-card:nth-child(3) { animation-delay: 0.2s; }
        .metric-card:nth-child(4) { animation-delay: 0.3s; }
    </style>
</head>
<body>
    <div class="wrapper">
        <!-- Header -->
        <th:block th:replace="~{admin/fragments/header :: header}"></th:block>
        
        <!-- Sidebar -->
        <th:block th:replace="~{admin/fragments/navbar :: navbar}"></th:block>

        <!-- Main Panel -->
        <div class="main-panel">
            <div class="content">
                <div class="page-inner">
                    <!-- Modern Header Section -->
                    <div class="page-header">
                        <div class="header-main">
                            <div class="header-content">
                                <h1 class="page-title">
                                    <i class="fas fa-chart-line"></i>
                                    Thống Kê Doanh Thu
                                </h1>
                                <p class="page-description">
                                    Phân tích doanh số và hiệu suất kinh doanh theo từng khoảng thời gian
                                </p>
                            </div>
                            
                            <div class="header-stats">
                                <div class="total-revenue-card">
                                    <div class="revenue-icon">
                                        <i class="fas fa-dollar-sign"></i>
                                    </div>
                                    <div class="revenue-info">
                                        <div class="revenue-label">Tổng Doanh Thu Tháng</div>
                                        <div class="revenue-value" th:text="${currentMonthRevenue}">2,500,000 đ</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Clean Breadcrumb Navigation -->
                    <nav aria-label="breadcrumb" class="breadcrumb-nav">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="/admin/home">
                                    <i class="fas fa-home me-1"></i>
                                    <span>Trang chủ</span>
                                </a>
                            </li>
                            <li class="breadcrumb-separator">›</li>
                            <li class="breadcrumb-item">
                                <span>Thống Kê Doanh Số</span>
                            </li>
                            <li class="breadcrumb-separator">›</li>
                            <li class="breadcrumb-item active">
                                <span>Thống Kê Doanh Thu</span>
                            </li>
                        </ol>
                    </nav>

                    <!-- Content -->
                    <div class="row">
                        <!-- Revenue Summary Cards -->
                        <div class="col-md-12 mb-4">
                            <div class="row g-4">
                                <div class="col-md-3">
                                    <div class="card metric-card primary-card">
                                        <div class="card-body p-4">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h3 class="mb-1 fw-bold" th:text="${currentMonthRevenue}">2,500,000 đ</h3>
                                                    <p class="mb-2 opacity-75">Doanh thu tháng này</p>
                                                    <div class="growth-indicator" th:classappend="${growthRate.startsWith('-')} ? 'text-danger' : 'text-success'">
                                                        <i class="fas" th:classappend="${growthRate.startsWith('-')} ? 'fa-arrow-down' : 'fa-arrow-up'" ></i>
                                                        <span th:text="${growthRate + '%'}">12.5%</span>
                                                    </div>
                                                </div>
                                                <div class="metric-icon">
                                                    <i class="fas fa-chart-line"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-3">
                                    <div class="card metric-card success-card">
                                        <div class="card-body p-4">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h3 class="mb-1 fw-bold" th:text="${todayOrders}">15</h3>
                                                    <p class="mb-2 opacity-75">Đơn hàng hôm nay</p>
                                                    <div class="revenue-amount">
                                                        <span th:text="${todayRevenue}">750,000 đ</span>
                                                    </div>
                                                </div>
                                                <div class="metric-icon">
                                                    <i class="fas fa-shopping-cart"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-3">
                                    <div class="card metric-card info-card">
                                        <div class="card-body p-4">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h3 class="mb-1 fw-bold" th:text="${selectedPeriod}">T10/2025</h3>
                                                    <p class="mb-2 opacity-75">Kỳ được chọn</p>
                                                    <div class="period-info">
                                                        <span th:text="${selectedRevenue}">1,500,000 đ</span>
                                                    </div>
                                                </div>
                                                <div class="metric-icon">
                                                    <i class="fas fa-calendar-alt"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-3">
                                    <div class="card metric-card warning-card">
                                        <div class="card-body p-4">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h3 class="mb-1 fw-bold" th:text="${completionRate} + '%'">98%</h3>
                                                    <p class="mb-2 opacity-75">Tỷ lệ hoàn thành</p>
                                                    <div class="completion-info" th:text="${completionText}">
                                                        286/292 đơn
                                                    </div>
                                                </div>
                                                <div class="metric-icon">
                                                    <i class="fas fa-check-circle"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Filter Section -->
                        <div class="col-md-12 mb-4">
                            <div class="card stats-section">
                                <div class="card-header bg-white border-0 pb-0">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-filter text-primary me-2"></i>
                                        Bộ lọc thống kê
                                    </h5>
                                    <p class="text-muted mt-1 mb-0">Chọn khoảng thời gian để xem dữ liệu chi tiết</p>
                                </div>
                                <div class="card-body pt-4">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="filter-buttons">
                                                <button type="button" class="btn btn-filter btn-primary me-2 mb-2" onclick="filterRevenue('month')">
                                                    <i class="fas fa-calendar me-2"></i>Theo Tháng
                                                </button>
                                                <button type="button" class="btn btn-filter btn-outline-secondary me-2 mb-2" onclick="filterRevenue('quarter')">
                                                    <i class="fas fa-th-large me-2"></i>Theo Quý
                                                </button>
                                                <button type="button" class="btn btn-filter btn-outline-warning mb-2" onclick="filterRevenue('year')">
                                                    <i class="fas fa-chart-line me-2"></i>Theo Năm
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label fw-semibold">Năm</label>
                                                    <select class="form-select form-control" id="yearSelect">
                                                        <option value="2025">2025</option>
                                                        <option value="2024">2024</option>
                                                        <option value="2023">2023</option>
                                                        <option value="2022">2022</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6 mb-3 mb-3">
                                                    <label class="form-label fw-semibold">Tháng</label>
                                                    <select class="form-select form-control" id="monthSelect">
                                                        <option value="1">Tháng 1</option>
                                                        <option value="2">Tháng 2</option>
                                                        <option value="3">Tháng 3</option>
                                                        <option value="4">Tháng 4</option>
                                                        <option value="5">Tháng 5</option>
                                                        <option value="6">Tháng 6</option>
                                                        <option value="7">Tháng 7</option>
                                                        <option value="8">Tháng 8</option>
                                                        <option value="9">Tháng 9</option>
                                                        <option value="10" selected>Tháng 10</option>
                                                        <option value="11">Tháng 11</option>
                                                        <option value="12">Tháng 12</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6" id="quarterSelector" style="display: none;">
                                                    <label class="form-label fw-semibold">Quý</label>
                                                    <select class="form-select form-control" id="quarterSelect">
                                                        <option value="1">Quý 1</option>
                                                        <option value="2">Quý 2</option>
                                                        <option value="3">Quý 3</option>
                                                        <option value="4" selected>Quý 4</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Revenue Chart Placeholder -->
                        <div class="col-md-8 mb-4">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-chart-bar text-primary me-2"></i>
                                        Biểu đồ Doanh Thu
                                    </h5>
                                    <div class="chart-controls">
                                        <button class="btn btn-sm btn-outline-primary" onclick="downloadChart()" title="Tải xuống biểu đồ">
                                            <i class="fas fa-download"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleChartType()" title="Chuyển đổi loại biểu đồ">
                                            <i class="fas fa-chart-bar"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container" id="chartContainer" style="height: 400px; position: relative;">
                                        <canvas id="revenueChart" width="400" height="400"></canvas>
                                        <div class="chart-info mt-3 text-center">
                                            <p class="text-muted mb-2">
                                                <i class="fas fa-info-circle"></i>
                                                <span id="chartDescription">Biểu đồ line thể hiện xu hướng doanh thu và đơn hàng theo thời gian</span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Top Customers -->
                        <div class="col-md-4 mb-4">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-users text-success me-2"></i>
                                        Top Khách Hàng
                                    </h6>
                                    <span class="badge bg-success">Top 5</span>
                                </div>
                                <div class="card-body">
                                    <div class="top-customers">
                                        <div th:if="${topCustomers != null && !topCustomers.empty}">
                                            <div th:each="customer : ${topCustomers}" class="customer-item d-flex justify-content-between align-items-center mb-3">
                                                <div class="customer-info">
                                                    <div class="customer-name fw-semibold" th:text="${customer.name}">Nguyễn Văn A</div>
                                                    <small class="text-muted" th:text="${customer.orderCount + ' đơn hàng'}">15 đơn hàng</small>
                                                </div>
                                                <div class="customer-revenue text-success fw-bold" th:text="${customer.formattedTotalSpent}">2,500,000 đ</div>
                                            </div>
                                        </div>
                                        <div th:if="${topCustomers == null || topCustomers.empty}" class="text-center py-4">
                                            <i class="fas fa-exclamation-circle text-muted mb-2" style="font-size: 2rem;"></i>
                                            <p class="text-muted">Chưa có dữ liệu khách hàng</p>
                                        </div>
                                        <div class="text-center">
                                            <small class="text-muted">Top khách hàng theo doanh thu</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Top Products -->
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-crown text-warning me-2"></i>
                                        Top Sản Phẩm
                                    </h6>
                                    <span class="badge bg-warning text-dark">TOP 5</span>
                                </div>
                                <div class="card-body">
                                    <div class="top-products">
                                        <div th:if="${topProducts != null && !topProducts.empty}">
                                            <div th:each="product : ${topProducts}" class="product-item d-flex justify-content-between align-items-center mb-3">
                                                <div class="product-info">
                                                    <div class="product-name fw-semibold" th:text="${product.name}">Kem dưỡng ban đêm</div>
                                                    <small class="text-muted" th:text="'Đã bán: ' + ${product.quantitySold} + ' sản phẩm'">Đã bán: 156 sản phẩm</small>
                                                </div>
                                                <div class="product-revenue text-primary fw-bold" th:text="${product.formattedRevenue}">1,200,000 đ</div>
                                            </div>
                                        </div>
                                        <div th:if="${topProducts == null || topProducts.empty}" class="text-center py-4">
                                            <i class="fas fa-exclamation-circle text-muted mb-2" style="font-size: 2rem;"></i>
                                            <p class="text-muted">Chưa có dữ liệu sản phẩm</p>
                                        </div>
                                        <div class="text-center">
                                            <small class="text-muted">Sản phẩm bán chạy nhất</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Summary Stats -->
                        <div class="col-md-6 mb-4">
                            <div class="card bg-gradient-primary text-white">
                                <div class="card-header border-0">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Tóm tát Thống kê
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="summary-stats">
                                        <div class="stat-row d-flex justify-content-between mb-2">
                                            <span>Tổng số đơn hàng:</span>
                                            <span class="fw-bold" id="totalOrders">...</span>
                                        </div>
                                        <div class="stat-row d-flex justify-content-between mb-2">
                                            <span>Doanh thu trung bình:</span>
                                            <span class="fw-bold" id="avgRevenue">...</span>
                                        </div>
                                        <div class="stat-row d-flex justify-content-between mb-2">
                                            <span>Tỷ lệ tăng trưởng:</span>
                                            <span class="fw-bold" id="growthRateDisplay">...</span>
                                        </div>
                                        <div class="stat-row d-flex justify-content-between mb-2">
                                            <span>Đơn hàng đã hoàn thành:</span>
                                            <span class="fw-bold" id="completedOrders">...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <footer class="footer">
                <div class="container-fluid">
                    <nav class="pull-left">
                        <ul class="nav">
                            <li class="nav-item">
                                <a class="nav-link" href="#">OneShop Admin</a>
                            </li>
                        </ul>
                    </nav>
                    <div class="copyright ml-auto">
                        2025, made with <i class="fa fa-heart heart text-danger"></i> by <a href="#">OneShop Team</a>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/assets/js/core/jquery.3.2.1.min.js"></script>
    <script src="/assets/js/core/popper.min.js"></script>
    <script src="/assets/js/core/bootstrap.min.js"></script>
    <script src="/assets/js/plugin/jquery-ui-1.12.1.custom/jquery-ui.min.js"></script>
    <script src="/assets/js/plugin/jquery-ui-touch-punch/jquery.ui.touch-punch.min.js"></script>
    <script src="/assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
    <script src="/assets/js/atlantis.min.js"></script>
    
    <script>
        // Global toggleSidebar function (required by header)
        window.toggleSidebar = function() {
            const wrapper = document.querySelector(".wrapper");
            const minibutton = document.querySelector(".toggle-sidebar");

            if (wrapper.classList.contains("sidebar_minimize")) {
                wrapper.classList.remove("sidebar_minimize");
                minibutton.classList.remove("toggled");
                minibutton.innerHTML = '<i class="icon-menu"></i>';
            } else {
                wrapper.classList.add("sidebar_minimize");
                minibutton.classList.add("toggled");
                minibutton.innerHTML = '<i class="icon-options-vertical"></i>';
            }
            window.dispatchEvent(new Event("resize"));
        };

        // Chart.js Variables
        let revenueChart;
        let chartType = 'line'; // 'line', 'bar', 'doughnut'
        let currentSelectedType = '[[${selectedType}]]';
        let selectedYear = parseInt('[[${currentYear}]]');
        let selectedMonth = parseInt('[[${currentMonth}]]');
        let selectedQuarter = parseInt('[[${currentQuarter}]]');

        // Fetch chart data from API
        async function fetchChartData(type, year) {
            try {
                console.log(`Fetching chart data for ${type} in ${year}`);
                const response = await fetch(`/admin/api/revenue-chart?type=${type}&year=${year}`);
                
                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('API returned data:', data);
                
                // Verify data structure
                if (!data.labels || !data.revenueData || !data.orderData) {
                    console.warn('API returned incomplete data structure', data);
                    return generateFallbackChartData(type);
                }
                
                // Process revenue and order data to ensure they're numeric arrays
                const processedRevenueData = Array.isArray(data.revenueData) ? 
                    data.revenueData.map(val => Number(val)) : 
                    [];
                    
                const processedOrderData = Array.isArray(data.orderData) ? 
                    data.orderData.map(val => Number(val)) : 
                    [];
                
                console.log('Processed chart data:', {
                    labels: data.labels,
                    revenueData: processedRevenueData,
                    orderData: processedOrderData
                });
                
                return {
                    labels: data.labels,
                    revenueData: processedRevenueData,
                    orderData: processedOrderData
                };
            } catch (error) {
                console.error('Error fetching chart data:', error);
                // Return fallback data if API fails
                return generateFallbackChartData(type);
            }
        }

        // Fallback data generator if API fails
        function generateFallbackChartData(type) {
            const now = new Date();
            let labels = [];
            let revenueData = [];
            let orderData = [];

            switch(type) {
                case 'month':
                    labels = ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'];
                    revenueData = Array(12).fill(0);
                    orderData = Array(12).fill(0);
                    break;
                case 'quarter':
                    labels = ['Q1', 'Q2', 'Q3', 'Q4'];
                    revenueData = Array(4).fill(0);
                    orderData = Array(4).fill(0);
                    break;
                case 'year':
                    const currentYear = now.getFullYear();
                    labels = [
                        (currentYear-4).toString(), 
                        (currentYear-3).toString(), 
                        (currentYear-2).toString(), 
                        (currentYear-1).toString(), 
                        currentYear.toString()
                    ];
                    revenueData = Array(5).fill(0);
                    orderData = Array(5).fill(0);
                    break;
                default:
                    labels = ['T1', 'T2', 'T3', 'T4', 'T5', 'T6'];
                    revenueData = Array(6).fill(0);
                    orderData = Array(6).fill(0);
            }

            console.log('Sử dụng dữ liệu fallback cho biểu đồ do API lỗi');
            return { labels, revenueData, orderData };
        }

        // Initialize Chart
        async function initChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            const chartData = await fetchChartData(currentSelectedType, selectedYear);

            if (revenueChart) {
                revenueChart.destroy();
            }

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: chartType === 'doughnut' ? 'bottom' : 'top',
                        labels: {
                            usePointStyle: true,
                            font: { size: chartType === 'doughnut' ? 14 : 12 },
                            padding: chartType === 'doughnut' ? 25 : 10
                        }
                    },
                    tooltip: {
                        mode: chartType === 'doughnut' ? 'point' : 'index',
                        intersect: chartType === 'doughnut' ? true : false,
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        callbacks: {
                            label: function(context) {
                                if (chartType === 'doughnut') {
                                    // Xử lý riêng cho biểu đồ tròn với hai datasets
                                    if (context.dataset.label === 'Số đơn hàng (x1000 để đồng tỷ lệ)') {
                                        // Scale lại về giá trị gốc cho đơn hàng
                                        const originalValue = context.parsed / 1000;
                                        const total = context.dataset.data.reduce((sum, value) => sum + value, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        return 'Đơn hàng: ' + originalValue + ' đơn (' + percentage + '%)';
                                    } else {
                                        const total = context.dataset.data.reduce((sum, value) => sum + value, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        return 'Doanh thu: ' + 
                                               new Intl.NumberFormat('vi-VN').format(context.parsed) + ' đ (' + 
                                               percentage + '%)';
                                    }
                                } else if (context.dataset.label === 'Doanh thu (VNĐ)') {
                                    return context.dataset.label + ': ' + new Intl.NumberFormat('vi-VN').format(context.parsed.y) + ' đ';
                                } else {
                                    return context.dataset.label + ': ' + context.parsed.y + ' đơn';
                                }
                            }
                        }
                    }
                }
            };

            // Chỉ thêm scales và interaction cho line và bar charts
            if (chartType !== 'doughnut') {
                chartOptions.scales = {
                    x: {
                        display: true,
                        title: { 
                            display: true, 
                            text: 'Thời gian',
                            font: { size: 14, weight: 'bold' },
                            color: '#666'
                        },
                        grid: { 
                            color: 'rgba(0,0,0,0.15)',
                            drawBorder: true,
                            borderColor: 'rgba(0,0,0,0.2)'
                        },
                        ticks: {
                            font: { size: 12 },
                            color: '#666',
                            padding: 8
                        }
                    },
                    y: {
                        display: true,
                        title: { 
                            display: true, 
                            text: 'Giá trị',
                            font: { size: 14, weight: 'bold' },
                            color: '#666'
                        },
                        grid: { 
                            color: 'rgba(0,0,0,0.1)',
                            drawBorder: true,
                            borderColor: 'rgba(0,0,0,0.2)',
                            lineWidth: 1
                        },
                        ticks: {
                            font: { size: 11 },
                            color: '#666',
                            padding: 6,
                            callback: function(value) {
                                return new Intl.NumberFormat('vi-VN').format(value) + 'đ';
                            }
                        },
                        beginAtZero: true
                    },
                    y1: {
                        display: true,
                        position: 'right',
                        title: { 
                            display: true, 
                            text: 'Số lượng đơn hàng',
                            font: { size: 12, weight: 'bold' },
                            color: '#666'
                        },
                        grid: {
                            drawOnChartArea: false, // Chỉ vẽ grid cho axis chính
                        },
                        ticks: {
                            font: { size: 11 },
                            color: '#666',
                            padding: 6,
                            stepSize: 10,
                            callback: function(value) {
                                return value + ' đơn';
                            }
                        },
                        beginAtZero: true
                    }
                };
                chartOptions.interaction = { intersect: false, mode: 'index' };
            }

            let datasets = [];

            if (chartType === 'doughnut') {
                // Tạo hai datasets cho biểu đồ tròn: một cho doanh thu và một cho đơn hàng
                const revenueColors = getPeriodColors(currentSelectedType);
                const orderColors = generateOrderColors(chartData.orderData.length);
                
                datasets = [
                    {
                        label: 'Doanh thu (VNĐ)',
                        data: chartData.revenueData,
                        backgroundColor: revenueColors.slice(0, chartData.revenueData.length),
                        borderColor: revenueColors.slice(0, chartData.revenueData.length).map(color => 
                            color.replace('0.8)', '1)')),  
                        borderWidth: 3,
                        hoverBorderWidth: 5,
                        hoverOffset: 10
                    },
                    {
                        label: 'Số đơn hàng (x1000 để đồng tỷ lệ)',
                        data: chartData.orderData.map(value => value * 1000), // Scale up để đồng tỷ lệ với doanh thu
                        backgroundColor: orderColors,
                        borderColor: orderColors.map(color => 
                            color.replace('0.6)', '1)')),  
                        borderWidth: 2,
                        hoverBorderWidth: 4,
                        hoverOffset: 8
                    }
                ];
            } else {
                // Datasets cho biểu đồ line và bar
                datasets = [
                    {
                        label: 'Doanh thu (VNĐ)',
                        data: chartData.revenueData,
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: chartType === 'line' ? 3 : 1,
                        fill: chartType === 'line',
                        tension: chartType === 'line' ? 0.4 : 0,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Số đơn hàng',
                        data: chartData.orderData,
                        borderColor: 'rgb(56, 239, 125)',
                        backgroundColor: 'rgba(56, 239, 125, 0.1)',
                        borderWidth: chartType === 'line' ? 2 : 1,
                        fill: chartType === 'line',
                        tension: chartType === 'line' ? 0.4 : 0,
                        yAxisID: 'y1'
                    }
                ];
            }

            revenueChart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: chartData.labels,
                    datasets: datasets
                },
                options: chartOptions
            });
        }

        // Generate colors based on period type
        function getPeriodColors(periodType) {
            const colorSchemes = {
                'month': [
                    // Màu sắc cho 12 tháng - theo mùa và cảm xúc
                    'rgba(255, 99, 132, 0.8)',   // T1 - Màu hồng mùa xuân
                    'rgba(255, 159, 64, 0.8)',   // T2 - Cam
                    'rgba(255, 205, 86, 0.8)',   // T3 - Vàng mùa xuân
                    'rgba(75, 192, 192, 0.8)',   // T4 - Xanh lá mùa hè
                    'rgba(54, 162, 235, 0.8)',   // T5 - Xanh dương mùa hè
                    'rgba(153, 102, 255, 0.8)', // T6 - Tím mùa hè
                    'rgba(255, 193, 7, 0.8)',    // T7 - Vàng chói mùa hè
                    'rgba(201, 203, 207, 0.8)',  // T8 - Xám mùa thu
                    'rgba(220, 53, 69, 0.8)',    // T9 - Đỏ mùa thu
                    'rgba(102, 126, 234, 0.8)',  // T10 - Xanh tím mùa đông
                    'rgba(40, 167, 69, 0.8)',    // T11 - Xanh lá đậm mùa đông
                    'rgba(111, 66, 193, 0.8)'    // T12 - Tím đậm mùa đông
                ],
                'quarter': [
                    // Màu sắc cho 4 quý
                    'rgba(56, 239, 125, 0.8)',   // Q1 - Xanh lá mùa xuân
                    'rgba(255, 193, 7, 0.8)',    // Q2 - Vàng mùa hè
                    'rgba(255, 99, 132, 0.8)',   // Q3 - Hồng mùa thu
                    'rgba(102, 126, 234, 0.8)'   // Q4 - Xanh mùa đông
                ],
                'year': [
                    // Màu sắc cho năm - gradient tăng dần độ đậm
                    'rgba(255, 159, 64, 0.8)',   // 2021 - Cam nhạt
                    'rgba(255, 99, 132, 0.8)',   // 2022 - Hồng
                    'rgba(153, 102, 255, 0.8)',  // 2023 - Tím
                    'rgba(54, 162, 235, 0.8)',   // 2024 - Xanh dương
                    'rgba(75, 192, 192, 0.8)'    // 2025 - Xanh lá
                ],
                'default': [
                    // Màu mặc định cho các case khác
                    'rgba(102, 126, 234, 0.8)',
                    'rgba(56, 239, 125, 0.8)',   
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(220, 53, 69, 0.8)',
                    'rgba(111, 66, 193, 0.8)',
                    'rgba(0, 177, 106, 0.8)',
                    'rgba(255, 159, 64, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(201, 203, 207, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(153, 102, 255, 0.8)',
                    'rgba(255, 99, 132, 0.8)'
                ]
            };
            
            return colorSchemes[periodType] || colorSchemes['default'];
        }

        // Generate colors for orders data
        function generateOrderColors(length) {
            const orderColors = [
                'rgba(56, 239, 125, 0.6)',   // Xanh lá cho đơn hàng
                'rgba(75, 192, 192, 0.6)',  // Cyan
                'rgba(54, 162, 235, 0.6)',  // Xanh dương
                'rgba(153, 102, 255, 0.6)', // Tím
                'rgba(255, 205, 86, 0.6)',  // Vàng
                'rgba(255, 159, 64, 0.6)',  // Cam
                'rgba(255, 99, 132, 0.6)',  // Hồng
                'rgba(201, 203, 207, 0.6)', // Xám
                'rgba(102, 126, 234, 0.6)', // Xanh tím
                'rgba(220, 53, 69, 0.6)',   // Đỏ
                'rgba(111, 66, 193, 0.6)',  // Tím đậm
                'rgba(0, 177, 106, 0.6)'    // Xanh lá đậm
            ];
            
            return orderColors.slice(0, length);
        }

        // Update Chart Description
        function updateChartDescription() {
            const descriptions = {
                'line': 'Biểu đồ đường thể hiện xu hướng doanh thu và đơn hàng theo thời gian',
                'bar': 'Biểu đồ cột so sánh doanh thu và số đơn hàng giữa các giai đoạn', 
                'doughnut': 'Biểu đồ tròn phân tích tỷ lệ doanh thu và đơn hàng theo từng giai đoạn'
            };
            document.getElementById('chartDescription').textContent = descriptions[chartType];
        }

        // Update Dynamic Grid
        function updateDynamicGrid() {
            const container = document.getElementById('chartContainer');
            if (chartType === 'doughnut') {
                container.classList.add('doughnut-grid');
            } else {
                container.classList.remove('doughnut-grid');
            }
        }

        // Chart Functions
        function downloadChart() {
            if (revenueChart) {
                const link = document.createElement('a');
                link.download = 'revenue-chart.png';
                link.href = revenueChart.toBase64Image();
                link.click();
            }
        }

        async function toggleChartType() {
            const chartTypes = ['line', 'bar', 'doughnut'];
            const currentIndex = chartTypes.indexOf(chartType);
            const nextIndex = (currentIndex + 1) % chartTypes.length;
            chartType = chartTypes[nextIndex];
            
            await initChart();
            updateChartDescription();
            updateDynamicGrid();
            
            // Update button icon
            const button = event.target.closest('button');
            const iconMap = {
                'line': 'fa-chart-line',
                'bar': 'fa-chart-bar', 
                'doughnut': 'fa-chart-pie'
            };
            button.innerHTML = `<i class="fas ${iconMap[chartType]}"></i>`;
        }
        
        async function filterRevenue(type) {
            currentSelectedType = type;
            
            // Update button states
            document.querySelectorAll('button[onclick*="filterRevenue"]').forEach(btn => {
                btn.classList.remove('btn-primary', 'btn-secondary', 'btn-warning');
                btn.classList.add('btn-outline-primary', 'btn-outline-secondary', 'btn-outline-warning');
            });
            
            const buttonMap = { 'month': 'btn-primary', 'quarter': 'btn-secondary', 'year': 'btn-warning' };
            const activeBtn = document.querySelector(`button[onclick="filterRevenue('${type}')"]`);
            if (activeBtn) {
                activeBtn.classList.remove('btn-outline-primary', 'btn-outline-secondary', 'btn-outline-warning');
                activeBtn.classList.add(buttonMap[type]);
            }
            
            // Show/hide quarter selector
            const quarterSelector = document.getElementById('quarterSelector');
            if (type === 'quarter') {
                quarterSelector.style.display = 'block';
            } else {
                quarterSelector.style.display = 'none';
            }
            
            // Update URL to reflect the current filter (without page reload)
            const url = new URL(window.location);
            url.searchParams.set('type', type);
            url.searchParams.set('year', selectedYear);
            if (type === 'month') url.searchParams.set('month', selectedMonth);
            if (type === 'quarter') url.searchParams.set('quarter', selectedQuarter);
            window.history.pushState({}, '', url);
            
            // Update URL with filter parameters
            const params = new URLSearchParams(window.location.search);
            params.set('type', type);
            params.set('year', selectedYear);
            if (type === 'month') params.set('month', selectedMonth);
            if (type === 'quarter') params.set('quarter', selectedQuarter);
            
            // Update chart with new data from API
            await initChart();
            updateChartDescription();
            updateDynamicGrid();
            
            console.log('Filtered to:', type);
        }

        // Fetch summary statistics
        async function fetchSummaryStats() {
            try {
                // Update growth rate display
                const growthRateEl = document.getElementById('growthRateDisplay');
                const growthRate = '[[${growthRate}]]';
                if (growthRateEl) {
                    const isNegative = growthRate.startsWith('-');
                    growthRateEl.textContent = (isNegative ? '' : '+') + growthRate + '%';
                    growthRateEl.className = isNegative ? 'fw-bold text-danger' : 'fw-bold text-success';
                }
                
                // Fetch order completion stats
                const totalOrders = document.getElementById('totalOrders');
                const avgRevenue = document.getElementById('avgRevenue');
                const completedOrders = document.getElementById('completedOrders');
                
                if (totalOrders && avgRevenue && completedOrders) {
                    // Use values from controller
                    const completionText = '[[${completionText}]]';
                    if (completionText) {
                        const parts = completionText.split('/');
                        if (parts.length === 2) {
                            completedOrders.textContent = parts[0] + '/' + parts[1];
                            totalOrders.textContent = parts[1];
                        }
                    }
                    
                    // Default to current month revenue if we don't have average
                    const monthRevenue = '[[${currentMonthRevenue}]]';
                    avgRevenue.textContent = monthRevenue || 'Chưa có dữ liệu';
                }
            } catch (error) {
                console.error('Error fetching summary stats:', error);
            }
        }

        // Initialize
        $(document).ready(async function() {
            console.log('Revenue Statistics page loaded with Chart.js');
            
            // Ensure Bootstrap collapse works for sidebar
            $('[data-toggle="collapse"]').on('click', function(e) {
                e.preventDefault();
                var target = $(this).attr('href');
                $(target).collapse('toggle');
                
                // Update active state
                $('.nav-item').removeClass('active');
                $(this).closest('.nav-item').addClass('active');
            });
            
            // Read URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const urlType = urlParams.get('type');
            const urlYear = urlParams.get('year');
            const urlMonth = urlParams.get('month');
            const urlQuarter = urlParams.get('quarter');
            
            // Update variables with URL params if available
            if (urlType) currentSelectedType = urlType;
            if (urlYear) selectedYear = parseInt(urlYear);
            if (urlMonth) selectedMonth = parseInt(urlMonth);
            if (urlQuarter) selectedQuarter = parseInt(urlQuarter);
            
            console.log('URL parameters:', { 
                type: currentSelectedType,
                year: selectedYear,
                month: selectedMonth,
                quarter: selectedQuarter
            });
            
            // Setup year/month/quarter selectors
            $('#yearSelect').val(selectedYear).change(function() {
                selectedYear = parseInt($(this).val());
                filterRevenue(currentSelectedType);
            });
            
            $('#monthSelect').val(selectedMonth).change(function() {
                selectedMonth = parseInt($(this).val());
                if (currentSelectedType === 'month') {
                    filterRevenue('month');
                }
            });
            
            $('#quarterSelect').val(selectedQuarter).change(function() {
                selectedQuarter = parseInt($(this).val());
                if (currentSelectedType === 'quarter') {
                    filterRevenue('quarter');
                }
            });
            
            // Show/hide quarter selector based on current type
            const quarterSelector = document.getElementById('quarterSelector');
            if (quarterSelector) {
                quarterSelector.style.display = currentSelectedType === 'quarter' ? 'block' : 'none';
            }
            
            // Fetch summary stats
            await fetchSummaryStats();
            
            try {
                // Initialize button states and chart
                await filterRevenue(currentSelectedType || 'month');
                
                // Also update top customers and products periodically
                setTimeout(async () => {
                    try {
                        await fetchTopCustomersAndProducts();
                    } catch (error) {
                        console.error('Error updating top lists:', error);
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error initializing charts:', error);
                alert('Có lỗi xảy ra khi tải dữ liệu biểu đồ. Vui lòng thử lại sau.');
            }
            
            console.log('Revenue Statistics with Chart.js initialized');
        });
        
        // Fetch top customers and products data from API
        async function fetchTopCustomersAndProducts() {
            try {
                // Get top customers container
                const topCustomersContainer = document.querySelector('.top-customers');
                if (topCustomersContainer) {
                    const customersResponse = await fetch('/admin/api/top-customers?limit=5');
                    if (customersResponse.ok) {
                        const customers = await customersResponse.json();
                        if (customers && customers.length > 0) {
                            // Update UI with actual customer data
                            console.log('Fetched top customers:', customers);
                        }
                    }
                }
                
                // Get top products container
                const topProductsContainer = document.querySelector('.top-products');
                if (topProductsContainer) {
                    const productsResponse = await fetch('/admin/api/top-products?limit=5');
                    if (productsResponse.ok) {
                        const products = await productsResponse.json();
                        if (products && products.length > 0) {
                            // Update UI with actual product data
                            console.log('Fetched top products:', products);
                        }
                    }
                }
            } catch (error) {
                console.error('Error fetching top data:', error);
            }
        }
    </script>
</body>
</html>
