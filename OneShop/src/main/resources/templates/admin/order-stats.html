<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thống kê đơn hàng - OneShop Admin</title>

    <!-- CSS Libraries -->
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/assets/css/atlantis.min.css" />
    <link rel="stylesheet" href="/fonts/fontawesome/fontawesome.min.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />

    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/assets/css/atlantis.css" />
    <link rel="stylesheet" href="/assets/css/demo.css" />
    <link rel="stylesheet" href="/assets/css/fonts.min.css" />
    <link rel="stylesheet" href="/assets/css/atlantis.min.css" />

    <style>
      /* Fixed Sidebar */
      .sidebar {
        position: fixed;
        top: 60px;
        left: 0;
        bottom: 0;
        z-index: 1028;
        width: 250px;
        background: #f8f9fa;
        border-right: 1px solid #e9ecef;
        margin: 0;
        padding: 0;
      }

      /* Main Content */
      .main-panel {
        margin-left: 250px;
        margin-top: 60px;
        min-height: calc(100vh - 60px);
        background: #f8f9fa;
      }

      /* Statistics Cards */
      .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        padding: 25px;
        color: white;
        margin-bottom: 20px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }

      .stats-card:hover {
        transform: translateY(-5px);
      }

      .stats-card.success {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      }

      .stats-card.warning {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      }

      .stats-card.danger {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
      }

      .stats-card.info {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        color: #333;
      }

      .stats-icon {
        font-size: 3rem;
        opacity: 0.8;
        margin-bottom: 15px;
      }

      .stats-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .stats-label {
        font-size: 1rem;
        opacity: 0.9;
      }

      /* Chart Container */
      .chart-container {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .page-header {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      }

      .btn-back {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        text-decoration: none;
        transition: all 0.3s ease;
      }

      .btn-back:hover {
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      /* Status Legend */
      .status-legend {
        padding: 20px 0;
      }

      .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 8px;
        background: #f8f9fa;
        transition: all 0.3s ease;
      }

      .legend-item:hover {
        background: #e9ecef;
        transform: translateX(5px);
      }

      .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .legend-text {
        flex: 1;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .legend-count {
        background: #007bff;
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 0.9rem;
      }

      /* Fallback Chart Styles */
      .simple-chart {
        max-width: 500px;
        margin: 0 auto;
      }

      .chart-bars {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .bar-item {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .bar-label {
        min-width: 120px;
        font-weight: 500;
        color: #333;
      }

      .bar-container {
        flex: 1;
        height: 30px;
        background: #f0f0f0;
        border-radius: 15px;
        overflow: hidden;
        position: relative;
      }

      .bar-fill {
        height: 100%;
        border-radius: 15px;
        transition: width 1s ease-in-out;
        position: relative;
      }

      .bar-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        animation: shimmer 2s infinite;
      }

      @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
      }

      .bar-value {
        min-width: 40px;
        text-align: center;
        font-weight: bold;
        color: #333;
        background: #f8f9fa;
        padding: 5px 10px;
        border-radius: 15px;
      }
    </style>
  </head>

  <body>
    <div class="wrapper">
      <!-- Navbar -->
      <div th:replace="~{admin/fragments/navbar :: navbar}"></div>

      <!-- Main Panel -->
      <div class="main-panel">
        <div class="content">
          <div class="container-fluid">
            <!-- Page Header -->
            <div class="page-header">
              <div class="row align-items-center">
                <div class="col-md-6">
                  <h2 class="page-title">
                    <i class="fas fa-chart-bar text-primary"></i>
                    Thống Kê Đơn Hàng
                  </h2>
                  <p class="text-muted mb-0">
                    Tổng quan về tình hình đơn hàng của hệ thống
                  </p>
                </div>
                <div class="col-md-6 text-right">
                  <a href="/admin/orders" class="btn-back">
                    <i class="fas fa-arrow-left"></i>
                    Quay lại Quản Lý Đơn Hàng
                  </a>
                </div>
              </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row">
              <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                  <div class="stats-icon">
                    <i class="fas fa-shopping-cart"></i>
                  </div>
                  <div class="stats-number" th:text="${totalOrders}">0</div>
                  <div class="stats-label">Tổng Đơn Hàng</div>
                </div>
              </div>

              <div class="col-lg-3 col-md-6">
                <div class="stats-card success">
                  <div class="stats-icon">
                    <i class="fas fa-check-circle"></i>
                  </div>
                  <div class="stats-number" th:text="${deliveredOrders}">0</div>
                  <div class="stats-label">Đã Giao Hàng</div>
                </div>
              </div>

              <div class="col-lg-3 col-md-6">
                <div class="stats-card warning">
                  <div class="stats-icon">
                    <i class="fas fa-clock"></i>
                  </div>
                  <div class="stats-number" th:text="${pendingOrders}">0</div>
                  <div class="stats-label">Chờ Xác Nhận</div>
                </div>
              </div>

              <div class="col-lg-3 col-md-6">
                <div class="stats-card danger">
                  <div class="stats-icon">
                    <i class="fas fa-times-circle"></i>
                  </div>
                  <div class="stats-number" th:text="${cancelledOrders}">0</div>
                  <div class="stats-label">Đã Hủy</div>
                </div>
              </div>
            </div>

            <!-- Revenue Card -->
            <div class="row">
              <div class="col-lg-6">
                <div class="stats-card info">
                  <div class="stats-icon">
                    <i class="fas fa-dollar-sign"></i>
                  </div>
                  <div class="stats-number" th:text="${#numbers.formatDecimal(totalRevenue, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">0 VNĐ</div>
                  <div class="stats-label">Tổng Doanh Thu</div>
                </div>
              </div>

              <div class="col-lg-6">
                <div class="stats-card">
                  <div class="stats-icon">
                    <i class="fas fa-check-double"></i>
                  </div>
                  <div class="stats-number" th:text="${confirmedOrders}">0</div>
                  <div class="stats-label">Đã Xác Nhận</div>
                </div>
              </div>
            </div>

            <!-- Status Distribution Chart -->
            <div class="row">
              <div class="col-lg-8">
                <div class="chart-container">
                  <h4 class="mb-4">
                    <i class="fas fa-pie-chart text-primary"></i>
                    Phân Bố Trạng Thái Đơn Hàng
                  </h4>
                  
                  <div class="chart-wrapper" style="position: relative; height: 400px;">
                    <canvas id="orderStatusChart"></canvas>
                    <!-- Fallback chart if Chart.js fails -->
                    <div id="fallbackChart" style="display: none; text-align: center; padding: 50px;">
                      <div class="simple-chart">
                        <div class="chart-title mb-4">
                          <h5>Phân Bố Trạng Thái Đơn Hàng</h5>
                        </div>
                        <div class="chart-bars">
                          <div class="bar-item">
                            <div class="bar-label">Chờ Xác Nhận</div>
                            <div class="bar-container">
                              <div class="bar-fill" style="background: #ff6b6b; width: 0%;" data-value="0"></div>
                            </div>
                            <div class="bar-value" th:text="${pendingOrders}">0</div>
                          </div>
                          <div class="bar-item">
                            <div class="bar-label">Đã Xác Nhận</div>
                            <div class="bar-container">
                              <div class="bar-fill" style="background: #4facfe; width: 0%;" data-value="0"></div>
                            </div>
                            <div class="bar-value" th:text="${confirmedOrders}">0</div>
                          </div>
                          <div class="bar-item">
                            <div class="bar-label">Đã Giao Hàng</div>
                            <div class="bar-container">
                              <div class="bar-fill" style="background: #00f2fe; width: 0%;" data-value="0"></div>
                            </div>
                            <div class="bar-value" th:text="${deliveredOrders}">0</div>
                          </div>
                          <div class="bar-item">
                            <div class="bar-label">Đã Hủy</div>
                            <div class="bar-container">
                              <div class="bar-fill" style="background: #ee5a24; width: 0%;" data-value="0"></div>
                            </div>
                            <div class="bar-value" th:text="${cancelledOrders}">0</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-lg-4">
                <div class="chart-container">
                  <h4 class="mb-4">
                    <i class="fas fa-list text-primary"></i>
                    Chi Tiết Trạng Thái
                  </h4>
                  
                  <div class="status-legend">
                    <div class="legend-item">
                      <div class="legend-color" style="background: #ff6b6b;"></div>
                      <div class="legend-text">
                        <strong>Chờ Xác Nhận</strong>
                        <span class="legend-count" th:text="${pendingOrders}">0</span>
                      </div>
                    </div>
                    
                    <div class="legend-item">
                      <div class="legend-color" style="background: #4facfe;"></div>
                      <div class="legend-text">
                        <strong>Đã Xác Nhận</strong>
                        <span class="legend-count" th:text="${confirmedOrders}">0</span>
                      </div>
                    </div>
                    
                    <div class="legend-item">
                      <div class="legend-color" style="background: #00f2fe;"></div>
                      <div class="legend-text">
                        <strong>Đã Giao Hàng</strong>
                        <span class="legend-count" th:text="${deliveredOrders}">0</span>
                      </div>
                    </div>
                    
                    <div class="legend-item">
                      <div class="legend-color" style="background: #ee5a24;"></div>
                      <div class="legend-text">
                        <strong>Đã Hủy</strong>
                        <span class="legend-count" th:text="${cancelledOrders}">0</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="/assets/js/core/jquery.3.2.1.min.js"></script>
    <script src="/assets/js/core/popper.min.js"></script>
    <script src="/assets/js/core/bootstrap.min.js"></script>
    <script src="/assets/js/plugin/jquery-ui-1.12.1.custom/jquery-ui.min.js"></script>
    <script src="/assets/js/plugin/jquery-ui-touch-punch/jquery.ui.touch-punch.min.js"></script>
    <script src="/assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
    <script src="/assets/js/atlantis.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
      // Wait for DOM to be ready
      document.addEventListener('DOMContentLoaded', function() {
        try {
          // Get data from Thymeleaf
          const pendingOrders = [[${pendingOrders}]];
          const confirmedOrders = [[${confirmedOrders}]];
          const deliveredOrders = [[${deliveredOrders}]];
          const cancelledOrders = [[${cancelledOrders}]];
          
          console.log('Order data:', {
            pending: pendingOrders,
            confirmed: confirmedOrders,
            delivered: deliveredOrders,
            cancelled: cancelledOrders
          });
          
          // Check if Chart.js is loaded
          if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded, showing fallback chart');
            document.getElementById('orderStatusChart').style.display = 'none';
            document.getElementById('fallbackChart').style.display = 'block';
            animateFallbackChart(pendingOrders, confirmedOrders, deliveredOrders, cancelledOrders);
            return;
          }
          
          // Get canvas element
          const canvas = document.getElementById('orderStatusChart');
          if (!canvas) {
            console.error('Canvas element not found');
            return;
          }
          
          const ctx = canvas.getContext('2d');
          
          // Create pie chart
          const orderStatusChart = new Chart(ctx, {
            type: 'pie',
            data: {
              labels: ['Chờ Xác Nhận', 'Đã Xác Nhận', 'Đã Giao Hàng', 'Đã Hủy'],
              datasets: [{
                data: [pendingOrders, confirmedOrders, deliveredOrders, cancelledOrders],
                backgroundColor: [
                  '#ff6b6b',
                  '#4facfe', 
                  '#00f2fe',
                  '#ee5a24'
                ],
                borderColor: [
                  '#ff5252',
                  '#2196f3',
                  '#00bcd4', 
                  '#ff5722'
                ],
                borderWidth: 2,
                hoverOffset: 10
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false // We have custom legend on the right
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      const label = context.label || '';
                      const value = context.parsed;
                      const total = context.dataset.data.reduce((a, b) => a + b, 0);
                      const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                      return `${label}: ${value} đơn hàng (${percentage}%)`;
                    }
                  }
                }
              },
              animation: {
                animateRotate: true,
                animateScale: true,
                duration: 2000
              }
            }
          });
          
          console.log('Chart created successfully');
          
        } catch (error) {
          console.error('Error creating chart:', error);
          document.getElementById('orderStatusChart').style.display = 'none';
          document.getElementById('fallbackChart').style.display = 'block';
          animateFallbackChart(0, 0, 0, 0);
        }
      });

      // Function to animate fallback chart
      function animateFallbackChart(pending, confirmed, delivered, cancelled) {
        const total = pending + confirmed + delivered + cancelled;
        const maxValue = Math.max(pending, confirmed, delivered, cancelled, 1);
        
        // Animate bars
        setTimeout(() => {
          const bars = document.querySelectorAll('.bar-fill');
          const values = [pending, confirmed, delivered, cancelled];
          
          bars.forEach((bar, index) => {
            const percentage = total > 0 ? (values[index] / maxValue) * 100 : 0;
            bar.style.width = percentage + '%';
            bar.setAttribute('data-value', values[index]);
          });
        }, 500);
      }
    </script>
  </body>
</html>
