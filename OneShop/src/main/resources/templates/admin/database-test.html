<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Database Test</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1>Kiểm tra kết nối Database</h1>
        
        <div class="card mt-4">
            <div class="card-header">
                Thông tin kết nối
            </div>
            <div class="card-body">
                <div id="connection-info">
                    <p>Đang kiểm tra kết nối...</p>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                Raw Statistics Data
            </div>
            <div class="card-body">
                <div id="raw-stats">
                    <p>Đang tải dữ liệu...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Kiểm tra kết nối database
        fetch('/admin/api/check-db')
            .then(response => response.json())
            .then(data => {
                const connectionInfo = document.getElementById('connection-info');
                
                if (data.status === 'success') {
                    connectionInfo.innerHTML = `
                        <div class="alert alert-success">
                            <h4>Kết nối thành công!</h4>
                            <ul>
                                <li>Số lượng Orders: ${data.ordersCount}</li>
                                <li>Số lượng Users: ${data.usersCount}</li>
                                <li>Số lượng Products: ${data.productsCount}</li>
                            </ul>
                        </div>
                    `;
                } else {
                    connectionInfo.innerHTML = `
                        <div class="alert alert-danger">
                            <h4>Kết nối thất bại!</h4>
                            <p>Lỗi: ${data.message}</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                document.getElementById('connection-info').innerHTML = `
                    <div class="alert alert-danger">
                        <h4>Có lỗi xảy ra!</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            });
        
        // Thêm phần SQL direct query
        const sqlForm = document.createElement('div');
        sqlForm.className = 'card mt-4';
        sqlForm.innerHTML = `
            <div class="card-header">
                Truy vấn SQL trực tiếp
            </div>
            <div class="card-body">
                <div class="form-group">
                    <textarea id="sql-query" class="form-control" rows="3" 
                        placeholder="Nhập truy vấn SQL (chỉ hỗ trợ SELECT)..."
                    >SELECT * FROM orders</textarea>
                </div>
                <div class="mt-2">
                    <button id="run-query" class="btn btn-primary">Chạy truy vấn</button>
                </div>
                <div class="mt-3">
                    <strong>Các truy vấn mẫu:</strong>
                    <div class="list-group mt-2">
                        <a href="#" class="list-group-item list-group-item-action sample-query" 
                           data-query="SELECT * FROM orders">Xem tất cả đơn hàng</a>
                        <a href="#" class="list-group-item list-group-item-action sample-query" 
                           data-query="SELECT * FROM order_details">Xem chi tiết đơn hàng</a>
                        <a href="#" class="list-group-item list-group-item-action sample-query" 
                           data-query="SELECT * FROM products">Xem danh sách sản phẩm</a>
                        <a href="#" class="list-group-item list-group-item-action sample-query" 
                           data-query="SELECT o.order_id, o.order_date, o.amount, o.status, u.name as user_name FROM orders o JOIN [user] u ON o.user_id = u.user_id">Xem đơn hàng + tên người dùng</a>
                        <a href="#" class="list-group-item list-group-item-action sample-query" 
                           data-query="SELECT YEAR(o.order_date) as year, MONTH(o.order_date) as month, COUNT(o.order_id) as order_count, SUM(o.amount) as total_amount FROM orders o GROUP BY YEAR(o.order_date), MONTH(o.order_date) ORDER BY year DESC, month DESC">Thống kê theo tháng</a>
                    </div>
                </div>
                <div id="query-result" class="mt-3">
                    <p>Kết quả sẽ hiển thị ở đây...</p>
                </div>
            </div>
        `;
        document.querySelector('.container').appendChild(sqlForm);
        
        // Xử lý nút chạy truy vấn SQL
        // Xử lý khi click vào các truy vấn mẫu
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('sample-query')) {
                event.preventDefault();
                const query = event.target.getAttribute('data-query');
                document.getElementById('sql-query').value = query;
            }
        });
        
        document.getElementById('run-query').addEventListener('click', function() {
            const query = document.getElementById('sql-query').value;
            const resultDiv = document.getElementById('query-result');
            resultDiv.innerHTML = '<p>Đang xử lý...</p>';
            
            fetch('/admin/api/run-sql', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query: query })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <p>Lỗi: ${data.error}</p>
                        </div>
                    `;
                } else {
                    let html = `<div class="alert alert-success">Tìm thấy ${data.count} kết quả</div>`;
                    
                    if (data.data && data.data.length > 0) {
                        html += '<table class="table table-striped table-bordered">';
                        
                        // Tạo tiêu đề bảng
                        html += '<thead><tr>';
                        const firstRow = data.data[0];
                        for (const key in firstRow) {
                            html += `<th>${key}</th>`;
                        }
                        html += '</tr></thead>';
                        
                        // Tạo nội dung bảng
                        html += '<tbody>';
                        data.data.forEach(row => {
                            html += '<tr>';
                            for (const key in row) {
                                html += `<td>${row[key]}</td>`;
                            }
                            html += '</tr>';
                        });
                        html += '</tbody></table>';
                    } else {
                        html += '<p>Không có dữ liệu</p>';
                    }
                    
                    resultDiv.innerHTML = html;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h4>Có lỗi xảy ra!</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            });
        });

        // Lấy dữ liệu thống kê
        fetch('/admin/api/raw-stats')
            .then(response => response.json())
            .then(data => {
                const rawStats = document.getElementById('raw-stats');
                
                if (data.error) {
                    rawStats.innerHTML = `
                        <div class="alert alert-danger">
                            <h4>Lỗi khi lấy dữ liệu thống kê!</h4>
                            <p>${data.error}</p>
                        </div>
                    `;
                } else {
                    let html = '<h4>Thông tin thống kê:</h4><ul>';
                    
                    html += `<li>Số lượng thống kê theo ngày: ${data.dailyStatsCount}</li>`;
                    html += `<li>Số lượng thống kê theo tháng: ${data.monthlyStatsCount}</li>`;
                    html += `<li>Số lượng thống kê theo năm: ${data.yearlyStatsCount}</li>`;
                    html += `<li>Tổng số đơn hàng: ${data.allOrdersCount}</li>`;
                    
                    html += '</ul>';
                    
                    if (data.dailyStatsExample) {
                        html += '<h5>Ví dụ thống kê theo ngày:</h5>';
                        html += '<pre>' + JSON.stringify(data.dailyStatsExample, null, 2) + '</pre>';
                    }
                    
                    if (data.monthlyStatsExample) {
                        html += '<h5>Ví dụ thống kê theo tháng:</h5>';
                        html += '<pre>' + JSON.stringify(data.monthlyStatsExample, null, 2) + '</pre>';
                    }
                    
                    if (data.firstOrderExample) {
                        html += '<h5>Ví dụ đơn hàng đầu tiên:</h5>';
                        html += '<pre>' + JSON.stringify(data.firstOrderExample, null, 2) + '</pre>';
                    }
                    
                    rawStats.innerHTML = html;
                }
            })
            .catch(error => {
                document.getElementById('raw-stats').innerHTML = `
                    <div class="alert alert-danger">
                        <h4>Có lỗi xảy ra!</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            });
    </script>
</body>
</html>