<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Quản lý sản phẩm - OneShop Admin</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-1ycn6IcaQQ40/MKB4Imkb9fZbNR1QDH5clooo6Ts6XG5G7a3eG6XhGKR/nfJ6wR1yMGyF/F7RH/We5T7yzB7w=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      body {
        background: #f8fafc;
        color: #0f172a;
      }
      .admin-header {
        background: linear-gradient(135deg, #1d4ed8 0%, #312e81 100%);
        color: #fff;
        border-radius: 20px;
        padding: 28px;
        box-shadow: 0 18px 40px rgba(29, 78, 216, 0.25);
      }
      .summary-card {
        background: #fff;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
        border: 1px solid rgba(148, 163, 184, 0.2);
      }
      .summary-card .label {
        text-transform: uppercase;
        font-size: 0.8rem;
        color: #64748b;
        letter-spacing: 0.05em;
        margin-bottom: 6px;
      }
      .summary-card .value {
        font-size: 1.8rem;
        font-weight: 700;
        color: #0f172a;
      }
      .filter-card {
        background: #fff;
        border-radius: 18px;
        padding: 20px;
        box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
        border: 1px solid rgba(148, 163, 184, 0.2);
      }
      .table thead {
        background: rgba(15, 23, 42, 0.04);
      }
      .badge-status {
        border-radius: 999px;
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
        font-weight: 600;
      }
      .shop-overview-card {
        background: #0f172a;
        color: #e2e8f0;
        border-radius: 18px;
        padding: 20px;
      }
      .shop-overview-card .shop-name {
        font-size: 1rem;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid py-4">
      <header class="admin-header mb-4">
        <div
          class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3"
        >
          <div>
            <h1 class="h3 mb-1">Quản lý sản phẩm</h1>
            <p class="mb-0 text-white-50">
              Theo dõi, tìm kiếm và cập nhật sản phẩm theo từng shop.
            </p>
          </div>
          <div class="d-flex gap-2">
            <a class="btn btn-outline-light" href="/admin/home">
              <i class="fas fa-arrow-left me-2"></i>Quay lại Dashboard
            </a>
            <button
              class="btn btn-light text-primary"
              data-bs-toggle="modal"
              data-bs-target="#addProductModal"
            >
              <i class="fas fa-plus-circle me-2"></i>Thêm sản phẩm mới
            </button>
          </div>
        </div>
      </header>

      <section class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="summary-card">
            <div class="label">Tổng số shop</div>
            <div class="value" th:text="${totalShopCount}">0</div>
            <small class="text-muted">Shop đang hoạt động & chờ duyệt</small>
          </div>
        </div>
        <div class="col-md-3">
          <div class="summary-card">
            <div class="label">Tổng sản phẩm</div>
            <div class="value" th:text="${totalProductCountSummary}">0</div>
            <small class="text-muted">Toàn bộ sản phẩm trong hệ thống</small>
          </div>
        </div>
        <div class="col-md-3">
          <div class="summary-card">
            <div class="label">Tổng tồn kho</div>
            <div class="value" th:text="${totalQuantitySummary}">0</div>
            <small class="text-muted">Số lượng hàng hóa hiện có</small>
          </div>
        </div>
        <div class="col-md-3">
          <div class="summary-card">
            <div class="label">Giá trị tồn kho</div>
            <div
              class="value"
              th:text="${#numbers.formatDecimal(totalInventoryValueSummary, 0, 'DEFAULT', 0, 'DEFAULT')} + ' ₫'"
            >
              0 ₫
            </div>
            <small class="text-muted">Tính theo giá niêm yết</small>
          </div>
        </div>
      </section>

      <section class="filter-card mb-4">
        <form
          class="row g-3 align-items-end"
          method="get"
          th:action="@{/admin/products}"
        >
          <div class="col-md-4">
            <label class="form-label" for="shopId">Lọc theo shop</label>
            <select id="shopId" name="shopId" class="form-select">
              <option value="" th:selected="${selectedShopId == null}">
                Tất cả shop
              </option>
              <option
                th:each="shop : ${shopList}"
                th:value="${shop.shopId}"
                th:text="${shop.shopName}"
                th:selected="${selectedShopId != null and shop.shopId == selectedShopId}"
              ></option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label" for="search">Từ khóa</label>
            <input
              id="search"
              name="search"
              type="text"
              class="form-control"
              placeholder="Tên sản phẩm, danh mục..."
              th:value="${search}"
            />
          </div>
          <div class="col-md-2">
            <label class="form-label" for="size">Kích thước trang</label>
            <select
              id="size"
              name="size"
              class="form-select"
              th:value="${pageSize}"
            >
              <option value="10">10</option>
              <option value="20">20</option>
              <option value="50">50</option>
            </select>
          </div>
          <div class="col-md-2 d-flex gap-2">
            <input type="hidden" name="sortBy" th:value="${sortBy}" />
            <input type="hidden" name="sortDir" th:value="${sortDir}" />
            <button type="submit" class="btn btn-primary flex-grow-1">
              <i class="fas fa-filter me-2"></i>Lọc
            </button>
            <a class="btn btn-outline-secondary" th:href="@{/admin/products}"
              ><i class="fas fa-undo me-1"></i>Đặt lại</a
            >
          </div>
        </form>
      </section>

      <section
        class="row g-3 mb-4"
        th:if="${shopStats != null && !shopStats.isEmpty()}"
      >
        <div class="col-lg-12">
          <div class="shop-overview-card">
            <h2 class="h6 mb-3">
              <i class="fas fa-store me-2"></i>Tổng quan theo shop
            </h2>
            <div class="table-responsive">
              <table
                class="table table-dark table-borderless align-middle mb-0"
              >
                <thead class="text-uppercase text-secondary small">
                  <tr>
                    <th>Shop</th>
                    <th>Trạng thái</th>
                    <th class="text-end">Sản phẩm</th>
                    <th class="text-end">Tồn kho</th>
                    <th class="text-end">Giá trị tồn</th>
                  </tr>
                </thead>
                <tbody>
                  <tr th:each="stat : ${shopStats}">
                    <td>
                      <span class="shop-name" th:text="${stat.shopName}"
                        >Shop name</span
                      >
                      <div
                        class="text-secondary small"
                        th:text="${stat.vendorName}"
                      >
                        Vendor
                      </div>
                    </td>
                    <td>
                      <span
                        class="badge bg-success"
                        th:if="${stat.status.name() == 'ACTIVE'}"
                        >Hoạt động</span
                      >
                      <span
                        class="badge bg-warning text-dark"
                        th:if="${stat.status.name() == 'PENDING'}"
                        >Chờ duyệt</span
                      >
                      <span
                        class="badge bg-secondary"
                        th:if="${stat.status.name() != 'ACTIVE' and stat.status.name() != 'PENDING'}"
                        >Tạm ngưng</span
                      >
                    </td>
                    <td class="text-end" th:text="${stat.productCount}">0</td>
                    <td class="text-end" th:text="${stat.totalQuantity}">0</td>
                    <td
                      class="text-end"
                      th:text="${#numbers.formatDecimal(stat.totalInventoryValue, 0, 'DEFAULT', 0, 'DEFAULT')} + ' ₫'"
                    >
                      0 ₫
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section class="card border-0 shadow-sm mb-4">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead>
                <tr>
                  <th>
                    <a
                      th:href="@{/admin/products(sortBy='productId', sortDir=${sortDir == 'asc' ? 'desc' : 'asc'}, page=${currentPage}, size=${pageSize}, search=${search}, shopId=${selectedShopId})}"
                      class="text-decoration-none text-dark"
                      >ID</a
                    >
                  </th>
                  <th>Shop</th>
                  <th>Sản phẩm</th>
                  <th>Danh mục</th>
                  <th>Thương hiệu</th>
                  <th class="text-end">Giá bán</th>
                  <th class="text-end">Giảm giá</th>
                  <th class="text-end">Tồn kho</th>
                  <th>Trạng thái</th>
                  <th class="text-center">Thao tác</th>
                </tr>
              </thead>
              <tbody>
                <tr th:if="${#lists.isEmpty(products)}">
                  <td colspan="10" class="text-center py-4">
                    Không tìm thấy sản phẩm phù hợp.
                  </td>
                </tr>
                <tr th:each="product : ${products}">
                  <td th:text="${product.productId}">1</td>
                  <td
                    th:text="${product.shop != null ? product.shop.shopName : 'Chưa gán'}"
                  >
                    Shop
                  </td>
                  <td>
                    <div class="fw-semibold" th:text="${product.productName}">
                      Tên sản phẩm
                    </div>
                    <div
                      class="text-muted small"
                      th:text="${product.description}"
                    ></div>
                  </td>
                  <td
                    th:text="${product.category != null ? product.category.categoryName : '-'}"
                  >
                    Danh mục
                  </td>
                  <td
                    th:text="${product.brand != null ? product.brand.brandName : '-'}"
                  >
                    Thương hiệu
                  </td>
                  <td
                    class="text-end"
                    th:text="${#numbers.formatDecimal(product.price, 0, 'DEFAULT', 0, 'DEFAULT')} + ' ₫'"
                  >
                    0 ₫
                  </td>
                  <td
                    class="text-end"
                    th:text="${product.discount != null ? product.discount : 0} + '%'"
                  >
                    0%
                  </td>
                  <td class="text-end" th:text="${product.quantity}">0</td>
                  <td>
                    <span
                      class="badge-status bg-success-subtle text-success"
                      th:if="${product.status}"
                      >Đang bán</span
                    >
                    <span
                      class="badge-status bg-secondary-subtle text-secondary"
                      th:if="${!product.status}"
                      >Tạm ẩn</span
                    >
                  </td>
                  <td>
                    <div class="d-flex justify-content-center gap-2">
                      <a
                        class="btn btn-outline-primary btn-sm"
                        th:href="@{'/admin/editProduct/' + ${product.productId}}"
                      >
                        <i class="fas fa-edit"></i>
                      </a>
                      <a
                        class="btn btn-outline-danger btn-sm"
                        th:href="@{'/admin/deleteProduct/' + ${product.productId}}"
                        onclick="return confirm('Bạn chắc chắn muốn xóa sản phẩm này?');"
                      >
                        <i class="fas fa-trash"></i>
                      </a>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <nav th:if="${totalPages > 1}" aria-label="Pagination">
        <ul class="pagination justify-content-center">
          <li
            class="page-item"
            th:classappend="${currentPage == 0} ? ' disabled'"
          >
            <a
              class="page-link"
              th:href="@{/admin/products(page=${currentPage - 1}, size=${pageSize}, sortBy=${sortBy}, sortDir=${sortDir}, search=${search}, shopId=${selectedShopId})}"
              >Trước</a
            >
          </li>
          <li
            class="page-item"
            th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}"
            th:classappend="${pageNum == currentPage} ? ' active'"
          >
            <a
              class="page-link"
              th:text="${pageNum + 1}"
              th:href="@{/admin/products(page=${pageNum}, size=${pageSize}, sortBy=${sortBy}, sortDir=${sortDir}, search=${search}, shopId=${selectedShopId})}"
              >1</a
            >
          </li>
          <li
            class="page-item"
            th:classappend="${currentPage + 1 == totalPages} ? ' disabled'"
          >
            <a
              class="page-link"
              th:href="@{/admin/products(page=${currentPage + 1}, size=${pageSize}, sortBy=${sortBy}, sortDir=${sortDir}, search=${search}, shopId=${selectedShopId})}"
              >Sau</a
            >
          </li>
        </ul>
      </nav>
    </div>

    <div
      class="modal fade"
      id="addProductModal"
      tabindex="-1"
      aria-labelledby="addProductModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addProductModalLabel">
              Thêm sản phẩm mới
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <form
            th:action="@{/admin/addProduct}"
            th:object="${product}"
            method="post"
            enctype="multipart/form-data"
          >
            <div class="modal-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label" for="productName"
                    >Tên sản phẩm *</label
                  >
                  <input
                    id="productName"
                    type="text"
                    class="form-control"
                    th:field="*{productName}"
                    required
                  />
                </div>
                <div class="col-md-3">
                  <label class="form-label" for="priceModal">Giá bán *</label>
                  <input
                    id="priceModal"
                    type="number"
                    min="0"
                    step="1000"
                    class="form-control"
                    th:field="*{price}"
                    required
                  />
                </div>
                <div class="col-md-3">
                  <label class="form-label" for="quantityModal"
                    >Tồn kho *</label
                  >
                  <input
                    id="quantityModal"
                    type="number"
                    min="0"
                    class="form-control"
                    th:field="*{quantity}"
                    required
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label" for="discountModal"
                    >Giảm giá (%)</label
                  >
                  <input
                    id="discountModal"
                    type="number"
                    min="0"
                    max="100"
                    class="form-control"
                    th:field="*{discount}"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label" for="categoryModal"
                    >Danh mục *</label
                  >
                  <select
                    id="categoryModal"
                    class="form-select"
                    name="categoryId"
                    required
                  >
                    <option value="" disabled selected>Chọn danh mục</option>
                    <option
                      th:each="category : ${categoryList}"
                      th:value="${category.categoryId}"
                      th:text="${category.categoryName}"
                    ></option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label" for="brandModal"
                    >Thương hiệu *</label
                  >
                  <select
                    id="brandModal"
                    class="form-select"
                    name="brandId"
                    required
                  >
                    <option value="" disabled selected>Chọn thương hiệu</option>
                    <option
                      th:each="brand : ${brandList}"
                      th:value="${brand.brandId}"
                      th:text="${brand.brandName}"
                    ></option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="shopModal">Thuộc shop *</label>
                  <select
                    id="shopModal"
                    class="form-select"
                    name="shopId"
                    required
                  >
                    <option value="" disabled selected>Chọn shop</option>
                    <option
                      th:each="shop : ${shopList}"
                      th:value="${shop.shopId}"
                      th:text="${shop.shopName}"
                    ></option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="imageModal">Hình ảnh</label>
                  <input
                    id="imageModal"
                    type="file"
                    class="form-control"
                    name="file"
                    accept="image/*"
                  />
                </div>
                <div class="col-12">
                  <label class="form-label" for="descriptionModal">Mô tả</label>
                  <textarea
                    id="descriptionModal"
                    class="form-control"
                    rows="3"
                    th:field="*{description}"
                  ></textarea>
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="manufactureModal"
                    >Ngày sản xuất</label
                  >
                  <input
                    id="manufactureModal"
                    type="date"
                    class="form-control"
                    th:field="*{manufactureDate}"
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="expiryModal"
                    >Hạn sử dụng</label
                  >
                  <input
                    id="expiryModal"
                    type="date"
                    class="form-control"
                    th:field="*{expiryDate}"
                  />
                </div>
                <div class="col-md-6">
                  <div class="form-check form-switch">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="statusModal"
                      th:field="*{status}"
                    />
                    <label class="form-check-label" for="statusModal"
                      >Kích hoạt sản phẩm</label
                    >
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-check form-switch">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="favoriteModal"
                      th:field="*{favorite}"
                    />
                    <label class="form-check-label" for="favoriteModal"
                      >Đánh dấu nổi bật</label
                    >
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-outline-secondary"
                data-bs-dismiss="modal"
              >
                Hủy
              </button>
              <button type="submit" class="btn btn-primary">
                Thêm sản phẩm
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
