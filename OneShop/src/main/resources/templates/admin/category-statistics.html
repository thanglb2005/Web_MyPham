<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thống kê danh mục - OneShop Admin</title>
    <link rel="icon" href="/images/icon.png" />
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/assets/css/atlantis.min.css" />
    <link rel="stylesheet" href="/assets/css/atlantis.css" />
    <link rel="stylesheet" href="/assets/css/demo.css" />
    <link rel="stylesheet" href="/assets/css/fonts.min.css" />
    <link rel="stylesheet" href="/fonts/fontawesome/fontawesome.min.css" />
    <link rel="stylesheet" href="/css/admin-fonts.css" />
    <style>
      :root {
        --section-gap: 30px;
      }
      body {
        background: #f4f6f9;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        font-size: 14px;
        line-height: 1.5;
      }
      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 30px;
        border-radius: 15px;
        color: #fff;
        margin-bottom: var(--section-gap);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      }
      .stats-card {
        background: #fff;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
        height: 180px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 20px;
      }
      .stats-card .icon {
        font-size: 2.6rem;
        margin-bottom: 10px;
      }
      .stats-card .number {
        font-size: 2.2rem;
        font-weight: 800;
        color: #2c3e50;
      }
      .stats-card .label {
        color: #7f8c8d;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        font-weight: 600;
      }
      .chart-container {
        background: #fff;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
        margin-bottom: var(--section-gap);
        min-height: 400px;
      }
      .chart-container canvas {
        width: 100% !important;
        height: 350px !important;
        max-height: 350px;
      }
      .table-container {
        background: #fff;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
        margin-bottom: var(--section-gap);
      }
      .chart-title {
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 15px;
      }
      .stats-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 35px rgba(102, 126, 234, 0.25);
      }
      .export-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        transition: all 0.3s ease;
      }
      .export-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        color: white;
      }
      .filter-container {
        background: #fff;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
        margin-bottom: var(--section-gap);
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <th:block th:replace="~{admin/fragments/header :: header}"></th:block>
      <th:block th:replace="~{admin/fragments/navbar :: navbar}"></th:block>
      <div class="main-panel">
        <div class="content">
          <!-- Header -->
          <div class="header">
            <h3 class="mb-1">
              <i class="fas fa-chart-pie"></i> Thống kê danh mục
            </h3>
            <div class="text-light" style="opacity: 0.9">
              Phân tích hiệu suất và doanh thu theo từng danh mục sản phẩm
            </div>
          </div>

          <!-- Summary Cards -->
          <div class="row mb-4">
            <div class="col-xl-3 col-lg-6 col-md-6">
              <div class="stats-card text-center" data-chart="product-count">
                <div class="icon text-primary">
                  <i class="fas fa-boxes"></i>
                </div>
                <div
                  class="number"
                  th:text="${#numbers.formatInteger(totalProducts,0)}"
                >
                  0
                </div>
                <div class="label">TỔNG SẢN PHẨM</div>
              </div>
            </div>
            <div class="col-xl-3 col-lg-6 col-md-6">
              <div class="stats-card text-center" data-chart="revenue">
                <div class="icon text-success">
                  <i class="fas fa-dollar-sign"></i>
                </div>
                <div
                  class="number"
                  th:text="${#numbers.formatDecimal(totalRevenue, 0, 'COMMA', 0, 'POINT')}"
                >
                  0
                </div>
                <div class="label">TỔNG DOANH THU (VNĐ)</div>
              </div>
            </div>
            <div class="col-xl-3 col-lg-6 col-md-6">
              <div class="stats-card text-center" data-chart="favorites">
                <div class="icon text-danger">
                  <i class="fas fa-heart"></i>
                </div>
                <div
                  class="number"
                  th:text="${#numbers.formatInteger(totalFavorites,0)}"
                >
                  0
                </div>
                <div class="label">TỔNG LƯỢT YÊU THÍCH</div>
              </div>
            </div>
            <div class="col-xl-3 col-lg-6 col-md-6">
              <div class="stats-card text-center" data-chart="rating">
                <div class="icon text-warning">
                  <i class="fas fa-star"></i>
                </div>
                <div
                  class="number"
                  th:text="${#numbers.formatDecimal(overallRating, 1, 'COMMA', 1, 'POINT')}"
                >
                  0.0
                </div>
                <div class="label">ĐÁNH GIÁ TRUNG BÌNH</div>
              </div>
            </div>
          </div>

          <!-- Filter Section -->
          <div class="filter-container">
            <form method="get" th:action="@{/admin/category-statistics/filter}">
              <div class="row g-3 align-items-end">
                <div class="col-md-4">
                  <label class="form-label text-muted">
                    <i class="fas fa-calendar text-primary"></i> Từ ngày
                  </label>
                  <input
                    type="date"
                    class="form-control"
                    name="startDate"
                    th:value="${startDate}"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label text-muted">
                    <i class="fas fa-calendar text-primary"></i> Đến ngày
                  </label>
                  <input
                    type="date"
                    class="form-control"
                    name="endDate"
                    th:value="${endDate}"
                  />
                </div>
                <div class="col-md-2">
                  <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-filter"></i> Lọc
                  </button>
                </div>
                <div class="col-md-2">
                  <a
                    href="/admin/category-statistics/export"
                    class="btn export-btn w-100"
                  >
                    <i class="fas fa-download"></i> Xuất Excel
                  </a>
                </div>
              </div>
            </form>
          </div>

          <!-- Charts Row 1 -->
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="chart-container">
                <div class="chart-title">
                  <i class="fas fa-chart-bar text-primary"></i> Số lượng sản
                  phẩm theo danh mục
                </div>
                <canvas id="productCountChart"></canvas>
              </div>
            </div>
            <div class="col-md-6">
              <div class="chart-container">
                <div class="chart-title">
                  <i class="fas fa-chart-pie text-success"></i> Doanh thu theo
                  danh mục
                </div>
                <canvas id="revenueChart"></canvas>
              </div>
            </div>
          </div>

          <!-- Comprehensive Statistics Table -->
          <div class="table-container">
            <div class="chart-title">
              <i class="fas fa-table text-dark"></i> Thống kê tổng hợp theo danh
              mục
            </div>
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead class="table-dark">
                  <tr>
                    <th>STT</th>
                    <th>Danh mục</th>
                    <th>Số sản phẩm</th>
                    <th>Doanh thu (VNĐ)</th>
                    <th>Lượt yêu thích</th>
                    <th>Đánh giá TB</th>
                    <th>Số đánh giá</th>
                    <th>Hành động</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    th:if="${comprehensiveStats == null or #lists.isEmpty(comprehensiveStats)}"
                  >
                    <td colspan="8" class="text-center text-muted">
                      Không có dữ liệu thống kê
                    </td>
                  </tr>
                  <tr th:each="stat, iterStat : ${comprehensiveStats}">
                    <!-- stat: [categoryName, productCount, revenue, favorites, avgRating, ratingCount, categoryId, categoryImage] -->
                    <td th:text="${iterStat.index + 1}">1</td>
                    <td>
                      <div class="d-flex align-items-center">
                        <img
                          th:if="${stat[7] != null}"
                          th:src="'/images/' + ${stat[7]}"
                          class="me-2"
                          style="
                            width: 30px;
                            height: 30px;
                            object-fit: cover;
                            border-radius: 5px;
                          "
                          alt="Category Image"
                        />
                        <strong th:text="${stat[0]}">Category Name</strong>
                      </div>
                    </td>
                    <td>
                      <span class="badge bg-primary" th:text="${stat[1]}"
                        >0</span
                      >
                    </td>
                    <td class="text-end">
                      <strong
                        th:text="${#numbers.formatDecimal(stat[2], 0, 'COMMA', 0, 'POINT')}"
                        >0</strong
                      >
                    </td>
                    <td class="text-end">
                      <span class="badge bg-danger" th:text="${stat[3]}"
                        >0</span
                      >
                    </td>
                    <td class="text-center">
                      <span
                        th:if="${stat[4] != null and stat[4] > 0}"
                        th:text="${#numbers.formatDecimal(stat[4], 1, 'COMMA', 1, 'POINT')}"
                        >0.0</span
                      >
                      <span
                        th:if="${stat[4] == null or stat[4] == 0}"
                        class="text-muted"
                        >-</span
                      >
                    </td>
                    <td class="text-center" th:text="${stat[5]}">0</td>
                    <td>
                      <a
                        th:href="@{/admin/categories}"
                        class="btn btn-sm btn-outline-primary"
                      >
                        <i class="fas fa-eye"></i>
                      </a>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <th:block th:replace="~{admin/fragments/footer :: footer}"></th:block>
    </div>

    <!-- Scripts -->
    <script src="/assets/js/core/jquery.3.2.1.min.js"></script>
    <script src="/assets/js/core/popper.min.js"></script>
    <script src="/assets/js/core/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <script th:inline="javascript">
      $(document).ready(function () {
        // Chart colors
        const colors = [
          "#667eea",
          "#764ba2",
          "#a29bfe",
          "#fd79a8",
          "#fdcb6e",
          "#55efc4",
          "#81ecec",
          "#74b9ff",
          "#ff7675",
          "#6c5ce7",
          "#a29bfe",
          "#fd79a8",
        ];

        // Product Count Chart (Bar Chart)
        const productCountCtx = document
          .getElementById("productCountChart")
          .getContext("2d");
        const productCountData = /*[[${productCountStats}]]*/ [];
        new Chart(productCountCtx, {
          type: "bar",
          data: {
            labels: productCountData.map((item) => item[0]),
            datasets: [
              {
                label: "Số sản phẩm",
                data: productCountData.map((item) => item[1]),
                backgroundColor: colors[0],
                borderColor: colors[0],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });

        // Revenue Chart (Pie Chart)
        const revenueCtx = document
          .getElementById("revenueChart")
          .getContext("2d");
        const revenueData = /*[[${revenueStats}]]*/ [];
        new Chart(revenueCtx, {
          type: "doughnut",
          data: {
            labels: revenueData.map((item) => item[0]),
            datasets: [
              {
                data: revenueData.map((item) => item[1]),
                backgroundColor: colors.slice(0, revenueData.length),
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
              },
            },
          },
        });

        // Rating and Favorites charts removed as requested

        // Chart click handlers
        $(".stats-card[data-chart]").on("click", function () {
          const chartType = $(this).data("chart");
          const chartElement = $("#" + chartType + "Chart");
          if (chartElement.length) {
            chartElement[0].scrollIntoView({ behavior: "smooth" });
          }
        });
      });
    </script>
  </body>
</html>
