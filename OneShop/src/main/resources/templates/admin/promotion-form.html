<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="${promotion.promotionId != null ? 'Chỉnh sửa khuyến mãi' : 'Thêm khuyến mãi mới'} - OneShop Admin</title>

    <!-- CSS Libraries -->
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/assets/css/atlantis.min.css" />
    <link rel="stylesheet" href="/fonts/fontawesome/fontawesome.min.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />

    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/assets/css/atlantis.css" />
    <link rel="stylesheet" href="/assets/css/demo.css" />
    <link rel="stylesheet" href="/assets/css/fonts.min.css" />
    <link rel="stylesheet" href="/assets/css/atlantis.min.css" />
    <link rel="stylesheet" href="/css/admin-fonts.css" />

    <style>
      /* Fixed Sidebar */
      .sidebar {
        position: fixed !important;
        top: 60px;
        left: 0;
        bottom: 0;
        z-index: 1028;
        width: 250px;
        background: white !important;
        border-right: 1px solid #e9ecef;
        margin: 0;
        padding: 0;
      }

      /* Main Content Adjustment */
      .main-panel {
        margin-top: 60px !important;
        margin-left: 250px !important;
        padding: 0;
        margin-right: 0;
      }

      .content {
        padding: 0;
        margin: 0;
        position: relative;
        top: 0;
      }

      .page-inner {
        padding: 20px;
        margin: 0;
      }

      .page-header {
        padding: 15px 20px;
        margin: 0;
        background: white;
        border-bottom: 1px solid #e9ecef;
        position: relative;
        top: 0;
      }

      .page-title {
        color: #333;
        font-size: 1.8rem;
        margin: 0;
        font-weight: 600;
      }

      /* Form Styling */
      .form-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .form-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 25px;
        border: none;
      }

      .form-header h5 {
        margin: 0;
        font-weight: 600;
        font-size: 1.2rem;
      }

      .form-header i {
        margin-right: 10px;
        font-size: 1.1rem;
      }

      .form-body {
        padding: 30px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
        display: block;
      }

      .form-control {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 12px 15px;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        outline: none;
      }

      .form-control.is-invalid {
        border-color: #dc3545;
      }

      .invalid-feedback {
        display: block;
        color: #dc3545;
        font-size: 12px;
        margin-top: 5px;
      }

      .form-control.is-valid {
        border-color: #28a745;
      }

      .valid-feedback {
        display: block;
        color: #28a745;
        font-size: 12px;
        margin-top: 5px;
      }

      /* Button Styling */
      .btn {
        border-radius: 8px;
        font-weight: 500;
        padding: 10px 20px;
        transition: all 0.3s ease;
        border: none;
      }

      .btn-primary {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
      }

      .btn-primary:hover {
        background: linear-gradient(135deg, #0056b3, #004085);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
      }

      .btn-secondary {
        background: linear-gradient(135deg, #6c757d, #545b62);
        color: white;
      }

      .btn-secondary:hover {
        background: linear-gradient(135deg, #545b62, #495057);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);
      }

      .btn-danger {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white;
      }

      .btn-danger:hover {
        background: linear-gradient(135deg, #c82333, #bd2130);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
      }

      /* Alert Styling */
      .alert {
        border: none;
        border-radius: 8px;
        padding: 15px 20px;
        margin-bottom: 20px;
      }

      .alert-success {
        background: linear-gradient(135deg, #d4edda, #c3e6cb);
        color: #155724;
        border-left: 4px solid #28a745;
      }

      .alert-danger {
        background: linear-gradient(135deg, #f8d7da, #f5c6cb);
        color: #721c24;
        border-left: 4px solid #dc3545;
      }

      .alert-warning {
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        color: #856404;
        border-left: 4px solid #ffc107;
      }

      .alert-info {
        background: linear-gradient(135deg, #d1ecf1, #bee5eb);
        color: #0c5460;
        border-left: 4px solid #17a2b8;
      }

      /* Card Styling */
      .card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 20px 25px;
      }

      .card-body {
        padding: 30px;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .page-inner {
          padding: 10px;
        }

        .form-body {
          padding: 20px;
        }

        .form-control {
          font-size: 16px; /* Prevent zoom on iOS */
        }
      }

      /* Animation */
      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <!-- Header -->
      <th:block th:replace="~{admin/fragments/header :: header}"></th:block>

      <!-- Navbar -->
      <th:block th:replace="~{admin/fragments/navbar :: navbar}"></th:block>

      <div class="main-panel">
        <div class="content">
          <!-- Page Header -->
          <div class="page-header">
            <h2 class="page-title" th:text="${promotion.promotionId != null ? 'Chỉnh sửa khuyến mãi' : 'Thêm khuyến mãi mới'}"></h2>
          </div>

          <div class="page-inner">
            <!-- Content Section -->
            <div class="content-section">
              <!-- Form Container -->
              <div class="form-container">
                <div class="form-header">
                  <h5 class="mb-0">
                    <i class="fas fa-tags"></i>
                    <span th:text="${promotion.promotionId != null ? 'Chỉnh sửa khuyến mãi' : 'Thêm khuyến mãi mới'}"></span>
                  </h5>
                </div>
                <div class="form-body">
                  <!-- Alert Messages -->
                  <div th:if="${success}" class="alert alert-success fade-in">
                    <i class="fas fa-check-circle"></i>
                    <span th:text="${success}"></span>
                  </div>
                  
                  <div th:if="${error}" class="alert alert-danger fade-in">
                    <i class="fas fa-exclamation-circle"></i>
                    <span th:text="${error}"></span>
                  </div>

                  <!-- Form -->
                  <form th:action="${promotion.promotionId != null ? '/admin/promotions/edit/' + promotion.promotionId : '/admin/promotions/add'}" 
                        th:object="${promotion}" 
                        method="post" 
                        class="fade-in">
                    
                    <div class="row">
                      <!-- Tên khuyến mãi -->
                      <div class="col-sm-12">
                        <div class="form-group">
                          <label class="form-label">
                            <i class="fas fa-tag"></i> Tên khuyến mãi <span class="text-danger">*</span>
                          </label>
                          <input
                            th:field="*{promotionName}"
                            type="text"
                            class="form-control"
                            placeholder="Nhập tên khuyến mãi..."
                            required
                          />
                          <div class="invalid-feedback">
                            Vui lòng nhập tên khuyến mãi
                          </div>
                        </div>
                      </div>

                      <!-- Mô tả -->
                      <div class="col-sm-12">
                        <div class="form-group">
                          <label class="form-label">
                            <i class="fas fa-align-left"></i> Mô tả
                          </label>
                          <textarea
                            th:field="*{description}"
                            class="form-control"
                            rows="3"
                            placeholder="Nhập mô tả khuyến mãi..."
                          ></textarea>
                        </div>
                      </div>

                      <!-- Mã khuyến mãi -->
                      <div class="col-md-6">
                        <div class="form-group">
                          <label class="form-label">
                            <i class="fas fa-code"></i> Mã khuyến mãi <span class="text-danger">*</span>
                          </label>
                          <input
                            th:field="*{promotionCode}"
                            type="text"
                            class="form-control"
                            placeholder="Nhập mã khuyến mãi..."
                            required
                          />
                          <div class="invalid-feedback">
                            Vui lòng nhập mã khuyến mãi
                          </div>
                        </div>
                      </div>

                      <!-- Loại khuyến mãi -->
                      <div class="col-md-6">
                        <div class="form-group">
                          <label class="form-label">
                            <i class="fas fa-list"></i> Loại khuyến mãi <span class="text-danger">*</span>
                          </label>
                          <select th:field="*{promotionType}" class="form-control" required>
                            <option value="">Chọn loại khuyến mãi</option>
                            <option value="PRODUCT_PERCENTAGE">Giảm % sản phẩm</option>
                            <option value="SHIPPING_DISCOUNT">Giảm phí ship</option>
                            <option value="FIXED_AMOUNT">Giảm số tiền</option>
                          </select>
                          <div class="invalid-feedback">
                            Vui lòng chọn loại khuyến mãi
                          </div>
                        </div>
                      </div>

                      <!-- Giá trị giảm -->
                      <div class="col-md-6">
                        <div class="form-group">
                          <label class="form-label">
                            <i class="fas fa-percentage"></i> Giá trị giảm <span class="text-danger">*</span>
                          </label>
                          <input
                            th:field="*{discountValue}"
                            type="number"
                            step="0.01"
                            min="0"
                            class="form-control"
                            placeholder="Nhập giá trị giảm..."
                            required
                          />
                          <div class="invalid-feedback">
                            Vui lòng nhập giá trị giảm hợp lệ
                          </div>
                        </div>
                      </div>

                      <!-- Đơn hàng tối thiểu -->
                      <div class="col-md-6">
                        <div class="form-group">
                          <label class="form-label">
                            <i class="fas fa-shopping-cart"></i> Đơn hàng tối thiểu <span class="text-danger">*</span>
                          </label>
                          <input
                            th:field="*{minimumOrderAmount}"
                            type="number"
                            step="0.01"
                            min="0"
                            class="form-control"
                            placeholder="Nhập đơn hàng tối thiểu..."
                            required
                          />
                          <div class="invalid-feedback">
                            Vui lòng nhập đơn hàng tối thiểu hợp lệ
                          </div>
                        </div>
                      </div>

                      <!-- Giảm tối đa -->
                      <div class="col-md-6">
                        <div class="form-group">
                          <label class="form-label">
                            <i class="fas fa-gift"></i> Giảm tối đa <span class="text-danger">*</span>
                          </label>
                          <input
                            th:field="*{maximumDiscountAmount}"
                            type="number"
                            step="0.01"
                            min="0"
                            class="form-control"
                            placeholder="Nhập giảm tối đa..."
                            required
                          />
                          <div class="invalid-feedback">
                            Vui lòng nhập giảm tối đa hợp lệ
                          </div>
                        </div>
                      </div>

                      <!-- Giới hạn sử dụng -->
                      <div class="col-md-6">
                        <div class="form-group">
                          <label class="form-label">
                            <i class="fas fa-users"></i> Giới hạn sử dụng <span class="text-danger">*</span>
                          </label>
                          <input
                            th:field="*{usageLimit}"
                            type="number"
                            min="1"
                            class="form-control"
                            placeholder="Nhập giới hạn sử dụng..."
                            required
                          />
                          <div class="invalid-feedback">
                            Vui lòng nhập giới hạn sử dụng hợp lệ
                          </div>
                        </div>
                      </div>

                      <!-- Ngày bắt đầu -->
                      <div class="col-md-6">
                        <div class="form-group">
                          <label class="form-label">
                            <i class="fas fa-calendar-alt"></i> Ngày bắt đầu <span class="text-danger">*</span>
                          </label>
                          <input
                            th:field="*{startDate}"
                            type="datetime-local"
                            class="form-control"
                            required
                          />
                          <div class="invalid-feedback">
                            Vui lòng chọn ngày bắt đầu
                          </div>
                        </div>
                      </div>

                      <!-- Ngày kết thúc -->
                      <div class="col-md-6">
                        <div class="form-group">
                          <label class="form-label">
                            <i class="fas fa-calendar-times"></i> Ngày kết thúc <span class="text-danger">*</span>
                          </label>
                          <input
                            th:field="*{endDate}"
                            type="datetime-local"
                            class="form-control"
                            required
                          />
                          <div class="invalid-feedback">
                            Vui lòng chọn ngày kết thúc
                          </div>
                        </div>
                      </div>

                      <!-- Trạng thái (chỉ hiển thị khi edit) -->
                      <div class="col-sm-12" th:if="${promotion.promotionId != null}">
                        <div class="form-group">
                          <label class="form-label">
                            <i class="fas fa-toggle-on"></i> Trạng thái
                          </label>
                          <div class="form-check">
                            <input
                              th:field="*{isActive}"
                              type="checkbox"
                              class="form-check-input"
                              id="isActive"
                            />
                            <label class="form-check-label" for="isActive">
                              Kích hoạt khuyến mãi
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="form-actions">
                      <div class="row">
                        <div class="col-sm-12">
                          <div class="d-flex justify-content-between">
                            <a href="/admin/promotions" class="btn btn-secondary">
                              <i class="fas fa-arrow-left"></i> Quay lại
                            </a>
                            <div>
                              <button type="button" class="btn btn-danger mr-2" onclick="resetForm()">
                                <i class="fas fa-undo"></i> Làm mới
                              </button>
                              <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i>
                                <span th:text="${promotion.promotionId != null ? 'Cập nhật' : 'Thêm mới'}"></span>
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="/assets/js/core/jquery.3.2.1.min.js"></script>
    <script src="/assets/js/core/popper.min.js"></script>
    <script src="/assets/js/core/bootstrap.min.js"></script>
    <script src="/assets/js/plugin/jquery-ui-1.12.1.custom/jquery-ui.min.js"></script>
    <script src="/assets/js/plugin/jquery-ui-touch-punch/jquery.ui.touch-punch.min.js"></script>
    <script src="/assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
    <script src="/assets/js/plugin/chart.js/chart.min.js"></script>
    <script src="/assets/js/plugin/jquery.sparkline/jquery.sparkline.min.js"></script>
    <script src="/assets/js/atlantis.min.js"></script>
    <script src="/js/main.js"></script>

    <script>
      // Form validation
      function validateForm() {
        let isValid = true;
        const form = document.querySelector('form');
        const inputs = form.querySelectorAll('input[required], select[required]');
        
        inputs.forEach(input => {
          if (!input.value.trim()) {
            input.classList.add('is-invalid');
            isValid = false;
          } else {
            input.classList.remove('is-invalid');
            input.classList.add('is-valid');
          }
        });
        
        // Validate dates
        const startDate = document.querySelector('input[name="startDate"]');
        const endDate = document.querySelector('input[name="endDate"]');
        
        if (startDate.value && endDate.value) {
          if (new Date(startDate.value) >= new Date(endDate.value)) {
            endDate.classList.add('is-invalid');
            isValid = false;
          } else {
            endDate.classList.remove('is-invalid');
            endDate.classList.add('is-valid');
          }
        }
        
        return isValid;
      }
      
      // Reset form
      function resetForm() {
        if (confirm('Bạn có chắc chắn muốn làm mới form không? Tất cả dữ liệu sẽ bị mất.')) {
          document.querySelector('form').reset();
          document.querySelectorAll('.form-control').forEach(input => {
            input.classList.remove('is-valid', 'is-invalid');
          });
        }
      }
      
      // Auto-format promotion code
      document.addEventListener('DOMContentLoaded', function() {
        const codeInput = document.querySelector('input[name="promotionCode"]');
        if (codeInput) {
          codeInput.addEventListener('input', function() {
            this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
          });
        }
        
        // Set minimum date to today
        const today = new Date().toISOString().slice(0, 16);
        const startDateInput = document.querySelector('input[name="startDate"]');
        const endDateInput = document.querySelector('input[name="endDate"]');
        
        if (startDateInput && !startDateInput.value) {
          startDateInput.min = today;
        }
        
        if (endDateInput && !endDateInput.value) {
          endDateInput.min = today;
        }
        
        // Update end date minimum when start date changes
        if (startDateInput && endDateInput) {
          startDateInput.addEventListener('change', function() {
            endDateInput.min = this.value;
          });
        }
      });
      
      // Kế thừa script từ admin chính - Đảm bảo function global
      window.toggleSidebar = function() {
        const wrapper = document.querySelector(".wrapper");
        const minibutton = document.querySelector(".toggle-sidebar");

        if (wrapper.classList.contains("sidebar_minimize")) {
          // Expand sidebar
          wrapper.classList.remove("sidebar_minimize");
          minibutton.classList.remove("toggled");
          minibutton.innerHTML = '<i class="icon-menu"></i>';
        } else {
          // Collapse sidebar
          wrapper.classList.add("sidebar_minimize");
          minibutton.classList.add("toggled");
          minibutton.innerHTML = '<i class="icon-options-vertical"></i>';
        }
        // Trigger resize event
        window.dispatchEvent(new Event("resize"));
      };

      // Đảm bảo Bootstrap collapse hoạt động cho menu - kế thừa từ admin/index.html
      $(document).ready(function() {
        console.log('Promotion form page loaded');
        
        // Khởi tạo collapse cho menu - giống admin chính
        $('[data-toggle="collapse"]').on('click', function(e) {
          e.preventDefault();
          var target = $(this).attr('href');
          console.log('Menu clicked:', target);
          $(target).collapse('toggle');
        });

        // Thêm class active cho menu item được click - giống admin chính
        $('.nav-item a[data-toggle="collapse"]').on('click', function() {
          $('.nav-item').removeClass('active');
          $(this).closest('.nav-item').addClass('active');
        });

        // Đảm bảo menu mở đúng khi trang load - giống admin chính
        $('.collapse').on('show.bs.collapse', function () {
          $(this).siblings('.nav-item').addClass('active');
        });
        
        $('.collapse').on('hide.bs.collapse', function () {
          $(this).siblings('.nav-item').removeClass('active');
        });

        // Auto-highlight menu khi ở trang promotion form
        setTimeout(function() {
          $('.nav-item a[href="#tables"]').closest('.nav-item').addClass('active');
          $('#tables').addClass('show');
          $('.nav-item a[href="/admin/promotions"]').addClass('active');
          console.log('Menu auto-highlighted');
        }, 100);
      });

      // Form submission
      document.querySelector('form').addEventListener('submit', function(e) {
        if (!validateForm()) {
          e.preventDefault();
          alert('Vui lòng kiểm tra lại thông tin và điền đầy đủ các trường bắt buộc.');
        }
      });
    </script>
  </body>
</html>
