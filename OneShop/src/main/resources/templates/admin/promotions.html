<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý khuyến mãi - OneShop Admin</title>

    <!-- CSS Libraries -->
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/assets/css/atlantis.min.css" />
    <link rel="stylesheet" href="/fonts/fontawesome/fontawesome.min.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />

    <!-- CSS (deduplicated) -->
    <link rel="stylesheet" href="/assets/css/demo.css" />
    <link rel="stylesheet" href="/assets/css/fonts.min.css" />
    <link rel="stylesheet" href="/css/admin-fonts.css" />

    <style>
      /* NOTE: Dùng layout & CSS gốc của theme Atlantis để tránh overlay che sidebar/navbar. */
      .page-title { color: #333; font-size: 1.8rem; margin: 0; font-weight: 600; }

      /* Action Bar */
      .action-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 15px 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .search-form {
        margin-right: 15px;
      }

      .search-box {
        position: relative;
        display: flex;
        align-items: center;
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 25px;
        padding: 8px 15px;
        transition: all 0.3s ease;
        min-width: 300px;
      }

      .search-box:focus-within {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
      }

      .search-box i {
        color: #6c757d;
        margin-right: 10px;
        font-size: 14px;
      }

      .search-box input {
        border: none;
        background: transparent;
        outline: none;
        flex: 1;
        font-size: 14px;
        color: #495057;
      }

      .search-box input::placeholder {
        color: #6c757d;
      }

      .page-size-form {
        margin-right: 15px;
      }

      .page-size-form select {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 8px 12px;
        background: white;
        color: #495057;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .page-size-form select:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        outline: none;
      }

      /* Table Container */
      .table-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 20px 25px;
        border-radius: 0;
      }

      .card-header h5 {
        margin: 0;
        font-weight: 600;
        font-size: 1.2rem;
      }

      .card-header i {
        margin-right: 10px;
        font-size: 1.1rem;
      }

      /* Table Styling */
      .table {
        margin: 0;
        border-collapse: separate;
        border-spacing: 0;
      }

      .table thead th {
        background: #f8f9fa;
        border: none;
        padding: 15px 12px;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        position: sticky;
        top: 0;
        z-index: 10;
        cursor: pointer;
        user-select: none;
      }

      .table tbody tr {
        transition: all 0.3s ease;
        border-bottom: 1px solid #f1f3f4;
      }

      .table tbody tr:hover {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .table td {
        padding: 15px 12px;
        vertical-align: middle;
        border: none;
      }

      /* Badge Styling */
      .badge {
        font-size: 0.75rem;
        padding: 6px 10px;
        border-radius: 20px;
        font-weight: 500;
      }

      .badge-primary {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
      }

      .badge-success {
        background: linear-gradient(135deg, #28a745, #1e7e34);
        color: white;
      }

      .badge-danger {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white;
      }

      .badge-warning {
        background: linear-gradient(135deg, #ffc107, #e0a800);
        color: #212529;
      }

      .badge-info {
        background: linear-gradient(135deg, #17a2b8, #138496);
        color: white;
      }

      .badge-secondary {
        background: linear-gradient(135deg, #6c757d, #545b62);
        color: white;
      }

      /* Status Styling */
      .status-active {
        color: #28a745;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .status-inactive {
        color: #dc3545;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      /* Action Buttons */
      .action-buttons {
        display: flex;
        gap: 5px;
        align-items: center;
      }

      .btn-edit {
        background: linear-gradient(135deg, #ffc107, #e0a800);
        border: none;
        color: #212529;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 500;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 35px;
        height: 35px;
      }

      .btn-edit:hover {
        background: linear-gradient(135deg, #e0a800, #d39e00);
        color: #212529;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
      }

      .btn-delete {
        background: linear-gradient(135deg, #dc3545, #c82333);
        border: none;
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 500;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 35px;
        height: 35px;
      }

      .btn-delete:hover {
        background: linear-gradient(135deg, #c82333, #bd2130);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
      }

      .btn-view {
        background: linear-gradient(135deg, #17a2b8, #138496);
        border: none;
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 500;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 35px;
        height: 35px;
      }

      .btn-view:hover {
        background: linear-gradient(135deg, #138496, #117a8b);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(23, 162, 184, 0.4);
      }

      .btn-toggle {
        background: linear-gradient(135deg, #6c757d, #545b62);
        border: none;
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 500;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 35px;
        height: 35px;
      }

      .btn-toggle:hover {
        background: linear-gradient(135deg, #545b62, #495057);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);
      }

      /* Price and Discount Display */
      .price-display {
        font-weight: 600;
        color: #28a745;
        font-size: 14px;
      }

      .discount-display {
        font-weight: 600;
        color: #dc3545;
        font-size: 14px;
      }

      /* Progress Bar */
      .progress {
        height: 6px;
        background-color: #e9ecef;
        border-radius: 3px;
        overflow: hidden;
      }

      .progress-bar {
        background: linear-gradient(135deg, #007bff, #0056b3);
        border-radius: 3px;
        transition: width 0.3s ease;
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
      }

      .empty-state i {
        font-size: 4rem;
        margin-bottom: 20px;
        color: #dee2e6;
      }

      .empty-state h3 {
        margin-bottom: 10px;
        color: #495057;
      }

      .empty-state p {
        margin-bottom: 0;
        font-size: 14px;
      }

      /* Modal Styling */
      .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px 8px 0 0;
      }

      .modal-title {
        font-weight: 600;
        font-size: 1.2rem;
      }

      .modal-content {
        border: none;
        border-radius: 8px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .modal-body {
        padding: 25px;
      }

      .modal-footer {
        border: none;
        padding: 20px 25px;
        background: #f8f9fa;
        border-radius: 0 0 8px 8px;
      }

      .btn-close {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        opacity: 0.8;
      }

      .btn-close:hover {
        opacity: 1;
      }

      .add-form-card {
        display: none;
        margin-top: 20px;
      }

      .form-control-file {
        display: block;
        width: 100%;
        padding: 8px 12px;
        font-size: 14px;
        line-height: 1.5;
        color: #495057;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid #ced4da;
        border-radius: 4px;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
      }

      .form-control-file:focus {
        border-color: #007bff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
      }

      .price-display {
        font-weight: 600;
        color: #28a745;
      }

      .discount-display {
        font-weight: 600;
        color: #dc3545;
      }

      .status-active {
        color: #28a745;
      }

      .status-inactive {
        color: #dc3545;
      }

      /* Animation */
      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Dashboard and Charts Styling */
      .dashboard-container,
      .charts-container {
        padding: 20px;
      }

      .stat-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border: none;
        transition: all 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      }

      .stat-card .card-body {
        padding: 25px;
      }

      .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
        color: #333;
      }

      .stat-label {
        color: #6c757d;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin: 0;
      }

      .stat-card i {
        margin-bottom: 15px;
      }

      .text-primary { color: #007bff !important; }
      .text-success { color: #28a745 !important; }
      .text-danger { color: #dc3545 !important; }
      .text-warning { color: #ffc107 !important; }

      /* Chart containers */
      .chart-container {
        position: relative;
        height: 300px;
        margin: 20px 0;
      }

      .chart-container canvas {
        max-height: 300px;
      }

      /* Alert styling for dashboard */
      .alert {
        border: none;
        border-radius: 8px;
        padding: 15px 20px;
        margin-bottom: 15px;
        border-left: 4px solid;
      }

      .alert-warning {
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        border-left-color: #ffc107;
        color: #856404;
      }

      .alert-info {
        background: linear-gradient(135deg, #d1ecf1, #bee5eb);
        border-left-color: #17a2b8;
        color: #0c5460;
      }

      .alert strong {
        font-weight: 600;
        display: block;
        margin-bottom: 5px;
      }

      .alert small {
        color: inherit;
        opacity: 0.8;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .action-bar {
          flex-direction: column;
          gap: 15px;
          align-items: stretch;
        }

        .search-box {
          min-width: auto;
          width: 100%;
        }

        .table-responsive {
          font-size: 0.875rem;
        }

        .table td,
        .table th {
          padding: 8px 6px;
        }

        .action-buttons {
          flex-direction: column;
          gap: 3px;
        }

        .btn-edit,
        .btn-delete,
        .btn-view,
        .btn-toggle {
          width: 30px;
          height: 30px;
          font-size: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <!-- Header -->
      <th:block th:replace="~{admin/fragments/header :: header}"></th:block>

      <!-- Navbar -->
      <th:block th:replace="~{admin/fragments/navbar :: navbar}"></th:block>

      <div class="main-panel">
        <div class="content">
          <!-- Page Header -->
          <div class="page-header">
            <h2 class="page-title" th:text="${filter == 'active' ? 'Khuyến mãi hoạt động' : filter == 'expired' ? 'Khuyến mãi hết hạn' : 'Quản lý khuyến mãi'}">Quản lý khuyến mãi</h2>
          </div>

          <div class="page-inner">
            <!-- Content Section -->
            <div class="content-section">
              <!-- Action Bar -->
              <div class="action-bar">
                <div class="d-flex align-items-center">
                  <!-- Search Form -->
                  <form method="get" class="search-form mr-3">
                    <input type="hidden" name="page" value="0" />
                    <input type="hidden" name="size" th:value="${size}" />
                    <input type="hidden" name="sortBy" th:value="${sortBy}" />
                    <input type="hidden" name="sortDir" th:value="${sortDir}" />
                    <div class="search-box">
                      <i class="fas fa-search"></i>
                      <input
                        type="text"
                        name="search"
                        th:value="${search}"
                        placeholder="Tìm kiếm khuyến mãi..."
                        onchange="this.form.submit()"
                      />
                    </div>
                  </form>

                  <!-- Page Size Selector -->
                  <form method="get" class="page-size-form">
                    <input type="hidden" name="page" value="0" />
                    <input type="hidden" name="search" th:value="${search}" />
                    <input type="hidden" name="sortBy" th:value="${sortBy}" />
                    <input type="hidden" name="sortDir" th:value="${sortDir}" />
                    <select
                      name="size"
                      class="form-control form-control-sm"
                      style="width: auto"
                      onchange="this.form.submit()"
                    >
                      <option value="5" th:selected="${size == 5}">
                        5 dòng
                      </option>
                      <option value="10" th:selected="${size == 10}">
                        10 dòng
                      </option>
                      <option value="20" th:selected="${size == 20}">
                        20 dòng
                      </option>
                      <option value="50" th:selected="${size == 50}">
                        50 dòng
                      </option>
                    </select>
                  </form>
                </div>

                <a
                  href="/admin/promotions/add"
                  class="btn btn-primary"
                >
                  <i class="fas fa-plus"></i>
                  Thêm khuyến mãi mới
                </a>
              </div>

              <!-- Promotions Table -->
              <div class="table-container">
                <div class="card">
                  <div class="card-header">
                    <h5 class="mb-0">
                      <i class="fas fa-tags"></i>
                      Danh sách khuyến mãi
                    </h5>
                  </div>
                  <div class="card-body" style="padding: 0">
                    <div class="table-responsive">
                      <table class="table table-hover" id="promotionsTable">
                        <thead>
                          <tr>
                            <th>ID</th>
                            <th>Tên khuyến mãi</th>
                            <th>Mã khuyến mãi</th>
                            <th>Loại</th>
                            <th>Giá trị giảm</th>
                            <th>Ngày bắt đầu</th>
                            <th>Ngày kết thúc</th>
                            <th>Trạng thái</th>
                            <th>Sử dụng</th>
                            <th>Thao tác</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr th:each="promotion : ${promotions.content}" class="fade-in">
                            <td>
                              <span
                                class="badge badge-primary"
                                th:text="${promotion.promotionId}"
                              ></span>
                            </td>
                            <td>
                              <strong th:text="${promotion.promotionName}"></strong>
                              <br>
                              <small class="text-muted" th:text="${promotion.description}"></small>
                            </td>
                            <td>
                              <span
                                class="badge badge-info"
                                th:text="${promotion.promotionCode}"
                              ></span>
                            </td>
                            <td>
                              <span
                                class="badge badge-secondary"
                                th:text="${promotion.promotionType.name().replace('_', ' ')}"
                              ></span>
                            </td>
                            <td>
                              <th:block th:switch="${promotion.promotionType}">
                                <span th:case="${T(vn.entity.Promotion.PromotionType).PERCENTAGE}">
                                  <span class="discount-display" th:text="${#numbers.formatDecimal(promotion.discountValue, 0, 'COMMA', 0, 'POINT')} + '%'">%</span>
                                </span>
                                <span th:case="*">
                                  <span class="price-display" th:text="${#numbers.formatDecimal(promotion.discountValue, 0, 'COMMA', 0, 'POINT')} + ' đ'">đ</span>
                                </span>
                              </th:block>
                            </td>
                            <td>
                              <span
                                th:if="${promotion.startDate != null}"
                                th:text="${#temporals.format(promotion.startDate, 'dd/MM/yyyy')}"
                                class="date-display"
                              ></span>
                              <span
                                th:unless="${promotion.startDate != null}"
                                class="text-muted"
                                >--</span
                              >
                            </td>
                            <td>
                              <span
                                th:if="${promotion.endDate != null}"
                                th:text="${#temporals.format(promotion.endDate, 'dd/MM/yyyy')}"
                                class="date-display"
                              ></span>
                              <span
                                th:unless="${promotion.endDate != null}"
                                class="text-muted"
                                >--</span
                              >
                            </td>
                            <td>
                              <span
                                th:if="${promotion.isActive}"
                                class="status-active"
                              >
                                <i class="fas fa-check-circle"></i> Hoạt động
                              </span>
                              <span
                                th:unless="${promotion.isActive}"
                                class="status-inactive"
                              >
                                <i class="fas fa-times-circle"></i> Tạm dừng
                              </span>
                            </td>
                            <td>
                              <span th:text="${promotion.usedCount}"></span> / 
                              <span th:text="${promotion.usageLimit}"></span>
                              <div class="progress mt-1">
                                <div class="progress-bar" 
                                     th:style="'width: ' + ${(promotion.usedCount * 100) / promotion.usageLimit} + '%'">
                                </div>
                              </div>
                            </td>
                            <td>
                              <div class="action-buttons">
                                <a
                                  th:href="@{/admin/promotions/view/{id}(id=${promotion.promotionId})}"
                                  class="btn btn-view"
                                  title="Xem chi tiết"
                                >
                                  <i class="fas fa-eye"></i>
                                </a>
                                <a
                                  th:href="@{/admin/promotions/edit/{id}(id=${promotion.promotionId})}"
                                  class="btn btn-edit"
                                  title="Chỉnh sửa khuyến mãi"
                                >
                                  <i class="fas fa-edit"></i>
                                </a>
                                <a
                                  th:href="@{/admin/promotions/toggle/{id}(id=${promotion.promotionId})}"
                                  class="btn btn-toggle"
                                  th:title="${promotion.isActive} ? 'Tạm dừng' : 'Kích hoạt'"
                                >
                                  <i th:class="${promotion.isActive} ? 'fas fa-pause' : 'fas fa-play'"></i>
                                </a>
                                <button
                                  type="button"
                                  class="btn btn-delete"
                                  th:data-id="${promotion.promotionId}"
                                  th:data-name="${promotion.promotionName}"
                                  onclick="confirmDelete(this)"
                                  title="Xóa khuyến mãi"
                                >
                                  <i class="fas fa-trash"></i>
                                </button>
                              </div>
                            </td>
                          </tr>
                          <tr th:if="${#lists.isEmpty(promotions.content)}">
                            <td colspan="10" class="empty-state">
                              <i class="fas fa-tags"></i>
                              <h3>Chưa có khuyến mãi nào</h3>
                              <p>
                                Hãy thêm khuyến mãi đầu tiên để bắt đầu quản lý
                              </p>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Promotion Modal -->
    <div class="modal fade" id="addPromotionModal" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-plus"></i>
              Thêm khuyến mãi mới
            </h5>
            <button type="button" class="btn-close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form
              th:action="@{/admin/promotions/add}"
              th:object="${promotion}"
              method="post"
            >
              <div class="row">
                <div class="col-sm-12">
                  <div class="form-group">
                    <label class="form-label">Tên khuyến mãi</label>
                    <input
                      th:field="*{promotionName}"
                      type="text"
                      class="form-control"
                      placeholder="Tên khuyến mãi..."
                      required
                    />
                  </div>
                </div>
                <div class="col-sm-12">
                  <div class="form-group">
                    <label class="form-label">Mô tả</label>
                    <textarea
                      th:field="*{description}"
                      class="form-control"
                      rows="3"
                      placeholder="Mô tả khuyến mãi..."
                    ></textarea>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label">Mã khuyến mãi</label>
                    <input
                      th:field="*{promotionCode}"
                      type="text"
                      class="form-control"
                      placeholder="Mã khuyến mãi..."
                      required
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label">Loại khuyến mãi</label>
                    <select th:field="*{promotionType}" class="form-control" required>
                      <option value="">Chọn loại khuyến mãi</option>
                      <option value="PRODUCT_PERCENTAGE">Giảm % sản phẩm</option>
                      <option value="SHIPPING_DISCOUNT">Giảm phí ship</option>
                      <option value="FIXED_AMOUNT">Giảm số tiền</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label">Giá trị giảm</label>
                    <input
                      th:field="*{discountValue}"
                      type="number"
                      step="0.01"
                      class="form-control"
                      placeholder="Giá trị giảm..."
                      required
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label">Đơn hàng tối thiểu</label>
                    <input
                      th:field="*{minimumOrderAmount}"
                      type="number"
                      step="0.01"
                      class="form-control"
                      placeholder="Đơn hàng tối thiểu..."
                      required
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label">Giảm tối đa</label>
                    <input
                      th:field="*{maximumDiscountAmount}"
                      type="number"
                      step="0.01"
                      class="form-control"
                      placeholder="Giảm tối đa..."
                      required
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label">Giới hạn sử dụng</label>
                    <input
                      th:field="*{usageLimit}"
                      type="number"
                      class="form-control"
                      placeholder="Giới hạn sử dụng..."
                      required
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label">Ngày bắt đầu</label>
                    <input
                      th:field="*{startDate}"
                      type="datetime-local"
                      class="form-control"
                      required
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label">Ngày kết thúc</label>
                    <input
                      th:field="*{endDate}"
                      type="datetime-local"
                      class="form-control"
                      required
                    />
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                  Hủy
                </button>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i>
                  Lưu khuyến mãi
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="/assets/js/core/jquery.3.2.1.min.js"></script>
    <script src="/assets/js/core/popper.min.js"></script>
    <script src="/assets/js/core/bootstrap.min.js"></script>
    <script src="/assets/js/plugin/jquery-ui-1.12.1.custom/jquery-ui.min.js"></script>
    <script src="/assets/js/plugin/jquery-ui-touch-punch/jquery.ui.touch-punch.min.js"></script>
    <script src="/assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
    <script src="/assets/js/plugin/chart.js/chart.min.js"></script>
    <script src="/assets/js/plugin/jquery.sparkline/jquery.sparkline.min.js"></script>
    <script src="/assets/js/atlantis.min.js"></script>
    <script src="/js/main.js"></script>
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      // Table sorting functionality
      (function () {
        const table = document.getElementById('promotionsTable');
        if (!table) return;
        const thead = table.querySelector('thead');
        const tbody = table.querySelector('tbody');
        if (!thead || !tbody) return;

        // Column type map by index
        const types = ['number', 'string', 'string', 'string', 'currency', 'date', 'date', 'boolean', 'number', null];

        const original = Array.from(tbody.rows);
        let state = { index: -1, dir: 0 }; // 0 none, 1 asc, -1 desc

        function parseCell(td, type) {
          if (!td) return '';
          const txt = td.innerText.trim();
          switch (type) {
            case 'number':
              return Number(txt.replace(/[^\d.-]/g, '')) || 0;
            case 'currency':
              return Number(txt.replace(/[^\d.-]/g, '')) || 0;
            case 'date': {
              const m = txt.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
              if (m) return new Date(+m[3], +m[2] - 1, +m[1]).getTime();
              const t = Date.parse(txt);
              return isNaN(t) ? 0 : t;
            }
            case 'boolean':
              return td.querySelector('.status-active') ? 1 : 0;
            default:
              return txt.toLowerCase();
          }
        }

        function sortTable(index, dir) {
          const tbody = table.querySelector('tbody');
          const rows = Array.from(tbody.rows);
          const type = types[index];
          
          rows.sort((a, b) => {
            const aVal = parseCell(a.cells[index], type);
            const bVal = parseCell(b.cells[index], type);
            
            if (aVal < bVal) return -dir;
            if (aVal > bVal) return dir;
            return 0;
          });
          
          rows.forEach(row => tbody.appendChild(row));
        }

        function updateHeader(index, dir) {
          thead.querySelectorAll('th').forEach((th, i) => {
            th.classList.remove('sort-asc', 'sort-desc');
            if (i === index) {
              th.classList.add(dir === 1 ? 'sort-asc' : 'sort-desc');
            }
          });
        }

        thead.addEventListener('click', (e) => {
          const th = e.target.closest('th');
          if (!th) return;
          
          const index = Array.from(thead.querySelectorAll('th')).indexOf(th);
          if (index === -1 || types[index] === null) return;
          
          let dir = 1;
          if (state.index === index) {
            dir = state.dir === 1 ? -1 : 1;
          }
          
          state = { index, dir };
          sortTable(index, dir);
          updateHeader(index, dir);
        });

        // Add sort indicators
        thead.querySelectorAll('th').forEach((th, i) => {
          if (types[i] !== null) {
            th.style.cursor = 'pointer';
            th.style.userSelect = 'none';
            th.innerHTML += ' <i class="fas fa-sort" style="opacity: 0.5;"></i>';
          }
        });
      })();

      // Delete confirmation
      function confirmDelete(button) {
        const id = button.getAttribute('data-id');
        const name = button.getAttribute('data-name');
        
        if (confirm(`Bạn có chắc chắn muốn xóa khuyến mãi "${name}" không?`)) {
          window.location.href = `/admin/promotions/delete/${id}`;
        }
      }

      // Kế thừa script từ admin chính - Đảm bảo function global
      window.toggleSidebar = function() {
        const wrapper = document.querySelector(".wrapper");
        const minibutton = document.querySelector(".toggle-sidebar");

        if (wrapper.classList.contains("sidebar_minimize")) {
          // Expand sidebar
          wrapper.classList.remove("sidebar_minimize");
          minibutton.classList.remove("toggled");
          minibutton.innerHTML = '<i class="icon-menu"></i>';
        } else {
          // Collapse sidebar
          wrapper.classList.add("sidebar_minimize");
          minibutton.classList.add("toggled");
          minibutton.innerHTML = '<i class="icon-options-vertical"></i>';
        }
        // Trigger resize event
        window.dispatchEvent(new Event("resize"));
      };

      // Đảm bảo Bootstrap collapse hoạt động cho menu - kế thừa từ admin/index.html
      $(document).ready(function() {
        console.log('Promotions page loaded');
        
        // Khởi tạo collapse cho menu (giống index.html)
        $('[data-toggle="collapse"]').on('click', function(e) {
          e.preventDefault();
          var target = $(this).attr('href');
          $(target).collapse('toggle');
        });

        // Thêm class active cho menu item được click (giống index.html)
        $('.nav-item a[data-toggle="collapse"]').on('click', function() {
          $('.nav-item').removeClass('active');
          $(this).closest('.nav-item').addClass('active');
        });

        // Đảm bảo menu mở đúng khi trang load (giống index.html)
        $('.collapse').on('show.bs.collapse', function () {
          $(this).siblings('.nav-item').addClass('active');
        });

        // Auto-highlight menu khi ở trang promotions
        setTimeout(function() {
          $('.nav-item a[href="#tables"]').closest('.nav-item').addClass('active');
          $('#tables').addClass('show');
          $('.nav-item a[href="/admin/promotions"]').addClass('active');
          console.log('Menu auto-highlighted');
        }, 100);

        // Convert sidebar statistic links to absolute routes with query param on this page
        (function fixSidebarStatisticLinks() {
          const mapTab = (hash) => {
            if (!hash) return '';
            const key = hash.replace('#','');
            switch (key) {
              case 'overview': return 'overview';
              case 'products': return 'products';
              case 'brands': return 'brands';
              case 'best-sellers': return 'best-sellers';
              case 'favorites': return 'favorites';
              default: return key;
            }
          };
          $('#charts .nav-collapse a[href^="/admin/statistics#"]').each(function(){
            const href = $(this).attr('href');
            const hashIdx = href.indexOf('#');
            if (hashIdx > -1) {
              const hash = href.substring(hashIdx);
              const tab = mapTab(hash);
              $(this).attr('href', `/admin/statistics?tab=${encodeURIComponent(tab)}`);
            }
          });
        })();
      });

      // Auto-submit search form on Enter
      document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.querySelector('input[name="search"]');
        if (searchInput) {
          searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              this.form.submit();
            }
          });
        }
        
        // Handle hash fragments for different views
        handleHashView();
        
        // Listen for hash changes
        window.addEventListener('hashchange', handleHashView);
      });
      
      function handleHashView() {
        // Always show default table view on promotions page
        showTablesView();
      }
      
      function showDashboardView() {
        const contentSection = document.querySelector('.content-section');
        if (!contentSection) return;
        
        // Create dashboard view if not exists
        let dashboardView = contentSection.querySelector('#dashboard-view');
        if (!dashboardView) {
          dashboardView = createDashboardView();
          contentSection.appendChild(dashboardView);
        }
        
        dashboardView.style.display = 'block';
      }
      
      function showChartsView() {
        const contentSection = document.querySelector('.content-section');
        if (!contentSection) return;
        
        // Create charts view if not exists
        let chartsView = contentSection.querySelector('#charts-view');
        if (!chartsView) {
          chartsView = createChartsView();
          contentSection.appendChild(chartsView);
        }
        
        chartsView.style.display = 'block';
      }
      
      function showTablesView() {
        const contentSection = document.querySelector('.content-section');
        if (!contentSection) return;
        
        // Show default table view
        const actionBar = contentSection.querySelector('.action-bar');
        const tableContainer = contentSection.querySelector('.table-container');
        if (actionBar) actionBar.style.display = 'flex';
        if (tableContainer) tableContainer.style.display = 'block';
      }
      
      function showDefaultView() {
        showTablesView();
      }
      
      function createDashboardView() {
        const dashboardDiv = document.createElement('div');
        dashboardDiv.id = 'dashboard-view';
        dashboardDiv.className = 'dashboard-container';
        dashboardDiv.innerHTML = `
          <div class="row">
            <div class="col-md-3">
              <div class="card stat-card">
                <div class="card-body text-center">
                  <i class="fas fa-tags fa-2x text-primary mb-3"></i>
                  <h3 class="stat-value">${getTotalPromotions()}</h3>
                  <p class="stat-label">Tổng khuyến mãi</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card stat-card">
                <div class="card-body text-center">
                  <i class="fas fa-check-circle fa-2x text-success mb-3"></i>
                  <h3 class="stat-value">${getActivePromotions()}</h3>
                  <p class="stat-label">Đang hoạt động</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card stat-card">
                <div class="card-body text-center">
                  <i class="fas fa-times-circle fa-2x text-danger mb-3"></i>
                  <h3 class="stat-value">${getExpiredPromotions()}</h3>
                  <p class="stat-label">Đã hết hạn</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card stat-card">
                <div class="card-body text-center">
                  <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
                  <h3 class="stat-value">${getFullyUsedPromotions()}</h3>
                  <p class="stat-label">Đã hết lượt</p>
                </div>
              </div>
            </div>
          </div>
          <div class="row mt-4">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h5><i class="fas fa-clock"></i> Khuyến mãi sắp hết hạn</h5>
                </div>
                <div class="card-body">
                  <div class="alert alert-warning">
                    <strong>Khuyến mãi Tết 2024</strong>
                    <br>
                    <small>15/02/2024 23:59</small>
                  </div>
                  <div class="alert alert-warning">
                    <strong>Black Friday Sale</strong>
                    <br>
                    <small>30/11/2024 23:59</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h5><i class="fas fa-chart-line"></i> Khuyến mãi gần đây</h5>
                </div>
                <div class="card-body">
                  <div class="alert alert-info">
                    <strong>Giảm giá 20%</strong>
                    <br>
                    <small>01/12/2024 10:30</small>
                  </div>
                  <div class="alert alert-info">
                    <strong>Miễn phí ship</strong>
                    <br>
                    <small>30/11/2024 15:45</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        return dashboardDiv;
      }
      
      function createChartsView() {
        const chartsDiv = document.createElement('div');
        chartsDiv.id = 'charts-view';
        chartsDiv.className = 'charts-container';
        chartsDiv.innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h5><i class="fas fa-chart-pie"></i> Phân bố theo loại</h5>
                </div>
                <div class="card-body">
                  <canvas id="typeChart" width="400" height="200"></canvas>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h5><i class="fas fa-chart-bar"></i> Thống kê sử dụng</h5>
                </div>
                <div class="card-body">
                  <canvas id="usageChart" width="400" height="200"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="row mt-4">
            <div class="col-md-12">
              <div class="card">
                <div class="card-header">
                  <h5><i class="fas fa-chart-line"></i> Biểu đồ xu hướng</h5>
                </div>
                <div class="card-body">
                  <canvas id="trendChart" width="800" height="300"></canvas>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // Initialize charts after a short delay
        setTimeout(() => {
          initializeCharts();
        }, 100);
        
        return chartsDiv;
      }
      
      function initializeCharts() {
        // Type Chart (Pie)
        const typeCtx = document.getElementById('typeChart');
        if (typeCtx) {
          new Chart(typeCtx, {
            type: 'pie',
            data: {
              labels: ['Giảm % sản phẩm', 'Giảm phí ship', 'Giảm số tiền'],
              datasets: [{
                data: [60, 25, 15],
                backgroundColor: ['#007bff', '#28a745', '#ffc107']
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false
            }
          });
        }
        
        // Usage Chart (Bar)
        const usageCtx = document.getElementById('usageChart');
        if (usageCtx) {
          new Chart(usageCtx, {
            type: 'bar',
            data: {
              labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6'],
              datasets: [{
                label: 'Lần sử dụng',
                data: [12, 19, 3, 5, 2, 3],
                backgroundColor: '#007bff'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });
        }
        
        // Trend Chart (Line)
        const trendCtx = document.getElementById('trendChart');
        if (trendCtx) {
          new Chart(trendCtx, {
            type: 'line',
            data: {
              labels: ['Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6'],
              datasets: [{
                label: 'Khuyến mãi mới',
                data: [5, 8, 12, 6, 15, 10],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4
              }, {
                label: 'Khuyến mãi hết hạn',
                data: [2, 3, 5, 8, 4, 6],
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });
        }
      }
      
      // Helper functions to get statistics
      function getTotalPromotions() {
        const totalElements = document.querySelector('[th\\:text*="totalElements"]');
        return totalElements ? totalElements.textContent : '0';
      }
      
      function getActivePromotions() {
        return '3'; // Mock data
      }
      
      function getExpiredPromotions() {
        return '1'; // Mock data
      }
      
      function getFullyUsedPromotions() {
        return '2'; // Mock data
      }
    </script>
  </body>
</html>
