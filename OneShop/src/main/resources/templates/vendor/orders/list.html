<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý đơn hàng</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .vendor-section {
        background: white;
        border-radius: 8px;
        padding: 24px;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .order-card {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        transition: all 0.2s ease;
        background: #fdfdfd;
      }

      .order-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
        border-color: #007bff;
      }

      .status-badge {
        font-size: 0.75rem;
        padding: 4px 10px;
        border-radius: 20px;
        font-weight: 500;
      }

      .nav-tabs .nav-link {
        border: none;
        color: #6c757d;
        font-weight: 500;
      }

      .nav-tabs .nav-link.active {
        color: #007bff;
        background-color: #e7f1ff;
        border-radius: 6px;
      }

      .nav-tabs .nav-link:hover:not(.active) {
        color: #0056b3;
      }

      .order-amount {
        font-size: 1.1rem;
        font-weight: 600;
        color: #28a745;
      }
    </style>
  </head>
  <body class="bg-light">
    <div th:replace="~{vendor/fragments/nav :: vendorNav('orders')}"></div>

    <main class="container py-4">
      <!-- Header Section -->
      <section class="vendor-section mb-4">
        <div
          class="d-flex flex-column flex-xl-row justify-content-between gap-3 align-items-start align-items-xl-center"
        >
          <div>
            <h2 class="h4 mb-1">Quản lý đơn hàng</h2>
            <p class="text-muted mb-0">Danh sách đơn hàng của shop</p>
          </div>
          <div class="d-flex gap-2">
            <span class="badge bg-primary fs-6">
              <i class="fas fa-shopping-cart me-1"></i>
              Tổng: <span th:text="${totalOrders}">0</span> đơn hàng
            </span>
          </div>
        </div>
      </section>

      <!-- Search & Filter Section -->
      <section class="vendor-section mb-4">
        <!-- Status Tabs -->
        <ul class="nav nav-tabs mb-4" id="orderTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <a
              class="nav-link"
              th:classappend="${currentStatus == null ? 'active' : ''}"
              th:href="@{/vendor/orders(shopId=${shopId}, q=${search})}"
            >
              Tất cả
              <span class="badge bg-secondary ms-1" th:text="${totalOrders}"
                >0</span
              >
            </a>
          </li>
          <li class="nav-item" role="presentation">
            <a
              class="nav-link"
              th:classappend="${currentStatus == 'PENDING' ? 'active' : ''}"
              th:href="@{/vendor/orders(shopId=${shopId}, status=PENDING, q=${search})}"
            >
              Chờ xác nhận
              <span class="badge bg-secondary ms-1" th:text="${pendingCount}"
                >0</span
              >
            </a>
          </li>
          <li class="nav-item" role="presentation">
            <a
              class="nav-link"
              th:classappend="${currentStatus == 'CONFIRMED' ? 'active' : ''}"
              th:href="@{/vendor/orders(shopId=${shopId}, status=CONFIRMED, q=${search})}"
            >
              Đã xác nhận
              <span class="badge bg-secondary ms-1" th:text="${confirmedCount}"
                >0</span
              >
            </a>
          </li>
          <li class="nav-item" role="presentation">
            <a
              class="nav-link"
              th:classappend="${currentStatus == 'SHIPPING' ? 'active' : ''}"
              th:href="@{/vendor/orders(shopId=${shopId}, status=SHIPPING, q=${search})}"
            >
              Đang giao hàng
              <span class="badge bg-secondary ms-1" th:text="${shippingCount}"
                >0</span
              >
            </a>
          </li>
          <li class="nav-item" role="presentation">
            <a
              class="nav-link"
              th:classappend="${currentStatus == 'DELIVERED' ? 'active' : ''}"
              th:href="@{/vendor/orders(shopId=${shopId}, status=DELIVERED, q=${search})}"
            >
              Đã giao
              <span class="badge bg-success ms-1" th:text="${deliveredCount}"
                >0</span
              >
            </a>
          </li>
          <li class="nav-item" role="presentation">
            <a
              class="nav-link"
              th:classappend="${currentStatus == 'CANCELLED' ? 'active' : ''}"
              th:href="@{/vendor/orders(shopId=${shopId}, status=CANCELLED, q=${search})}"
            >
              Đã hủy
              <span class="badge bg-danger ms-1" th:text="${cancelledCount}"
                >0</span
              >
            </a>
          </li>
          <li class="nav-item" role="presentation">
            <a
              class="nav-link"
              th:classappend="${currentStatus == 'RETURNED' ? 'active' : ''}"
              th:href="@{/vendor/orders(shopId=${shopId}, status=RETURNED, q=${search})}"
            >
              Đã hoàn trả
              <span class="badge bg-secondary ms-1" th:text="${returnedCount}"
                >0</span
              >
            </a>
          </li>
        </ul>

        <!-- Search Form -->
        <form th:action="@{/vendor/orders}" method="get">
          <input type="hidden" name="shopId" th:value="${shopId}" />
          <input
            type="hidden"
            name="status"
            th:value="${currentStatus != null ? currentStatus : ''}"
          />
          <div class="row">
            <div class="col-md-6">
              <div class="input-group">
                <input
                  type="text"
                  name="q"
                  class="form-control"
                  placeholder="Tìm kiếm theo mã đơn hàng..."
                  th:value="${search}"
                />
                <button class="btn btn-primary" type="submit">
                  <i class="fas fa-search"></i> Tìm kiếm
                </button>
              </div>
            </div>
          </div>
        </form>
      </section>

      <!-- Orders List -->
      <section>
        <div
          th:if="${error}"
          class="alert alert-danger"
          th:text="${error}"
        ></div>

        <div th:if="${orders != null and !orders.content.isEmpty()}">
          <div class="row">
            <div th:each="order : ${orders.content}" class="col-12 mb-3">
              <div class="order-card">
                <div class="card-body p-3">
                  <div class="row align-items-center">
                    <div class="col-md-8">
                      <h6 class="mb-2">
                        <i class="fas fa-receipt text-primary me-2"></i>
                        Đơn hàng #<span th:text="${order.orderId}">1</span>
                      </h6>
                      <div class="row text-muted small">
                        <div class="col-6">
                          <i class="fas fa-clock me-1"></i>
                          <span
                            th:text="${order.orderDate != null ? #temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm') : 'N/A'}"
                          ></span>
                        </div>
                        <div class="col-6">
                          <i class="fas fa-credit-card me-1"></i>
                          <span
                            th:text="${order.paymentMethod ?: 'COD'}"
                          ></span>
                        </div>
                      </div>
                      <div class="mt-1">
                        <i class="fas fa-map-marker-alt me-1"></i>
                        <small
                          th:text="${order.shippingAddress ?: 'N/A'}"
                          class="text-muted"
                        ></small>
                      </div>
                    </div>
                    <div class="col-md-4 text-end">
                      <div
                        class="order-amount mb-2"
                        th:text="${(order.finalAmount != null && order.finalAmount > 0) ? (#numbers.formatDecimal(order.finalAmount, 0, 'COMMA', 0, 'POINT') + ' VNĐ') : (order.totalAmount != null ? (#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT') + ' VNĐ') : '0 VNĐ')}"
                      ></div>
                      <div class="mb-2">
                        <div th:switch="${order.status.name()}">
                          <span th:case="'PENDING'" class="badge bg-secondary"
                            >Chờ xác nhận</span
                          >
                          <span th:case="'CONFIRMED'" class="badge bg-primary"
                            >Đã xác nhận</span
                          >
                          <span th:case="'SHIPPING'" class="badge bg-warning"
                            >Đang giao hàng</span
                          >
                          <span th:case="'DELIVERED'" class="badge bg-success"
                            >Đã giao</span
                          >
                          <span th:case="'CANCELLED'" class="badge bg-danger"
                            >Đã hủy</span
                          >
                          <span th:case="'RETURNED'" class="badge bg-dark"
                            >Đã hoàn trả</span
                          >
                          <span
                            th:case="*"
                            class="badge bg-light text-dark"
                            th:text="${order.status}"
                          ></span>
                        </div>
                      </div>
                      <div
                        class="d-flex justify-content-end align-items-center gap-2"
                      >
                        <!-- Các nút hành động cho đơn chờ xác nhận -->
                        <div th:if="${order.status.name() == 'PENDING'}">
                          <!-- Nút chọn shipper cho đơn hỏa tốc (TPHCM) -->
                          <button 
                            th:if="${#strings.containsIgnoreCase(order.shippingAddress, 'hồ chí minh') or #strings.containsIgnoreCase(order.shippingAddress, 'ho chi minh') or #strings.containsIgnoreCase(order.shippingAddress, 'tphcm') or #strings.containsIgnoreCase(order.shippingAddress, 'sài gòn') or #strings.containsIgnoreCase(order.shippingAddress, 'quận 1') or #strings.containsIgnoreCase(order.shippingAddress, 'quận 2') or #strings.containsIgnoreCase(order.shippingAddress, 'quận 3') or #strings.containsIgnoreCase(order.shippingAddress, 'quận 4') or #strings.containsIgnoreCase(order.shippingAddress, 'quận 5') or #strings.containsIgnoreCase(order.shippingAddress, 'quận 6') or #strings.containsIgnoreCase(order.shippingAddress, 'quận 7') or #strings.containsIgnoreCase(order.shippingAddress, 'quận 8') or #strings.containsIgnoreCase(order.shippingAddress, 'quận 9') or #strings.containsIgnoreCase(order.shippingAddress, 'quận 10') or #strings.containsIgnoreCase(order.shippingAddress, 'quận 11') or #strings.containsIgnoreCase(order.shippingAddress, 'quận 12') or #strings.containsIgnoreCase(order.shippingAddress, 'thủ đức') or #strings.containsIgnoreCase(order.shippingAddress, 'bình thạnh') or #strings.containsIgnoreCase(order.shippingAddress, 'tân bình') or #strings.containsIgnoreCase(order.shippingAddress, 'tân phú') or #strings.containsIgnoreCase(order.shippingAddress, 'phú nhuận') or #strings.containsIgnoreCase(order.shippingAddress, 'gò vấp') or #strings.containsIgnoreCase(order.shippingAddress, 'bình tân') or #strings.containsIgnoreCase(order.shippingAddress, 'hóc môn') or #strings.containsIgnoreCase(order.shippingAddress, 'củ chi') or #strings.containsIgnoreCase(order.shippingAddress, 'bình chánh') or #strings.containsIgnoreCase(order.shippingAddress, 'nhà bè') or #strings.containsIgnoreCase(order.shippingAddress, 'cần giờ')}"
                            type="button" 
                            class="btn btn-sm btn-warning me-1"
                            th:data-order-id="${order.orderId}"
                            th:data-shop-id="${order.shop.shopId}"
                            th:disabled="${order.shipper != null}"
                          >
                            <i class="fas fa-motorcycle me-1"></i>
                            <span th:if="${order.shipper != null}">Đã gán shipper</span>
                            <span th:if="${order.shipper == null}">Chọn Shipper (Hỏa tốc)</span>
                          </button>
                          
                          <!-- Nút chọn nhà vận chuyển cho đơn đi xa (ngoài TPHCM) -->
                          <button 
                            th:if="${!#strings.containsIgnoreCase(order.shippingAddress, 'hồ chí minh') and !#strings.containsIgnoreCase(order.shippingAddress, 'ho chi minh') and !#strings.containsIgnoreCase(order.shippingAddress, 'tphcm') and !#strings.containsIgnoreCase(order.shippingAddress, 'sài gòn') and !#strings.containsIgnoreCase(order.shippingAddress, 'quận 1') and !#strings.containsIgnoreCase(order.shippingAddress, 'quận 2') and !#strings.containsIgnoreCase(order.shippingAddress, 'quận 3') and !#strings.containsIgnoreCase(order.shippingAddress, 'quận 4') and !#strings.containsIgnoreCase(order.shippingAddress, 'quận 5') and !#strings.containsIgnoreCase(order.shippingAddress, 'quận 6') and !#strings.containsIgnoreCase(order.shippingAddress, 'quận 7') and !#strings.containsIgnoreCase(order.shippingAddress, 'quận 8') and !#strings.containsIgnoreCase(order.shippingAddress, 'quận 9') and !#strings.containsIgnoreCase(order.shippingAddress, 'quận 10') and !#strings.containsIgnoreCase(order.shippingAddress, 'quận 11') and !#strings.containsIgnoreCase(order.shippingAddress, 'quận 12') and !#strings.containsIgnoreCase(order.shippingAddress, 'thủ đức') and !#strings.containsIgnoreCase(order.shippingAddress, 'bình thạnh') and !#strings.containsIgnoreCase(order.shippingAddress, 'tân bình') and !#strings.containsIgnoreCase(order.shippingAddress, 'tân phú') and !#strings.containsIgnoreCase(order.shippingAddress, 'phú nhuận') and !#strings.containsIgnoreCase(order.shippingAddress, 'gò vấp') and !#strings.containsIgnoreCase(order.shippingAddress, 'bình tân') and !#strings.containsIgnoreCase(order.shippingAddress, 'hóc môn') and !#strings.containsIgnoreCase(order.shippingAddress, 'củ chi') and !#strings.containsIgnoreCase(order.shippingAddress, 'bình chánh') and !#strings.containsIgnoreCase(order.shippingAddress, 'nhà bè') and !#strings.containsIgnoreCase(order.shippingAddress, 'cần giờ')}"
                            type="button" 
                            class="btn btn-sm btn-info me-1"
                            th:data-order-id="${order.orderId}"
                            th:disabled="${order.shippingProviderId != null}"
                          >
                            <i class="fas fa-truck me-1"></i>
                            <span th:if="${order.shippingProviderId != null}">Đã chọn nhà vận chuyển</span>
                            <span th:if="${order.shippingProviderId == null}">Chọn Nhà Vận Chuyển (Đi xa)</span>
                          </button>

                          <!-- Nút xác nhận - chỉ hiển thị khi đã chọn shipper hoặc nhà vận chuyển -->
                          <form
                            th:action="@{/vendor/orders/confirm}"
                            method="post"
                            class="d-inline"
                            th:if="${order.shipper != null or order.shippingProviderId != null}"
                          >
                            <input
                              type="hidden"
                              name="orderId"
                              th:value="${order.orderId}"
                            />
                            <input
                              type="hidden"
                              name="shopId"
                              th:value="${shopId}"
                            />
                            <button
                              type="submit"
                              class="btn btn-sm btn-success me-1"
                            >
                              <i class="fas fa-check me-1"></i>Xác nhận
                            </button>
                          </form>

                          <!-- Thông báo cần chọn shipper/nhà vận chuyển trước -->
                          <div th:if="${order.shipper == null and order.shippingProviderId == null}" class="text-warning small">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            Vui lòng chọn shipper hoặc nhà vận chuyển trước khi xác nhận
                          </div>


                          <form
                            th:action="@{/vendor/orders/cancel}"
                            method="post"
                            class="d-inline"
                          >
                            <input
                              type="hidden"
                              name="orderId"
                              th:value="${order.orderId}"
                            />
                            <input
                              type="hidden"
                              name="shopId"
                              th:value="${shopId}"
                            />
                            <button
                              type="submit"
                              class="btn btn-sm btn-danger"
                              onclick="return confirm('Bạn có chắc chắn muốn hủy đơn hàng này không?')"
                            >
                              <i class="fas fa-times me-1"></i>Hủy
                            </button>
                          </form>
                        </div>

                        <!-- Nút chọn shipper/nhà vận chuyển cho đơn đã xác nhận (backup) -->
                        <div th:if="${order.status.name() == 'CONFIRMED'}">
                          <!-- Nút chọn shipper cho đơn hỏa tốc (TPHCM) -->
                          <button 
                            th:if="${#strings.containsIgnoreCase(order.shippingAddress, 'hồ chí minh') or #strings.containsIgnoreCase(order.shippingAddress, 'ho chi minh') or #strings.containsIgnoreCase(order.shippingAddress, 'tphcm') or #strings.containsIgnoreCase(order.shippingAddress, 'sài gòn') or #strings.containsIgnoreCase(order.shippingAddress, 'quận 1') or #strings.containsIgnoreCase(order.shippingAddress, 'quận 2') or #strings.containsIgnoreCase(order.shippingAddress, 'quận 3') or #strings.containsIgnoreCase(order.shippingAddress, 'quận 4') or #strings.containsIgnoreCase(order.shippingAddress, 'quận 5') or #strings.containsIgnoreCase(order.shippingAddress, 'quận 6') or #strings.containsIgnoreCase(order.shippingAddress, 'quận 7') or #strings.containsIgnoreCase(order.shippingAddress, 'quận 8') or #strings.containsIgnoreCase(order.shippingAddress, 'quận 9') or #strings.containsIgnoreCase(order.shippingAddress, 'quận 10') or #strings.containsIgnoreCase(order.shippingAddress, 'quận 11') or #strings.containsIgnoreCase(order.shippingAddress, 'quận 12') or #strings.containsIgnoreCase(order.shippingAddress, 'thủ đức') or #strings.containsIgnoreCase(order.shippingAddress, 'bình thạnh') or #strings.containsIgnoreCase(order.shippingAddress, 'tân bình') or #strings.containsIgnoreCase(order.shippingAddress, 'tân phú') or #strings.containsIgnoreCase(order.shippingAddress, 'phú nhuận') or #strings.containsIgnoreCase(order.shippingAddress, 'gò vấp') or #strings.containsIgnoreCase(order.shippingAddress, 'bình tân') or #strings.containsIgnoreCase(order.shippingAddress, 'hóc môn') or #strings.containsIgnoreCase(order.shippingAddress, 'củ chi') or #strings.containsIgnoreCase(order.shippingAddress, 'bình chánh') or #strings.containsIgnoreCase(order.shippingAddress, 'nhà bè') or #strings.containsIgnoreCase(order.shippingAddress, 'cần giờ')}"
                            type="button" 
                            class="btn btn-sm btn-warning me-1"
                            th:data-order-id="${order.orderId}"
                            th:data-shop-id="${order.shop.shopId}"
                            th:disabled="${order.shipper != null}"
                          >
                            <i class="fas fa-motorcycle me-1"></i>
                            <span th:if="${order.shipper != null}">Đã gán shipper</span>
                            <span th:if="${order.shipper == null}">Chọn Shipper (Hỏa tốc)</span>
                          </button>
                          
                          <!-- Nút chọn nhà vận chuyển cho đơn đi xa (ngoài TPHCM) -->
                          <button 
                            th:if="${!#strings.containsIgnoreCase(order.shippingAddress, 'hồ chí minh') and !#strings.containsIgnoreCase(order.shippingAddress, 'ho chi minh') and !#strings.containsIgnoreCase(order.shippingAddress, 'tphcm') and !#strings.containsIgnoreCase(order.shippingAddress, 'sài gòn') and !#strings.containsIgnoreCase(order.shippingAddress, 'quận 1') and !#strings.containsIgnoreCase(order.shippingAddress, 'quận 2') and !#strings.containsIgnoreCase(order.shippingAddress, 'quận 3') and !#strings.containsIgnoreCase(order.shippingAddress, 'quận 4') and !#strings.containsIgnoreCase(order.shippingAddress, 'quận 5') and !#strings.containsIgnoreCase(order.shippingAddress, 'quận 6') and !#strings.containsIgnoreCase(order.shippingAddress, 'quận 7') and !#strings.containsIgnoreCase(order.shippingAddress, 'quận 8') and !#strings.containsIgnoreCase(order.shippingAddress, 'quận 9') and !#strings.containsIgnoreCase(order.shippingAddress, 'quận 10') and !#strings.containsIgnoreCase(order.shippingAddress, 'quận 11') and !#strings.containsIgnoreCase(order.shippingAddress, 'quận 12') and !#strings.containsIgnoreCase(order.shippingAddress, 'thủ đức') and !#strings.containsIgnoreCase(order.shippingAddress, 'bình thạnh') and !#strings.containsIgnoreCase(order.shippingAddress, 'tân bình') and !#strings.containsIgnoreCase(order.shippingAddress, 'tân phú') and !#strings.containsIgnoreCase(order.shippingAddress, 'phú nhuận') and !#strings.containsIgnoreCase(order.shippingAddress, 'gò vấp') and !#strings.containsIgnoreCase(order.shippingAddress, 'bình tân') and !#strings.containsIgnoreCase(order.shippingAddress, 'hóc môn') and !#strings.containsIgnoreCase(order.shippingAddress, 'củ chi') and !#strings.containsIgnoreCase(order.shippingAddress, 'bình chánh') and !#strings.containsIgnoreCase(order.shippingAddress, 'nhà bè') and !#strings.containsIgnoreCase(order.shippingAddress, 'cần giờ')}"
                            type="button" 
                            class="btn btn-sm btn-info me-1"
                            th:data-order-id="${order.orderId}"
                            th:disabled="${order.shippingProviderId != null}"
                          >
                            <i class="fas fa-truck me-1"></i>
                            <span th:if="${order.shippingProviderId != null}">Đã chọn nhà vận chuyển</span>
                            <span th:if="${order.shippingProviderId == null}">Chọn Nhà Vận Chuyển (Đi xa)</span>
                          </button>
                        </div>

                        <!-- Nút Chi tiết -->
                        <a
                          th:href="@{/vendor/orders/{id}(id=${order.orderId})}"
                          class="btn btn-sm btn-outline-primary"
                        >
                          <i class="fas fa-eye me-1"></i>Chi tiết
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Pagination -->
        <div
          th:if="${orders.totalPages > 1}"
          class="d-flex justify-content-center mt-4"
        >
          <nav aria-label="Page navigation">
            <ul class="pagination">
              <li
                class="page-item"
                th:classappend="${orders.first ? 'disabled' : ''}"
              >
                <a
                  class="page-link"
                  th:href="@{/vendor/orders(shopId=${shopId}, status=${currentStatus}, q=${search}, page=${orders.number - 1}, size=${orders.size})}"
                  aria-label="Previous"
                >
                  <span aria-hidden="true">&laquo;</span>
                </a>
              </li>
              <li
                class="page-item"
                th:each="i : ${#numbers.sequence(0, orders.totalPages - 1)}"
                th:classappend="${i == orders.number ? 'active' : ''}"
              >
                <a
                  class="page-link"
                  th:href="@{/vendor/orders(shopId=${shopId}, status=${currentStatus}, q=${search}, page=${i}, size=${orders.size})}"
                  th:text="${i + 1}"
                >
                  1
                </a>
              </li>
              <li
                class="page-item"
                th:classappend="${orders.last ? 'disabled' : ''}"
              >
                <a
                  class="page-link"
                  th:href="@{/vendor/orders(shopId=${shopId}, status=${currentStatus}, q=${search}, page=${orders.number + 1}, size=${orders.size})}"
                  aria-label="Next"
                >
                  <span aria-hidden="true">&raquo;</span>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </section>

      <div
        th:if="${orders == null or orders.content.isEmpty()}"
        class="text-center py-5 vendor-section"
      >
        <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">Chưa có đơn hàng nào</h5>
      </div>
    </main>

    <!-- Modal chọn Shipper -->
    <div class="modal fade" id="shipperModal" tabindex="-1" aria-labelledby="shipperModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="shipperModalLabel">
              <i class="fas fa-motorcycle me-2"></i>Chọn Shipper cho đơn hỏa tốc
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Danh sách Shipper có sẵn:</label>
              <select class="form-select" id="shipperSelect">
                <option value="">-- Chọn Shipper --</option>
              </select>
            </div>
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              <strong>Lưu ý:</strong> Đơn hàng hỏa tốc sẽ được giao trong 2-4 giờ với phí 30,000 VNĐ. Sau khi chọn shipper, bạn có thể xác nhận đơn hàng.
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
            <button type="button" class="btn btn-warning" onclick="assignShipper()">
              <i class="fas fa-check me-1"></i>Gán Shipper
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal chọn Nhà Vận Chuyển -->
    <div class="modal fade" id="providerModal" tabindex="-1" aria-labelledby="providerModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="providerModalLabel">
              <i class="fas fa-truck me-2"></i>Chọn Nhà Vận Chuyển cho đơn đi xa
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Danh sách Nhà Vận Chuyển:</label>
              <select class="form-select" id="providerSelect">
                <option value="">-- Chọn Nhà Vận Chuyển --</option>
              </select>
            </div>
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              <strong>Lưu ý:</strong> Đơn hàng đi xa sẽ được giao trong 2-5 ngày tùy theo nhà vận chuyển. Sau khi chọn nhà vận chuyển, bạn có thể xác nhận đơn hàng.
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
            <button type="button" class="btn btn-info" onclick="assignProvider()">
              <i class="fas fa-check me-1"></i>Chọn Nhà Vận Chuyển
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
      let currentOrderId = null;
      let currentShopId = null;


      // Thêm event listener khi trang load
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, adding event listeners...');
        
        // Thêm event listener cho tất cả nút chọn shipper và nhà vận chuyển
        document.addEventListener('click', function(e) {
          if (e.target.closest('button[data-order-id]')) {
            const button = e.target.closest('button[data-order-id]');
            const orderId = button.getAttribute('data-order-id');
            const shopId = button.getAttribute('data-shop-id');
            
            // Kiểm tra nếu có shopId thì là nút shipper
            if (shopId) {
              console.log('Shipper button clicked for order:', orderId, 'shop:', shopId);
              openShipperModal(orderId, shopId);
            } else {
              console.log('Provider button clicked for order:', orderId);
              openProviderModal(orderId);
            }
          }
        });
      });

      // Mở modal chọn shipper
      function openShipperModal(orderId, shopId) {
        console.log('Opening shipper modal for order:', orderId, 'shop:', shopId);
        currentOrderId = orderId;
        currentShopId = shopId;
        
        // Load danh sách shipper
        loadShippers(shopId);
        
        // Hiển thị modal
        const modalElement = document.getElementById('shipperModal');
        if (modalElement) {
          const modal = new bootstrap.Modal(modalElement);
          modal.show();
        } else {
          console.error('Shipper modal element not found');
          alert('Không thể mở modal chọn shipper');
        }
      }

      // Mở modal chọn nhà vận chuyển
      function openProviderModal(orderId) {
        console.log('Opening provider modal for order:', orderId);
        currentOrderId = orderId;
        
        // Load danh sách nhà vận chuyển
        loadProviders();
        
        // Hiển thị modal
        const modalElement = document.getElementById('providerModal');
        if (modalElement) {
          const modal = new bootstrap.Modal(modalElement);
          modal.show();
        } else {
          console.error('Provider modal element not found');
          alert('Không thể mở modal chọn nhà vận chuyển');
        }
      }

      // Load danh sách shipper
      function loadShippers(shopId) {
        console.log('Loading shippers for shop:', shopId);
        fetch(`/vendor/orders/api/shop-shippers/${shopId}`)
          .then(response => {
            console.log('Shipper API response:', response);
            return response.json();
          })
          .then(shippers => {
            console.log('Shippers loaded:', shippers);
            const select = document.getElementById('shipperSelect');
            if (select) {
              select.innerHTML = '<option value="">-- Chọn Shipper --</option>';
              
              shippers.forEach(shipper => {
                const option = document.createElement('option');
                option.value = shipper.userId;
                option.textContent = shipper.name + ' (' + shipper.email + ')';
                select.appendChild(option);
              });
            } else {
              console.error('Shipper select element not found');
            }
          })
          .catch(error => {
            console.error('Lỗi khi load shippers:', error);
            alert('Không thể tải danh sách shipper: ' + error.message);
          });
      }

      // Load danh sách nhà vận chuyển
      function loadProviders() {
        console.log('Loading shipping providers...');
        fetch('/vendor/orders/api/shipping-providers')
          .then(response => {
            console.log('Provider API response:', response);
            return response.json();
          })
          .then(providers => {
            console.log('Providers loaded:', providers);
            const select = document.getElementById('providerSelect');
            if (select) {
              select.innerHTML = '<option value="">-- Chọn Nhà Vận Chuyển --</option>';
              
              providers.forEach(provider => {
                const option = document.createElement('option');
                option.value = provider.providerId;
                option.textContent = provider.providerName + ' - ' + (provider.shippingFees ? provider.shippingFees.toLocaleString() + ' VNĐ' : 'Liên hệ');
                select.appendChild(option);
              });
            } else {
              console.error('Provider select element not found');
            }
          })
          .catch(error => {
            console.error('Lỗi khi load providers:', error);
            alert('Không thể tải danh sách nhà vận chuyển: ' + error.message);
          });
      }

      // Gán shipper
      function assignShipper() {
        const shipperId = document.getElementById('shipperSelect').value;
        if (!shipperId) {
          alert('Vui lòng chọn shipper');
          return;
        }

        const formData = new FormData();
        formData.append('orderId', currentOrderId);
        formData.append('shipperId', shipperId);

        fetch('/vendor/orders/assign-shipper', {
          method: 'POST',
          body: formData
        })
        .then(response => response.text())
        .then(result => {
          if (result === 'success') {
            alert('Gán shipper thành công! Bây giờ bạn có thể xác nhận đơn hàng.');
            location.reload();
          } else if (result === 'not_hcm') {
            alert('Đơn hàng này không phải địa chỉ TPHCM');
          } else if (result === 'shipper_not_assigned') {
            alert('Shipper này chưa được gán cho shop');
          } else {
            alert('Có lỗi xảy ra: ' + result);
          }
        })
        .catch(error => {
          console.error('Lỗi:', error);
          alert('Có lỗi kết nối đến server');
        });
      }

      // Gán nhà vận chuyển
      function assignProvider() {
        const providerId = document.getElementById('providerSelect').value;
        if (!providerId) {
          alert('Vui lòng chọn nhà vận chuyển');
          return;
        }

        const formData = new FormData();
        formData.append('orderId', currentOrderId);
        formData.append('providerId', providerId);

        fetch('/vendor/orders/assign-shipping-provider', {
          method: 'POST',
          body: formData
        })
        .then(response => response.text())
        .then(result => {
          if (result === 'success') {
            alert('Chọn nhà vận chuyển thành công! Bây giờ bạn có thể xác nhận đơn hàng.');
            location.reload();
          } else if (result === 'is_hcm') {
            alert('Đơn hàng này là địa chỉ TPHCM, vui lòng chọn shipper');
          } else {
            alert('Có lỗi xảy ra: ' + result);
          }
        })
        .catch(error => {
          console.error('Lỗi:', error);
          alert('Có lỗi kết nối đến server');
        });
      }
    </script>
  </body>
</html>
