<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý đơn hàng</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .vendor-section {
        background: white;
        border-radius: 8px;
        padding: 24px;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .order-card {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        transition: all 0.2s ease;
        background: #fdfdfd;
      }

      .order-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
        border-color: #007bff;
      }

      .status-badge {
        font-size: 0.75rem;
        padding: 4px 10px;
        border-radius: 20px;
        font-weight: 500;
      }

      .nav-tabs .nav-link {
        border: none;
        color: #6c757d;
        font-weight: 500;
      }

      .nav-tabs .nav-link.active {
        color: #007bff;
        background-color: #e7f1ff;
        border-radius: 6px;
      }

      .nav-tabs .nav-link:hover:not(.active) {
        color: #0056b3;
      }

      .order-amount {
        font-size: 1.1rem;
        font-weight: 600;
        color: #28a745;
      }
    </style>
  </head>
  <body class="bg-light">
    <div th:replace="~{vendor/fragments/nav :: vendorNav('orders')}"></div>

    <main class="container py-4">
      <!-- Header Section -->
      <section class="vendor-section mb-4">
        <div
          class="d-flex flex-column flex-xl-row justify-content-between gap-3 align-items-start align-items-xl-center"
        >
          <div>
            <h2 class="h4 mb-1">Quản lý đơn hàng</h2>
            <p class="text-muted mb-0">Danh sách đơn hàng của shop</p>
          </div>
          <div class="d-flex gap-2">
            <span class="badge bg-primary fs-6">
              <i class="fas fa-shopping-cart me-1"></i>
              Tổng: <span th:text="${totalOrders}">0</span> đơn hàng
            </span>
          </div>
        </div>
      </section>

      <!-- Search & Filter Section -->
      <section class="vendor-section mb-4">
        <!-- Status Tabs -->
        <ul class="nav nav-tabs mb-4" id="orderTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <a
              class="nav-link"
              th:classappend="${currentStatus == null ? 'active' : ''}"
              th:href="@{/vendor/orders(shopId=${shopId}, q=${search})}"
            >
              Tất cả
              <span class="badge bg-secondary ms-1" th:text="${totalOrders}"
                >0</span
              >
            </a>
          </li>
          <li class="nav-item" role="presentation">
            <a
              class="nav-link"
              th:classappend="${currentStatus == 'PENDING' ? 'active' : ''}"
              th:href="@{/vendor/orders(shopId=${shopId}, status=PENDING, q=${search})}"
            >
              Chờ xác nhận
              <span class="badge bg-secondary ms-1" th:text="${pendingCount}"
                >0</span
              >
            </a>
          </li>
          <li class="nav-item" role="presentation">
            <a
              class="nav-link"
              th:classappend="${currentStatus == 'CONFIRMED' ? 'active' : ''}"
              th:href="@{/vendor/orders(shopId=${shopId}, status=CONFIRMED, q=${search})}"
            >
              Đã xác nhận
              <span class="badge bg-secondary ms-1" th:text="${confirmedCount}"
                >0</span
              >
            </a>
          </li>
          <li class="nav-item" role="presentation">
            <a
              class="nav-link"
              th:classappend="${currentStatus == 'SHIPPING' ? 'active' : ''}"
              th:href="@{/vendor/orders(shopId=${shopId}, status=SHIPPING, q=${search})}"
            >
              Đang giao hàng
              <span class="badge bg-secondary ms-1" th:text="${shippingCount}"
                >0</span
              >
            </a>
          </li>
          <li class="nav-item" role="presentation">
            <a
              class="nav-link"
              th:classappend="${currentStatus == 'DELIVERED' ? 'active' : ''}"
              th:href="@{/vendor/orders(shopId=${shopId}, status=DELIVERED, q=${search})}"
            >
              Đã giao
              <span class="badge bg-success ms-1" th:text="${deliveredCount}"
                >0</span
              >
            </a>
          </li>
          <li class="nav-item" role="presentation">
            <a
              class="nav-link"
              th:classappend="${currentStatus == 'CANCELLED' ? 'active' : ''}"
              th:href="@{/vendor/orders(shopId=${shopId}, status=CANCELLED, q=${search})}"
            >
              Đã hủy
              <span class="badge bg-danger ms-1" th:text="${cancelledCount}"
                >0</span
              >
            </a>
          </li>
          <li class="nav-item" role="presentation">
            <a
              class="nav-link"
              th:classappend="${currentStatus == 'RETURNED' ? 'active' : ''}"
              th:href="@{/vendor/orders(shopId=${shopId}, status=RETURNED, q=${search})}"
            >
              Đã hoàn trả
              <span class="badge bg-secondary ms-1" th:text="${returnedCount}"
                >0</span
              >
            </a>
          </li>
        </ul>

        <!-- Search Form -->
        <form th:action="@{/vendor/orders}" method="get">
          <input type="hidden" name="shopId" th:value="${shopId}" />
          <input
            type="hidden"
            name="status"
            th:value="${currentStatus != null ? currentStatus : ''}"
          />
          <div class="row">
            <div class="col-md-6">
              <div class="input-group">
                <input
                  type="text"
                  name="q"
                  class="form-control"
                  placeholder="Tìm kiếm theo mã đơn hàng..."
                  th:value="${search}"
                />
                <button class="btn btn-primary" type="submit">
                  <i class="fas fa-search"></i> Tìm kiếm
                </button>
              </div>
            </div>
          </div>
        </form>
      </section>

      <!-- Orders List -->
      <section>
        <div
          th:if="${error}"
          class="alert alert-danger"
          th:text="${error}"
        ></div>

        <div th:if="${orders != null and !orders.content.isEmpty()}">
          <div class="row">
            <div th:each="order : ${orders.content}" class="col-12 mb-3">
              <div class="order-card">
                <div class="card-body p-3">
                  <div class="row align-items-center">
                    <div class="col-md-8">
                      <h6 class="mb-2">
                        <i class="fas fa-receipt text-primary me-2"></i>
                        Đơn hàng #<span th:text="${order.orderId}">1</span>
                      </h6>
                      <div class="row text-muted small">
                        <div class="col-6">
                          <i class="fas fa-clock me-1"></i>
                          <span
                            th:text="${order.orderDate != null ? #temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm') : 'N/A'}"
                          ></span>
                        </div>
                        <div class="col-6">
                          <i class="fas fa-credit-card me-1"></i>
                          <span
                            th:text="${order.paymentMethod ?: 'COD'}"
                          ></span>
                        </div>
                      </div>
                      <!-- Delivery Type Badge -->
                      <div class="mt-1" th:if="${order.deliveryType}">
                        <span th:if="${order.deliveryType.name() == 'EXPRESS'}" class="badge bg-danger">
                          <i class="fas fa-bolt me-1"></i>Hỏa tốc
                        </span>
                        <span th:if="${order.deliveryType.name() == 'STANDARD'}" class="badge bg-info">
                          <i class="fas fa-truck me-1"></i>Tiêu chuẩn
                        </span>
                        <!-- Display assigned shipper for EXPRESS orders -->
                        <div th:if="${order.deliveryType.name() == 'EXPRESS' && order.status.name() != 'PENDING' && order.shipper != null}" 
                             class="mt-1 text-success">
                          <i class="fas fa-user-tie me-1"></i>
                          <small th:text="|Shipper: ${shipperNameMap[order.shipper.userId]}|">Shipper Name</small>
                        </div>
                        <!-- Display shipping provider for STANDARD orders -->
                        <div th:if="${order.deliveryType.name() == 'STANDARD' && order.status.name() != 'PENDING' && order.shippingProviderId != null}" 
                             class="mt-1 text-primary">
                          <i class="fas fa-truck me-1"></i>
                          <small th:text="|Đơn vị: ${shippingProviderMap[order.shippingProviderId]}|">Provider Name</small>
                        </div>
                      </div>
                      <div class="mt-1">
                        <i class="fas fa-map-marker-alt me-1"></i>
                        <small
                          th:text="${order.shippingAddress ?: 'N/A'}"
                          class="text-muted"
                        ></small>
                      </div>
                    </div>
                    <div class="col-md-4 text-end">
                      <div
                        class="order-amount mb-2"
                        th:text="${(order.finalAmount != null && order.finalAmount > 0) ? (#numbers.formatDecimal(order.finalAmount, 0, 'COMMA', 0, 'POINT') + ' VNĐ') : (order.totalAmount != null ? (#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT') + ' VNĐ') : '0 VNĐ')}"
                      ></div>
                      <div class="mb-2">
                        <div th:switch="${order.status.name()}">
                          <span th:case="'PENDING'" class="badge bg-secondary"
                            >Chờ xác nhận</span
                          >
                          <span th:case="'CONFIRMED'" class="badge bg-primary"
                            >Đã xác nhận</span
                          >
                          <span th:case="'SHIPPING'" class="badge bg-warning"
                            >Đang giao hàng</span
                          >
                          <span th:case="'DELIVERED'" class="badge bg-success"
                            >Đã giao</span
                          >
                          <span th:case="'CANCELLED'" class="badge bg-danger"
                            >Đã hủy</span
                          >
                          <span th:case="'RETURNED'" class="badge bg-dark"
                            >Đã hoàn trả</span
                          >
                          <span
                            th:case="*"
                            class="badge bg-light text-dark"
                            th:text="${order.status}"
                          ></span>
                        </div>
                      </div>
                      <div
                        class="d-flex justify-content-end align-items-center gap-2"
                      >
                        <!-- Các nút hành động chỉ hiển thị khi trạng thái là PENDING hoặc CONFIRMED -->
                        <div th:if="${order.status.name() == 'PENDING' or order.status.name() == 'CONFIRMED'}">
                          <!-- Express orders: open modal to select shipper -->
                          <div th:if="${order.deliveryType != null && order.deliveryType.name() == 'EXPRESS' && order.status.name() == 'PENDING'}">
                            <button
                              type="button"
                              class="btn btn-sm btn-success btn-confirm-express"
                              th:data-order-id="${order.orderId}"
                              th:data-shop-id="${shopId}"
                              onclick="openConfirmExpressModal(this)"
                            >
                              <i class="fas fa-check me-1"></i>Xác nhận
                            </button>
                          </div>
                          
                          <!-- Standard orders: open modal to select shipping provider -->
                          <div th:if="${(order.deliveryType == null || order.deliveryType.name() != 'EXPRESS') && order.status.name() == 'PENDING'}">
                            <button
                              type="button"
                              class="btn btn-sm btn-success btn-confirm-standard"
                              th:data-order-id="${order.orderId}"
                              th:data-shop-id="${shopId}"
                              onclick="openConfirmStandardModal(this)"
                            >
                              <i class="fas fa-check me-1"></i>Xác nhận
                            </button>
                          </div>
                          
                          <!-- Cancel button -->
                          <form
                            th:action="@{/vendor/orders/cancel}"
                            method="post"
                            class="d-inline"
                          >
                            <input
                              type="hidden"
                              name="orderId"
                              th:value="${order.orderId}"
                            />
                            <input
                              type="hidden"
                              name="shopId"
                              th:value="${shopId}"
                            />
                            <button
                              type="submit"
                              class="btn btn-sm btn-danger"
                              onclick="return confirm('Bạn có chắc chắn muốn hủy đơn hàng này không?')"
                            >
                              <i class="fas fa-times me-1"></i>Hủy
                            </button>
                          </form>
                        </div>

                        <!-- Nút Chi tiết -->
                        <a
                          th:href="@{/vendor/orders/{id}(id=${order.orderId})}"
                          class="btn btn-sm btn-outline-primary"
                        >
                          <i class="fas fa-eye me-1"></i>Chi tiết
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Pagination -->
        <div
          th:if="${orders.totalPages > 1}"
          class="d-flex justify-content-center mt-4"
        >
          <nav aria-label="Page navigation">
            <ul class="pagination">
              <li
                class="page-item"
                th:classappend="${orders.first ? 'disabled' : ''}"
              >
                <a
                  class="page-link"
                  th:href="@{/vendor/orders(shopId=${shopId}, status=${currentStatus}, q=${search}, page=${orders.number - 1}, size=${orders.size})}"
                  aria-label="Previous"
                >
                  <span aria-hidden="true">&laquo;</span>
                </a>
              </li>
              <li
                class="page-item"
                th:each="i : ${#numbers.sequence(0, orders.totalPages - 1)}"
                th:classappend="${i == orders.number ? 'active' : ''}"
              >
                <a
                  class="page-link"
                  th:href="@{/vendor/orders(shopId=${shopId}, status=${currentStatus}, q=${search}, page=${i}, size=${orders.size})}"
                  th:text="${i + 1}"
                >
                  1
                </a>
              </li>
              <li
                class="page-item"
                th:classappend="${orders.last ? 'disabled' : ''}"
              >
                <a
                  class="page-link"
                  th:href="@{/vendor/orders(shopId=${shopId}, status=${currentStatus}, q=${search}, page=${orders.number + 1}, size=${orders.size})}"
                  aria-label="Next"
                >
                  <span aria-hidden="true">&raquo;</span>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </section>

      <div
        th:if="${orders == null or orders.content.isEmpty()}"
        class="text-center py-5 vendor-section"
      >
        <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">Chưa có đơn hàng nào</h5>
      </div>
    </main>
    
    <!-- Modal to select shipping provider for STANDARD orders -->
    <div class="modal fade" id="confirmStandardModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Xác nhận đơn hàng tiêu chuẩn</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p class="text-muted mb-3">
              Đơn hàng này là đơn giao tiêu chuẩn. Vui lòng chọn nhà vận chuyển trước khi xác nhận.
            </p>
            <form id="confirmStandardOrderForm" action="/vendor/orders/confirm" method="post">
              <input type="hidden" name="orderId" id="confirmStandardOrderId" value="" />
              <input type="hidden" name="shopId" id="confirmStandardShopId" th:value="${shopId}" />
              
              <div class="mb-3">
                <label for="shippingProvider" class="form-label">
                  <i class="fas fa-truck me-2"></i>Nhà vận chuyển <span class="text-danger">*</span>
                </label>
                <select class="form-select" id="shippingProvider" name="shippingProviderId" required>
                  <option value="">-- Chọn nhà vận chuyển --</option>
                  <option value="1">GHN - Giao Hàng Nhanh</option>
                  <option value="2">GHTK - Giao Hàng Tiết Kiệm</option>
                  <option value="3">J&T Express</option>
                  <option value="4">Viettel Post</option>
                  <option value="5">Vietnam Post</option>
                </select>
                <small class="text-muted">
                  Vui lòng chọn nhà vận chuyển để có thể xác nhận đơn hàng tiêu chuẩn.
                </small>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Hủy
            </button>
            <button type="submit" form="confirmStandardOrderForm" class="btn btn-success">
              <i class="fas fa-check me-2"></i>Xác nhận đơn hàng
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Modal to select shipper for EXPRESS orders -->
    <div class="modal fade" id="confirmExpressModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Xác nhận đơn hàng hỏa tốc</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p class="text-muted mb-3">
              Đơn hàng này là đơn hỏa tốc. Vui lòng chọn shipper trước khi xác nhận.
            </p>
            <form id="confirmExpressOrderForm" action="/vendor/orders/confirm" method="post">
              <input type="hidden" name="orderId" id="confirmExpressOrderId" value="" />
              <input type="hidden" name="shopId" id="confirmExpressShopId" th:value="${shopId}" />
              
              <div class="mb-3">
                <label for="shipperSelect" class="form-label">
                  <i class="fas fa-user-tie me-2"></i>Shipper <span class="text-danger">*</span>
                </label>
                <select class="form-select" id="shipperSelect" name="shipperId" required>
                  <option value="">-- Chọn shipper --</option>
                  <option th:each="shipper : ${shopShippers}" 
                          th:value="${shipper.userId}" 
                          th:text="${shipper.name}">
                    Shipper Name
                  </option>
                </select>
                <small class="text-muted">
                  Vui lòng chọn shipper để có thể xác nhận đơn hàng hỏa tốc.
                </small>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Hủy
            </button>
            <button type="submit" form="confirmExpressOrderForm" class="btn btn-success">
              <i class="fas fa-check me-2"></i>Xác nhận đơn hàng
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <script>
      // Function to open modal for EXPRESS orders (select shipper)
      function openConfirmExpressModal(button) {
        console.log('Opening confirm EXPRESS modal...');
        
        // Get orderId and shopId from button data attributes
        const orderId = button.getAttribute('data-order-id');
        const shopId = button.getAttribute('data-shop-id');
        
        console.log('EXPRESS Order ID:', orderId, 'Shop ID:', shopId);
        
        // Set order ID
        document.getElementById('confirmExpressOrderId').value = orderId;
        
        // Set shop ID if provided
        const shopIdInput = document.querySelector('#confirmExpressOrderForm input[name="shopId"]');
        if (shopIdInput && shopId) {
          shopIdInput.value = shopId;
        }
        
        // Reset shipper selection
        document.getElementById('shipperSelect').value = '';
        
        // Open modal
        const modal = new bootstrap.Modal(document.getElementById('confirmExpressModal'));
        modal.show();
      }
      
      // Function to open modal for STANDARD orders (select shipping provider)
      function openConfirmStandardModal(button) {
        console.log('Opening confirm STANDARD modal...');
        
        // Get orderId and shopId from button data attributes
        const orderId = button.getAttribute('data-order-id');
        const shopId = button.getAttribute('data-shop-id');
        
        console.log('STANDARD Order ID:', orderId, 'Shop ID:', shopId);
        
        // Set order ID
        document.getElementById('confirmStandardOrderId').value = orderId;
        
        // Set shop ID if provided
        const shopIdInput = document.querySelector('#confirmStandardOrderForm input[name="shopId"]');
        if (shopIdInput && shopId) {
          shopIdInput.value = shopId;
        }
        
        // Reset shipping provider selection
        document.getElementById('shippingProvider').value = '';
        
        // Open modal
        const modal = new bootstrap.Modal(document.getElementById('confirmStandardModal'));
        modal.show();
      }
      
      // Handle form submit with validation for STANDARD orders
      document.addEventListener('DOMContentLoaded', function() {
        const standardForm = document.getElementById('confirmStandardOrderForm');
        if (standardForm) {
          standardForm.addEventListener('submit', function(e) {
            const shippingProvider = document.getElementById('shippingProvider').value;
            if (!shippingProvider || shippingProvider === '') {
              e.preventDefault();
              alert('Vui lòng chọn nhà vận chuyển trước khi xác nhận đơn hàng!');
              return false;
            }
            console.log('Submitting STANDARD order with shipping provider:', shippingProvider);
          });
        }
        
        // Handle form submit with validation for EXPRESS orders
        const expressForm = document.getElementById('confirmExpressOrderForm');
        if (expressForm) {
          expressForm.addEventListener('submit', function(e) {
            const shipperId = document.getElementById('shipperSelect').value;
            if (!shipperId || shipperId === '') {
              e.preventDefault();
              alert('Vui lòng chọn shipper trước khi xác nhận đơn hàng!');
              return false;
            }
            console.log('Submitting EXPRESS order with shipper ID:', shipperId);
          });
        }
      });
    </script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
